let canvas,ctx;console.log("üìÖ Using real current date:",(new Date).toISOString().split("T")[0]);let currentGeoJSON=null,parsedShapes=[];window.debugCurrentAttempts=function(e,t){const n=window.currentAttempts||[],o=void 0!==currentAttempts?currentAttempts:[];console.log(`üéØ ATTEMPTS DEBUG [${e}] ${t}:`),console.log(`   Window attempts: ${n.length}`,n.map((e,t)=>`[${t}] ${e.leftPercentage?.toFixed(1)}/${e.rightPercentage?.toFixed(1)}`)),console.log(`   Local attempts: ${o.length}`,o.map((e,t)=>`[${t}] ${e.leftPercentage?.toFixed(1)}/${e.rightPercentage?.toFixed(1)}`)),console.log(`   Shape: ${window.currentShapeNumber||"?"}, Attempt: ${window.currentAttemptNumber||"?"}, Total cuts: ${window.totalCutsMade||0}`)};let gameState="initial";window.gameState=gameState;let currentDate=null,currentDayNumber=1,isInteractionEnabled=!1;function setGameState(e){gameState=e,window.gameState=e,console.log("üîÑ Game state updated:",e)}function setInteractionEnabled(e,t=!1){if(window.isPracticeMode){if(isInteractionEnabled=e,window.isInteractionEnabled=e,console.log("üîÑ Practice mode: Interaction enabled (bypassing animation check)"),e&&("cutting"===gameState||"playing"===gameState)){const e=getInitialInstruction(getPracticeMechanicName());window.updateInstructionText&&e&&(window.updateInstructionText(e),console.log("üéÆ Practice mode: Set initial instruction:",e))}}else if(isDailyMode&&e&&"awaiting_choice"===gameState&&!t)console.log("üö´ DAILY MODE: Cannot re-enable interaction while awaiting user choice - use progression buttons");else if(!e||isShapeAnimationComplete||"cutting"!==gameState&&"playing"!==gameState){if(isInteractionEnabled=e,window.isInteractionEnabled=e,console.log("üîÑ Interaction enabled updated:",e,t?"(from progression button)":""),e&&("cutting"===gameState||"playing"===gameState)){const e=getInitialInstruction(getCurrentMechanicName());window.updateInstructionText&&e&&(window.updateInstructionText(e),console.log("üéØ Daily mode: Set initial instruction:",e))}}else console.log("üö´ Interaction enable blocked - waiting for shape animation to complete")}window.isInteractionEnabled=isInteractionEnabled;let isPractiseMode=!1,isPracticeMode=!1,isDailyMode=!1,practiceShapes=[],currentPracticeShapeIndex=0,isFirstPracticeCut=!0,hasShownFinalInstructions=!1;const practiceMode={isActive:!1,currentShapeIndex:0,availableShapes:[],currentShapePath:null,practiceCanvas:null,practiceCtx:null,practiceParsedShapes:[],practiceCurrentVector:null,practiceIsDrawingVector:!1,practiceVectorStart:null,practiceVectorEnd:null,savedDailyGameState:null,cachedCanvasRect:null};let currentAttempts=[],attemptCount=0,maxAttempts=2,finalLockedScore=null,shapeScreenshot=null,pulseCount=0,pulseInterval=null,canvasRestoreData=null,isShapeAnimationComplete=!1,dailyStats={};for(let e=1;e<=7;e++)dailyStats[`day${e}`]={shape1:[],shape2:[],shape3:[]};const savedDemoStats=localStorage.getItem("demoGameDailyStats");if(savedDemoStats)try{const e=JSON.parse(savedDemoStats);Object.assign(dailyStats,e),console.log("üìä Loaded saved demo stats from localStorage")}catch(e){console.warn("‚ö†Ô∏è Could not load saved demo stats:",e)}let loadingAnimationActive=!1,loadingAnimationFrame=null,hexagonProgress=0,loadingText="";const loadingMessages=["Give us this day our Daily Shapes!","Things are taking Shape!","Shape up or ship out!","What do we want? SHAPES!","Shape that booty!","Let there be Shapes!"];function showLoadingAnimation(){canvas&&ctx&&(loadingAnimationActive=!0,hexagonProgress=0,loadingText=loadingMessages[Math.floor(Math.random()*loadingMessages.length)],animateLoading())}function hideLoadingAnimation(){window.stopImmediateLoadingAnimation&&window.stopImmediateLoadingAnimation(),loadingAnimationActive=!1,loadingAnimationFrame&&(cancelAnimationFrame(loadingAnimationFrame),loadingAnimationFrame=null),canvas&&ctx&&drawGrid()}function animateLoading(){loadingAnimationActive&&(ctx.clearRect(0,0,canvas.width,canvas.height),drawLoadingHexagon(),drawLoadingText(),hexagonProgress+=.008,hexagonProgress>1&&(hexagonProgress=0),loadingAnimationFrame=requestAnimationFrame(animateLoading))}function drawLoadingHexagon(){const e=380,t=.1*Math.min(e,e),n=6*hexagonProgress*2;ctx.save(),ctx.strokeStyle="#000",ctx.lineWidth=3,ctx.lineCap="round",ctx.translate(190,140),ctx.rotate(hexagonProgress*Math.PI*2);const o=2*Math.PI/6,a=[];for(let e=0;e<6;e++){const n=e*o-Math.PI/2;a.push({x:t*Math.cos(n),y:t*Math.sin(n)})}if(ctx.beginPath(),n<=6){const e=n;for(let t=0;t<Math.floor(e)&&t<6;t++){const e=a[t],n=a[(t+1)%6];0===t&&ctx.moveTo(e.x,e.y),ctx.lineTo(n.x,n.y)}const t=e%1;if(t>0&&Math.floor(e)<6){const n=Math.floor(e),o=a[n],i=a[(n+1)%6],r=o.x+(i.x-o.x)*t,s=o.y+(i.y-o.y)*t;0===Math.floor(e)&&ctx.moveTo(o.x,o.y),ctx.lineTo(r,s)}}else{const e=n-6,t=Math.floor(e),o=e%1,i=t;if(6-t>0){let e=!1;for(let t=i;t<6;t++){const n=a[t],o=a[(t+1)%6];e||(ctx.moveTo(n.x,n.y),e=!0),ctx.lineTo(o.x,o.y)}if(o>0&&i>0){const t=i-1,n=a[t],r=a[(t+1)%6],s=1-o;if(s>0){const t=n.x+(r.x-n.x)*s,o=n.y+(r.y-n.y)*s;e?ctx.moveTo(n.x,n.y):(ctx.moveTo(n.x,n.y),e=!0),ctx.lineTo(t,o)}}}}ctx.stroke(),ctx.restore()}function drawLoadingText(){const e=380;ctx.save();const t=.04*Math.min(e,e),n=Math.max(16,Math.min(32,t));ctx.font=`${n}px Arial, sans-serif`,ctx.fillStyle="#000",ctx.textAlign="center",ctx.textBaseline="middle";wrapText(ctx,loadingText,190,290,304,1.2*n),ctx.restore()}function wrapText(e,t,n,o,a,i){const r=t.split(" ");let s="",c=o;for(let t=0;t<r.length;t++){const o=s+r[t]+" ";e.measureText(o).width>a&&t>0?(e.fillText(s,n,c),s=r[t]+" ",c+=i):s=o}e.fillText(s,n,c)}let lastResetDate=null;function checkDailyReset(){const e=(new Date).toDateString();lastResetDate!==e&&(console.log("üåÖ New day detected - resetting daily stats"),resetDailyStats(),lastResetDate=e,localStorage.setItem("lastResetDate",e),cleanupOldGameStates(e))}let dailyGameState=null,isRestoringState=!1;function initializeDailyGameState(){dailyGameState={isGameStarted:!1,currentShape:1,currentAttempt:1,cuts:[]}}function saveVisualState(e,t,n){if(dailyGameState&&!isRestoringState)try{e&&(dailyGameState.lastRenderedCut=e),void 0!==t&&void 0!==n&&(dailyGameState.lastPercentageDisplay={left:t,right:n}),!canvas||"cutting"!==gameState&&"playing"!==gameState?(dailyGameState.lastShapeColors=null,console.log("üö´ Visual state: Skipped canvas capture during results phase")):(dailyGameState.lastShapeColors=canvas.toDataURL(),console.log("üì∏ Visual state: Captured unshaded canvas state"))}catch(e){console.error("‚ùå Failed to save visual state:",e)}}function saveCutResult(e,t,n,o,a,i,r){if(!dailyGameState||isRestoringState)return;const s={shapeIndex:e,attemptNumber:t,cutVector:n,leftPercentage:o,rightPercentage:a,score:i,commentary:r,timestamp:Date.now()};window.currentSquareData&&(s.squareData={center:window.currentSquareData.center,size:window.currentSquareData.size,rotation:window.currentSquareData.rotation},console.log("üíæ Saved rotating square data:",s.squareData)),window.GameFlowEnforcer&&window.GameFlowEnforcer.isFlowActive()&&window.GameFlowEnforcer.onCutCompleted(s),dailyGameState.cuts.push(s),saveVisualState(n,o,a),window.SimpleGameRefresh&&window.SimpleGameRefresh.save&&window.SimpleGameRefresh.save()}function getCurrentLocalDate(){const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function checkForExistingGameState(){const e=`dailyGameState_${getCurrentLocalDate()}`;console.log("üîç Checking for saved state with key:",e);const t=localStorage.getItem(e);if(console.log("üîç Found saved state:",!!t),t)try{const e=JSON.parse(t);if(console.log("üîÑ Parsed existing game state:",e),console.log("üîç State details - isGameStarted:",e.isGameStarted,"isGameComplete:",e.isGameComplete,"dayComplete:",e.dayComplete),e.isGameStarted){if(dailyGameState=e,e.isGameComplete||e.dayComplete){console.log("üèÅ Game already completed today - showing completion view"),gameState="finished",isInteractionEnabled=!1;const t=document.getElementById("playBtn");return t&&(t.style.display="none",console.log("üö´ Play button hidden - game already completed")),setTimeout(()=>{if(window.completeView&&e.finalStats){const t=buildCompletionModelFromFinalStats(e.finalStats);window.completeView.show(t),console.log("‚úÖ Completion view shown with saved finalStats")}else{const e=buildCompletionModel(getDayStats(currentDay));window.completeView.show(e),console.warn("‚ö†Ô∏è Using fallback live data - finalStats not available")}},500),"completed"}return console.log("‚ñ∂Ô∏è Game in progress - will restore"),"in_progress"}console.log("‚ö†Ô∏è State found but game not started")}catch(t){console.error("‚ùå Failed to parse saved state:",t),localStorage.removeItem(e)}else console.log("üÜï No saved state - new game");return"new"}function cleanupOldGameStates(e){const t=[];for(let n=0;n<localStorage.length;n++){const o=localStorage.key(n);o&&o.startsWith("dailyGameState_")&&!o.includes(e)&&t.push(o)}t.forEach(e=>{localStorage.removeItem(e),console.log("üóëÔ∏è Removed old game state:",e)})}async function restoreInProgressGame(e){console.log("üîÑ Restoring in-progress game..."),console.log("üîÑ Saved state to restore:",e),isRestoringState=!0;try{if(console.log("üîÑ Step 1: Hiding initial UI..."),hideInitialGameUI(),console.log("üîÑ Step 2: Setting variables..."),currentShapeNumber=e.currentShape,currentAttemptNumber=e.currentAttempt,currentDay=e.mechanic,window.currentDay=currentDay,console.log("üîÑ Variables set - Shape:",currentShapeNumber,"Attempt:",currentAttemptNumber,"Day:",currentDay),console.log("üîÑ Step 3: Loading demo day..."),await loadDemoDay(e.mechanic),console.log("üîÑ Demo day loaded successfully"),e.currentShapeGeoJSON){currentGeoJSON=e.currentShapeGeoJSON;const t=parseGeometry(currentGeoJSON);parsedShapes=t.shapes}else await loadDemoShape(e.mechanic,e.currentShape);const t=e.cuts.filter(t=>t.shapeIndex===e.currentShape);if(t.length>0){const n=t[t.length-1];await restoreCutVisual(n),showAttemptResult(n.leftPercentage,n.rightPercentage),setTimeout(()=>{1===e.currentAttempt&&1===t.length?createProgressionButton():2===e.currentAttempt&&2===t.length&&(e.currentShape<3?createProgressionButton():setTimeout(()=>showDayStatsPopup(),1e3))},150)}else gameState="cutting",isInteractionEnabled=!0;updateProgressUI(),restoreStatsFromCuts(e.cuts)}catch(e){console.error("‚ùå Failed to restore game state:",e),initializeDemoGame()}finally{isRestoringState=!1}}async function restoreCutVisual(e){if(e)try{if(e.squareData&&window.RotatingSquareMechanic){console.log("üîÑ Restoring rotating square cut:",e.squareData),window.RotatingSquareMechanic.currentSquare=e.squareData;const t=window.RotatingSquareMechanic.calculateAreas();window.RotatingSquareMechanic.renderCutResult(t),console.log("‚úÖ Rotating square cut restored successfully")}else{if(!e.cutVector)return void console.warn("‚ö†Ô∏è No valid cut data to restore:",e);{console.log("üîÑ Restoring vector-based cut:",e.cutVector);const{leftArea:t,rightArea:n}=await performCut(e.cutVector);renderColoredCutResult(t,n),console.log("‚úÖ Vector-based cut restored successfully")}}e.commentary&&showCommentary(e.commentary,!1)}catch(e){console.error("‚ùå Failed to restore cut visual:",e)}}function restoreStatsFromCuts(e){if(e&&0!==e.length){for(let e=1;e<=7;e++)dailyStats[`day${e}`]={shape1:[],shape2:[],shape3:[]};e.forEach(e=>{const t=`day${currentDay}`,n=`shape${e.shapeIndex}`;dailyStats[t][n]||(dailyStats[t][n]=[]),dailyStats[t][n].push({score:e.score,leftPercentage:e.leftPercentage,rightPercentage:e.rightPercentage})}),console.log("üìä Stats restored from cuts")}}function showCompletedGameState(e){console.log("üèÅ Showing completed game state"),hideInitialGameUI(),showCompletionScreen(e),e.finalStats&&(dailyGameState.finalStats=e.finalStats)}function showCompletionScreen(e){ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid(),showCountdownToMidnight();const t=document.getElementById("resultsContainer");t&&(t.style.display="block",t.innerHTML='\n            <div class="completion-buttons" style="text-align: center; margin-top: 20px;">\n                <button onclick="viewTodayStats()" style="padding: 12px 24px; margin: 10px; background: #6496ff; color: white; border: none; border-radius: 6px; cursor: pointer;">\n                    View Today\'s Stats\n                </button>\n            </div>\n        ')}function hideInitialGameUI(){const e=document.getElementById("welcomeOverlay");e&&(e.style.visibility="hidden");const t=document.getElementById("initialPlayButton");t&&(t.style.visibility="hidden")}function viewTodayStats(){dailyGameState&&dailyGameState.finalStats&&(showDayStatsContent(currentDay),document.getElementById("statsOverlay").style.display="block")}function getOrCreateGuestId(){let e=localStorage.getItem("guestId");return e||(e="guest_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),localStorage.setItem("guestId",e)),e}function saveGuestState(e){const t=`dailyGameState_guest_${getOrCreateGuestId()}_${getCurrentLocalDate()}`;localStorage.setItem(t,JSON.stringify(e))}function restoreGuestState(){const e=`dailyGameState_guest_${getOrCreateGuestId()}_${getCurrentLocalDate()}`;return localStorage.getItem(e)}function checkPracticeAccess(){return!!localStorage.getItem("sb-zxrfhumifazjxgikltkz-auth-token")||(localStorage.setItem("pendingUserAction","practice"),showAuthenticationPopup(),!1)}function showCountdownToMidnight(){const e=new Date,t=new Date(e);t.setDate(t.getDate()+1),t.setHours(0,0,0,0);const n=()=>{const e=new Date,n=t-e;if(n<=0)return checkDailyReset(),void location.reload();const o=`Next puzzle in ${Math.floor(n/36e5)}h ${Math.floor(n%36e5/6e4)}m ${Math.floor(n%6e4/1e3)}s`;ctx.save(),ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid(),ctx.font="bold 24px sans-serif",ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillStyle="#333",ctx.fillText(o,190,190),ctx.restore()};n(),setInterval(n,1e3)}function resetDailyStats(){for(let e=1;e<=7;e++)dailyStats[`day${e}`]={shape1:[],shape2:[],shape3:[]};localStorage.setItem("demoGameDailyStats",JSON.stringify(dailyStats)),console.log("üìä Daily stats reset complete")}function initializeDailyReset(){const e=localStorage.getItem("lastResetDate"),t=(new Date).toDateString();e!==t?(console.log("üåÖ Initializing daily reset - new day detected"),resetDailyStats(),lastResetDate=t,localStorage.setItem("lastResetDate",t)):(lastResetDate=e,console.log("üìä Using existing daily stats (same day)")),setInterval(checkDailyReset,6e4)}window.viewTodayStats=viewTodayStats;let gameResults=[],isReplayMode=!1,replayShapeIndex=1,currentShapeIndex=1,cutsPerformed=0,firstCutVector=null,pendingQuadrants=[],maxCutsForShape3=2,isDrawingVector=!1,vectorStart=null,vectorEnd=null,currentVector=null,vectorCutActive=!1,dragDistance=0,loadingPopupElement=null,splashStartTime=null;const STORAGE_KEYS={lastPlayDate:"dailyShapes_lastPlayDate",sessionTimestamp:"dailyShapes_sessionTimestamp",gamePhase:"dailyShapes_gamePhase",playStarted:"dailyShapes_playStarted",isFinished:"dailyShapes_isFinished",currentTryNumber:"dailyShapes_currentTryNumber",hasTriedToday:"dailyShapes_hasTriedToday",tryAttempts:"dailyShapes_tryAttempts",currentCutData:"dailyShapes_currentCutData",canvasState:"dailyShapes_canvasState",displayedPercentages:"dailyShapes_displayedPercentages",finalCommittedData:"dailyShapes_finalCommittedData",gameState:"dailyShapes_gameState",attemptCount:"dailyShapes_attemptCount",currentAttempts:"dailyShapes_currentAttempts",finalScoreData:"dailyShapes_finalScoreData",currentCutState:"dailyShapes_currentCutState"};let testingMode=!1;const fallbackShape={type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:{type:"Polygon",coordinates:[[[100,100],[250,100],[250,200],[175,250],[100,200],[100,100]]]}}]};let currentMechanic=null,currentDay=1;window.currentDay=currentDay,window.setCurrentMechanic=function(e){currentMechanic=e,window.currentMechanic=e,console.log("üîß GLOBAL: Updated both local and window.currentMechanic to:",e?.name)};let currentShapeNumber=1,currentDemoAttempt=0,currentAttemptNumber=1,isDemoMode=!0;window.isDemoMode=isDemoMode,window.currentShapeNumber=currentShapeNumber,window.currentAttemptNumber=currentAttemptNumber,window.syncBulletproofVariables=function(e,t){console.log("üîÑ SYNC: Updating main.js local variables"),console.log("   From:",{currentShapeNumber:currentShapeNumber,currentAttemptNumber:currentAttemptNumber,totalCutsMade:totalCutsMade,cutsMadeThisShape:cutsMadeThisShape}),console.log("   To:",{shapeNumber:e,attemptNumber:t}),currentShapeNumber=e,currentAttemptNumber=t,window.currentShapeNumber=currentShapeNumber,window.currentAttemptNumber=currentAttemptNumber,"number"==typeof window.totalCutsMade&&(totalCutsMade=window.totalCutsMade,console.log("üîÑ SYNC: Restored totalCutsMade to",totalCutsMade)),"number"==typeof window.cutsMadeThisShape&&(cutsMadeThisShape=window.cutsMadeThisShape,console.log("üîÑ SYNC: Restored cutsMadeThisShape to",cutsMadeThisShape)),console.log("‚úÖ SYNC: All variables synchronized")};const dayMechanics={1:"DefaultWithUndoMechanic",2:"HorizontalOnlyMechanic",3:"CircleCutMechanic",4:"DiagonalAscendingMechanic",5:"ThreePointTriangleMechanic",6:"RotatingSquareMechanic",7:"RotatingShapeVectorMechanic"};function getUserFriendlyMechanicName(e){return{DefaultWithUndoMechanic:"Straight Line Cutter",HorizontalOnlyMechanic:"Locked Horizontal Cutter",DiagonalAscendingMechanic:"Locked Diagonal Cutter",CircleCutMechanic:"Circular Cutter",ThreePointTriangleMechanic:"Triangular Cutter",RotatingSquareMechanic:"Rotatable Square Cutter",RotatingShapeVectorMechanic:"Straight Line Cutter (Rotating Shape)"}[e]||e}function hideTodaysChallenge(){const e=document.getElementById("mechanicInfo");e&&(e.style.visibility="hidden")}function showInstructionArea(){const e=document.getElementById("instructionArea"),t=document.getElementById("instructionText");if(e&&t){t.textContent="",t.style.fontWeight="",t.style.textAlign="",e.style.display="flex",e.style.visibility="visible",console.log("üìù Instruction area display set to flex and visibility to visible");const n=getCurrentMechanicName(),o=getInitialInstruction(n);o?(updateInstructionText(o),console.log("‚úÖ Instruction area shown with initial instruction:",o)):console.log("‚ö†Ô∏è No initial instruction available for mechanic:",n)}}function isMobileDevice(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}function getCancellationInstruction(){return isMobileDevice()?"tap with another finger to cancel":"right-click to cancel"}function getInitialActionInstruction(){return isMobileDevice()?"Tap and hold":"Click and hold"}function getTapInstruction(){return isMobileDevice()?"Tap":"Click"}function getInitialInstruction(e){const t=isMobileDevice(),n=t?"Tap and hold":"Click and hold";return{DefaultWithUndoMechanic:`${n} to start cutting`,HorizontalOnlyMechanic:`${n} to start cutting`,CircleCutMechanic:`${n} to start cutting`,DiagonalAscendingMechanic:`${n} to start cutting`,ThreePointTriangleMechanic:`${t?"Tap":"Click"} to place first triangle corner`,RotatingSquareMechanic:`${n} to start cutting`,RotatingShapeVectorMechanic:`${n} to start cutting`}[e]||`${n} to start cutting`}function getDynamicInstruction(e,t){const n=isMobileDevice(),o=n?"Tap and hold":"Click and hold",a=n?"Tap":"Click",i=`Drag and release to cut. ${n?"Tap with another finger":"Right-click"} to start again.`,r={DefaultWithUndoMechanic:{initial:`${o} to start cutting`,first_touch:i,completed:`${o} to start cutting`},HorizontalOnlyMechanic:{initial:`${o} to start cutting`,first_touch:i,completed:`${o} to start cutting`},CircleCutMechanic:{initial:`${o} to start cutting`,first_touch:i,completed:`${o} to start cutting`},DiagonalAscendingMechanic:{initial:`${o} to start cutting`,first_touch:i,completed:`${o} to start cutting`},ThreePointTriangleMechanic:{initial:`${a} to place first triangle corner`,first_tap:`${a} to place second triangle corner`,second_tap:`${a} to place third triangle corner`,third_tap:`Drag corners to adjust, then ${a.toLowerCase()} inside to cut`},RotatingSquareMechanic:{initial:`${o} to start cutting`,first_touch:i,completed:`${o} to start cutting`},RotatingShapeVectorMechanic:{initial:`${o} to start cutting`,first_touch:i,completed:`${o} to start cutting`}}[e];return r&&r[t]?r[t]:"initial"===t||window.isPracticeMode&&"completed"===t?`${holdAction} to start cutting (${getCancellationInstruction()})`:"completed"===t?`${holdAction} to start cutting`:"Complete your cut"}function updateInstructionText(e,t=!1){const n=document.getElementById("instructionText");if(!n)return void console.warn("‚ö†Ô∏è Instruction text element not found");n.textContent=e,t?(n.style.fontWeight="bold",n.style.textAlign="center"):(n.style.fontWeight="normal",n.style.textAlign="center"),n.style.opacity="1",n.style.display="block",n.style.visibility="visible";const o=window.isPracticeMode?"Practice":"Daily";console.log(`üìù ${o} mode instruction updated:`,e,"isBold:",t)}function resetInstructionsToInitial(){updateInstructionText(getInitialInstruction(isPracticeMode?getPracticeMechanicName():getCurrentMechanicName()))}function getCurrentMechanicName(){return{1:"DefaultWithUndoMechanic",2:"HorizontalOnlyMechanic",3:"DiagonalAscendingMechanic",4:"CircleCutMechanic",5:"ThreePointTriangleMechanic",6:"RotatingSquareMechanic",7:"RotatingShapeVectorMechanic"}[currentDay]||"DefaultWithUndoMechanic"}function getPracticeMechanicName(){return{1:"DefaultWithUndoMechanic",2:"HorizontalOnlyMechanic",3:"CircleCutMechanic",4:"DiagonalAscendingMechanic",5:"ThreePointTriangleMechanic",6:"RotatingSquareMechanic",7:"DefaultWithUndoMechanic"}[currentDay]||"DefaultWithUndoMechanic"}function saveDemoGameState(){try{const e={currentDay:currentDay,currentShapeNumber:currentShapeNumber,currentAttemptNumber:currentAttemptNumber,gameStarted:"initial"!==gameState,gameStateValue:gameState,isInteractionEnabled:isInteractionEnabled,totalCutsMade:window.totalCutsMade||0,cutsMadeThisShape:window.cutsMadeThisShape||0,currentAttempts:currentAttempts||[],mechanicName:currentMechanic?.name||null,canvasDataURL:null,leftPercentage:currentAttempts.length>0?currentAttempts[currentAttempts.length-1].leftPercentage:document.getElementById("leftPercentage")?.textContent||null,rightPercentage:currentAttempts.length>0?currentAttempts[currentAttempts.length-1].rightPercentage:document.getElementById("rightPercentage")?.textContent||null,hasProgressButton:!!document.getElementById("progressionButton"),welcomeScreenVisible:!!document.querySelector(".welcome-overlay:not(.hidden)"),dayComplete:dailyGameState?.dayComplete||!1,isGameComplete:dailyGameState?.isGameComplete||!1,completedAt:dailyGameState?.completedAt||null,finalStats:dailyGameState?.finalStats||null,timestamp:Date.now()},t=document.getElementById("geoCanvas");if(t&&parsedShapes&&parsedShapes.length>0)try{window.canceledLineDrawing?(console.log("üö´ Skipping canvas capture due to recent cancel - preventing corrupted state save"),e.canvasDataURL=null):window.skipCanvasCaptureAfterShapeTransition?(console.log("üö´ Skipping canvas capture after shape transition - preventing shaded state persistence"),e.canvasDataURL=null):"results"===gameState||"finished"===gameState||"locked"===gameState?(console.log("üö´ Skipping canvas capture during end-game phase"),e.canvasDataURL=null):(e.canvasDataURL=t.toDataURL(),console.log("üì∏ Canvas state captured for restoration (gameState: "+gameState+", length:",e.canvasDataURL.length,")"))}catch(t){console.warn("‚ö†Ô∏è Could not capture canvas state:",t),e.canvasDataURL=null}else console.log("üì∏ No canvas state to capture - canvas:",!!t,"shapes:",parsedShapes?.length||0);localStorage.setItem("dailyGameState_demo",JSON.stringify(e)),window.SimpleRefresh&&window.SimpleRefresh.save&&window.SimpleRefresh.save(),console.log("üíæ Demo game state saved:",{day:e.currentDay,shape:e.currentShapeNumber,attempt:e.currentAttemptNumber,cuts:e.totalCutsMade,gameStarted:e.gameStarted}),window.SimpleGameRefresh&&window.SimpleGameRefresh.save&&window.SimpleGameRefresh.save()}catch(e){console.warn("‚ö†Ô∏è Could not save demo game state:",e)}}async function initializeSupabaseGameMode(){try{if(console.log("üîó Starting Supabase Game Mode initialization..."),window.isPracticeMode=!1,window.isDailyMode=!0,console.log("üîÑ Ensured daily mode flags are set for Supabase initialization"),hideCommentary(),window.AuthService&&!window.AuthService.initialized&&(console.log("üîê Initializing AuthService..."),await window.AuthService.initialize(),console.log("‚úÖ AuthService initialized, isLoggedIn:",window.AuthService.isLoggedIn())),window.UserAccountManager&&!window.UserAccountManager.initialized&&(console.log("üë§ Initializing UserAccountManager..."),await window.UserAccountManager.initialize(),console.log("‚úÖ UserAccountManager initialized")),window.AuthService&&window.AuthService.isLoggedIn()&&await syncServerCompletionState(),dailyGameState||initializeDailyGameState(),initializeDailyReset(),canvas=document.getElementById("geoCanvas"),!canvas)throw new Error("Canvas element not found");if(ctx=setupCanvasForCrispRendering(canvas),!ctx)throw new Error("Could not get 2D context from canvas");console.log("‚úÖ Canvas setup complete"),setupDemoEventListeners(),gameState="initial",isInteractionEnabled=!1,maxAttempts=2;const e=(new Date).getDay();currentDay=0===e?7:e,window.currentDay=currentDay,currentShapeNumber=1,currentAttemptNumber=1,window.currentShapeNumber=currentShapeNumber,window.currentAttemptNumber=currentAttemptNumber,console.log(`üìÖ Current day: ${currentDay} (${["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][7===currentDay?0:currentDay]})`);let t=window.SimpleRefresh&&window.SimpleRefresh.restore&&window.SimpleRefresh.restore();if(t){const e=t.currentDay||t.day;if(e&&e!==currentDay){console.log(`‚ö†Ô∏è Saved game is from day ${e}, but current day is ${currentDay}. Clearing old state.`);const n=`demo_completed_day_${e}`;localStorage.removeItem(n),console.log(`üóëÔ∏è Cleared old demo flag: ${n}`),window.SimpleRefresh.clear(),t=null}else console.log(`‚úÖ Saved game validated - same day of week (day ${currentDay})`)}if(console.log("üîç Supabase init: hasActiveGame result:",!!t),t){hideLoadingAnimation(),console.log("üîÑ Skipping welcome screen in Supabase init - will restore saved game state later");const e=document.getElementById("welcomeOverlay");e&&(e.style.visibility="hidden")}else window.stopImmediateLoadingAnimation?window.stopImmediateLoadingAnimation(showWelcomeScreen):(hideLoadingAnimation(),showWelcomeScreen());createProgressUI(),setupEventListeners(),console.log("üîó Supabase Game Mode initialized - checking for shapes from integration");const n=async()=>{if(console.log("üéØ Supabase shapes ready - initializing DailyGameCore"),window.DailyGameCore)try{console.log("üîÑ Initializing DailyGameCore to load Supabase shapes..."),await window.DailyGameCore.initialize(),console.log("‚úÖ DailyGameCore initialized with Supabase shapes");window.DailyGameCore.getShapeData(1)?console.log("‚úÖ Shape 1 is now available from DailyGameCore"):console.error("‚ùå Shape 1 still not available after DailyGameCore initialization")}catch(e){console.error("‚ùå Failed to initialize DailyGameCore:",e)}const e=dayMechanics[currentDay];e&&(loadDemoMechanic(e,!1),console.log(`üîß Loaded mechanic: ${e}`)),console.log("‚úÖ Supabase integration with game engine complete"),console.log("üîµ Shapes loaded - initializing animated menu..."),initializeAnimatedMenu(),window.isRestoringGameState&&window.pendingCanvasRestoration&&(console.log("üîÑ Triggering delayed canvas restoration after Supabase init"),setTimeout(()=>{if(window.pendingCanvasRestoration&&window.canvas&&window.ctx){console.log("üé® Restoring canvas state with cut shading (Supabase flow)");const e=new Image;e.onload=function(){if(window.ctx.clearRect(0,0,window.canvas.width,window.canvas.height),window.ctx.drawImage(e,0,0),console.log("‚úÖ Canvas state with cut shading restored (Supabase flow)"),window.currentAttempts&&window.currentAttempts.length>0){const e=window.currentAttempts[window.currentAttempts.length-1];e&&void 0!==e.leftPercentage&&(console.log("üîÑ Restoring percentage display:",e.leftPercentage,"/",e.rightPercentage),window.showAttemptResult&&window.showAttemptResult(e.leftPercentage,e.rightPercentage))}window.pendingCanvasRestoration=null,window.isRestoringGameState=!1,console.log("üîÑ Cleared isRestoringGameState flag - restoration complete (Supabase flow)"),currentMechanic&&"Rotating Shape Vector Cut"===currentMechanic.name&&"function"==typeof currentMechanic.startRotation&&!currentMechanic.isRotating&&(console.log("üîÑ Starting rotation after canvas restoration (Supabase flow)"),currentMechanic.startRotation())},e.src=window.pendingCanvasRestoration}},300)),setTimeout(()=>{menuState.isInitialized||(console.log("üîµ Menu not initialized yet, trying fallback initialization..."),initializeAnimatedMenu())},1e3)};console.log("‚è≥ Waiting for Supabase shapes to be loaded...");let o=0;const a=100,i=async()=>{for(;o<a;){if(window.dailyModeManager&&window.dailyModeManager.shapes&&window.dailyModeManager.shapes.length>=3)return console.log("‚úÖ Supabase shapes are ready - initializing DailyGameCore"),void await n();o++,await new Promise(e=>setTimeout(e,100))}console.log("‚ö†Ô∏è Timeout waiting for Supabase shapes - proceeding anyway")};window.addEventListener("dailyShapesReady",n),i(),window.updateDateTitle&&"function"==typeof window.updateDateTitle?(window.updateDateTitle(),console.log("üîÑ Supabase init: Header title formatted properly")):console.log("‚ö†Ô∏è Supabase init: updateDateTitle not available yet"),document.body.classList.add("ready")}catch(e){console.error("‚ùå Supabase Game Mode initialization failed:",e),hideLoadingAnimation(),console.log("üîÑ Falling back to demo mode"),await initializeDemoGame()}}async function initializeDemoGame(){try{if(console.log("üéÆ Starting Demo Game initialization..."),localStorage.setItem("dailyShapes_demoMode","true"),hideCommentary(),window.AuthService&&!window.AuthService.initialized&&(console.log("üîê Initializing AuthService..."),await window.AuthService.initialize(),console.log("‚úÖ AuthService initialized, isLoggedIn:",window.AuthService.isLoggedIn())),window.UserAccountManager&&!window.UserAccountManager.initialized&&(console.log("üë§ Initializing UserAccountManager..."),await window.UserAccountManager.initialize(),console.log("‚úÖ UserAccountManager initialized")),dailyGameState||initializeDailyGameState(),initializeDailyReset(),canvas=document.getElementById("geoCanvas"),!canvas)throw new Error("Canvas element not found");if(ctx=setupCanvasForCrispRendering(canvas),!ctx)throw new Error("Could not get 2D context from canvas");drawGrid(),console.log("‚úÖ Canvas setup complete"),setupDemoEventListeners();"true"===localStorage.getItem("dailyShapes_practiceMode")?(isPracticeMode=!0,window.isPracticeMode=!0,isPractiseMode=!0,isDailyMode=!1,console.log("üéÆ Initializing in practice mode - unlimited cuts allowed")):(isPracticeMode=!1,window.isPracticeMode=!1,isPractiseMode=!1,isDailyMode=!1,console.log("üéØ Initializing in demo mode - 2-cut restriction enabled")),gameState="initial",isInteractionEnabled=!1,maxAttempts=2,currentDay=1,window.currentDay=currentDay,currentShapeNumber=1,currentAttemptNumber=1,window.currentShapeNumber=currentShapeNumber,window.currentAttemptNumber=currentAttemptNumber;Object.keys(localStorage).filter(e=>e.startsWith("dailyGameState_2025-")||e.includes("bulletproof")).forEach(e=>{console.log("üßπ Clearing conflicting refresh data:",e),localStorage.removeItem(e)});const e=(new Date).getDay(),t=0===e?7:e;currentDay=t,window.currentDay=currentDay,console.log("üîÑ Checking for saved game state to restore...");const n=localStorage.getItem("dailyGameState_demo");let o=null;if(console.log("üîç DEBUG: savedGameState exists:",!!n),console.log("üîç DEBUG: currentDemoDay:",t),n)try{o=JSON.parse(n),console.log("üîç DEBUG: parsed state:",{currentDay:o.currentDay,currentShapeNumber:o.currentShapeNumber,gameStarted:o.gameStarted,currentDemoDay:t}),o.currentDay===t&&o.currentShapeNumber?(console.log("üîÑ Restoring saved demo state - Day:",o.currentDay,"Shape:",o.currentShapeNumber,"Attempt:",o.currentAttemptNumber),currentDay=o.currentDay,window.currentDay=currentDay,currentShapeNumber=o.currentShapeNumber,currentAttemptNumber=o.currentAttemptNumber||1,o.gameStarted&&(setGameState(o.gameStateValue||"playing"),setInteractionEnabled(o.isInteractionEnabled||!1),window.totalCutsMade=o.totalCutsMade||0,window.cutsMadeThisShape=o.cutsMadeThisShape||0,o.currentAttempts&&(currentAttempts=o.currentAttempts),console.log("üìä Restored game progress - cuts:",window.totalCutsMade,"thisShape:",window.cutsMadeThisShape),window.restoreGameState=!0,document.body.classList.add("restoring")),window.currentShapeNumber=currentShapeNumber,window.currentAttemptNumber=currentAttemptNumber):(console.log("üÜï New day detected - starting fresh for day",t),currentDay=t,window.currentDay=currentDay)}catch(e){console.log("‚ö†Ô∏è Invalid saved state, using current day"),currentDay=t,window.currentDay=currentDay}else currentDay=t,window.currentDay=currentDay;console.log(`üìÖ Demo day: ${t} (${["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][7===t?0:t]})`);let a=null;window.SimpleRefresh&&window.SimpleRefresh.restore&&(a=window.SimpleRefresh.restore(),console.log("üîÑ SimpleRefresh.restore() called, result:",!!a));let i=!1;if(a&&(i=a.isGameStarted,console.log("üîç DEBUG: hasActiveGame from restored state:",i,{isGameStarted:a.isGameStarted,currentDay:a.currentDay,currentShape:a.currentShape,currentAttempt:a.currentAttempt,dayComplete:a.dayComplete})),console.log("üîç DEBUG: hasActiveGame result:",i),window.restoreGameState||i){hideLoadingAnimation(),console.log("üîÑ Skipping welcome screen - restoring saved game state (restoreGameState:",!!window.restoreGameState,"hasActiveGame:",i,")");const e=document.getElementById("welcomeOverlay");e&&(e.style.visibility="hidden"),hideInitialWelcomeButtons()}else window.stopImmediateLoadingAnimation?window.stopImmediateLoadingAnimation(showWelcomeScreen):(hideLoadingAnimation(),showWelcomeScreen());createProgressUI(),console.log("üîß Setting up event listeners..."),setupEventListeners(),console.log("üéÆ Initial demo state: Shape",currentShapeNumber,", Attempt",currentAttemptNumber),console.log("üéÆ Demo Game initialized successfully"),console.log("üîµ Demo game loaded - initializing animated menu..."),initializeAnimatedMenu(),setTimeout(()=>{menuState.isInitialized||(console.log("üîµ Menu not initialized yet, trying demo fallback initialization..."),initializeAnimatedMenu())},1e3),window.updateDateTitle&&"function"==typeof window.updateDateTitle?(window.updateDateTitle(),console.log("üîÑ Demo init: Header title formatted properly")):console.log("‚ö†Ô∏è Demo init: updateDateTitle not available yet"),window.restoreGameState||setTimeout(()=>{document.body.classList.add("ready")},50),window.restoreGameState&&(console.log("üîÑ Completing game state restoration..."),setTimeout(async()=>{const e=document.querySelector(".welcome-overlay");e&&(e.style.visibility="hidden"),hideInitialWelcomeButtons(),console.log("üîÑ Welcome buttons hidden during state restoration");const t=o||JSON.parse(localStorage.getItem("dailyGameState_demo")||"{}");loadDemoMechanic(dayMechanics[currentDay]);const n=window.totalCutsMade,a=window.cutsMadeThisShape,i=t.currentAttempts||[];await loadDemoShape(currentDay,t.currentShapeNumber),window.totalCutsMade=n,window.cutsMadeThisShape=a,totalCutsMade=n,cutsMadeThisShape=a,currentAttempts=i,attemptCount=i.length,currentAttemptNumber=t.currentAttemptNumber,window.currentAttemptNumber=currentAttemptNumber,window.cutsMadeThisShape>0&&window.cutsMadeThisShape<2&&1===currentAttemptNumber?(setGameState("awaiting_choice"),setInteractionEnabled(!1),console.log('üîÑ First attempt done, awaiting "Next Attempt" button')):window.cutsMadeThisShape>0&&window.cutsMadeThisShape<2&&2===currentAttemptNumber?(setGameState("cutting"),setInteractionEnabled(!0),console.log("üîÑ Ready for second attempt - fresh uncut shape")):window.cutsMadeThisShape>=2?(setGameState("awaiting_choice"),setInteractionEnabled(!1),console.log("üîÑ Both attempts done, awaiting shape progression")):(setGameState("cutting"),setInteractionEnabled(!0),console.log("üîÑ Enabled canvas interaction for fresh shape (no cuts made)")),console.log("üîÑ Restored game state:",gameState,"interaction enabled:",isInteractionEnabled),console.log("üîÑ Restored cut counters - total:",window.totalCutsMade,"thisShape:",window.cutsMadeThisShape);if(t&&t.canvasDataURL&&!(window.cutsMadeThisShape>0&&2===currentAttemptNumber)){console.log("üîÑ Preparing to restore canvas state..."),console.log("üîÑ Canvas data URL length:",t.canvasDataURL.length);const e=()=>{const n=document.getElementById("geoCanvas"),o=n?.getContext("2d");if(n&&o&&parsedShapes&&parsedShapes.length>0){const e=new Image;e.onload=function(){if(window.canceledLineDrawing)console.log("üö´ Skipping canvas restoration due to recent cancel - preventing visual corruption");else if(console.log("üé® Restoring canvas: drawing saved cut state over current canvas..."),o.drawImage(e,0,0),console.log("‚úÖ Canvas state restored successfully from saved data"),window.cutsMadeThisShape>0&&t){const e=window.completeView&&"function"==typeof window.completeView.isActive&&window.completeView.isActive(),n=window.RefreshProtection&&window.RefreshProtection.isGameCompleted()||window.dailyGameState&&(window.dailyGameState.dayComplete||window.dailyGameState.isGameComplete);if(e||n)return void console.log("üéÆ Completion state active during restoration - skipping percentage display restoration to prevent flash");const o=document.getElementById("percentageDisplay");if(o&&(o.style.display="none"),t.leftPercentage&&t.rightPercentage&&"-"!==t.leftPercentage&&"-"!==t.rightPercentage){const e=document.getElementById("resultsContainer");if(e){e.querySelectorAll(".attempt-result").forEach(e=>e.remove());const n="number"==typeof t.leftPercentage?t.leftPercentage:parseFloat(t.leftPercentage),o="number"==typeof t.rightPercentage?t.rightPercentage:parseFloat(t.rightPercentage);createNewAttemptResult(n,o),console.log("üìä Restored percentages using proper format:",n,o)}}}},e.onerror=function(){console.error("‚ùå Failed to load saved canvas image")},e.src=t.canvasDataURL}else setTimeout(e,50)};setTimeout(e,200)}else t&&t.canvasDataURL&&2===currentAttemptNumber?console.log("üîÑ Canvas restoration SKIPPED - user is on attempt 2 and needs fresh uncut shape"):console.log("üîÑ No canvas data to restore"),(0===window.cutsMadeThisShape&&"cutting"===gameState||2===currentAttemptNumber&&"cutting"===gameState)&&setTimeout(()=>{const e=document.getElementById("geoCanvas");e&&(e.style.pointerEvents="auto",console.log("üîß ACTIVATED: Canvas pointer-events set to auto for fresh shape after restoration"))},100);if(currentMechanic&&(console.log("üîÑ Setting up mechanics event listeners after restoration"),setupMechanicsEventListeners()),setTimeout(()=>{if("cutting"===gameState&&isInteractionEnabled){const e=document.getElementById("geoCanvas");e&&(e.style.pointerEvents="auto",console.log("üîß FINAL CHECK: Canvas activation confirmed for cutting state"))}},200),window.cutsMadeThisShape>0){const e=window.cutsMadeThisShape;currentAttemptNumber=e,window.currentAttemptNumber=currentAttemptNumber,console.log("üîÑ Adjusted attempt number to match cuts made:",currentAttemptNumber),createProgressionButton()}updateProgressUI(),"function"!=typeof redrawCanvas||t&&t.canvasDataURL?t&&t.canvasDataURL&&console.log("üé® Skipped redrawCanvas to preserve restored canvas state"):(redrawCanvas(),console.log("üé® Called redrawCanvas (no saved canvas state to restore)")),console.log("üìä Final restored state - Shape:",currentShapeNumber,"Attempt:",currentAttemptNumber,"Cuts:",window.cutsMadeThisShape);const r=t&&(t.dayComplete||t.isGameComplete),s=dailyGameState&&(dailyGameState.dayComplete||dailyGameState.isGameComplete),c=`dailyGameState_${getCurrentLocalDate()}`;let l=!1;try{const e=localStorage.getItem(c);if(e){const t=JSON.parse(e);l=t.dayComplete||t.isGameComplete}}catch(e){console.warn("Could not parse localStorage state for completion check")}const d=r||s||l;t&&t.gameStarted&&!d?setTimeout(()=>{0},200):d&&(console.log("‚úÖ Day complete detected - suppressing welcome back popup"),console.log("‚úÖ Sources - savedState:",r,"dailyState:",s,"localStorage:",l)),console.log("‚úÖ Game state restoration completed"),document.body.classList.remove("restoring"),document.body.classList.add("ready"),window.restoreGameState=!1},100)),window.handleCutAttempt=handleCutAttempt,window.isDemoMode=isDemoMode,window.CompetitionManager&&window.CompetitionUI&&setTimeout(async()=>{try{console.log("üèÜ Initializing competition system..."),await window.CompetitionManager.initialize(),window.CompetitionUI.initialize();const e=window.CompetitionManager?.parseJoinLink();if(e){console.log("üîó Join link detected on page load:",e);const t=()=>new Promise(e=>{const t=()=>{window.AuthService&&window.AuthService.initialized?(console.log("‚úÖ AuthService ready for competition join modal"),e()):(console.log("‚è≥ Waiting for AuthService to initialize..."),setTimeout(t,100))};t()});await t();const n=window.AuthService.isLoggedIn();if(console.log("üîç Auth status for competition join:",{isLoggedIn:n,isGuest:window.AuthService.isGuest,userId:window.AuthService.currentUser?.id}),n){console.log("üîÑ User already logged in, attempting auto-join to competition");try{const t=await window.CompetitionManager.joinCompetition(e,window.AuthService.currentUser.id);t&&t.success?(console.log("‚úÖ Auto-joined competition successfully"),setTimeout(()=>{openCompetitionModal()},500)):(console.log("‚ö†Ô∏è Auto-join failed, showing manual join modal"),showJoinCompetitionModal(e))}catch(t){console.error("‚ùå Error auto-joining competition:",t),showJoinCompetitionModal(e)}}else console.log("üîë User not logged in, storing competition ID and showing join modal"),sessionStorage.setItem("pendingJoinCompetitionId",e),showJoinCompetitionModal(e)}else window.AuthService?.currentUser&&await window.CompetitionManager.autoJoinGlobalCompetition(window.AuthService.currentUser.id);console.log("‚úÖ Competition system initialized successfully")}catch(e){console.warn("‚ö†Ô∏è Competition system initialization failed:",e)}setTimeout(()=>{console.log("üîÑ Final button state update check");const e=localStorage.getItem("sb-zxrfhumifazjxgikltkz-auth-token"),t=localStorage.getItem("userAuthToken");console.log("üîç Direct localStorage check at final update:",{supabaseToken:!!e,userAuthToken:!!t}),e||t?(console.log("‚úÖ Tokens found - forcing button enable"),"function"==typeof updateButtonStates&&updateButtonStates()):"function"==typeof updateButtonStates&&updateButtonStates()},3e3)},2e3)}catch(e){console.error("üí• Error initializing Demo Game:",e)}}function showWelcomeScreen(){console.log("üéÆ Showing welcome screen");const e=document.getElementById("welcomeOverlay");e&&(e.style.visibility="visible");const t=document.getElementById("todaysMechanic"),n=document.getElementById("mechanicWelcomeText");if(t){const e={1:"Straight Line Cutter",2:"Horizontal Line Cutter",3:"Circle Cutter",4:"Diagonal Line Cutter",5:"Triangle Cutter",6:"Rotating Square Cutter",7:"Straight Line Cutter"}[currentDay]||"Loading...";t.textContent=e,t.style.color="#6496FF",n&&7===currentDay&&(n.innerHTML='Today you\'re using the <strong style="color: #6496FF;">Straight Line Cutter</strong> on <strong style="color: #6496FF;">spinning shapes</strong>. Follow tips above the grid.')}const o=document.getElementById("playBtn");if(o){o.style.display="block";const e=document.getElementById("initialPlayButton");e&&(e.style.visibility="visible")}canvas&&ctx&&(canvas.style.display="block",ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid())}function showSignInReminderModal(){const e=document.createElement("div");e.id="signInReminderModal",e.className="auth-modal",e.style.display="flex",e.style.zIndex="10001",e.innerHTML='\n        <div class="auth-modal-content" style="border-radius: 12px !important;">\n            <div class="auth-modal-body">\n                <p style="text-align: center; margin: 16px 0; line-height: 1.4; font-size: 14px;">\n                    Don\'t forget to sign in to your account if you\'re currently playing in a competition\n                </p>\n                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 16px;">\n                    <button class="auth-submit-button" onclick="openSignInFromReminder()">\n                        Sign In\n                    </button>\n                    <button class="cancel-btn" onclick="proceedWithoutSignIn()" style="background: #6c757d; border: 2px solid #6c757d;">\n                        No Thanks\n                    </button>\n                </div>\n            </div>\n        </div>\n    ',document.body.appendChild(e),document.body.classList.add("modal-open")}function closeSignInReminderModal(){const e=document.getElementById("signInReminderModal");e&&(e.remove(),document.body.classList.remove("modal-open"))}function openSignInFromReminder(){closeSignInReminderModal(),sessionStorage.setItem("signInFromPlay","true"),window.openAuthModal&&window.openAuthModal("login")}function proceedWithoutSignIn(){closeSignInReminderModal(),continuePlayButtonClick()}async function checkIfUserHasPlayedToday(){if(!window.SupabaseConfig?.isReady()||!window.AuthService?.currentUser?.id)return!1;try{const e=(new Date).toISOString().split("T")[0],{data:t,error:n}=await window.SupabaseConfig.client.from("user_daily_progress").select("completed").eq("user_id",window.AuthService.currentUser.id).eq("date",e).single();return n&&"PGRST116"!==n.code?(console.error("Error checking daily progress:",n),!1):!0===t?.completed}catch(e){return console.error("Error checking if user has played today:",e),!1}}async function syncServerCompletionState(){if(window.SupabaseConfig?.isReady()&&window.AuthService?.currentUser?.id)try{const e=(new Date).toISOString().split("T")[0],t=getCurrentLocalDate();console.log("üîÑ Syncing server completion state for:",e);const{data:n,error:o}=await window.SupabaseConfig.client.from("user_daily_progress").select("*").eq("user_id",window.AuthService.currentUser.id).eq("date",e).single();if(o&&"PGRST116"!==o.code)return void console.error("Error fetching server completion state:",o);if(n&&n.completed){console.log("‚úÖ Server shows game completed - syncing to localStorage");const e=`dailyGameState_${t}`,n={isGameStarted:!0,isGameComplete:!0,dayComplete:!0,currentShape:4,currentAttempt:1,cuts:[],mechanic:currentDay,date:t,timestamp:Date.now(),syncedFromServer:!0,totalCutsMade:6};localStorage.setItem(e,JSON.stringify(n)),console.log("üíæ Saved completed state to localStorage from server"),window.SimpleRefresh&&window.SimpleRefresh.saveState&&(window.SimpleRefresh.saveState(n),console.log("üíæ Saved completed state to SimpleRefresh from server")),dailyGameState=n}else console.log("üìù No completed game found on server for today")}catch(e){console.error("Error syncing server completion state:",e)}}function showAlreadyPlayedModal(){const e=document.createElement("div");e.id="alreadyPlayedModal",e.className="auth-modal",e.style.display="flex",e.style.zIndex="10001",e.innerHTML='\n        <div class="auth-modal-content" style="border-radius: 12px !important;">\n            <div class="auth-modal-header">\n                <h2>Already Completed Today! üéâ</h2>\n                <button class="auth-modal-close" onclick="closeAlreadyPlayedModal()">&times;</button>\n            </div>\n            <div class="auth-modal-body">\n                <p style="text-align: center; margin: 16px 0; line-height: 1.4; font-size: 14px;">\n                    You\'ve already completed today\'s Daily Shapes challenge!\n                </p>\n                <p style="text-align: center; margin: 16px 0; line-height: 1.4; font-size: 14px;">\n                    Come back tomorrow for a new puzzle, or try Practice Mode to keep playing.\n                </p>\n                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 16px;">\n                    <button class="auth-submit-button" onclick="openPracticeModeFromAlreadyPlayed()">\n                        Try Practice Mode\n                    </button>\n                    <button class="cancel-btn" onclick="closeAlreadyPlayedModal()" style="background: #6c757d; border: 2px solid #6c757d;">\n                        Close\n                    </button>\n                </div>\n            </div>\n        </div>\n    ',document.body.appendChild(e),document.body.classList.add("modal-open")}function closeAlreadyPlayedModal(){const e=document.getElementById("alreadyPlayedModal");e&&(e.remove(),document.body.classList.remove("modal-open"))}function openPracticeModeFromAlreadyPlayed(){closeAlreadyPlayedModal(),window.PracticeMode&&window.PracticeMode.start&&window.PracticeMode.start()}function continuePlayButtonClick(){window.isPracticeMode&&window.PracticeMode&&window.PracticeMode.close&&(console.log("üîö Closing practice mode before starting daily mode"),window.PracticeMode.close()),localStorage.setItem("dailyShapes_demoMode","true"),window.SimpleRefresh&&window.SimpleRefresh.clear&&window.SimpleRefresh.clear(),localStorage.removeItem("dailyGameState_demo"),dailyGameState||initializeDailyGameState(),dailyGameState.isGameStarted=!0,hideTodaysChallenge(),showInstructionArea();const e=document.getElementById("demoProgressDisplay");e&&(e.style.setProperty("visibility","visible","important"),e.style.setProperty("display","block","important"),e.style.setProperty("opacity","1","important"),console.log("üìä Progress display forcibly shown in play button handler"));const t=document.getElementById("welcomeOverlay");t?(t.style.visibility="hidden",console.log("‚úÖ Welcome overlay hidden")):console.error("‚ùå Welcome overlay not found!"),hidePlayButton(),console.log("üéÆ About to call startGame()..."),startGame()}async function handlePlayButtonClick(){if(dailyGameState&&(dailyGameState.isGameComplete||dailyGameState.dayComplete))return console.log("üö´ Game already completed today - play button blocked"),void(window.playButtonClicked=!1);if("finished"===gameState)return console.log("üö´ Game is finished - play button blocked"),void(window.playButtonClicked=!1);if(window.playButtonClicked)return void console.log("‚ö†Ô∏è Play button already clicked - ignoring duplicate");window.playButtonClicked=!0,setTimeout(()=>{window.playButtonClicked=!1},2e3);const e=window.AuthService&&window.AuthService.isLoggedIn();if(console.log("üîê Play button - checking auth status:",{AuthService:!!window.AuthService,isLoggedIn:e,gameState:gameState}),!e&&"initial"===gameState)return console.log("üë§ User not logged in - showing sign-in reminder modal"),showSignInReminderModal(),void(window.playButtonClicked=!1);if(e&&"initial"===gameState){if(await checkIfUserHasPlayedToday())return console.log("üö´ User has already completed today's game"),showAlreadyPlayedModal(),void(window.playButtonClicked=!1)}continuePlayButtonClick()}function calculateScore(e,t){const n=Math.abs(e-50),o=Math.abs(t-50);if(n<=.05&&o<=.05)return 100;const a=(n+o)/2,i=Math.max(0,100-2*a);return Math.round(10*i)/10}function getCommentary(e,t){const n=calculateScore(e,t);return 100===n?"PERFECT CUT! üéØ":n>=95?"Amazing! üåü":n>=90?"Excellent! üëè":n>=85?"Great job! üëç":n>=80?"Nice cut! ‚ú®":n>=75?"Good effort! üí™":n>=70?"Not bad! üéØ":n>=60?"Keep trying! üí´":"Try again! üîÑ"}function recordAttemptScore(e,t,n,o){const a=calculateScore(n,o),i=`day${e}`,r=`shape${t}`;dailyStats[i]||(dailyStats[i]={shape1:[],shape2:[],shape3:[]}),dailyStats[i][r]||(dailyStats[i][r]=[]);const s={score:a,leftPercentage:Math.round(10*n)/10,rightPercentage:Math.round(10*o)/10};return dailyStats[i][r].push(s),localStorage.setItem("demoGameDailyStats",JSON.stringify(dailyStats)),console.log(`üìä STATS: Recorded score ${a} (${s.leftPercentage}%/${s.rightPercentage}%) for Day ${e}, Shape ${t}`),console.log(`üìä STATS: Current stats for ${i}.${r}:`,dailyStats[i][r]),a}function clearStatsForDay(e){const t=`day${e}`;dailyStats[t]&&(dailyStats[t]={shape1:[],shape2:[],shape3:[]},console.log(`üìä STATS: Cleared all stats for Day ${e}`))}function getDayStats(e){return dailyStats[`day${e}`]||{shape1:[],shape2:[],shape3:[]}}function calculateDayAverage(e){const t=getDayStats(e),n=[];if(["shape1","shape2","shape3"].forEach(e=>{t[e]&&t[e].length>0&&t[e].forEach(e=>{const t="number"==typeof e?e:e.score;n.push(t)})}),0===n.length)return 0;const o=n.reduce((e,t)=>e+t,0)/n.length;return console.log("üìä STANDARD scoring calculation for completion screen:"),console.log(`   All cut scores: [${n.join(", ")}]`),console.log(`   Standard average: ${o.toFixed(1)}`),Math.round(10*o)/10}function getAllScoresForDay(e){const t=getDayStats(e),n=[];return["shape1","shape2","shape3"].forEach(e=>{(t[e]||[]).forEach(e=>{const t="number"==typeof e?e:e.score;n.push(t)})}),n}function getShapeAveragesForDay(e){const t=getDayStats(e),n=[];return["shape1","shape2","shape3"].forEach(e=>{const o=t[e]||[];if(o.length>0){let e=0;o.forEach(t=>{const n="number"==typeof t?t:t.score;e+=n}),n.push(Math.round(e/o.length*10)/10)}else n.push(0)}),n}async function showDayStatsPopup(){console.log("üìä Day completed - showing completion view..."),gameState="finished",updateProgressUI();const e=getDayStats(currentDay);let t=!1;for(const n of["shape1","shape2","shape3"])if(e[n]&&e[n].length>0){t=!0;break}if(dailyGameState&&(dailyGameState.isGameComplete=!0,dailyGameState.dayComplete=!0,dailyGameState.completedAt=Date.now(),dailyGameState.finalStats={allScores:getAllScoresForDay(currentDay),shapeAverages:getShapeAveragesForDay(currentDay),dailyAverage:calculateDayAverage(currentDay),completedAt:Date.now()}),window.RefreshProtection){const e={allScores:getAllScoresForDay(currentDay),shapeAverages:getShapeAveragesForDay(currentDay),dailyAverage:calculateDayAverage(currentDay),completedAt:Date.now()};window.RefreshProtection.saveGameCompletion(e)}if(saveDemoGameState(),!isPracticeMode&&window.AuthService&&window.AuthService.isLoggedIn())try{const e=getDayStats(currentDay),t={};for(let n=1;n<=3;n++){const o=`shape${n}`,a=e[o]||[];t[o]={attempt1:a[0]?"number"==typeof a[0]?a[0]:a[0].score:null,attempt2:a[1]?"number"==typeof a[1]?a[1]:a[1].score:null}}console.log("üíæ Final completion - saving daily scores for all shapes:",JSON.stringify(t,null,2));const n=(new Date).toISOString().split("T")[0],o=await window.AuthService.saveDailyScore(n,t,getCurrentMechanicName());o.success?(console.log("‚úÖ Final daily scores saved successfully"),window.AuthService?.currentUser&&window.CompetitionManager&&null!==o.averageScore&&setTimeout(()=>{window.CompetitionManager.updateCompetitionScores(window.AuthService.currentUser.id,n,o.averageScore).catch(e=>{console.error("‚ùå Failed to update competition scores:",e)})},100)):o.error&&console.error("‚ùå Final daily score save failed:",o.error)}catch(e){console.error("‚ùå Failed to save final daily scores:",e)}if(window.completeView&&t){const t=buildCompletionModel(e);window.completeView.show(t)}else{const e={dayNumber:currentDay,avgScorePct:0,shapes:[],bestCut:null,avgScore:0,shapeSplits:[]};window.completeView&&window.completeView.show(e)}}function drawFinalScoresOnCanvas(e){if(!canvas)return;const t=document.getElementById("completion-html-overlay");t&&t.remove(),ctx&&(ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid());const n=document.createElement("div");n.id="completion-html-overlay",n.style.cssText="\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        width: 85%;\n        max-width: 320px;\n        pointer-events: none;\n        font-family: Arial, sans-serif;\n        color: #333;\n        text-align: center;\n        box-sizing: border-box;\n    ";let o=0,a='<div style="font-size: 20px; font-weight: bold; margin-bottom: 16px; text-align: center;">Today\'s Score</div>';for(let t=1;t<=3;t++){const n=e[`shape${t}`]||[];a+='<div style="margin-bottom: 12px; text-align: center;">',a+=`<div style="font-size: 16px; font-weight: bold; margin-bottom: 6px;">Shape ${t}:</div>`;for(let e=0;e<2;e++){const t=n[e];if(t){const n="number"==typeof t?t:t.score,i=t.leftPercentage||0,r=t.rightPercentage||0;a+='<div style="font-size: 14px; color: #555; margin-bottom: 4px;">',a+=`Attempt ${e+1}: ${i.toFixed(1)}% / ${r.toFixed(1)}% - ${n.toFixed(1)}`,a+="</div>",o+=n}}a+="</div>"}a+='<div style="border-top: 2px solid #ddd; margin: 16px auto; padding-top: 16px; font-size: 20px; font-weight: bold; text-align: center; max-width: 200px;">',a+=`Total: ${o.toFixed(1)}`,a+="</div>",n.innerHTML=a;const i=canvas.parentElement;i&&(i.style.position="relative",i.appendChild(n),console.log("‚úÖ Created crisp HTML text overlay for scores"))}function buildCompletionModelFromFinalStats(e){console.log("üìä Building completion model from saved finalStats:",e);const t=getDayStats(currentDay);let n=[],o=[],a=null,i=0;for(let e=1;e<=3;e++){const r=`shape${e}`;let s=[],c=0;if(t[r]&&t[r].length>0){t[r].slice(0,2).forEach((t,o)=>{if(void 0!==t.leftPercentage&&void 0!==t.rightPercentage){const r=calculateScore(t.leftPercentage,t.rightPercentage),l={n:o+1,leftPct:t.leftPercentage,rightPct:t.rightPercentage,scorePct:r};s.push(l),n.push(r),r>c&&(c=r),r>i&&(i=r,a={shapeName:`Shape ${e}`,leftPct:t.leftPercentage,rightPct:t.rightPercentage,scorePct:r})}})}s.length>0&&o.push({name:`Shape ${e}`,shapeNumber:e,attempts:s})}const r=n.length>0?n.reduce((e,t)=>e+t,0)/n.length:e.dailyAverage||0;return console.log("‚úÖ Completion model built with",o.length,"shapes,",o.reduce((e,t)=>e+t.attempts.length,0),"total attempts"),{dayNumber:currentDay,avgScorePct:r,shapes:o,bestCut:a,avgScore:r,shapeSplits:o}}function buildCompletionModel(e){let t=[],n=[],o=null,a=0;for(let i=1;i<=3;i++){const r=`shape${i}`;let s=[],c=0,l=null;e[r]&&e[r].length>0&&e[r].forEach((e,n)=>{if(void 0!==e.leftPercentage&&void 0!==e.rightPercentage){const r=calculateScore(e.leftPercentage,e.rightPercentage),d={n:n+1,leftPct:e.leftPercentage,rightPct:e.rightPercentage,scorePct:r};s.push(d),t.push(r),r>c&&(c=r,l=d),r>a&&(a=r,o={shapeName:`Shape ${i}`,leftPct:e.leftPercentage,rightPct:e.rightPercentage,scorePct:r})}}),s.length>0&&n.push({name:`Shape ${i}`,shapeNumber:i,attempts:s})}const i=t.length>0?t.reduce((e,t)=>e+t,0)/t.length:0;return{dayNumber:currentDay,avgScorePct:i,shapes:n,bestCut:o,avgScore:i,shapeSplits:n}}function showDayStatsContent(e){const t=document.getElementById("statsContent"),n=getDayStats(e),o=calculateDayAverage(e);let a=`\n        <div class="day-summary">\n            <h3>${["","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"][e]} Complete!</h3>\n            <div class="total-score">Average Score: ${o.toFixed(1)}/100</div>\n            <div class="shapes-summary">\n    `;["shape1","shape2","shape3"].forEach((e,t)=>{const o=t+1,i=n[e]||[];0!==i.length&&(a+=`\n            <div class="shape-result">\n                <div class="shape-header">Shape ${o}</div>\n                <div class="attempts-list">\n        `,i.forEach((e,t)=>{const n="number"==typeof e?e:e.score,o="object"==typeof e?e.leftPercentage:null,r="object"==typeof e?e.rightPercentage:null;a+=`<div class="attempt-score${t===i.length-1?" best":""}">`,a+=`Attempt ${t+1}: ${n}/100`,null!==o&&null!==r&&(a+=`<span class="split-percentages">${o.toFixed(1)}% / ${r.toFixed(1)}%</span>`),a+="</div>"}),a+="\n                </div>\n            </div>\n        ")}),a+='\n            </div>\n        </div>\n        <div style="text-align: center; margin-top: 30px;">\n            <button onclick="closeStatsWindow()" style="padding: 12px 24px; font-size: 16px; background: #6496ff; color: white; border: none; border-radius: 6px; cursor: pointer;">\n                Continue\n            </button>\n        </div>\n    ',t.innerHTML=a}function showStatsWindow(){const e=document.getElementById("statsOverlay"),t=document.getElementById("statsContent");let n=!1;for(let e=1;e<=7;e++){const t=getDayStats(e);["shape1","shape2","shape3"].forEach(e=>{t[e]&&t[e].length>0&&(n=!0)})}if(!n)return t.innerHTML='\n            <div class="no-attempts" style="text-align: center; padding: 40px; font-size: 16px;">\n                <p style="margin-bottom: 20px;">üìä No attempts recorded yet!</p>\n                <p style="color: #6c757d;">Start playing to see your scores and stats here.</p>\n            </div>\n        ',void(e.style.display="flex");let o="";for(let e=1;e<=7;e++){const t=["","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],n=getDayStats(e),a=calculateDayAverage(e);["shape1","shape2","shape3"].some(e=>n[e]&&n[e].length>0)&&(o+=`\n            <div class="day-summary">\n                <h3>${t[e]} (Day ${e})</h3>\n                <div class="total-score">Average Score: ${a.toFixed(1)}/100</div>\n                <div class="shapes-summary">\n        `,["shape1","shape2","shape3"].forEach((e,t)=>{const a=t+1,i=n[e]||[];0!==i.length&&(o+=`\n                <div class="shape-result">\n                    <div class="shape-header">Shape ${a}</div>\n                    <div class="attempts-list">\n            `,i.forEach((e,t)=>{const n="number"==typeof e?e:e.score,a="object"==typeof e?e.leftPercentage:null,r="object"==typeof e?e.rightPercentage:null,s=i.map(e=>"number"==typeof e?e:e.score),c=n===Math.max(...s)&&i.length>1;o+=`\n                    <div class="attempt-score ${c?"best":""}">\n                        Attempt ${t+1}<br>\n                        <strong>${n.toFixed(1)}/100</strong>\n                        ${null!==a&&null!==r?`<br><small class="split-percentages">${a}% | ${r}%</small>`:""}\n                    </div>\n                `}),o+="\n                    </div>\n                </div>\n            ")}),o+="\n                </div>\n            </div>\n        ")}t.innerHTML=o,e.style.display="flex"}function closeStatsWindow(){document.getElementById("statsOverlay").style.display="none"}function setupDemoEventListeners(){console.log("üéß Setting up Demo Game event listeners...");const e=document.getElementById("daySelect");e?(console.log("‚úÖ Found daySelect, adding event listener"),e.addEventListener("change",async function(){const t=parseInt(e.value);console.log("üìÖ Day selected:",t),clearStatsForDay(t),currentDay=t,currentShapeNumber=1,currentAttemptNumber=1,saveDemoGameState(),hideProgressionButton(),await loadDemoDay(t),createProgressUI()})):console.log("üìå Day selector not present - using current day"),console.log("‚úÖ Demo Game event listeners setup complete")}async function loadDemoDay(e){try{console.log(`üîÑ Loading demo day ${e}`),resetDemoGame(),currentDay=e,currentShapeNumber=1,currentDemoAttempt=0;const t=dayMechanics[e];console.log(`üîß Day ${e} selected - Loading mechanic: ${t}`),loadDemoMechanic(t,!1),await loadDemoShape(e,1),currentMechanic&&currentMechanic.init&&(console.log("üîß Initializing mechanic after shapes loaded"),currentMechanic.init(),console.log("üîß Setting up canvas interaction after mechanic init"),setupMechanicsEventListeners()),setGameState("cutting"),setInteractionEnabled(!1),isShapeAnimationComplete=!1;const n=document.getElementById("geoCanvas");n&&(n.style.pointerEvents="none",console.log("üîß Canvas pointer-events set to none - waiting for animation")),console.log(`‚úÖ Demo day ${e} loaded successfully - canvas inactive until animation completes`)}catch(t){console.error(`üí• Error loading demo day ${e}:`,t)}}async function loadSupabaseShape(e,t){console.log(`üîó Loading Supabase shape: day${e}, shape${t}`);try{let n=null;if(console.log("üîç DEBUG: DailyGameCore exists?",!!window.DailyGameCore),console.log("üîç DEBUG: DailyGameCore.getShapeData exists?",!(!window.DailyGameCore||!window.DailyGameCore.getShapeData)),window.DailyGameCore&&window.DailyGameCore.getShapeData&&(n=window.DailyGameCore.getShapeData(t),console.log("üîç DEBUG: DailyGameCore.getShapeData returned:",!!n)),n||(console.log("üîç DEBUG: Trying to get shape directly from dailyModeManager..."),console.log("üîç DEBUG: window.dailyModeManager exists?",!!window.dailyModeManager),console.log("üîç DEBUG: window.dailyModeManager.shapes exists?",!(!window.dailyModeManager||!window.dailyModeManager.shapes)),window.dailyModeManager&&window.dailyModeManager.shapes?(console.log("üîç DEBUG: dailyModeManager.shapes.length:",window.dailyModeManager.shapes.length),console.log("üîç DEBUG: dailyModeManager.shapes:",window.dailyModeManager.shapes),t>=1&&t<=window.dailyModeManager.shapes.length?(n=window.dailyModeManager.shapes[t-1],console.log("üîç DEBUG: Got shape directly from dailyModeManager:",!!n),console.log("üîç DEBUG: Shape data type:",typeof n),n&&console.log("üîç DEBUG: Shape data keys:",Object.keys(n))):console.log("üîç DEBUG: Shape number out of range:",t,"available:",window.dailyModeManager.shapes.length)):console.log("üîç DEBUG: dailyModeManager or shapes not available")),!n)throw new Error(`Shape ${t} not available from either DailyGameCore or dailyModeManager`);if(console.log("‚úÖ Supabase shape retrieved successfully"),window.loadedGeoJSON=n,window.currentGeoJSON=n,loadedGeoJSON=n,window.parseGeometry){const e=window.parseGeometry(n);parsedShapes=e.shapes,window.parsedShapes=parsedShapes,console.log(`üé® Parsed ${parsedShapes.length} shapes from Supabase GeoJSON`)}const o=dayMechanics[e];o&&window.loadDemoMechanic&&(console.log(`üîß Loading mechanic: ${o}`),window.loadDemoMechanic(o,!0)),console.log("üîß Setting up canvas interaction"),window.setupMechanicsEventListeners&&window.setupMechanicsEventListeners(),setGameState("cutting"),setInteractionEnabled(!1),console.log("‚úÖ Supabase shape loaded and game ready")}catch(t){console.error("‚ùå Failed to load Supabase shape:",t),console.log("üîÑ Falling back to demo shapes"),await loadDemoDay(e)}}async function loadDemoShape(e,t){console.log(`üìÅ Loading demo shape: day${e}, shape${t}`);try{const n=`v4-tests/day${e}/shape${t}.geojson`;console.log(`üîç Fetching shape from: ${n}`);const o=await fetch(n);if(!o.ok)throw new Error(`Failed to load shape: ${o.status} ${o.statusText}`);const a=await o.json();console.log(`‚úÖ Demo shape loaded: ${n}`);const i=parseGeometry(a);parsedShapes=i.shapes,window.parsedShapes=parsedShapes,console.log(`üìê Parsed ${parsedShapes.length} shapes for day ${e}, shape ${t}`),currentMechanic&&"Rotating Shape Vector Cut"===currentMechanic.name&&"function"==typeof currentMechanic.initializeWithShapes&&(console.log("üîÑ SHAPES LOADED: Initializing rotating mechanic with new shapes"),currentMechanic.initializeWithShapes()),parsedShapes.length>0&&(window.freshGameStart||window.isRestoringGameState?window.isRestoringGameState?(console.log("üîÑ Skipped initial rendering - restoring game state with saved canvas"),setTimeout(()=>{if(window.pendingCanvasRestoration&&window.canvas&&window.ctx){console.log("üé® Restoring canvas state with cut shading after shape load");const e=new Image;e.onload=function(){window.ctx.clearRect(0,0,window.canvas.width,window.canvas.height),window.ctx.drawImage(e,0,0),console.log("‚úÖ Canvas state with cut shading restored"),window.pendingCanvasRestoration=null,window.isRestoringGameState=!1,console.log("üîÑ Cleared isRestoringGameState flag - restoration complete"),currentMechanic&&"Rotating Shape Vector Cut"===currentMechanic.name&&"function"==typeof currentMechanic.startRotation&&!currentMechanic.isRotating&&(console.log("üîÑ Starting rotation after canvas restoration"),currentMechanic.startRotation())},e.src=window.pendingCanvasRestoration}else window.isRestoringGameState=!1,console.log("üîÑ Cleared isRestoringGameState flag - no canvas to restore"),currentMechanic&&"Rotating Shape Vector Cut"===currentMechanic.name&&"function"==typeof currentMechanic.startRotation&&!currentMechanic.isRotating&&(console.log("üîÑ Starting rotation (no canvas to restore)"),currentMechanic.startRotation())},200)):console.log("üé¨ Skipped immediate rendering in loadDemoShape - will use fade-in animation"):(ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid(ctx),renderShapeForCutting(parsedShapes),console.log("üé® Demo shape rendered successfully")))}catch(n){throw console.error(`‚ùå Failed to load demo shape: day${e}, shape${t}`,n),n}}function resetDemoGame(){console.log("üîÑ Resetting Demo Game..."),currentMechanic&&currentMechanic.reset&&(console.log("üßπ Cleaning up current mechanic before reset"),currentMechanic.reset()),currentMechanic=null,currentGeoJSON=null,parsedShapes=[],currentAttempts=[],console.log("‚úÖ Demo Game reset complete")}function loadDemoMechanic(e,t=!0){try{console.log(`üîß Loading demo mechanic: ${e}`);const n=window[e];if(console.log("üîß Looking for mechanic class:",e,"Found:",!!n),!n)throw new Error(`Mechanic class ${e} not found`);currentMechanic=n,window.currentMechanic=n,console.log("üîß Mechanic loaded:",currentMechanic.name),console.log("üîß Mechanic has performVectorCut:",typeof currentMechanic.performVectorCut),parsedShapes&&parsedShapes.length>0&&(setGameState("cutting"),setInteractionEnabled(!0),console.log("üéÆ Game state set to cutting with interaction enabled")),t&&(currentMechanic.init(),"RotatingShapeVectorMechanic"===e&&(console.log("üåÄ Loading RotatingShapeVectorMechanic"),console.log("üåÄ Special init for RotatingShapeVectorMechanic - ensuring rotation starts"),setTimeout(()=>{currentMechanic&&currentMechanic.setupRotation&&!currentMechanic.isRotating?(console.log("üåÄ Forcing rotation setup with delay..."),currentMechanic.setupRotation()):currentMechanic&&currentMechanic.isRotating?console.log("üåÄ Rotation already active"):console.warn("üåÄ Cannot setup rotation - mechanic not available")},100))),console.log(`‚úÖ Mechanic ${e} loaded successfully`)}catch(t){console.error(`üí• Error loading mechanic ${e}:`,t),currentMechanic=null}}function createProgressUI(){const e=document.getElementById("demoProgressDisplay");e?(e.style.visibility="hidden",updateProgressUI()):console.error("‚ùå Progress display element not found in HTML")}function updateProgressUI(){const e=document.getElementById("demoProgressDisplay");if(!e)return void console.error("‚ùå Progress display element not found!");const t="initial"!==gameState&&"welcome"!==gameState&&"finished"!==gameState&&"locked"!==gameState&&"completed"!==gameState||"playing"===gameState;console.log("üìä Progress display before changes:"),console.log("   - inline style:",e.style.cssText),console.log("   - computed display:",window.getComputedStyle(e).display),console.log("   - computed opacity:",window.getComputedStyle(e).opacity),console.log("   - should show:",t,"(gameState:",gameState,")"),t?(e.style.setProperty("visibility","visible","important"),e.style.setProperty("display","block","important"),e.style.setProperty("opacity","1","important")):(e.style.setProperty("display","none"),e.style.setProperty("visibility","hidden"));const n=`Shape ${currentShapeNumber} of 3 - Cut ${currentAttemptNumber} of 2`;e.textContent=n,console.log("üìä Progress display after changes:"),console.log("   - inline style:",e.style.cssText),console.log("   - computed display:",window.getComputedStyle(e).display),console.log("   - computed opacity:",window.getComputedStyle(e).opacity),console.log("   - element text:",e.textContent),console.log("üìä Progress UI updated:",n),console.log("üéÆ Game state:",gameState,"| Interaction enabled:",isInteractionEnabled)}function createProgressionButton(){console.log("üéÆ createProgressionButton called"),console.log("üéÆ Current state when creating button:",{currentAttemptNumber:currentAttemptNumber,currentShapeNumber:currentShapeNumber,cutsMadeThisShape:cutsMadeThisShape,totalCutsMade:totalCutsMade,isDemoMode:isDemoMode,isDailyMode:isDailyMode,gameState:gameState});const e=document.querySelector(".progression-button");e&&(console.log("üîÑ Removing existing button to create new one"),e.remove());const t=document.getElementById("fixedButtonArea");if(!t)return void console.error("‚ùå Fixed button area not found");t.style.setProperty("display","flex","important"),t.style.setProperty("visibility","visible","important"),t.style.setProperty("pointer-events","auto","important"),console.log("üîò Fixed button area styles applied"),t.innerHTML="",console.log("üîò Fixed button area cleared for new button:",t);const n=document.createElement("div");n.id="demoProgressionButton",n.className="demo-progression-button-container",n.style.cssText="\n        width: 100%;\n        text-align: center;\n        margin: 10px 0;\n        padding: 10px;\n        visibility: visible !important;\n        display: block !important;\n        opacity: 1 !important;\n    ";const o=document.createElement("button");o.className="progression-button",o.style.cssText="\n        padding: 8px 16px;\n        font-size: 16px;\n        font-weight: bold;\n        background-color: #FFC8E2;\n        color: black;\n        border: none;\n        border-radius: 6px;\n        cursor: pointer;\n        transition: background-color 0.2s ease;\n        position: relative;\n        z-index: 1000;\n        pointer-events: auto;\n        visibility: visible !important;\n        display: inline-block !important;\n        opacity: 1 !important;\n    ";let a="",i=null;if(console.log("üîò Button decision - Attempt:",currentAttemptNumber,"Shape:",currentShapeNumber),1===currentAttemptNumber)a="Next Attempt",i=handleNextAttempt,console.log("üîò Showing: Next Attempt (for attempt 2)"),console.log("üîò Click handler assigned:",typeof i,i?.name);else if(2===currentAttemptNumber)if(currentShapeNumber<=2)a="Next Shape",i=handleNextShape,console.log("üîò Showing: Next Shape (load shape",currentShapeNumber+1,")");else{if(3===currentShapeNumber)return console.log("üîò Day complete - showing stats popup"),void setTimeout(()=>{showDayStatsPopup()},1500);a="Error",i=()=>console.error("Unexpected state")}console.log("üîò Button text determined:",a),console.log("üîò Click handler determined:",i?.name||"none"),a?(o.textContent=a,o.addEventListener("click",e=>{if(console.log("üîò Button clicked!",a,"Handler:",i?.name||"unknown"),console.log("üîò Current game state:",gameState,"Interaction enabled:",isInteractionEnabled),console.log("üîò Current position - Shape:",currentShapeNumber,"Attempt:",currentAttemptNumber,"Cuts this shape:",cutsMadeThisShape),e.preventDefault(),e.stopPropagation(),i)try{console.log("üîò About to execute handler:",i.name),i(),console.log("‚úÖ Click handler executed successfully"),console.log("üîò After handler - Shape:",currentShapeNumber,"Attempt:",currentAttemptNumber)}catch(e){console.error("‚ùå Error executing click handler:",e),console.error("Stack:",e.stack)}else console.error("‚ùå No click handler defined for button:",a)}),o.addEventListener("mouseover",()=>{o.style.backgroundColor="#FFB3D9"}),o.addEventListener("mouseout",()=>{o.style.backgroundColor="#FFC8E2"}),n.appendChild(o),t.appendChild(n),console.log("üîò Created progression button:",a,"(just completed attempt",currentAttemptNumber,"of shape",currentShapeNumber+")"),setTimeout(()=>{const e=document.querySelector("#demoProgressionButton button");e?(console.log("üîò Button found in DOM:",e),console.log("üîò Button clickable test:"),console.log("   - offsetWidth:",e.offsetWidth),console.log("   - offsetHeight:",e.offsetHeight),console.log("   - visibility:",window.getComputedStyle(e).visibility),console.log("   - pointer-events:",window.getComputedStyle(e).pointerEvents),console.log("   - z-index:",window.getComputedStyle(e).zIndex),console.log("   - position:",e.getBoundingClientRect()),e.onclick=function(){console.log("üîò Direct onclick fired!")}):console.error("‚ùå Button not found in DOM after creation")},500),window.SimpleRefresh&&window.SimpleRefresh.save&&(window.SimpleRefresh.save(),console.log("üíæ State saved after button creation"))):console.error("‚ùå No button text determined! State:",{currentAttemptNumber:currentAttemptNumber,currentShapeNumber:currentShapeNumber,cutsMadeThisShape:cutsMadeThisShape})}function hideProgressionButton(){const e=document.getElementById("demoProgressionButton");e&&(e.style.display="none")}function showProgressionButton(){const e=document.getElementById("demoProgressionButton");e&&(e.style.display="block")}function handleNextAttempt(){console.log("üîò Next Attempt clicked - moving to attempt 2 of shape",currentShapeNumber),console.log("üîò Current state before: Shape",currentShapeNumber,"Attempt",currentAttemptNumber,"Cuts",cutsMadeThisShape),hideProgressionButton();document.querySelectorAll(".split-display-large").forEach(e=>{e.closest(".attempt-result")&&(e.closest(".attempt-result").style.display="none")});const e=document.getElementById("fixedPercentageArea");e&&(e.innerHTML=""),currentAttemptNumber=2,totalCutsMade++,console.log("üîò Next Attempt: Incremented totalCutsMade to",totalCutsMade),window.currentAttemptNumber=currentAttemptNumber,window.totalCutsMade=totalCutsMade,saveDemoGameState(),updateProgressUI(),console.log("üîò About to call resetForNextAttempt"),resetForNextAttempt(),console.log("üîò resetForNextAttempt completed"),resetInstructionsToInitial(),console.log("üîò AFTER handleNextAttempt - gameState:",gameState,"isInteractionEnabled:",isInteractionEnabled)}function handleNextShape(){console.log("üîò Next Shape clicked - current shape:",currentShapeNumber),hideProgressionButton();document.querySelectorAll(".split-display-large").forEach(e=>{e.closest(".attempt-result")&&(e.closest(".attempt-result").style.display="none")});const e=document.getElementById("fixedPercentageArea");e&&(e.innerHTML=""),currentShapeNumber<3&&(currentShapeNumber++,currentAttemptNumber=1,cutsMadeThisShape=0,totalCutsMade++,console.log("üîò Next Shape: Incremented totalCutsMade to",totalCutsMade),window.cutsMadeThisShape=cutsMadeThisShape,window.currentShapeNumber=currentShapeNumber,window.currentAttemptNumber=currentAttemptNumber,window.totalCutsMade=totalCutsMade,saveDemoGameState(),console.log("üîò Moving to shape",currentShapeNumber,"attempt",currentAttemptNumber),console.log("üîò Reset cutsMadeThisShape to 0 for new shape")),updateProgressUI(),setTimeout(async()=>{window.restoreGameState=!1,console.log("üîß Cleared restoreGameState to force canvas redraw"),currentVector=null,window.currentVector=null,globalThis.currentVector=null,console.log("üö´ Cleared currentVector to prevent coordinate persistence from previous shape"),window.skipCanvasCaptureAfterShapeTransition=!0,console.log("üö´ Set flag to skip canvas capture during shape transition"),window.ctx&&window.canvas&&(window.ctx.clearRect(0,0,canvas.width,canvas.height),console.log("üßπ Cleared canvas before loading new shape")),window.supabaseIntegrationActive&&window.DailyGameCore?(console.log("üîó Loading next Supabase shape for daily game..."),await loadSupabaseShape(currentDay,currentShapeNumber)):(console.log("üéÆ Loading next demo shape..."),await loadDemoShape(currentDay,currentShapeNumber)),parsedShapes&&parsedShapes.length>0&&(console.log("üé® Force redrawing canvas for new shape with",parsedShapes.length,"shapes"),redrawCanvas()),setGameState("cutting"),isShapeAnimationComplete=!0,console.log("‚úÖ Shape animation marked as complete for new shape"),setInteractionEnabled(!0,!0),console.log("üîò New shape - enabled canvas interaction for cutting"),resetInstructionsToInitial();const e=document.getElementById("geoCanvas");e&&(e.style.pointerEvents="auto",e.style.cursor="crosshair",window.canvas||(window.canvas=e),window.ctx||(window.ctx=e.getContext("2d")),console.log("üîß FIXED: Canvas fully activated for next shape"),console.log("üîß Canvas state:",{hasCanvas:!!window.canvas,hasCtx:!!window.ctx,pointerEvents:e.style.pointerEvents,cursor:e.style.cursor,isInteractionEnabled:isInteractionEnabled,gameState:gameState})),setTimeout(()=>{window.skipCanvasCaptureAfterShapeTransition=!1,console.log("‚úÖ Cleared skip canvas capture flag - canvas is now clean"),saveDemoGameState(),console.log("üíæ State saved with clean canvas after shape transition delay")},200),7===currentDay&&currentMechanic&&"Rotating Shape Vector Cut"===currentMechanic.name&&(console.log("üîÑ ROTATION: Sunday mechanic - restarting rotation for new shape"),currentMechanic.restartRotationForNextAttempt&&currentMechanic.restartRotationForNextAttempt()),console.log("üîò New shape loaded - canvas active for cutting"),currentMechanic&&currentMechanic.name&&(console.log("üîß FINAL CHECK: Current mechanic:",currentMechanic.name),console.log("üîß FINAL CHECK: Mechanic has event listeners:",!!currentMechanic.setupEventListeners),setTimeout(()=>{console.log("üîÑ FORCE: Re-setting up mechanic event listeners for post-refresh next shape"),setupMechanicsEventListeners(),currentMechanic.init&&(console.log("üîÑ FORCE: Re-initializing mechanic"),currentMechanic.init())},100))},500)}function resetForNextAttempt(){if(console.log("üîÑ BEFORE reset - gameState:",gameState,"isInteractionEnabled:",isInteractionEnabled),setGameState("cutting"),setInteractionEnabled(!0,!0),console.log("üîÑ AFTER reset - gameState:",gameState,"isInteractionEnabled:",isInteractionEnabled),(!parsedShapes||0===parsedShapes.length)&&(console.log("‚ö†Ô∏è parsedShapes missing after reset - reloading shape data"),window.currentGeoJSON)){console.log("üîÑ Reloading shape from currentGeoJSON");const e=parseGeometry(window.currentGeoJSON);parsedShapes=e.shapes,console.log("‚úÖ Reloaded",parsedShapes.length,"shapes for redraw")}window.restoreGameState=!1,console.log("üîß Cleared restoreGameState in resetForNextAttempt to force canvas redraw"),window.dailyGameState&&(window.dailyGameState.lastShapeColors=null,window.dailyGameState.shadedCanvasState=null,console.log("üîß Cleared saved canvas states to prevent shading persistence"));const e=localStorage.getItem("dailyGameState_demo");if(e){const t=JSON.parse(e);t.canvasDataURL&&(t.canvasDataURL=null,localStorage.setItem("dailyGameState_demo",JSON.stringify(t)),console.log("üîß Cleared demo canvas state to prevent shading persistence"))}redrawCanvas(),parsedShapes&&parsedShapes.length>0&&setTimeout(()=>{console.log("üé® Force redrawing canvas after reset with",parsedShapes.length,"shapes"),redrawCanvas()},50);const t=document.getElementById("percentageDisplay");t&&(t.style.display="none"),currentMechanic&&currentMechanic.reset&&(console.log("üîÑ Resetting current mechanic state"),currentMechanic.reset(),currentMechanic.init&&(console.log("üîÑ Re-initializing current mechanic"),currentMechanic.init())),7===currentDay&&currentMechanic&&"Rotating Shape Vector Cut"===currentMechanic.name&&(console.log("üîÑ ROTATION: Sunday mechanic - restarting rotation for next attempt"),currentMechanic.restartRotationForNextAttempt&&currentMechanic.restartRotationForNextAttempt(),window.returnedFromPracticeMode&&(console.log("üîÑ ROTATION: Returned from practice mode - reinitializing mechanic"),currentMechanic.init&&currentMechanic.init(),window.returnedFromPracticeMode=!1)),console.log("üîÑ Setting up mechanics event listeners after reset"),setupMechanicsEventListeners(),currentVector=null,window.currentVector=null,globalThis.currentVector=null,console.log("üîß Cleared all global vector references in resetForNextAttempt"),console.log("üß™ TESTING: Adding comprehensive canvas debugging");const n=document.getElementById("geoCanvas");if(n&&(n.style.pointerEvents="auto",n.style.cursor="crosshair",window.canvas||(window.canvas=n),window.ctx||(window.ctx=n.getContext("2d")),console.log("üîß FIXED: Canvas fully activated for next attempt"),console.log("üîß Canvas state:",{hasCanvas:!!window.canvas,hasCtx:!!window.ctx,pointerEvents:n.style.pointerEvents,cursor:n.style.cursor,isInteractionEnabled:isInteractionEnabled,gameState:gameState})),console.log("üß™ TESTING: Canvas found =",!!n),n){console.log("üß™ CANVAS DEBUG:",{id:n.id,display:window.getComputedStyle(n).display,visibility:window.getComputedStyle(n).visibility,pointerEvents:window.getComputedStyle(n).pointerEvents,position:window.getComputedStyle(n).position,zIndex:window.getComputedStyle(n).zIndex,opacity:window.getComputedStyle(n).opacity,width:n.offsetWidth,height:n.offsetHeight,clientRect:n.getBoundingClientRect()});const e=n.getBoundingClientRect(),t=e.left+e.width/2,o=e.top+e.height/2,a=document.elementFromPoint(t,o);console.log("üß™ ELEMENT AT CANVAS CENTER:",{element:a?.tagName,id:a?.id,className:a?.className,isCanvas:a===n})}window.testCanvasClickHandler&&n?.removeEventListener("click",window.testCanvasClickHandler),window.testCanvasClickHandler=e=>{console.log("üß™ DIRECT CANVAS CLICK DETECTED!",{x:e.clientX,y:e.clientY,target:e.target?.id,gameState:gameState,isInteractionEnabled:isInteractionEnabled}),window.menuState&&window.menuState.isExpanded&&(console.log("üîµ Direct canvas handler - closing menu dropdown"),window.collapseMenu())},n&&(n.addEventListener("click",window.testCanvasClickHandler),console.log("üß™ TESTING: Direct click listener added to canvas")),console.log("üîÑ Ready for next attempt on same shape - interaction should be enabled"),isShapeAnimationComplete=!0,console.log("‚úÖ Shape animation marked as complete - interaction now allowed"),setInteractionEnabled(!0),currentMechanic&&currentMechanic.name&&(console.log("üîß FINAL CHECK (Next Attempt): Current mechanic:",currentMechanic.name),console.log("üîß FINAL CHECK (Next Attempt): Mechanic has event listeners:",!!currentMechanic.setupEventListeners),setTimeout(()=>{console.log("üîÑ Ensuring mechanic event listeners are active for next attempt"),setupMechanicsEventListeners()},50))}function restoreAuthoritativeGameState(e){console.log("üìã AUTHORITATIVE RESTORE - Shape:",e.currentShape,"Attempt:",e.currentAttempt,"Cuts:",e.cutsMadeThisShape,"State:",e.gameState),e.currentAttempts&&e.currentAttempts.length>0?(currentAttempts=e.currentAttempts,console.log("‚úÖ Restored currentAttempts from state:",currentAttempts.length,"attempts"),window.debugCurrentAttempts("restoration","RESTORED from saved state")):window.currentAttempts&&window.currentAttempts.length>0&&(currentAttempts=window.currentAttempts,console.log("‚úÖ Restored currentAttempts from window:",currentAttempts.length,"attempts"),window.debugCurrentAttempts("restoration","RESTORED from window fallback")),window.currentAttempts=currentAttempts,currentShapeNumber=e.currentShape,currentAttemptNumber=e.currentAttempt,cutsMadeThisShape=e.cutsMadeThisShape||0,window.currentShapeNumber=currentShapeNumber,window.currentAttemptNumber=currentAttemptNumber,window.cutsMadeThisShape=cutsMadeThisShape,"cutting"===e.gameState?restoreCleanCanvasState(e):"awaiting_choice"===e.gameState?restoreCutCompleteState(e):3===e.currentShape&&2===e.cutsMadeThisShape?restoreCompletionState(e):(console.log("‚ö†Ô∏è Unknown state, defaulting to cutting mode"),restoreCleanCanvasState(e))}function restoreCleanCanvasState(e){console.log("üßπ Restoring clean canvas state"),setGameState("cutting"),isShapeAnimationComplete=!0,setInteractionEnabled(!0),updateProgressUI();const t=document.getElementById("geoCanvas");t&&(t.style.pointerEvents="auto",t.style.cursor="crosshair"),redrawCanvas(),console.log("‚úÖ Clean canvas ready - Shape",e.currentShape,"Cut",getCurrentCutNumber(e))}function restoreCutCompleteState(e){console.log("üé® Restoring cut complete state"),setGameState("awaiting_choice"),setInteractionEnabled(!1),updateProgressUI();const t=document.getElementById("geoCanvas");t&&(t.style.pointerEvents="none"),restoreVisualState(e),setTimeout(()=>{createAppropriateButton(e)},500),console.log("‚úÖ Cut complete state restored - Shape",e.currentShape,"Attempt",e.currentAttempt)}function restoreCompletionState(e){console.log("üèÜ Restoring completion state"),setGameState("finished"),setInteractionEnabled(!1);const t=document.getElementById("geoCanvas");t&&(t.style.pointerEvents="none"),setTimeout(()=>{showInCanvasCompletion()},500),console.log("‚úÖ Completion state restored")}function getCurrentCutNumber(e){return 1===e.currentAttempt?1:2}function createAppropriateButton(e){1===e.currentAttempt&&1===e.cutsMadeThisShape?(console.log("üîò Creating Next Attempt button"),createProgressionButton()):2===e.currentAttempt&&1===e.cutsMadeThisShape&&e.currentShape<3&&(console.log("üîò Creating Next Shape button"),createProgressionButton())}function restoreVisualState(e){const t=e.canvasData||window.pendingCanvasRestoration;if(t&&window.canvas&&window.ctx)console.log("üé® restoreVisualState: Found canvas data to restore"),setTimeout(()=>{const e=new Image;e.onload=function(){window.canceledLineDrawing?console.log("üö´ Skipping canvas visual state restoration due to recent cancel - preventing visual corruption"):(window.ctx.clearRect(0,0,canvas.width,canvas.height),window.ctx.drawImage(e,0,0),console.log("‚úÖ Canvas visual state restored from image data"),window.pendingCanvasRestoration&&(window.pendingCanvasRestoration=null,console.log("üîÑ Cleared pendingCanvasRestoration after use")))},e.src=t},100);else if(console.log("‚ö†Ô∏è No canvas data available, falling back to pixel-based restoration"),e.currentAttempts&&e.currentAttempts.length>0){const t=e.currentAttempts[e.currentAttempts.length-1];t.leftArea&&t.rightArea?(console.log("üé® Using pixel-based restoration from attempt data"),redrawCanvas(),setTimeout(()=>{renderPixelBasedCutResult(t)},50)):redrawCanvas()}else redrawCanvas();e.currentAttempts&&e.currentAttempts.length>0&&setTimeout(()=>{restoreCutResultDisplayWithIndex(e)},200)}function showInCanvasCompletion(){console.log("üéØ Showing in-canvas completion (no popup)"),"function"==typeof showCompletionView&&showCompletionView()}function restoreCutResultDisplayWithIndex(e){if(!e.currentAttempts||0===e.currentAttempts.length)return;const t=e.currentShape||window.currentShapeNumber||1,n=e.currentAttempt||window.currentAttemptNumber||1,o=n-1;console.log(`üé® Restoring cut result display for Shape ${t}, Attempt ${n} (index ${o})`);const a=e.currentAttempts;if(o<0||o>=a.length){if(console.log(`‚ö†Ô∏è Target attempt index ${o} out of bounds (attempts length: ${a.length})`),a.length>0){console.log("üìä Falling back to last attempt in array");const e=a[a.length-1];if(e&&void 0!==e.leftPercentage&&void 0!==e.rightPercentage)return void displayCutResult(e.leftPercentage,e.rightPercentage)}return}const i=a[o];i&&void 0!==i.leftPercentage&&void 0!==i.rightPercentage?(console.log("üé® Using attempt data:",i.leftPercentage,i.rightPercentage),displayCutResult(i.leftPercentage,i.rightPercentage),console.log("‚úÖ Cut result display restored with correct indexing")):console.log("‚ö†Ô∏è Target attempt has no percentage data:",i)}function displayCutResult(e,t){const n=document.getElementById("fixedPercentageArea");if(!n)return;const o=document.createElement("div");o.className="attempt-result";o.innerHTML=`\n        <div class="attempt-info">\n            <div class="split-display-large">\n                <span style="color: #6496FF; font-weight: bold;">${e.toFixed(1)}%</span>\n                <span style="color: #999999; font-weight: bold; font-size: 46px; margin: 0 5px;"> / </span>\n                <span style="color: #999999; font-weight: bold;">${t.toFixed(1)}%</span>\n            </div>\n        </div>\n    `,n.innerHTML="",n.style.setProperty("visibility","visible","important"),n.appendChild(o),console.log("‚úÖ Cut result displayed:",e.toFixed(1),"/",t.toFixed(1))}function restoreCutResultDisplay(e){if(!e||0===e.length)return;const t=e[e.length-1];if(!t||!t.leftPercentage||!t.rightPercentage)return;console.log("üé® [LEGACY] Restoring cut result display:",t.leftPercentage,t.rightPercentage);const n=document.getElementById("fixedPercentageArea");if(!n)return;const o=document.createElement("div");o.className="attempt-result";o.innerHTML=`\n        <div class="attempt-info">\n            <div class="split-display-large">\n                <span style="color: #6496FF; font-weight: bold;">${t.leftPercentage.toFixed(1)}%</span>\n                <span style="color: #999999; font-weight: bold; font-size: 46px; margin: 0 5px;"> / </span>\n                <span style="color: #999999; font-weight: bold;">${t.rightPercentage.toFixed(1)}%</span>\n            </div>\n        </div>\n    `,n.innerHTML="",n.style.setProperty("visibility","visible","important"),n.appendChild(o),console.log("‚úÖ [LEGACY] Cut result display restored")}async function handleDemoAttemptComplete(){console.log("‚ö†Ô∏è handleDemoAttemptComplete called - this should now be handled by button system")}function setupMechanicsEventListeners(){if(console.log("üéß Setting up mechanics event listeners..."),!canvas)return void console.error("Canvas not available for mechanics event listeners");let e=null;if(window.restoreGameState&&ctx)try{e=ctx.getImageData(0,0,380,380),console.log("üíæ Preserved canvas content during event listener setup")}catch(e){console.log("‚ö†Ô∏è Could not preserve canvas content:",e)}const t=canvas.cloneNode(!0);if(canvas.parentNode.replaceChild(t,canvas),canvas=t,window.canvas=canvas,ctx=canvas.getContext("2d"),window.ctx=ctx,e&&window.restoreGameState&&!window.canceledLineDrawing)try{ctx.putImageData(e,0,0),console.log("‚úÖ Restored canvas content after event listener setup")}catch(e){console.log("‚ö†Ô∏è Could not restore canvas content:",e)}else window.canceledLineDrawing&&console.log("üö´ Skipping canvas restoration due to recent cancel - preventing visual corruption");parsedShapes&&parsedShapes.length>0?window.restoreGameState||window.freshGameStart?window.restoreGameState?console.log("üîÑ Skipped redrawCanvas in setupMechanicsEventListeners during restoration"):window.freshGameStart&&console.log("üé¨ Skipped redrawCanvas in setupMechanicsEventListeners - will use fade-in animation"):redrawCanvas():drawGrid(),canvas.addEventListener("mousedown",handleMechanicStart),canvas.addEventListener("mousemove",handleMechanicMove),canvas.addEventListener("mouseup",handleMechanicEnd),canvas.addEventListener("touchstart",handleMechanicStart),canvas.addEventListener("touchmove",handleMechanicMove),canvas.addEventListener("touchend",handleMechanicEnd),canvas.addEventListener("touchstart",e=>e.preventDefault()),canvas.addEventListener("touchmove",e=>e.preventDefault()),canvas.addEventListener("touchend",e=>e.preventDefault()),canvas.addEventListener("contextmenu",e=>{if(console.log("üåê Global contextmenu handler triggered"),e.preventDefault(),currentMechanic){const e=currentMechanic.isDrawing||currentMechanic.isDrawingVector;console.log("üåê Current mechanic:",currentMechanic.name,"isDrawing:",currentMechanic.isDrawing,"isDrawingVector:",currentMechanic.isDrawingVector),e&&(console.log("üîÑ Global: Right-click detected during drawing - canceling"),currentMechanic.cancelDraw?currentMechanic.cancelDraw():currentMechanic.cancelLineDraw&&currentMechanic.cancelLineDraw(),window.dailyGameState&&(console.log("üîß Global handler: Clearing corrupted visual states after cancel"),window.dailyGameState.lastShapeColors=null,window.dailyGameState.lastRenderedCut=null,window.dailyGameState.shadedCanvasState=null),window.RefreshProtection&&window.RefreshProtection.currentGameState&&(window.RefreshProtection.currentGameState.lastShapeColors=null,window.RefreshProtection.currentGameState.lastRenderedCut=null,window.RefreshProtection.currentGameState.shadedCanvasState=null),window.shadedCanvasState&&(console.log("üîß Global handler: Clearing global shadedCanvasState after cancel"),window.shadedCanvasState=null),window.currentVector&&(console.log("üîß Global handler: Clearing window.currentVector after cancel to prevent stale cut rendering"),window.currentVector=null),window.canceledLineDrawing=!0)}},!1),console.log("‚úÖ Mechanics event listeners setup complete")}function handleMechanicStart(e){if(console.log("üîßüîßüîß handleMechanicStart CALLED!!! üîßüîßüîß",{hasCurrentMechanic:!!currentMechanic,mechanicName:currentMechanic?.name,isInteractionEnabled:isInteractionEnabled,gameState:gameState,parsedShapesLength:parsedShapes?.length,eventType:e.type,eventTarget:e.target?.tagName+"#"+e.target?.id}),window.menuState&&window.menuState.isExpanded&&(console.log("üîµ Mechanic interaction started - closing menu dropdown"),window.collapseMenu()),resetInstructionsToInitial(),window.canceledLineDrawing=!1,"mousedown"===e.type&&0!==e.button)return void console.log("üîß Ignoring non-left-click mousedown, button:",e.button);if(!currentMechanic||!isInteractionEnabled)return void console.log("üö´ Mechanic start blocked:",{noMechanic:!currentMechanic,interactionDisabled:!isInteractionEnabled});if(isDailyMode&&window.cutsMadeThisShape>=2)return void console.log("üö´ MECHANIC START BLOCKED: Daily mode cut limit reached",{cutsMadeThisShape:window.cutsMadeThisShape,isDailyMode:isDailyMode,maxCuts:2});const t=canvas.getBoundingClientRect();currentMechanic.handleStart(e,t)&&(hideTryAgainMessage(),e.preventDefault())}function handleMechanicMove(e){if(console.log("üîç DEBUG: handleMechanicMove called",{currentMechanic:currentMechanic?currentMechanic.name:"null",isInteractionEnabled:isInteractionEnabled,practiceMode:practiceMode.isActive,eventType:e.type}),!currentMechanic||!isInteractionEnabled)return;if(isDailyMode&&window.cutsMadeThisShape>=2)return void console.log("üö´ MECHANIC MOVE BLOCKED: Daily mode cut limit reached");const t=canvas.getBoundingClientRect(),n=currentMechanic.handleMove(e,t);console.log("üîç DEBUG: handleMechanicMove result:",n),n&&e.preventDefault()}async function handleMechanicEnd(e){if(!currentMechanic||!isInteractionEnabled)return;if("mouseup"===e.type&&0!==e.button)return void console.log("üîß Ignoring non-left-click mouseup, button:",e.button);if(isDailyMode&&window.cutsMadeThisShape>=2)return void console.log("üö´ MECHANIC END BLOCKED: Daily mode cut limit reached");await currentMechanic.handleEnd(e)&&e.preventDefault()}function clearResultsTable(){const e=document.getElementById("resultsTableBody");e&&(e.innerHTML="")}function showErrorMessage(e){const t=document.createElement("div");t.style.cssText="\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        background: #ff4444;\n        color: white;\n        padding: 20px;\n        border-radius: 8px;\n        z-index: 10000;\n        text-align: center;\n        font-family: sans-serif;\n    ",t.innerHTML=`\n        <h3>‚ö†Ô∏è Error</h3>\n        <p>${e}</p>\n        <button onclick="location.reload()" style="background: white; color: #ff4444; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Reload Page</button>\n    `,document.body.appendChild(t)}function saveStructuredGameState(){try{const e={date:getCurrentLocalDate(),lastUpdated:Date.now(),currentShape:currentShapeNumber||1,currentAttempt:currentAttemptNumber||1,currentDay:currentDay||1,gameState:gameState||"playing",cutsMadeThisShape:cutsMadeThisShape||0,totalCutsMade:totalCutsMade||0,currentAttempts:currentAttempts||[],attemptCount:attemptCount||0,currentGeoJSON:currentGeoJSON,mechanic:currentMechanic?currentMechanic.name:null,isGameComplete:"finished"===gameState||"locked"===gameState,dayComplete:"finished"===gameState||"locked"===gameState};if(localStorage.setItem(STORAGE_KEYS.structuredState,JSON.stringify(e)),currentAttempts&&currentAttempts.length>0){const e=currentAttempts[currentAttempts.length-1],t={leftPercentage:e.leftPercentage,rightPercentage:e.rightPercentage,splitAreas:e.splitAreas,vector:e.cutVector,timestamp:Date.now()};localStorage.setItem(STORAGE_KEYS.currentCutState,JSON.stringify(t))}if("finished"===gameState||"locked"===gameState){const e=getFinalScore();if(e){const t={leftPercentage:e.leftPercentage,rightPercentage:e.rightPercentage,attemptCount:attemptCount,cutVector:currentVector,splitAreas:currentAttempts[currentAttempts.length-1]?.splitAreas,timestamp:Date.now()};localStorage.setItem(STORAGE_KEYS.finalCommittedData,JSON.stringify(t))}}console.log("‚úÖ Structured game state saved successfully")}catch(e){console.error("‚ùå Failed to save structured game state:",e)}}function getGamePhase(){let e;return e="awaiting_choice"===gameState?"during-play":"locked"===gameState||"finished"===gameState?"post-play":"playing"===gameState||"cutting"===gameState||"animating"===gameState||currentAttempts.length>0?"during-play":"pre-play",console.log("üîç DEBUG - getGamePhase():",{gameState:gameState,currentAttemptsLength:currentAttempts.length,finalLockedScore:!!finalLockedScore,detectedPhase:e}),e}function isPlayStarted(){return"initial"!==gameState&&"loading"!==gameState}function isGameFinished(){return"locked"===gameState||"finished"===gameState}function getCurrentTryNumber(){return"awaiting_choice"===gameState&&currentAttempts.length>0?currentAttempts.length:currentAttempts.length+1}function saveGameState(){try{console.log("üíæ saveGameState() called with:",{gameState:gameState,attemptCount:attemptCount,currentAttemptsLength:currentAttempts.length});const e=getCurrentDateString();if(localStorage.setItem(STORAGE_KEYS.lastPlayDate,e),localStorage.setItem(STORAGE_KEYS.gameState,gameState),localStorage.setItem(STORAGE_KEYS.attemptCount,attemptCount.toString()),localStorage.setItem(STORAGE_KEYS.currentAttempts,JSON.stringify(currentAttempts)),localStorage.setItem(STORAGE_KEYS.isFinished,("finished"===gameState||"locked"===gameState).toString()),"awaiting_choice"===gameState&&currentVector&&currentAttempts.length>0){const e={cutVector:currentVector,lastAttemptResult:currentAttempts[currentAttempts.length-1],isAwaitingChoice:!0};localStorage.setItem(STORAGE_KEYS.currentCutState,JSON.stringify(e)),console.log("üíæ Saved current cut state for uncommitted cut")}else localStorage.removeItem(STORAGE_KEYS.currentCutState);if(console.log("üíæ Game state saved:",{date:e,gameState:gameState,attemptCount:attemptCount,attempts:currentAttempts.length,isFinished:"finished"===gameState||"locked"===gameState}),"finished"===gameState||"locked"===gameState){const e=currentAttempts[currentAttempts.length-1];if(e){const t={leftPercentage:e.leftPercentage,rightPercentage:e.rightPercentage,cutVector:e.cutVector,attemptCount:attemptCount,splitAreas:e.splitAreas};localStorage.setItem(STORAGE_KEYS.finalScoreData,JSON.stringify(t))}}console.log("üíæ Game state saved:",{gameState:gameState,attemptCount:attemptCount,isFinished:"finished"===gameState||"locked"===gameState})}catch(e){console.error("‚ùå Failed to save game state:",e)}}function loadStructuredGameState(){try{const e=getCurrentDateString(),t=localStorage.getItem(STORAGE_KEYS.lastPlayDate);if(console.log("üîç Loading structured game state:",{today:e,lastPlayDate:t,isNewDay:t!==e}),t!==e)return console.log("üìÖ New day detected, clearing previous state"),clearStructuredGameState(),null;if("true"===localStorage.getItem("dailyShapes_practiceMode")){console.log("üéÆ Was in practice mode - clearing all state for fresh start"),localStorage.removeItem("dailyShapes_practiceMode"),isPracticeMode=!1,window.isPracticeMode=!1,isPractiseMode=!1;return["phase1Instructions","phase2Instructions","finalPracticeInstructions","practicePercentageDisplay","playBtnBelowCanvas","practicePlayBtn","medalStatsTable"].forEach(e=>{const t=document.getElementById(e);t&&t.remove()}),clearStructuredGameState(),null}const n=localStorage.getItem(STORAGE_KEYS.gamePhase)||"pre-play",o="true"===localStorage.getItem(STORAGE_KEYS.playStarted),a="true"===localStorage.getItem(STORAGE_KEYS.isFinished),i=parseInt(localStorage.getItem(STORAGE_KEYS.currentTryNumber)||"1"),r="true"===localStorage.getItem(STORAGE_KEYS.hasTriedToday);console.log("üîç DEBUG - Loading from localStorage:",{gamePhase:n,playStarted:o,isFinished:a,currentTryNumber:i,hasTriedToday:r});const s=JSON.parse(localStorage.getItem(STORAGE_KEYS.tryAttempts)||"[]"),c=JSON.parse(localStorage.getItem(STORAGE_KEYS.currentCutData)||"null"),l=JSON.parse(localStorage.getItem(STORAGE_KEYS.displayedPercentages)||"null"),d=JSON.parse(localStorage.getItem(STORAGE_KEYS.finalCommittedData)||"null"),p={lastPlayDate:t,sessionTimestamp:parseInt(localStorage.getItem(STORAGE_KEYS.sessionTimestamp)||"0"),gamePhase:n,playStarted:o,isFinished:a,currentTryNumber:i,hasTriedToday:r,tryAttemptsData:s,currentCutData:c,displayedPercentages:l,finalCommittedData:d,needsWelcomeBack:"pre-play"!==n,restoreType:determineRestoreType(n,c,a)};return console.log("üìÇ Loaded structured state:",p),p}catch(e){return console.error("‚ùå Failed to load structured game state:",e),null}}function determineRestoreType(e,t,n){return console.log("üîç DEBUG - determineRestoreType inputs:",{gamePhase:e,hasCurrentCutData:!!t,isAwaitingChoice:t?.isAwaitingChoice,isFinished:n}),"pre-play"===e?(console.log("üîç Restore type: none (pre-play)"),"none"):"post-play"===e||n?(console.log("üîç Restore type: post-play"),"post-play"):t&&t.isAwaitingChoice?(console.log("üîç Restore type: awaiting-choice"),"awaiting-choice"):(console.log("üîç Restore type: during-play"),"during-play")}function clearStructuredGameState(){try{Object.values(STORAGE_KEYS).forEach(e=>{localStorage.removeItem(e)}),console.log("üóëÔ∏è Structured game state cleared for new day")}catch(e){console.error("‚ùå Failed to clear structured game state:",e)}}function loadGameState(){try{const e=getCurrentDateString(),t=localStorage.getItem(STORAGE_KEYS.lastPlayDate);if(console.log("üîç Loading game state:",{today:e,lastPlayDate:t,gameStateInStorage:localStorage.getItem(STORAGE_KEYS.gameState),attemptCountInStorage:localStorage.getItem(STORAGE_KEYS.attemptCount)}),t!==e)return console.log("üìÖ New day detected, clearing previous state"),clearGameState(),null;const n=localStorage.getItem(STORAGE_KEYS.gameState),o=parseInt(localStorage.getItem(STORAGE_KEYS.attemptCount)||"0"),a=JSON.parse(localStorage.getItem(STORAGE_KEYS.currentAttempts)||"[]"),i="true"===localStorage.getItem(STORAGE_KEYS.isFinished),r=JSON.parse(localStorage.getItem(STORAGE_KEYS.finalScoreData)||"null"),s=JSON.parse(localStorage.getItem(STORAGE_KEYS.currentCutState)||"null");return console.log("üìÇ Loaded game state:",{savedGameState:n,savedAttemptCount:o,savedIsFinished:i,attemptsLength:a.length,hasCutState:!!s}),{gameState:n,attemptCount:o,currentAttempts:a,isFinished:i,finalScoreData:r,currentCutState:s}}catch(e){return console.error("‚ùå Failed to load game state:",e),null}}function clearGameState(){try{Object.values(STORAGE_KEYS).forEach(e=>{localStorage.removeItem(e)}),console.log("üóëÔ∏è Game state cleared for new day")}catch(e){console.error("‚ùå Failed to clear game state:",e)}}function checkMidnightReset(){try{const e=getCurrentDateString(),t=localStorage.getItem("lastMidnightReset");return t!==e?(console.log("üìÖ Midnight reset needed:",{lastResetDate:t,today:e}),clearStructuredGameState(),localStorage.setItem("lastMidnightReset",e),console.log("üîÑ Midnight reset completed"),!0):(console.log("‚úÖ No midnight reset needed"),!1)}catch(e){return console.error("‚ùå Failed to check midnight reset:",e),!1}}function showAttemptDisplayForTry(e){console.log(`üî™ Showing CUT popup for try ${e}`),showCutPopup();const t=document.getElementById("progressCircles");t&&(t.style.display="flex",t.style.opacity="0",setTimeout(()=>{t.style.transition="opacity 0.5s ease",t.style.opacity="1",updateProgressCircles(attemptCount)},50))}function updateProgressCircles(e){const t=["circle1","circle2","circle3"],n=document.getElementById("progressCircles");console.log("üîµ updateProgressCircles called with attemptNumber:",e),n&&(n.style.display="flex",n.style.opacity="1"),t.forEach(e=>{const t=document.getElementById(e);t&&t.classList.remove("filled")});for(let n=0;n<e&&n<t.length;n++){const e=document.getElementById(t[n]);e&&(e.classList.add("filled"),console.log("üîµ Filled circle:",t[n]))}}function calculateCorrectGameState(e){const t=e.totalCutsMade||0;let n,o,a,i;return 0===t?(n=1,o=1,a=0,i="Initial"):1===t?(n=1,o=1,a=1,i=1):2===t?(n=1,o=2,a=1,i=2):3===t?(n=1,o=2,a=2,i=3):4===t?(n=2,o=1,a=0,i=4):5===t?(n=2,o=1,a=1,i=5):6===t?(n=2,o=2,a=1,i=6):7===t?(n=2,o=2,a=2,i=7):8===t?(n=3,o=1,a=0,i=8):9===t?(n=3,o=1,a=1,i=9):10===t?(n=3,o=2,a=1,i=10):11===t&&(n=3,o=2,a=2,i=11),console.log("üìã CALCULATE SCENARIO",i+":","Total cuts:",t,"‚Üí Shape:",n,"Attempt:",o,"CutsThisShape:",a),{...e,currentShape:n,currentAttempt:o,cutsMadeThisShape:a,totalCutsMade:t,scenarioNumber:i}}function restoreAuthoritativeGameState(e){console.log("üìã AUTHORITATIVE RESTORE - Using corrected state:",e),window.currentShapeNumber=e.currentShape,window.currentAttemptNumber=e.currentAttempt,window.cutsMadeThisShape=e.cutsMadeThisShape,window.totalCutsMade=e.totalCutsMade,void 0!==currentShapeNumber&&(currentShapeNumber=e.currentShape),void 0!==currentAttemptNumber&&(currentAttemptNumber=e.currentAttempt),void 0!==cutsMadeThisShape&&(cutsMadeThisShape=e.cutsMadeThisShape),void 0!==totalCutsMade&&(totalCutsMade=e.totalCutsMade),console.log("‚úÖ All variables synchronized to corrected state:",{currentShapeNumber:window.currentShapeNumber,currentAttemptNumber:window.currentAttemptNumber,cutsMadeThisShape:window.cutsMadeThisShape,totalCutsMade:window.totalCutsMade}),11===e.scenarioNumber?restoreCompletionState(e):1===e.scenarioNumber||3===e.scenarioNumber||5===e.scenarioNumber||7===e.scenarioNumber||9===e.scenarioNumber?restoreCutCompleteState(e):(2===e.scenarioNumber||4===e.scenarioNumber||6===e.scenarioNumber||8===e.scenarioNumber||e.scenarioNumber,restoreCleanCanvasState(e))}function restoreCleanCanvasState(e){console.log("üé® SCENARIO",e.scenarioNumber,"- CLEAN CANVAS STATE (Button clicked, ready for cutting)"),window.currentShapeNumber=e.currentShape,window.currentAttemptNumber=e.currentAttempt,window.cutsMadeThisShape=e.cutsMadeThisShape,window.totalCutsMade=e.totalCutsMade,setGameState("cutting"),setInteractionEnabled(!0),updateProgressUI();const t=document.getElementById("fixedButtonArea");t&&(t.innerHTML="",t.style.visibility="hidden",console.log("üö´ Cleared buttons - clean cutting state"));const n=document.getElementById("fixedPercentageArea");n&&(n.innerHTML="");const o=document.getElementById("commentary");o&&(o.remove(),console.log("üóëÔ∏è Removed old commentary area"));const a=document.querySelector(".results-container");if(a){const e=a.querySelector(".results-table");e&&(e.remove(),console.log("üóëÔ∏è Completely removed results table to eliminate layout interference"));const t=a.querySelector("#attemptDisplay");t&&t.remove(),a.setAttribute("data-elements-removed","true"),console.log("üóëÔ∏è Removed all interfering elements - container now contains only fixed areas")}setTimeout(()=>{"function"!=typeof redrawCanvas||window.redrawAlreadyCalled||(console.log("üé® Redrawing shape for immediate visibility"),window.redrawAlreadyCalled=!0,redrawCanvas(),setTimeout(()=>{window.redrawAlreadyCalled=!1},1e3));const t=document.getElementById("geoCanvas");t&&(t.style.pointerEvents="auto",t.style.cursor="crosshair",console.log("‚úÖ Canvas activated for cutting")),window.isShapeAnimationComplete=!0,"function"==typeof setupMechanicsEventListeners&&setupMechanicsEventListeners(),showPreCutInstruction(),console.log("‚úÖ SCENARIO",e.scenarioNumber,"restoration complete - ready for cutting on Shape",e.currentShape,"Attempt",e.currentAttempt),setTimeout(()=>{const e=document.querySelector(".results-container");e&&(e.removeAttribute("data-elements-removed"),console.log("üîÑ Refresh restoration complete - fixed elements now in proper position"))},500)},200)}function getScenarioNumberForButton(e){return 1===e?2:2===e?4:3===e?6:4===e?8:5===e?10:"Initial"}function showPreCutInstruction(){updateInstructionText(getInitialInstruction(getCurrentMechanicName()),!1)}function restoreCutCompleteState(e){const t=e.totalCutsMade||0;console.log("üéØ SCENARIO",getScenarioNumber(t),"- CUT COMPLETE STATE"),window.currentShapeNumber=e.currentShape,window.currentAttemptNumber=e.currentAttempt,window.cutsMadeThisShape=e.cutsMadeThisShape,window.totalCutsMade=e.totalCutsMade,setGameState("awaiting_choice"),setInteractionEnabled(!1),updateProgressUI();const n=document.querySelector(".results-container");if(n){const e=n.querySelector(".results-table");e&&(e.remove(),console.log("üóëÔ∏è Completely removed results table to eliminate layout interference"));const t=n.querySelector("#attemptDisplay");t&&t.remove(),n.setAttribute("data-elements-removed","true"),console.log("üóëÔ∏è Removed all interfering elements - container now contains only fixed areas")}let o;setTimeout(()=>{restoreCompleteVisualState(e)},200),1===e.cutsMadeThisShape?o="Next Attempt":2===e.cutsMadeThisShape&&e.currentShape<3&&(o="Next Shape"),console.log("üîò Will show:",o,"button for Shape",e.currentShape,"Cut",e.cutsMadeThisShape),setTimeout(()=>{createProgressionButton();const e=document.getElementById("fixedButtonArea");e&&(e.style.setProperty("display","flex","important"),e.style.setProperty("visibility","visible","important"),e.style.setProperty("opacity","1","important"),console.log("‚úÖ",o,"button forced visible with preserved positioning"))},300),console.log("‚úÖ SCENARIO",getScenarioNumber(t),"restoration complete"),setTimeout(()=>{const e=document.querySelector(".results-container");e&&(e.removeAttribute("data-elements-removed"),console.log("üîÑ Refresh restoration complete - fixed elements now in proper position"))},500)}function getScenarioNumber(e){return 1===e?1:2===e?3:3===e?5:4===e?7:5===e?9:6===e?11:"Unknown"}function restoreCompletionState(e){console.log("üéâ COMPLETION STATE - Game finished"),setGameState("finished"),restoreCompleteVisualState(e),setTimeout(()=>{showDayStatsPopup()},1500)}function saveStructuredGameState(){try{const e=getCurrentDateString(),t=Date.now();console.log("üíæ Saving structured game state:",{gamePhase:getGamePhase(),currentTryNumber:getCurrentTryNumber(),playStarted:isPlayStarted(),isFinished:isGameFinished()}),localStorage.setItem(STORAGE_KEYS.lastPlayDate,e),localStorage.setItem(STORAGE_KEYS.sessionTimestamp,t.toString()),localStorage.setItem(STORAGE_KEYS.gamePhase,getGamePhase()),localStorage.setItem(STORAGE_KEYS.playStarted,isPlayStarted().toString()),localStorage.setItem(STORAGE_KEYS.isFinished,isGameFinished().toString()),localStorage.setItem(STORAGE_KEYS.currentTryNumber,getCurrentTryNumber().toString()),localStorage.setItem(STORAGE_KEYS.hasTriedToday,(currentAttempts.length>0).toString());const n=currentAttempts.map(e=>({tryNumber:e.tryNumber||currentAttempts.indexOf(e)+1,leftPercentage:e.leftPercentage,rightPercentage:e.rightPercentage,cutVector:e.cutVector,splitAreas:e.splitAreas,timestamp:e.timestamp||Date.now()}));if(localStorage.setItem(STORAGE_KEYS.tryAttempts,JSON.stringify(n)),"awaiting_choice"===gameState&&currentVector){const e={cutVector:currentVector,lastAttemptResult:currentAttempts[currentAttempts.length-1],isAwaitingChoice:!0,tryNumber:getCurrentTryNumber()};localStorage.setItem(STORAGE_KEYS.currentCutData,JSON.stringify(e))}else localStorage.removeItem(STORAGE_KEYS.currentCutData);if(currentAttempts.length>0){const e=currentAttempts[currentAttempts.length-1],t={leftPercentage:e.leftPercentage,rightPercentage:e.rightPercentage,tryNumber:getCurrentTryNumber()};localStorage.setItem(STORAGE_KEYS.displayedPercentages,JSON.stringify(t))}if(finalLockedScore){const e={leftPercentage:finalLockedScore.leftPercentage,rightPercentage:finalLockedScore.rightPercentage,attemptCount:attemptCount,cutVector:currentVector,splitAreas:currentAttempts[currentAttempts.length-1]?.splitAreas,timestamp:Date.now()};localStorage.setItem(STORAGE_KEYS.finalCommittedData,JSON.stringify(e))}console.log("‚úÖ Structured game state saved successfully")}catch(e){console.error("‚ùå Failed to save structured game state:",e)}}function getGamePhase(){let e;return e="awaiting_choice"===gameState?"during-play":"locked"===gameState||"finished"===gameState?"post-play":"playing"===gameState||"cutting"===gameState||"animating"===gameState||currentAttempts.length>0?"during-play":"pre-play",console.log("üîç DEBUG - getGamePhase():",{gameState:gameState,currentAttemptsLength:currentAttempts.length,finalLockedScore:!!finalLockedScore,detectedPhase:e}),e}function isPlayStarted(){return"initial"!==gameState&&"loading"!==gameState}function isGameFinished(){return"locked"===gameState||"finished"===gameState}function getCurrentTryNumber(){return"awaiting_choice"===gameState&&currentAttempts.length>0?currentAttempts.length:currentAttempts.length+1}function saveGameState(){try{console.log("üíæ saveGameState() called with:",{gameState:gameState,attemptCount:attemptCount,currentAttemptsLength:currentAttempts.length});const e=getCurrentDateString();if(localStorage.setItem(STORAGE_KEYS.lastPlayDate,e),localStorage.setItem(STORAGE_KEYS.gameState,gameState),localStorage.setItem(STORAGE_KEYS.attemptCount,attemptCount.toString()),localStorage.setItem(STORAGE_KEYS.currentAttempts,JSON.stringify(currentAttempts)),localStorage.setItem(STORAGE_KEYS.isFinished,("finished"===gameState||"locked"===gameState).toString()),"awaiting_choice"===gameState&&currentVector&&currentAttempts.length>0){const e={cutVector:currentVector,lastAttemptResult:currentAttempts[currentAttempts.length-1],isAwaitingChoice:!0};localStorage.setItem(STORAGE_KEYS.currentCutState,JSON.stringify(e)),console.log("üíæ Saved current cut state for uncommitted cut")}else localStorage.removeItem(STORAGE_KEYS.currentCutState);if(console.log("üíæ Game state saved:",{date:e,gameState:gameState,attemptCount:attemptCount,attempts:currentAttempts.length,isFinished:"finished"===gameState||"locked"===gameState}),"finished"===gameState||"locked"===gameState){const e=currentAttempts[currentAttempts.length-1];if(e){const t={leftPercentage:e.leftPercentage,rightPercentage:e.rightPercentage,cutVector:e.cutVector,attemptCount:attemptCount,splitAreas:e.splitAreas};localStorage.setItem(STORAGE_KEYS.finalScoreData,JSON.stringify(t))}}console.log("üíæ Game state saved:",{gameState:gameState,attemptCount:attemptCount,isFinished:"finished"===gameState||"locked"===gameState})}catch(e){console.error("‚ùå Failed to save game state:",e)}}function loadStructuredGameState(){try{const e=getCurrentDateString(),t=localStorage.getItem(STORAGE_KEYS.lastPlayDate);if(console.log("üîç Loading structured game state:",{today:e,lastPlayDate:t,isNewDay:t!==e}),t!==e)return console.log("üìÖ New day detected, clearing previous state"),clearStructuredGameState(),null;if("true"===localStorage.getItem("dailyShapes_practiceMode")){console.log("üéÆ Was in practice mode - clearing all state for fresh start"),localStorage.removeItem("dailyShapes_practiceMode"),isPracticeMode=!1,window.isPracticeMode=!1,isPractiseMode=!1;return["phase1Instructions","phase2Instructions","finalPracticeInstructions","practicePercentageDisplay","playBtnBelowCanvas","practicePlayBtn","medalStatsTable"].forEach(e=>{const t=document.getElementById(e);t&&t.remove()}),clearStructuredGameState(),null}const n=localStorage.getItem(STORAGE_KEYS.gamePhase)||"pre-play",o="true"===localStorage.getItem(STORAGE_KEYS.playStarted),a="true"===localStorage.getItem(STORAGE_KEYS.isFinished),i=parseInt(localStorage.getItem(STORAGE_KEYS.currentTryNumber)||"1"),r="true"===localStorage.getItem(STORAGE_KEYS.hasTriedToday);console.log("üîç DEBUG - Loading from localStorage:",{gamePhase:n,playStarted:o,isFinished:a,currentTryNumber:i,hasTriedToday:r});const s=JSON.parse(localStorage.getItem(STORAGE_KEYS.tryAttempts)||"[]"),c=JSON.parse(localStorage.getItem(STORAGE_KEYS.currentCutData)||"null"),l=JSON.parse(localStorage.getItem(STORAGE_KEYS.displayedPercentages)||"null"),d=JSON.parse(localStorage.getItem(STORAGE_KEYS.finalCommittedData)||"null"),p={lastPlayDate:t,sessionTimestamp:parseInt(localStorage.getItem(STORAGE_KEYS.sessionTimestamp)||"0"),gamePhase:n,playStarted:o,isFinished:a,currentTryNumber:i,hasTriedToday:r,tryAttemptsData:s,currentCutData:c,displayedPercentages:l,finalCommittedData:d,needsWelcomeBack:"pre-play"!==n,restoreType:determineRestoreType(n,c,a)};return console.log("üìÇ Loaded structured state:",p),p}catch(e){return console.error("‚ùå Failed to load structured game state:",e),null}}function determineRestoreType(e,t,n){return console.log("üîç DEBUG - determineRestoreType inputs:",{gamePhase:e,hasCurrentCutData:!!t,isAwaitingChoice:t?.isAwaitingChoice,isFinished:n}),"pre-play"===e?(console.log("üîç Restore type: none (pre-play)"),"none"):"post-play"===e||n?(console.log("üîç Restore type: post-play"),"post-play"):t&&t.isAwaitingChoice?(console.log("üîç Restore type: awaiting-choice"),"awaiting-choice"):(console.log("üîç Restore type: during-play"),"during-play")}function clearStructuredGameState(){try{Object.values(STORAGE_KEYS).forEach(e=>{localStorage.removeItem(e)}),console.log("üóëÔ∏è Structured game state cleared for new day")}catch(e){console.error("‚ùå Failed to clear structured game state:",e)}}function loadGameState(){try{const e=getCurrentDateString(),t=localStorage.getItem(STORAGE_KEYS.lastPlayDate);if(console.log("üîç Loading game state:",{today:e,lastPlayDate:t,gameStateInStorage:localStorage.getItem(STORAGE_KEYS.gameState),attemptCountInStorage:localStorage.getItem(STORAGE_KEYS.attemptCount)}),t!==e)return console.log("üìÖ New day detected, clearing previous state"),clearGameState(),null;const n=localStorage.getItem(STORAGE_KEYS.gameState),o=parseInt(localStorage.getItem(STORAGE_KEYS.attemptCount)||"0"),a=JSON.parse(localStorage.getItem(STORAGE_KEYS.currentAttempts)||"[]"),i="true"===localStorage.getItem(STORAGE_KEYS.isFinished),r=JSON.parse(localStorage.getItem(STORAGE_KEYS.finalScoreData)||"null"),s=JSON.parse(localStorage.getItem(STORAGE_KEYS.currentCutState)||"null");return console.log("üìÇ Loaded game state:",{savedGameState:n,savedAttemptCount:o,savedIsFinished:i,attemptsLength:a.length,hasCutState:!!s}),{gameState:n,attemptCount:o,currentAttempts:a,isFinished:i,finalScoreData:r,currentCutState:s}}catch(e){return console.error("‚ùå Failed to load game state:",e),null}}function clearGameState(){try{Object.values(STORAGE_KEYS).forEach(e=>{localStorage.removeItem(e)}),console.log("üóëÔ∏è Game state cleared for new day")}catch(e){console.error("‚ùå Failed to clear game state:",e)}}function getCurrentDateString(){const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function checkMidnightReset(){try{const e=new Date,t=getCurrentDateString(),n=localStorage.getItem(STORAGE_KEYS.lastPlayDate);return!(!n||n===t)&&(console.log("üåô Midnight reset detected:",{storedDate:n,today:t,timeDiff:e.toISOString()}),clearStructuredGameState(),gameState="initial",currentAttempts=[],attemptCount=0,finalLockedScore=null,currentVector=null,console.log("‚úÖ Game state reset for new day"),!0)}catch(e){return console.error("‚ùå Failed to check midnight reset:",e),!1}}function setupMidnightCheck(){checkMidnightReset(),setInterval(()=>{checkMidnightReset()&&console.log("üîÑ Midnight reset triggered - reloading page for fresh start")},3e5),console.log("‚è∞ Midnight reset check scheduled every 5 minutes")}function showStructuredWelcomeBackPopup(e){if(dailyGameState&&dailyGameState.dayComplete)return void console.log("‚úÖ Day complete - suppressing structured welcome back popup");const t=document.getElementById("welcomeBackPopup"),n=document.getElementById("welcomeBackText"),o=document.getElementById("continueBtn");if(!t||!n||!o)return void console.error("‚ùå Welcome Back popup elements not found");const a=generateWelcomeBackMessage(e);n.innerHTML=a,hidePlayButton(),t.style.display="flex",o.onclick=()=>{t.style.display="none",console.log("üîÑ Player continued from structured welcome back"),performStructuredRestoration(e),saveStructuredGameState()},console.log("üëã Structured Welcome Back popup shown for:",e.restoreType)}function generateWelcomeBackMessage(e){const{restoreType:t,currentTryNumber:n,hasTriedToday:o,tryAttemptsData:a,currentCutData:i}=e;switch(t){case"during-play":if(o){const e=a.length;return`Welcome back.<br>You've made ${e} ${1===e?"try":"tries"}.`}return"Welcome back.<br>You haven't had a try yet.";case"awaiting-choice":return`Welcome back.<br>You're in the middle of your ${n}${1===n?"st":2===n?"nd":"rd"} try.`;case"post-play":return"Welcome back.<br>You've completed today's puzzle.";default:return"Welcome back."}}async function performStructuredRestoration(e){const{restoreType:t,tryAttemptsData:n,currentCutData:o,displayedPercentages:a,finalCommittedData:i}=e;console.log("üîÑ Performing structured restoration:",t),console.log("üîÑ DEBUG - Full structured state:",e);try{switch(t){case"during-play":await restoreDuringPlayState(e);break;case"awaiting-choice":await restoreAwaitingChoiceState(e);break;case"post-play":await restorePostPlayState(e);break;default:console.log("‚ÑπÔ∏è No restoration needed for:",t)}}catch(e){console.error("‚ùå Failed to perform structured restoration:",e)}}async function restoreDuringPlayState(e){const{currentTryNumber:t,tryAttemptsData:n,displayedPercentages:o}=e;if(console.log("üéÆ Restoring during-play state for try:",t),console.log("üéÆ DEBUG - Restoration data:",{currentTryNumber:t,tryAttemptsDataLength:n?.length,hasDisplayedPercentages:!!o,displayedPercentages:o,tryAttemptsData:n}),attemptCount=n.length,attemptCount>=maxAttempts&&console.log("‚ö†Ô∏è Already at max attempts - no more cuts allowed"),currentAttempts=n.map(e=>({leftPercentage:e.leftPercentage,rightPercentage:e.rightPercentage,cutVector:e.cutVector,splitAreas:e.splitAreas,tryNumber:e.tryNumber})),console.log("üîÑ Loading shape data for state restoration..."),!parsedShapes||0===parsedShapes.length)try{await loadDailyShape(),console.log("‚úÖ Shape data loaded for state restoration")}catch(e){console.error("‚ùå Failed to load shape data during restoration:",e)}hidePlayButton(),renderCurrentShape();/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?setTimeout(()=>{console.log("üì± Mobile: Delayed grid rendering"),ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid(),parsedShapes&&parsedShapes.length>0&&renderShapeForCutting(parsedShapes),console.log("‚úÖ Mobile: Grid and shape rendered after delay")},100):(console.log("üîÑ Desktop: Ensuring grid and shape are visible after refresh"),parsedShapes&&0!==parsedShapes.length?(ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid(),renderShapeForCutting(parsedShapes),console.log("‚úÖ Desktop: Grid and shape force-rendered after refresh")):console.warn("‚ö†Ô∏è No parsed shapes available for grid rendering")),gameState="cutting",isInteractionEnabled=!0,canvas&&(canvas.style.pointerEvents="auto",console.log("‚úÖ Canvas interaction enabled for restored playing state"));const a=document.querySelector(".results-container");if(a&&(a.style.display="block"),0===n.length){const e=document.querySelector(".results-container");if(e){e.style.display="block";const t=e.querySelector(".results-table");t&&(t.style.display="none");const n=document.getElementById("goalDisplay");document.getElementById("goalText");n&&(n.style.display="none",n.style.opacity="0"),setTimeout(()=>{showCutPopup();const e=document.getElementById("progressCircles");if(e){e.style.display="flex",e.style.opacity="1";const t=["circle1","circle2","circle3"];t.forEach(e=>{const t=document.getElementById(e);t&&t.classList.remove("filled")});for(let e=0;e<attemptCount&&e<t.length;e++){const n=document.getElementById(t[e]);n&&n.classList.add("filled")}}},300)}}else{console.log("üéÆ DEBUG - About to show previous percentages:",{hasDisplayedPercentages:!!o,displayedPercentages:o,currentAttemptsLength:currentAttempts.length,currentAttempts:currentAttempts});const e=document.getElementById("goalDisplay");if(e&&(e.style.display="none"),o)console.log("üéÆ Using displayedPercentages for attempt result display"),showAttemptResult(o.leftPercentage,o.rightPercentage);else if(currentAttempts.length>0){console.log("üéÆ Using fallback currentAttempts for attempt result display");const e=currentAttempts[currentAttempts.length-1];showAttemptResult(e.leftPercentage,e.rightPercentage)}else console.warn("‚ö†Ô∏è No previous percentages to display after attempts made");setTimeout(()=>{console.log("üéÆ About to call showAttemptDisplayForTry with:",t);document.querySelector(".results-container"),document.querySelector(".attempt-result");showCutPopup();const e=document.getElementById("progressCircles");if(e){e.style.display="flex",e.style.opacity="1";const t=["circle1","circle2","circle3"];t.forEach(e=>{const t=document.getElementById(e);t&&t.classList.remove("filled")});for(let e=0;e<attemptCount&&e<t.length;e++){const n=document.getElementById(t[e]);n&&n.classList.add("filled")}console.log("‚úÖ Progress circles restored for subsequent attempts, filled:",attemptCount)}console.log("üéÆ Showing CUT popup for try:",t)},50)}isInteractionEnabled=!0,canvas&&(canvas.style.pointerEvents="auto"),console.log("üéÆ During-play state restored:",{canvasEnabled:"auto"===canvas?.style.pointerEvents,isInteractionEnabled:isInteractionEnabled,goalDisplayVisible:"block"===document.getElementById("goalDisplay")?.style.display,attemptNumber:t});const i=document.getElementById("goalDisplay"),r=document.getElementById("goalText");console.log("üéÆ FINAL STATE CHECK:",{goalDisplayExists:!!i,goalDisplayVisible:i?.style.display,goalDisplayOpacity:i?.style.opacity,goalTextExists:!!r,goalTextContent:r?.innerHTML,cutPopupExists:!!document.getElementById("cutPopup")})}async function restoreAwaitingChoiceState(e){const{currentCutData:t,currentTryNumber:n,tryAttemptsData:o}=e;if(console.log("üîò Restoring awaiting-choice state for try:",n),!t)return void console.error("‚ùå No current cut data for awaiting-choice restoration");if(attemptCount=o.length,attemptCount>=maxAttempts)return console.log("‚ö†Ô∏è Player has already used all attempts - forcing to post-play state"),e.restoreType="post-play",e.finalCommittedData={leftPercentage:t.lastAttemptResult.leftPercentage,rightPercentage:t.lastAttemptResult.rightPercentage,attemptCount:attemptCount,cutVector:t.cutVector,splitAreas:t.lastAttemptResult.splitAreas},void await restorePostPlayState(e);currentAttempts=o.map(e=>({leftPercentage:e.leftPercentage,rightPercentage:e.rightPercentage,cutVector:e.cutVector,splitAreas:e.splitAreas,tryNumber:e.tryNumber})),hidePlayButton(),renderCurrentShape(),currentVector=t.cutVector;const a=t.lastAttemptResult;gameState="awaiting_choice",isInteractionEnabled=!1,canvas&&(canvas.style.pointerEvents="none",console.log("üö´ Canvas interaction disabled for awaiting-choice state"));const i=document.querySelector(".results-container");i&&(i.style.display="block"),renderVectorCutResult(a),showAttemptResult(a.leftPercentage,a.rightPercentage);const r=document.getElementById("goalDisplay");r&&(r.style.display="none"),showAttemptDisplayForTry(n);const s=document.getElementById("progressCircles");if(s){s.style.display="flex",s.style.opacity="1";const e=["circle1","circle2","circle3"];e.forEach(e=>{const t=document.getElementById(e);t&&t.classList.remove("filled")});for(let t=0;t<attemptCount&&t<e.length;t++){const n=document.getElementById(e[t]);n&&n.classList.add("filled")}}setTimeout(()=>{console.log("üîò Automatically proceeding to next attempt after restoration"),"awaiting_choice"===gameState&&attemptCount<maxAttempts?handleTryAgain():console.log("üîò Not proceeding - gameState is:",gameState,"attemptCount:",attemptCount)},1500),setTimeout(()=>{ensureProgressCirclesVisible()},100),console.log("üîò Awaiting-choice state restored:",{canvasDisabled:"none"===canvas?.style.pointerEvents,percentagesShown:!0,currentTryNumber:n,gameState:gameState})}async function restorePostPlayState(e){const{finalCommittedData:t,tryAttemptsData:n}=e;if(console.log("üèÅ Restoring post-play state"),!t)return void console.error("‚ùå No final committed data for post-play restoration");if(n&&n.length>0&&(currentAttempts=n,console.log("üèÅ Restored attempts data:",currentAttempts.length,"attempts")),gameState="locked",attemptCount=t.attemptCount,finalLockedScore={leftPercentage:t.leftPercentage,rightPercentage:t.rightPercentage},isInteractionEnabled=!1,t.cutVector){currentVector=t.cutVector;renderVectorCutResult({leftPercentage:t.leftPercentage,rightPercentage:t.rightPercentage,splitAreas:t.splitAreas})}hidePlayButton();const o={leftPercentage:t.leftPercentage,rightPercentage:t.rightPercentage,attemptCount:t.attemptCount};let a=null;try{a=await supabaseClient.getTodaysAverage(currentDate)}catch(e){console.error("Failed to get today's average for restored state:",e)}showCommittedResultInstant(o,a),showPostLockInElements(),setTimeout(()=>{ensureProgressCirclesVisible()},100)}function showAttemptDisplayForTry(e){console.log(`üî™ Showing CUT popup for try ${e}`),showCutPopup();const t=document.getElementById("progressCircles");t&&(t.style.display="flex",t.style.opacity="0",setTimeout(()=>{t.style.transition="opacity 0.5s ease",t.style.opacity="1",updateProgressCircles(attemptCount)},50))}function updateProgressCircles(e){const t=["circle1","circle2","circle3"],n=document.getElementById("progressCircles");console.log("üîµ updateProgressCircles called with attemptNumber:",e),n&&(n.style.display="flex",n.style.opacity="1"),t.forEach(e=>{const t=document.getElementById(e);t&&t.classList.remove("filled")});for(let n=0;n<e&&n<t.length;n++){const e=document.getElementById(t[n]);e&&(e.classList.add("filled"),console.log("üîµ Filled circle:",t[n]))}}function showWelcomeBackPopup(e){if(dailyGameState&&dailyGameState.dayComplete)return void console.log("‚úÖ Day complete - suppressing welcome back popup");const t=document.getElementById("welcomeBackPopup"),n=document.getElementById("welcomeBackText"),o=document.getElementById("continueBtn");if(!t||!n||!o)return void console.error("‚ùå Welcome Back popup elements not found");const a=window.currentAttemptNumber||e.currentAttemptNumber||1,i=window.cutsMadeThisShape||0,r=window.currentShapeNumber||e.currentShapeNumber||1;let s;if("cutting"===gameState&&2===a)s=`Welcome back! You're ready for your 2nd try on shape ${r}.`;else if("awaiting_choice"===gameState&&i>0){s=`Welcome back! You're in the middle of your ${a}${1===a?"st":2===a?"nd":"rd"} try on shape ${r}.`}else if(i>0){s=`Welcome back! You've made ${i} ${1===i?"try":"tries"} on shape ${r}.`}else s=`Welcome back! Continue your game on shape ${r}.`;n.textContent=s,t.style.display="flex",o.onclick=()=>{t.style.display="none",console.log("üîÑ Player continued in-progress demo game"),saveDemoGameState()},console.log("üëã Welcome Back popup shown for shape",r,"attempt",a)}async function restoreFinishedGameState(e){try{if(gameState="locked",attemptCount=e.attemptCount,currentAttempts=e.currentAttempts,e.finalScoreData){const t=e.finalScoreData;if(finalLockedScore={leftPercentage:t.leftPercentage,rightPercentage:t.rightPercentage},t.cutVector&&t.splitAreas){currentVector=t.cutVector;renderVectorCutResult({leftPercentage:t.leftPercentage,rightPercentage:t.rightPercentage,splitAreas:t.splitAreas})}else redrawCanvas();const n={leftPercentage:t.leftPercentage,rightPercentage:t.rightPercentage,attemptCount:attemptCount};let o=null;try{o=await supabaseClient.getTodaysAverage(currentDate)}catch(e){console.error("Failed to get today's average for restored state:",e)}showCommittedResultInstant(n,o),showPostLockInElements()}hidePlayButton(),isInteractionEnabled=!1,console.log("üéØ Finished game state restored - game is locked")}catch(e){console.error("‚ùå Failed to restore finished game state:",e)}}async function initializeGame(){try{if(console.log("üöÄ initializeGame() - Starting..."),canvas=document.getElementById("geoCanvas"),!canvas)throw new Error("Canvas element not found");if(console.log("‚úÖ Canvas element found"),ctx=setupCanvasForCrispRendering(canvas),!ctx)throw new Error("Could not get 2D context from canvas");if(console.log("‚úÖ Canvas 2D context obtained"),drawGrid(),console.log("‚úÖ Initial grid drawn"),console.log("üîç Demo mode - skipping DateUtils check"),console.log("üîç Checking supabaseClient..."),"undefined"==typeof supabaseClient)throw console.error("‚ùå supabaseClient not loaded"),new Error("supabaseClient not loaded");console.log("‚úÖ supabaseClient available"),currentDate=getCurrentDateString(),currentDayNumber=1,console.log(`üìÖ Current local date: ${currentDate}, Day #${currentDayNumber}`),console.log(`üîç Will load shapes from Supabase folder: day_${currentDate}/`),window.updateDateTitle&&"function"==typeof window.updateDateTitle?window.updateDateTitle():updateTitle(),setupMidnightCheck();try{localStorage.setItem("test","value");const e=localStorage.getItem("test");localStorage.removeItem("test"),console.log("üîç localStorage test result:",e)}catch(e){console.error("‚ùå localStorage not working:",e)}console.log("üîç Checking for structured game state...");const e=loadStructuredGameState();if(console.log("üîç loadStructuredGameState() returned:",e),e&&e.needsWelcomeBack){if(console.log("üìÇ Found structured state requiring restoration:",e.restoreType),e.dayComplete||e.isGameComplete){console.log("‚úÖ Day complete in structured state - suppressing welcome back popup");const t=await supabaseClient.loadShape(currentDate,1);if(t){currentGeoJSON=t;const n=parseGeometry(t);if(parsedShapes=n.shapes,setupEventListeners(),setupOrientationDetection(),redrawCanvas(),window.completeView&&e.finalStats){const e=buildCompletionModel(getDayStats(currentDay));window.completeView.show(e)}}return void hideLoadingAnimation()}const t=await supabaseClient.loadShape(currentDate,1);if(t){currentGeoJSON=t,console.log("üîç About to call parseGeometry...");const n=parseGeometry(t);console.log("üîç parseResult received:",n),console.log("üîç parseResult.shapes:",n?n.shapes:"null/undefined"),parsedShapes=n.shapes,console.log("üîç parsedShapes after assignment:",parsedShapes?parsedShapes.length:"null/undefined"),setupEventListeners(),setupOrientationDetection(),console.log("üîç parsedShapes before redrawCanvas:",parsedShapes?parsedShapes.length:"null/undefined"),redrawCanvas(),hideLoadingAnimation(),performStructuredRestoration(e),saveStructuredGameState()}else console.error("‚ùå Failed to load shape data for structured restoration")}console.log("üîç Checking for existing completion..."),console.log("üîç Current date:",currentDate),console.log("üîç Supabase client initialized:",!!supabaseClient);let t=null;try{console.log("üîç About to call checkTodaysCompletion..."),t=await Promise.race([supabaseClient.checkTodaysCompletion(currentDate),new Promise((e,t)=>setTimeout(()=>t(new Error("Supabase timeout")),5e3))]),console.log("üîç Completion status result:",t)}catch(e){console.warn("‚ö†Ô∏è Failed to check completion status:",e),console.log("üîÑ Continuing with normal initialization...")}if(t&&t.completed)return console.log(`‚úÖ Found existing completion: ${t.leftPercentage.toFixed(1)}%/${t.rightPercentage.toFixed(1)}% in ${t.attemptCount} attempts`),await loadAndDisplayCompletedPuzzle(t),void hideLoadingAnimation();console.log("‚ÑπÔ∏è No existing completion found, proceeding with normal initialization"),await normalInitialization()}catch(e){console.error("üí• initializeGame() failed:",e),window.debugLogger&&debugLogger.error("Game initialization failed",e);try{console.log("üîÑ Attempting fallback initialization..."),await fallbackInitialization()}catch(e){console.error("üí• Fallback initialization also failed:",e),showErrorMessage("Game failed to initialize. Please refresh the page.")}}}async function fallbackInitialization(){console.log("üîÑ Starting fallback initialization...");try{canvas=document.getElementById("geoCanvas"),canvas&&(ctx=setupCanvasForCrispRendering(canvas),console.log("‚úÖ Fallback canvas ready"))}catch(e){console.warn("‚ö†Ô∏è Canvas setup failed in fallback:",e)}try{setupBasicEventListeners()}catch(e){console.warn("‚ö†Ô∏è Event listeners setup failed in fallback:",e)}try{hideLoadingAnimation(),showBasicWelcomeMessage()}catch(e){console.warn("‚ö†Ô∏è Welcome message failed in fallback:",e)}console.log("‚úÖ Fallback initialization completed")}function setupCanvasForCrispRendering(e){if(!e)return null;const t=e.getContext("2d");if(!t)return null;const n=380;return e.width===n&&e.height===n?(console.log("‚ú® Canvas already configured: 380x380"),t.imageSmoothingEnabled=!1,t):(e.width=n,e.height=n,e.style.width="380px",e.style.height="380px",t.imageSmoothingEnabled=!1,console.log("‚ú® Canvas configured: 380x380"),t)}function getCanvasSize(){return 380}function drawBasicGrid(){if(ctx&&canvas){ctx.strokeStyle="#e0e0e0",ctx.lineWidth=1;for(let e=0;e<=380;e+=25)ctx.beginPath(),ctx.moveTo(e,0),ctx.lineTo(e,380),ctx.stroke();for(let e=0;e<=380;e+=25)ctx.beginPath(),ctx.moveTo(0,e),ctx.lineTo(380,e),ctx.stroke()}}function setupBasicEventListeners(){const e=document.getElementById("playBtn"),t=document.getElementById("practiseBtn");e&&e.addEventListener("click",function(){alert("Game initialization failed. Please refresh the page and check your internet connection.")}),t&&t.addEventListener("click",function(){alert("Game initialization failed. Please refresh the page and check your internet connection.")})}function showBasicWelcomeMessage(){const e=document.getElementById("goalDisplay"),t=document.getElementById("goalText");if(e&&t){const n="\n            <strong>Connection Issue</strong><br><br>\n            Unable to connect to the game server.<br><br>\n            Please check your internet connection and refresh the page to try again.\n        ";t.innerHTML=n,e.style.display="block",e.style.opacity="1",t.style.opacity="1"}}async function loadAndDisplayCompletedPuzzle(e){try{console.log("üéØ Loading and displaying completed puzzle..."),setupEventListeners(),setupOrientationDetection(),drawGrid(),console.log("üì• Loading shape data for completed puzzle...");const t=await supabaseClient.loadShape(currentDate,1);if(!t)throw new Error("Failed to load shape data for completed puzzle");currentGeoJSON=t;const n=parseGeometry(t);parsedShapes=n.shapes,console.log("‚úÖ Shape data loaded and parsed"),gameState="finished",attemptCount=e.attemptCount,finalLockedScore=e.leftPercentage;const o=createMockCutVector(calculateBounds(parsedShapes),e.leftPercentage,e.rightPercentage),a={score:e.leftPercentage,leftPercentage:e.leftPercentage,rightPercentage:e.rightPercentage,cutVector:o,splitAreas:null};currentAttempts.push(a),window.currentAttempts=[...currentAttempts],window.debugCurrentAttempts("completion","PUSHED completion attempt"),console.log("üé® Rendering completed puzzle with colors..."),renderReplayBinaryColors(o,1,parsedShapes),console.log("üìä Setting up completed state UI..."),showFinalState();const i=document.getElementById("goalDisplay"),r=document.getElementById("goalText");if(i&&r){const t=Math.round(e.leftPercentage),n=Math.round(e.rightPercentage);r.innerHTML=`<span class="percentage-text">${t}%</span> / <span class="percentage-text">${n}%</span>`,i.style.display="block"}console.log("‚úÖ Completed puzzle displayed successfully")}catch(e){console.error("üí• Failed to load completed puzzle:",e),console.log("üîÑ Falling back to normal initialization..."),await normalInitialization()}}async function normalInitialization(){console.log("üîß Setting up event listeners..."),setupEventListeners(),console.log("üì± Setting up orientation detection..."),setupOrientationDetection(),console.log("üñºÔ∏è UI displays already updated..."),console.log("üìê Drawing initial grid..."),drawGrid(),console.log("‚úÖ Daily Shapes v2.0 initialized successfully"),console.log(`üìä Game state: ${gameState}, Date: ${currentDate}`),hideLoadingAnimation(),showGoalDisplay(),showPlayButton();const e=document.getElementById("playBtn");e&&(e.disabled=!1,e.classList.remove("disabled")),window.debugLogger&&debugLogger.success("Game initialization complete",{date:currentDate,dayNumber:currentDayNumber,canvasSize:"380x380 (logical)"})}function updateTitle(){const e=`Daily Shapes #${currentDayNumber}`;if(document.title=e,window.updateDateTitle&&"function"==typeof window.updateDateTitle)window.updateDateTitle(),console.log("üîÑ updateTitle: Used updateDateTitle() to maintain proper header formatting");else{const e=document.getElementById("dateTitle");if(e){const t=new Date,n=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][t.getMonth()],o=t.getDate().toString().padStart(2,"0");e.innerHTML=`<strong>Daily Shapes</strong> ${n} ${o}`,console.log("üîÑ updateTitle: Used fallback to set proper header formatting")}}}window.updateInstructionText=updateInstructionText,window.getInitialInstruction=getInitialInstruction,window.showInstructionArea=showInstructionArea,window.resetInstructionsToInitial=resetInstructionsToInitial,window.closeSignInReminderModal=closeSignInReminderModal,window.openSignInFromReminder=openSignInFromReminder,window.proceedWithoutSignIn=proceedWithoutSignIn,window.closeAlreadyPlayedModal=closeAlreadyPlayedModal,window.openPracticeModeFromAlreadyPlayed=openPracticeModeFromAlreadyPlayed,window.buildCompletionModelFromFinalStats=buildCompletionModelFromFinalStats,document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("statsOverlay");e&&e.addEventListener("click",function(t){t.target===e&&closeStatsWindow()})}),document.addEventListener("DOMContentLoaded",async function(){try{if(window.innerWidth>=1200){const e=document.createElement("style");e.textContent="\n                .leaderboard-header h2,\n                #leaderboardTitle,\n                div.leaderboard-header h2,\n                .leaderboard-modal-content .leaderboard-header h2 {\n                    font-size: 23px !important;\n                    line-height: 1.2 !important;\n                }\n            ",document.head.appendChild(e)}window.isPracticeMode=!1,window.isDailyMode=!0,window.PracticeMode&&(window.PracticeMode.isActive=!1),window.practiceMode&&(window.practiceMode.isActive=!1),console.log("üßπ Cleared any lingering practice mode flags on page load"),document.body.classList.remove("restoring"),console.log("üîß Removed restoring class from body to enable split display visibility"),canvas=document.getElementById("geoCanvas"),canvas&&(ctx=setupCanvasForCrispRendering(canvas)),window.collapsibleMenu&&"function"==typeof window.collapsibleMenu.initialize&&window.collapsibleMenu.initialize(),document.addEventListener("authStateChange",function(e){updateLoginStatus(e.detail?.isLoggedIn||!1)}),setTimeout(()=>{if(window.AuthService&&"function"==typeof window.AuthService.isLoggedIn){updateLoginStatus(window.AuthService.isLoggedIn())}},1e3);let e=0;const t=50;for(;!window.supabaseIntegrationActive&&e<t;)await new Promise(e=>setTimeout(e,100)),e++;window.supabaseIntegrationActive?(console.log("üîó Supabase integration is active - using Supabase initialization path"),await initializeSupabaseGameMode()):(console.log("üéÆ Supabase integration not detected - using demo initialization path"),await initializeDemoGame()),setTimeout(async function(){if("#fresh"===window.location.hash||"true"===localStorage.getItem("freshStart"))return console.log("üÜï Fresh start requested - skipping restoration"),void localStorage.removeItem("freshStart");const e=window.SimpleRefresh&&window.SimpleRefresh.restore&&window.SimpleRefresh.restore();if(e){if(!(e.currentShape&&e.currentDay))return console.log("üÜï Invalid state (missing shape/day data), clearing"),void window.SimpleRefresh.clear();console.log("‚úÖ Valid state detected - will restore (gameStarted:",e.isGameStarted,"cuts:",e.totalCutsMade||0,")");if(Date.now()-(e.timestamp||0)>864e5)return console.log("‚ö†Ô∏è Saved state too old, starting fresh"),void window.SimpleRefresh.clear();if(!e.currentShape||!e.currentDay)return console.log("‚ö†Ô∏è Invalid saved state, starting fresh"),void window.SimpleRefresh.clear();const t=e.currentDay,n=new Date,o=0===n.getDay()?7:n.getDay();if(t&&t!==o){console.log(`‚ö†Ô∏è Saved state is from day ${t}, but current day is ${o}. Starting fresh for new day.`);const e=`demo_completed_day_${t}`;return localStorage.removeItem(e),console.log(`üóëÔ∏è Cleared old demo flag: ${e}`),void window.SimpleRefresh.clear()}t&&console.log(`‚úÖ Saved state validated - same day of week (day ${o})`),console.log("üîÑ Restoring game from saved state:",e),hideCommentary();const a=document.getElementById("playBtn"),i=document.getElementById("welcomeOverlay");if(e.isGameStarted?(a&&(a.style.display="none"),i&&(i.style.visibility="hidden"),console.log("‚úÖ Game started - hiding welcome elements")):(a&&(a.style.display="block"),i&&(i.style.visibility="visible"),console.log("‚úÖ Game not started - keeping welcome elements visible")),e.dayComplete||e.isGameComplete){gameState="finished",isInteractionEnabled=!1,window.restoredState=e,updateProgressUI();const t=document.getElementById("instructionText");return t&&(t.textContent="",console.log("üóëÔ∏è Cleared instruction text for completion state")),setTimeout(()=>{const e=getDayStats(currentDay);if(window.completeView){const t=buildCompletionModel(e);window.completeView.show(t)}else console.log("‚ö†Ô∏è Complete view not available yet")},500),void console.log("‚úÖ Restored to completion state - showing completion view")}if(!e.isGameStarted)return console.log("‚úÖ Game not started yet - showing initial welcome screen"),gameState="initial",void(isInteractionEnabled=!1);gameState="playing",isInteractionEnabled=!0;const r=calculateCorrectGameState(e);if(console.log("üìã Using corrected state:",r),window.DailyGameCore&&window.DailyGameCore.getShapeData){if(console.log("üîÑ DAILY MODE: Loading daily shape via DailyGameCore for restoration..."),window.currentMechanic)console.log(`üîß Using existing daily mechanic: ${window.currentMechanic.name}`);else{const e=dayMechanics[r.currentDay||currentDay];e&&(loadDemoMechanic(e),console.log(`üîß Loaded daily mechanic for restoration: ${e}`))}const e=window.DailyGameCore.getShapeData(r.currentShape);if(e){window.currentGeoJSON=e;const t=window.parseGeometry(e);console.log(`üîÑ DAILY MODE: Parsed daily shape ${r.currentShape} for restoration:`,t),parsedShapes=t.shapes,window.parsedShapes=parsedShapes,console.log(`üîÑ DAILY MODE: Set parsedShapes array with ${parsedShapes.length} shapes`),window.renderShapeForCutting(parsedShapes,!1),console.log(`‚úÖ DAILY MODE: Daily shape ${r.currentShape} loaded and rendered (base layer)`),window.baseShapeRendered=!0}else console.error(`‚ùå DAILY MODE: Failed to get daily shape ${r.currentShape} from DailyGameCore`)}else{console.log("üîÑ DEMO MODE: Loading demo shape for restoration...");const e=dayMechanics[r.currentDay||currentDay];e&&loadDemoMechanic(e),2!==r.scenarioNumber&&4!==r.scenarioNumber&&6!==r.scenarioNumber&&8!==r.scenarioNumber&&10!==r.scenarioNumber||(window.restoreGameState=!1,console.log("üé® Cleared restoreGameState for clean canvas scenario",r.scenarioNumber)),await loadDemoShape(r.currentDay||currentDay,r.currentShape)}window.canvas||(window.canvas=document.getElementById("geoCanvas")),!window.ctx&&window.canvas&&(window.ctx=setupCanvasForCrispRendering(window.canvas)),restoreAuthoritativeGameState(r)}},1500),setTimeout(()=>{processJoinLink()},1e3)}catch(e){console.error("‚ùå Error in game initialization:",e),showErrorMessage("Game failed to initialize. Please refresh the page.")}}),window.addEventListener("error",function(e){console.error("üí• Global error:",e.error),window.Analytics&&window.Analytics.trackError("global_error",e.message||e.error?.message||"Unknown error"),window.debugLogger&&debugLogger.error("Global error",{message:e.message,filename:e.filename,line:e.lineno,column:e.colno,error:e.error})});let currentSection="daily";function isUserSignedIn(){return!!localStorage.getItem("sb-zxrfhumifazjxgikltkz-auth-token")}function openCompetitionModal(){const e=document.getElementById("competitionModal");e&&(window.safariScrollPosition=window.pageYOffset||document.documentElement.scrollTop,document.body.style.position="fixed",document.body.style.top=`-${window.safariScrollPosition}px`,document.body.style.width="100%",e.style.display="flex",showCompetitionMain())}function closeCompetitionModal(){const e=document.getElementById("competitionModal");e&&(e.style.display="none",document.body.style.position="",document.body.style.top="",document.body.style.width="",void 0!==window.safariScrollPosition&&window.scrollTo(0,window.safariScrollPosition))}function showCompetitionMain(){hideAllCompetitionViews(),document.getElementById("competitionMainView").style.display="block"}function showActiveCompetitions(){console.log("‚úÖ Loading active competitions in existing modal"),hideAllCompetitionViews(),document.getElementById("competitionActiveView").style.display="block",loadActiveCompetitionsInModal()}function showCreateCompetition(){hideAllCompetitionViews(),document.getElementById("competitionCreateView").style.display="block",loadCompetitionCreationForm()}function showExpiredCompetitions(){hideAllCompetitionViews(),document.getElementById("competitionExpiredView").style.display="block",loadExpiredCompetitions()}async function loadActiveCompetitions(){const e=document.getElementById("activeCompetitionsList");if(window.AuthService&&!window.AuthService.isGuest){e.innerHTML='<p style="font-size: 24px;">Loading competitions...</p>';try{if(window.CompetitionManager){await window.CompetitionManager.loadUserCompetitions();const t=window.CompetitionManager.userCompetitions||[];let n="";const o=t.filter(e=>{const t=e.competitions;if(t.is_global)return!1;if(t.end_date){const e=new Date(t.end_date),n=new Date;return Math.ceil((e.getTime()-n.getTime())/864e5)>=0}return!0});o.length>0&&o.forEach(e=>{const t=e.competitions;e.participants_count=t.participant_count||t.competition_participants?.[0]?.count||0;let o="Unknown",a="#6496FF";if(t.start_date&&t.end_date){const e=new Date(t.start_date),n=new Date(t.end_date),i=new Date;if(i<e){const t=isAmericanUser();console.log("üåç Locale Detection Debug:",{timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,locale:navigator.language,isUS:t});const n=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0"),r=String(e.getFullYear()).slice(-2);t?(o=`Starting ${n}/${i}/${r}`,console.log("üìÖ Using US format:",o)):(o=`Starting ${i}/${n}/${r}`,console.log("üìÖ Using International format:",o)),a="#FAB06A"}else{const e=n.getTime()-i.getTime(),t=Math.ceil(e/864e5);t>0?o=`${t} day${1===t?"":"s"} left`:0===t&&(o="Ends today")}}n+=`\n                            <div class="competition-card-compact" \n                                 style="padding: 12px; margin: 6px 10px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; transition: all 0.2s; background: #e8e8e8; position: relative; min-height: 80px; width: calc(100% - 20px); box-sizing: border-box;" \n                                 onclick="window.showCompetitionLeaderboard('${t.id}', '${t.name.replace(/'/g,"\\'")}')"\n                                 onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'; this.style.borderColor='#6496FF';"\n                                 onmouseout="this.style.transform=''; this.style.boxShadow=''; this.style.borderColor='#ddd';">\n                                <div style="display: flex; justify-content: space-between; align-items: flex-start;">\n                                    <div style="flex: 1;">\n                                        <h4 style="margin: 0 0 4px 0; color: #333; font-size: 14px; font-weight: 600; line-height: 1.3;">${t.name.toUpperCase()}</h4>\n                                        <div style="display: flex; flex-direction: column; gap: 4px; margin-top: 8px;">\n                                            <span style="font-size: 13px; color: ${a}; font-weight: bold;">\n                                                üìÖ ${o}\n                                            </span>\n                                            <span style="font-size: 13px; color: #666; font-weight: bold;">\n                                                üë• ${e.participant_count||e.participants_count||0} players\n                                            </span>\n                                        </div>\n                                    </div>\n                                    <div style="text-align: right; margin-left: 8px;">\n                                        <p style="font-size: 12px; color: #999; margin: 0; line-height: 1.2; font-weight: bold;">View ‚Üí</p>\n                                    </div>\n                                </div>\n                            </div>\n                        `}),e.innerHTML=n?'<div class="competitions-grid-compact" style="padding: 0;">'+n+"</div>":'\n                    <div style="text-align: center; padding: 40px;">\n                        <p style="font-size: 16px; color: #666; margin-bottom: 20px;">Looks like you\'re not currently connected to any competitions</p>\n                        <button class="success-nav-btn primary" onclick="showCreateCompetition()">\n                            <span class="btn-icon">‚ûï</span>\n                            Create Competition\n                        </button>\n                    </div>\n                '}else e.innerHTML='\n                <div style="text-align: center; padding: 40px;">\n                    <p style="color: #666;">Competition system is loading...</p>\n                    <p style="color: #999; font-size: 14px; margin-top: 10px;">Please try again in a moment.</p>\n                    <button class="success-nav-btn secondary" onclick="showActiveCompetitions()" style="margin-top: 20px;">\n                        Refresh\n                    </button>\n                </div>\n            '}catch(t){console.error("Error loading competitions:",t),t.message&&t.message.includes("row-level security")?e.innerHTML='\n                <div style="text-align: center; padding: 40px;">\n                    <p style="color: #666;">Session expired. Please sign in again.</p>\n                    <button class="success-nav-btn primary" onclick="closeCompetitionModal(); showAuthenticationPopup();">\n                        Sign In\n                    </button>\n                </div>\n            ':e.innerHTML='\n                <div style="text-align: center; padding: 40px;">\n                    <p style="color: #666;">Unable to load competitions at this time.</p>\n                    <button class="success-nav-btn secondary" onclick="showActiveCompetitions()">\n                        Try Again\n                    </button>\n                </div>\n            '}}else e.innerHTML='\n            <div style="text-align: center; padding: 40px;">\n                <p style="font-size: 16px; color: #666; margin-bottom: 20px;">Please sign in to view competitions</p>\n                <button class="success-nav-btn primary" onclick="closeCompetitionModal(); showAuthenticationPopup();">\n                    Sign In\n                </button>\n            </div>\n        '}async function loadActiveCompetitionsInModal(){if(console.log("‚úÖ Loading active competitions with participant counts"),window.CompetitionManager&&window.CompetitionManager.fetchParticipantCounts)try{await window.CompetitionManager.fetchParticipantCounts(),console.log("‚úÖ Participant counts fetched successfully")}catch(e){console.error("‚ùå Error fetching participant counts:",e)}await loadActiveCompetitions()}async function loadExpiredCompetitions(){const e=document.getElementById("expiredCompetitionsList");if(window.AuthService&&!window.AuthService.isGuest){e.innerHTML='<p style="font-size: 24px;">Loading past competitions...</p>';try{if(window.CompetitionManager){await window.CompetitionManager.loadUserCompetitions();const t=window.CompetitionManager.userCompetitions||[];let n="";const o=t.filter(e=>{const t=e.competitions;if(t.is_global)return!1;if(t.end_date){const e=new Date(t.end_date),n=new Date;return Math.ceil((e.getTime()-n.getTime())/864e5)<0}return!1});o.length>0&&o.forEach(e=>{const t=e.competitions;e.participants_count=t.participant_count||t.competition_participants?.[0]?.count||0;let o="Ended";if(t.end_date){const e=new Date(t.end_date),n=new Date,a=Math.floor((n.getTime()-e.getTime())/864e5);if(0===a)o="Ended today";else if(1===a)o="Ended yesterday";else if(a<7)o=`Ended ${a} days ago`;else if(a<30){const e=Math.floor(a/7);o=`Ended ${e} week${1===e?"":"s"} ago`}else{const e=Math.floor(a/30);o=`Ended ${e} month${1===e?"":"s"} ago`}}n+=`\n                        <div class="competition-card-compact" \n                             style="padding: 12px; margin: 6px 10px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; transition: all 0.2s; background: #e8e8e8; position: relative; min-height: 80px; width: calc(100% - 20px); box-sizing: border-box; opacity: 0.8;" \n                             onclick="window.showCompetitionLeaderboard('${t.id}', '${t.name.replace(/'/g,"\\'")}')"\n                             onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'; this.style.borderColor='#999';"\n                             onmouseout="this.style.transform=''; this.style.boxShadow=''; this.style.borderColor='#ddd';">\n                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">\n                                <div style="flex: 1;">\n                                    <h4 style="margin: 0 0 4px 0; color: #333; font-size: 14px; font-weight: 600; line-height: 1.3;">${t.name.toUpperCase()}</h4>\n                                    ${t.description?`<p style="color: #666; margin: 0; font-size: 12px; line-height: 1.2;">\n                                        ${t.description}\n                                    </p>`:""}\n                                    <div style="display: flex; flex-direction: column; gap: 4px; margin-top: 8px;">\n                                        <span style="font-size: 13px; color: #e74c3c; font-weight: bold;">\n                                            üìÖ ${o}\n                                        </span>\n                                        <span style="font-size: 13px; color: #666; font-weight: bold;">\n                                            üë• ${e.participant_count||e.participants_count||0} player${1===(e.participant_count||e.participants_count)?"":"s"}\n                                        </span>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    `}),e.innerHTML=n?'<div class="competitions-grid-compact" style="padding: 0;">'+n+"</div>":'\n                    <div style="text-align: center; padding: 40px;">\n                        <p style="font-size: 16px; color: #666; margin-bottom: 20px;">No ended competitions to display</p>\n                        <button class="success-nav-btn secondary" onclick="showActiveCompetitions()">\n                            Back to Active Competitions\n                        </button>\n                    </div>\n                '}else e.innerHTML='\n                <div style="text-align: center; padding: 40px;">\n                    <p style="color: #666;">Competition system is loading...</p>\n                    <button class="success-nav-btn secondary" onclick="showExpiredCompetitions()" style="margin-top: 20px;">\n                        Refresh\n                    </button>\n                </div>\n            '}catch(t){console.error("Error loading ended competitions:",t),e.innerHTML='\n            <div style="text-align: center; padding: 40px;">\n                <p style="color: #666;">Unable to load ended competitions.</p>\n                <button class="success-nav-btn secondary" onclick="showExpiredCompetitions()">\n                    Try Again\n                </button>\n            </div>\n        '}}else e.innerHTML='\n            <div style="text-align: center; padding: 40px;">\n                <p style="font-size: 16px; color: #666; margin-bottom: 20px;">Please sign in to view competitions</p>\n                <button class="success-nav-btn primary" onclick="closeCompetitionModal(); showAuthenticationPopup();">\n                    Sign In\n                </button>\n            </div>\n        '}function loadCompetitionCreationForm(){const e=document.querySelector(".create-competition-form");if(!(window.AuthService&&!window.AuthService.isGuest))return void(e.innerHTML='\n            <div style="text-align: center; padding: 40px;">\n                <p style="font-size: 16px; color: #666; margin-bottom: 20px;">Please sign in to create competitions</p>\n                <button class="success-nav-btn primary" onclick="closeCompetitionModal(); showAuthenticationPopup();">\n                    Sign In\n                </button>\n            </div>\n        ');const t=new Date,n=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;e.innerHTML=`\n        <style>\n            /* Date input styling to match placeholder color */\n            #compStartDate, #compEndDate {\n                color: #6c757d !important;\n                font-family: inherit;\n            }\n\n            #compStartDate:focus, #compEndDate:focus {\n                color: #333 !important;\n            }\n\n            #compStartDate:valid, #compEndDate:valid {\n                color: #333 !important;\n            }\n\n            /* Webkit specific date input styling */\n            #compStartDate::-webkit-datetime-edit,\n            #compEndDate::-webkit-datetime-edit {\n                color: #6c757d !important;\n            }\n\n            #compStartDate:focus::-webkit-datetime-edit,\n            #compEndDate:focus::-webkit-datetime-edit {\n                color: #333 !important;\n            }\n\n            #compStartDate:valid::-webkit-datetime-edit,\n            #compEndDate:valid::-webkit-datetime-edit {\n                color: #333 !important;\n            }\n\n            /* Individual date field components */\n            #compStartDate::-webkit-datetime-edit-text,\n            #compStartDate::-webkit-datetime-edit-month-field,\n            #compStartDate::-webkit-datetime-edit-day-field,\n            #compStartDate::-webkit-datetime-edit-year-field,\n            #compEndDate::-webkit-datetime-edit-text,\n            #compEndDate::-webkit-datetime-edit-month-field,\n            #compEndDate::-webkit-datetime-edit-day-field,\n            #compEndDate::-webkit-datetime-edit-year-field {\n                color: #6c757d !important;\n            }\n\n            #compStartDate:focus::-webkit-datetime-edit-text,\n            #compStartDate:focus::-webkit-datetime-edit-month-field,\n            #compStartDate:focus::-webkit-datetime-edit-day-field,\n            #compStartDate:focus::-webkit-datetime-edit-year-field,\n            #compEndDate:focus::-webkit-datetime-edit-text,\n            #compEndDate:focus::-webkit-datetime-edit-month-field,\n            #compEndDate:focus::-webkit-datetime-edit-day-field,\n            #compEndDate:focus::-webkit-datetime-edit-year-field {\n                color: #333 !important;\n            }\n        </style>\n        <div class="competition-form">\n            <div class="form-group" style="margin-bottom: 32px;">\n                <label for="compName">Competition Name</label>\n                <input type="text" id="compName" placeholder="eg. Rhombus Rumble" maxlength="50" style="margin-bottom: 16px;">\n            </div>\n            <div class="form-group">\n                <label for="compStartDate">Start Date</label>\n                <input type="date" id="compStartDate" min="${n}">\n                <div class="input-help" style="font-size: 12px; margin-bottom: 20px;">Competition can start tomorrow or later</div>\n            </div>\n            <div class="form-group">\n                <label for="compEndDate">End Date</label>\n                <input type="date" id="compEndDate" min="${n}">\n            </div>\n            <button class="success-nav-btn primary" onclick="createNewCompetition()">\n                Create Competition\n            </button>\n        </div>\n    `,setTimeout(()=>{const e=document.getElementById("compStartDate"),t=document.getElementById("compEndDate");function n(e){e&&(e.style.color="#999",e.addEventListener("change",function(){this.value?this.style.color="#333":this.style.color="#999"}),e.addEventListener("focus",function(){this.style.color="#333"}),e.addEventListener("blur",function(){this.value||(this.style.color="#999")}))}n(e),n(t)},100)}async function showCompetitionLeaderboard(e,t){console.log("üìä Showing leaderboard for competition:",e,t);if(!(window.AuthService&&!window.AuthService.isGuest))return console.log("üîí User not logged in - cannot view leaderboard"),void showAuthenticationPopup();hideAllCompetitionViews();let n=document.getElementById("competitionLeaderboardView");if(!n){const e=document.querySelector(".competition-modal-content");if(!e)return void console.error("Competition modal content not found");n=document.createElement("div"),n.id="competitionLeaderboardView",n.className="competition-view",n.style.display="none",e.appendChild(n)}n.innerHTML='\n        <div class="competition-header">\n            <button class="back-btn" onclick="showActiveCompetitions()" style="margin-bottom: 20px; padding: 8px 16px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">\n                ‚Üê Back to Competitions\n            </button>\n            <h3 style="margin: 0 0 20px 0;">Leaderboard</h3>\n        </div>\n        <div id="leaderboardContent" style="max-height: 400px; overflow-y: auto;">\n            <p>Loading leaderboard...</p>\n        </div>\n    ',n.style.display="block";try{let t=[],n=null;if(window.CompetitionManager){if(console.log("üìä Trying CompetitionManager.getCompetitionLeaderboard..."),window.CompetitionManager.loadUserCompetitions&&await window.CompetitionManager.loadUserCompetitions(),window.CompetitionManager.getCompetitionLeaderboard)try{t=await window.CompetitionManager.getCompetitionLeaderboard(e),console.log("üìä Got leaderboard data from CompetitionManager:",t)}catch(e){console.log("‚ö†Ô∏è CompetitionManager.getCompetitionLeaderboard failed:",e),n=e}if((!t||0===t.length)&&window.CompetitionManager.userCompetitions){const n=window.CompetitionManager.userCompetitions.find(t=>t.competitions&&t.competitions.id===e);n&&n.participants&&(t=n.participants,console.log("üìä Got participants from userCompetitions:",t))}}if((!t||0===t.length)&&window.SupabaseConfig&&window.SupabaseConfig.client){console.log("üìä Trying direct Supabase query...");const{data:o,error:a}=await window.SupabaseConfig.client.from("competition_participants").select("\n                    *,\n                    users!inner(\n                        id,\n                        username,\n                        email\n                    )\n                ").eq("competition_id",e).order("total_score",{ascending:!1});a?(console.error("‚ùå Supabase query error:",a),n=a):o&&(t=o,console.log("üìä Got leaderboard data from Supabase:",t))}const o=document.getElementById("leaderboardContent");if(t&&t.length>0){let n='\n                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px;">\n                    <table style="width: 100%; border-collapse: collapse;">\n                        <thead>\n                            <tr style="border-bottom: 2px solid #dee2e6;">\n                                <th style="text-align: left; padding: 10px; font-weight: 600;">Rank</th>\n                                <th style="text-align: left; padding: 10px; font-weight: 600;">Player</th>\n                                <th style="text-align: right; padding: 10px; font-weight: 600;">Score</th>\n                                <th style="text-align: right; padding: 10px; font-weight: 600;">Games</th>\n                            </tr>\n                        </thead>\n                        <tbody>\n            ';t.forEach((e,t)=>{const o=t+1,a=1===o?"ü•á":2===o?"ü•à":3===o?"ü•â":"",i=e.users?.username||e.users?.email?.split("@")[0]||"Player",r=e.total_score||0,s=e.games_played||0,c=window.AuthService?.currentUser?.id===e.user_id;n+=`\n                    <tr style="${c?"background: #e3f2fd;":t%2==0?"background: #fff;":"background: #f8f9fa;"}">\n                        <td style="padding: 12px 10px; border-bottom: 1px solid #dee2e6;">\n                            <span style="font-weight: ${o<=3?"bold":"normal"};">${a} ${o}</span>\n                        </td>\n                        <td style="padding: 12px 10px; border-bottom: 1px solid #dee2e6;">\n                            ${i}\n                            ${c?'<span style="color: #1976d2; font-size: 12px;"> (You)</span>':""}\n                        </td>\n                        <td style="padding: 12px 10px; text-align: right; border-bottom: 1px solid #dee2e6; font-weight: 600;">\n                            ${r.toFixed(1)}%\n                        </td>\n                        <td style="padding: 12px 10px; text-align: right; border-bottom: 1px solid #dee2e6; color: #666;">\n                            ${s}\n                        </td>\n                    </tr>\n                `}),n+="\n                        </tbody>\n                    </table>\n                </div>\n            ";const a=t.reduce((e,t)=>e+(t.total_score||0),0)/t.length;n+=`\n                <div style="margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 8px;">\n                    <h4 style="margin: 0 0 10px 0; font-size: 16px;">Competition Stats</h4>\n                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">\n                        <div>\n                            <span style="color: #666; font-size: 14px;">Total Players:</span>\n                            <strong style="display: block; font-size: 18px;">${t.length}</strong>\n                        </div>\n                        <div>\n                            <span style="color: #666; font-size: 14px;">Average Score:</span>\n                            <strong style="display: block; font-size: 18px;">${a.toFixed(1)}%</strong>\n                        </div>\n                    </div>\n                </div>\n            `,n+=`\n                <div style="margin-top: 20px; text-align: center;">\n                    <button class="success-nav-btn secondary" onclick="shareCompetition('${e}')" style="width: 100%;">\n                        üì§ Share Competition Link\n                    </button>\n                </div>\n            `,o.innerHTML=n}else o.innerHTML=`\n                <div style="text-align: center; padding: 40px;">\n                    <p style="color: #666;">No players have joined this competition yet.</p>\n                    <button class="success-nav-btn primary" onclick="shareCompetition('${e}')">\n                        Invite Players\n                    </button>\n                </div>\n            `}catch(e){console.error("‚ùå Error loading leaderboard:",e);const t=document.getElementById("leaderboardContent");t&&(e.message&&(e.message.includes("row-level security")||e.message.includes("JWT"))?t.innerHTML='\n                    <div style="text-align: center; padding: 40px;">\n                        <p style="color: #666;">Session expired. Please sign in again.</p>\n                        <button class="success-nav-btn primary" onclick="closeCompetitionModal(); showAuthenticationPopup();">\n                            Sign In\n                        </button>\n                    </div>\n                ':t.innerHTML=`\n                    <div style="text-align: center; padding: 40px;">\n                        <p style="color: #d32f2f;">Error loading leaderboard</p>\n                        <p style="color: #666; font-size: 14px; margin-top: 10px;">${e.message||"Please try again later"}</p>\n                        <button class="success-nav-btn secondary" onclick="showActiveCompetitions()" style="margin-top: 20px;">\n                            Back to Competitions\n                        </button>\n                    </div>\n                `)}}function shareCompetition(e){const t=`${window.location.origin}${window.location.pathname}?join=${e}`,n=localStorage.getItem(`compDetails_${e}`);let o="Join my Daily Shapes competition!";if(n){const e=JSON.parse(n),a=formatCompetitionDate(e.startDate),i=formatCompetitionDate(e.endDate);o=`Join my Daily Shapes competition!\nRuns from ${a} to ${i}\nDon't be a square - join the fun!\n\n${t}`}navigator.share?navigator.share({title:"Join my Daily Shapes competition!",text:o,url:t}).catch(e=>{copyCompetitionToClipboard(o,t)}):copyCompetitionToClipboard(o,t)}function copyCompetitionToClipboard(e,t){try{navigator.clipboard.writeText(e).then(()=>{showCopyNotification()}).catch(()=>{n(e)})}catch(t){n(e)}function n(e){const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.top="0",t.style.left="0",document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),showCopyNotification()}}function copyToClipboard(e){const t=document.createElement("input");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t);const n=document.createElement("div");n.textContent="Competition link copied to clipboard!",n.style.cssText="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #4caf50; color: white; padding: 12px 24px; border-radius: 4px; z-index: 10000;",document.body.appendChild(n),setTimeout(()=>n.remove(),3e3)}function showCompetitionError(e){const t=document.querySelector(".create-competition-form");if(!t)return;const n=t.querySelector(".competition-error");n&&n.remove();const o=document.createElement("div");o.className="competition-error",o.style.cssText="\n        position: absolute !important;\n        top: -12px !important;\n        left: 8px !important;\n        right: 8px !important;\n        color: #dc3545 !important;\n        font-size: 14px !important;\n        font-family: system-ui, -apple-system, sans-serif !important;\n        font-weight: normal !important;\n        line-height: 1.3 !important;\n        margin: 0 !important;\n        padding: 0 !important;\n        border: none !important;\n        background: none !important;\n        text-align: left !important;\n        display: block !important;\n        width: auto !important;\n        box-sizing: border-box !important;\n        z-index: 1000 !important;\n        pointer-events: none !important;\n    ",o.textContent=e,"relative"!==t.style.position&&(t.style.position="relative"),t.appendChild(o),setTimeout(()=>{o.parentNode&&o.remove()},5e3)}async function createNewCompetition(){const e=document.getElementById("compName").value.trim(),t=document.getElementById("compStartDate").value,n=document.getElementById("compEndDate").value;if(!e)return void showCompetitionError("Please enter a competition name");if(!t)return void showCompetitionError("Please select a start date");if(!n)return void showCompetitionError("Please select an end date");const o=new Date;o.setHours(0,0,0,0);const a=new Date(t+"T00:00:00"),i=new Date(n+"T00:00:00");if(a<o)showCompetitionError("Start date cannot be in the past");else if(i<=a)showCompetitionError("End date must be after start date");else try{if(window.CompetitionManager){const o=window.AuthService?.currentUser?.id||window.AuthManager?.getCurrentUser()?.id;if(!o)return void showCompetitionError("Please log in to create a competition");const r=Math.ceil((i-a)/864e5),s=await window.CompetitionManager.createCompetition({name:e,duration_days:r,isPublic:!1,startDate:t,endDate:n,minParticipants:2,allowLateEntries:!0,requireConsecutiveDays:!1,scoringMethod:"average_score"},o);if(s&&s.id){const o=`${window.location.origin}${window.location.pathname}?join=${s.id}`;"undefined"!=typeof Storage&&localStorage.setItem(`compDetails_${s.id}`,JSON.stringify({name:e,startDate:t,endDate:n,link:o}));document.querySelector(".create-competition-form").innerHTML=`\n                    <div class="success-message">\n                        <h3>Competition Created!</h3>\n                        <p><strong>${e}</strong> has been created successfully.</p>\n                        \n                        <h4>Share this link to invite players:</h4>\n                        <div class="join-link-container">\n                            <input type="text" id="joinLinkInput" value="${o}" readonly \n                                   style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; margin: 8px 0;">\n                            <button class="success-nav-btn secondary" onclick="copyJoinLink()" style="width: 100%; margin-top: 8px;">\n                                Copy Join Link\n                            </button>\n                        </div>\n\n                        <div class="input-help" style="font-size: 12px; margin-bottom: 20px; text-align: center; margin-top: 15px;">Only those with access to this link can see the leaderboard</div>\n                    </div>\n                `}else showCompetitionError("Failed to create competition: "+(s?.error||"Unknown error"))}else showCompetitionError("Competition system is not available")}catch(e){console.error("Error creating competition:",e),showCompetitionError("Failed to create competition")}}function viewCompetitionDetails(e){showCompetitionLeaderboard(e)}async function showCompetitionLeaderboard(e){try{hideAllCompetitionViews();const t=document.getElementById("competitionLeaderboardView");if(!t)return void console.error("Leaderboard view not found");t.style.display="block";let n=null;if(window.CompetitionManager)try{n=await window.CompetitionManager.getCompetition(e)}catch(e){console.warn("Could not fetch competition details:",e)}const o=document.getElementById("leaderboardCompetitionTitle");o&&(o.textContent="Leaderboard");const a=document.getElementById("competitionLeaderboardContainer");if(!a)return;a.innerHTML='\n            <div style="text-align: center; padding: 40px;">\n                <div class="loading-spinner" style="margin: 0 auto 20px;"></div>\n                <p>Loading leaderboard...</p>\n            </div>\n        ';let i=[];if(window.CompetitionManager)try{i=await window.CompetitionManager.getCompetitionLeaderboard(e)}catch(t){return console.error("Error fetching leaderboard:",t),void(a.innerHTML=`\n                    <div style="text-align: center; padding: 40px;">\n                        <p style="color: #666;">Unable to load leaderboard.</p>\n                        <button onclick="showCompetitionLeaderboard('${e}')" class="success-nav-btn secondary">\n                            Try Again\n                        </button>\n                    </div>\n                `)}renderLeaderboardTable(a,i,n)}catch(e){console.error("Error showing competition leaderboard:",e)}}function renderLeaderboardTable(e,t,n){if(!t||0===t.length)return void(e.innerHTML='\n            <div style="text-align: center; padding: 40px;">\n                <p style="color: #666;">No participants yet.</p>\n                <p style="font-size: 14px; color: #999;">Invite friends to join this competition!</p>\n            </div>\n        ');let o="";if(n){const e=formatDateForUser(n.start_date),a=formatDateForUser(n.end_date),i=new Date<new Date(n.start_date)?"Upcoming":new Date>new Date(n.end_date)?"Ended":"Active";o=`\n            <div style="background: #f8f9fa; border-radius: 8px; padding: 16px; margin-bottom: 20px;">\n                <div style="margin-bottom: 12px;">\n                    <h3 style="margin: 0; color: #333; ${window.innerWidth>=1200?"font-size: 28px !important;":"font-size: 24px !important;"}">${n.name.toUpperCase()}</h3>\n                </div>\n                <div style="display: flex; flex-direction: column; gap: 4px; font-size: 14px; color: #666;">\n                    <span>üìÖ ${e} - ${a}</span>\n                    <div style="display: flex; justify-content: space-between; align-items: center;">\n                        <span>üë• ${t.length} players</span>\n                        ${"Ended"!==i?`\n                        <div style="display: flex; gap: 8px; align-items: center;">\n                            <button onclick="refreshCompetitionLeaderboard('${n.id}')" class="leaderboard-refresh-btn" title="Refresh leaderboard">\n                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">\n                                    <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>\n                                </svg>\n                            </button>\n                            <span onclick="copyCompetitionLink('${n.id}')"\n                                  style="padding: 4px 12px; background: #6496FF; color: white; border: 1px solid #000; border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer;"\n                                  onmouseover="this.style.background='#5485E8'"\n                                  onmouseout="this.style.background='#6496FF'"\n                                  title="Copy competition invite link">\n                                Invite\n                            </span>\n                        </div>\n                        `:""}\n                    </div>\n                </div>\n            </div>\n        `}let a=`\n        <div style="display: flex; flex-direction: column; height: 100%;">\n            \x3c!-- Fixed competition info --\x3e\n            ${o}\n\n            \x3c!-- Fixed table header --\x3e\n            <div style="background: white; border-radius: 8px 8px 0 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex-shrink: 0; overflow: hidden; width: 100%; max-width: 100%;">\n                <div style="background: #f8f9fa; padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: bold; display: grid !important; grid-template-columns: minmax(50px, 1fr) minmax(20px, 20px) minmax(120px, 3fr) minmax(80px, 1.5fr); gap: 8px; font-size: 14px; color: black; width: 100%; max-width: 100%; box-sizing: border-box; overflow: hidden;">\n                    <span style="text-align: center; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Rank</span>\n                    <span style="text-align: center; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></span>\n                    <span style="text-align: left; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Player</span>\n                    <span style="text-align: left; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Score</span>\n                </div>\n            </div>\n\n            \x3c!-- Scrollable data rows --\x3e\n            <div style="background: white; border-radius: 0 0 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex: 1; overflow-y: auto; overflow-x: hidden; min-height: 0; width: 100%; max-width: 100%;">\n    `;const i=window.AuthService?.currentUser?.id||window.AuthManager?.getCurrentUser()?.id;t.forEach((e,t)=>{const n=t+1,o=i&&e.user_id===i;e.days_played>0&&(e.total_score/e.days_played).toFixed(1);let r=n.toString();1===n?r="ü•á":2===n?r="ü•à":3===n&&(r="ü•â");let s=e.dailyAwards||"";a+=`\n            <div style="padding: 12px; border-bottom: 1px solid #f0f0f0; display: grid !important; grid-template-columns: minmax(50px, 1fr) minmax(20px, 20px) minmax(120px, 3fr) minmax(80px, 1.5fr); gap: 8px; align-items: center; font-size: 14px; color: black; width: 100%; max-width: 100%; box-sizing: border-box; overflow: hidden; ${o?"background: #e7f3ff; font-weight: bold;":""}" ${o?'id="current-user-row"':""}>\n                <span style="text-align: center; font-size: ${r.includes("ü•á")||r.includes("ü•à")||r.includes("ü•â")?"18px":"13px"}; color: black; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${r}</span>\n                <span style="text-align: center; font-size: 18px; color: black; font-weight: 300; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${s}</span>\n                <span style="text-align: left; color: ${o?"#0066cc":"black"}; font-weight: 300; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${e.username||"Player "+(t+1)}</span>\n                <span style="text-align: left; color: black; font-weight: 300; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${(e.total_score||0).toFixed(1)}</span>\n            </div>\n        `}),a+="\n            </div>\n        </div>\n    </div>",e.innerHTML=a,setTimeout(()=>{const e=document.getElementById("current-user-row");if(e){const t=e.closest('[style*="overflow-y: auto"]');if(t){const n=t.getBoundingClientRect(),o=e.getBoundingClientRect(),a=t.scrollTop+(o.top-n.top)-n.height/2+o.height/2;t.scrollTo({top:a,behavior:"smooth"})}else e.scrollIntoView({behavior:"smooth",block:"center"})}},100)}function hideAllCompetitionViews(){["competitionMainView","competitionActiveView","competitionCreateView","competitionLeaderboardView","competitionExpiredView"].forEach(e=>{const t=document.getElementById(e);t&&(t.style.display="none")})}function openFullCompetitionInterface(){closeCompetitionModal(),window.CompetitionUI?window.CompetitionUI.showCompetitionInterface():console.warn("Competition UI not available")}async function refreshCompetitionLeaderboard(e){console.log("üîÑ Refreshing competition leaderboard:",e),await showCompetitionLeaderboard(e),console.log("‚úÖ Leaderboard refreshed")}async function copyCompetitionLink(e){try{const t=`${window.location.origin}${window.location.pathname}?join=${e}`;let n=localStorage.getItem(`compDetails_${e}`);if(!n&&window.CompetitionManager)try{const o=await window.CompetitionManager.getCompetition(e);o&&(localStorage.setItem(`compDetails_${e}`,JSON.stringify({name:o.name,startDate:o.start_date,endDate:o.end_date,link:t})),n=localStorage.getItem(`compDetails_${e}`))}catch(e){console.warn("Could not fetch competition details:",e)}let o=t,a=`<a href="${t}">${t}</a>`;if(n){const e=JSON.parse(n),i=formatCompetitionDate(e.startDate),r=formatCompetitionDate(e.endDate);o=`Join my Daily Shapes competition!\nRuns from ${i} to ${r}\nDon't be a square - join the fun!\n\n${t}`,a=`Join my Daily Shapes competition!<br>\nRuns from ${i} to ${r}<br>\nDon't be a square - join the fun!<br><br>\n<a href="${t}">${t}</a>`}else o=`Join my Daily Shapes competition!\nDon't be a square - join the fun!\n\n${t}`,a=`Join my Daily Shapes competition!<br>\nDon't be a square - join the fun!<br><br>\n<a href="${t}">${t}</a>`;try{const e=new ClipboardItem({"text/plain":new Blob([o],{type:"text/plain"}),"text/html":new Blob([a],{type:"text/html"})});navigator.clipboard.write([e]).then(()=>{showCopyNotification()}).catch(()=>{navigator.clipboard.writeText(o).then(()=>{showCopyNotification()}).catch(()=>{fallbackCopyTextToClipboard(o)})})}catch(e){try{navigator.clipboard.writeText(o).then(()=>{showCopyNotification()}).catch(()=>{fallbackCopyTextToClipboard(o)})}catch(e){fallbackCopyTextToClipboard(o)}}}catch(e){console.error("Error copying competition link:",e)}}function fallbackCopyTextToClipboard(e){const t=document.createElement("textarea");t.value=e,t.style.top="0",t.style.left="0",t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.focus(),t.select();try{document.execCommand("copy")&&showCopyNotification()}catch(e){console.error("Fallback: Could not copy text: ",e)}document.body.removeChild(t)}function showCopyNotification(){const e=document.createElement("div");e.style.cssText="\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        background: white;\n        color: black;\n        border: 2px solid black;\n        padding: 12px 24px;\n        border-radius: 8px;\n        font-size: 14px;\n        font-weight: bold;\n        box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n        z-index: 10000;\n        pointer-events: none;\n        text-align: center;\n    ",e.textContent="Competition link copied",document.body.appendChild(e),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},1e3)}function testCompetitionLeaderboard(){const e=["AlexGamer","BettyShapes","CharlieAce","DianaSniper","EthanPro","FionaSharp","GeorgeKing","HelenStar","IvanMaster","JuliaCut","KevinBest","LindaWiz","MikeChamp","NancySkill","OscarTop","PaulaShot","QuinnEdge","RachelFast","SamShapes","TinaExact"].map((e,t)=>{const n=Math.max(0,95-3*t+10*Math.random()-5),o=Math.floor(7*Math.random())+1,a=Math.round(n*o*10)/10;let i="";return 0===t?i="üëëüíØ":t<3?i="üëë":Math.random()<.3&&(i="üíØ"),{user_id:`test_user_${t+1}`,username:e,total_score:a,days_played:o,participant_count:20,dailyAwards:i}});e.sort((e,t)=>t.total_score-e.total_score);const t={id:"test_competition_123",name:"TESTO Competition - 20 Players",start_date:"2025-01-15",end_date:"2025-01-21",description:"Test competition with 20 players to check leaderboard display"};window.AuthService||(window.AuthService={}),window.AuthService.currentUser||(window.AuthService.currentUser={}),window.AuthService.currentUser.id="test_user_8";const n=document.getElementById("competitionLeaderboardContainer");n?(renderLeaderboardTable(n,e,t),hideAllCompetitionViews(),document.getElementById("competitionLeaderboardView").style.display="block",console.log("üéÆ Test competition leaderboard created with 20 players"),console.log("üìä Current user (test_user_8) should be highlighted in blue"),console.log("üìä Leaderboard data:",e)):console.error("‚ùå Leaderboard container not found")}function isAmericanUser(){const e=Intl.DateTimeFormat().resolvedOptions().timeZone;if(e.startsWith("Australia/")||e.startsWith("Europe/")||e.startsWith("Asia/")||e.startsWith("Africa/")||e.startsWith("Antarctica/")||"UTC"===e)return!1;return!!["America/New_York","America/Chicago","America/Denver","America/Los_Angeles","America/Phoenix","America/Anchorage","Pacific/Honolulu","America/Detroit","America/Kentucky/Louisville","America/Indiana/Indianapolis","America/Boise","America/North_Dakota/Center","America/Menominee","America/Metlakatla","US/Eastern","US/Central","US/Mountain","US/Pacific","US/Alaska","US/Hawaii"].includes(e)}function formatDateForUser(e){const t=new Date(e);return isAmericanUser()?t.toLocaleDateString("en-US"):t.toLocaleDateString("en-GB")}async function showJoinCompetitionModal(e){console.log("üö® showJoinCompetitionModal called with ID:",e),console.trace("üö® Call stack:");const t=document.getElementById("joinCompetitionModal"),n=document.getElementById("joinCompetitionContent");if(!t||!n)return void console.error("Join competition modal elements not found");if(await checkUserParticipation(e))return console.log("üîó User already participating, showing already playing modal instead"),void showAlreadyPlayingModal(e);console.log("üö® About to show join competition modal"),n.innerHTML="<p>Loading competition details...</p>",t.style.display="flex";try{const o=await window.CompetitionManager.getCompetition(e);if(o){if(isUserSignedIn()){const a=new Date(o.start_date),i=new Date;i.setHours(0,0,0,0);const r=new Date(o.start_date);r.setHours(0,0,0,0);const s=r.getTime()===i.getTime(),c=e=>{if(Intl.DateTimeFormat().resolvedOptions().timeZone?.includes("America")||navigator.language?.startsWith("en-US")){return`${String(e.getMonth()+1).padStart(2,"0")}/${String(e.getDate()).padStart(2,"0")}/${String(e.getFullYear()).slice(-2)}`}return`${String(e.getDate()).padStart(2,"0")}/${String(e.getMonth()+1).padStart(2,"0")}/${String(e.getFullYear()).slice(-2)}`},l=new Date(o.start_date),d=new Date(o.end_date),p=Math.ceil((d-l)/864e5)+1,u=s?"Today":c(a);n.innerHTML=`\n                    <div class="success-message" style="padding: 12px 0 8px 0 !important; margin-bottom: 0 !important;">\n                        <p style="font-size: 14px; margin-bottom: 6px; color: #666;">Join Competition</p>\n                        <h2 style="font-size: 24px; font-weight: bold; margin: 0 0 10px 0;">${o.name.toUpperCase()}</h2>\n                        <p style="margin: 0 0 5px 0; font-size: 15px;">${o.description||""}</p>\n                        <p style="margin: 0 0 5px 0; font-size: 15px;">Duration: ${p} days starting ${u}</p>\n                        <p style="margin: 0; font-size: 15px;">Created by: ${o.creator_username||o.creator_id||"Daily Shapes"}</p>\n                    </div>\n\n                    <div class="success-navigation" style="padding-top: 8px !important; padding-bottom: 0px !important; margin-bottom: 0 !important;">\n                        <div class="success-buttons" style="margin-bottom: 0 !important;">\n                            <button class="success-nav-btn primary" onclick="joinCompetitionFromModal('${e}')">\n                                Accept\n                            </button>\n                            <button class="success-nav-btn tertiary" onclick="closeJoinCompetitionModal()">\n                                <span class="btn-icon">‚úï</span>\n                                Cancel\n                            </button>\n                        </div>\n                    </div>\n                `;const g=t.querySelector(".success-modal-body");g&&(g.style.paddingTop="8px",g.style.paddingBottom="0px");const m=t.querySelector(".success-modal-content");m&&(m.style.paddingBottom="12px")}else n.innerHTML=`\n                    <div class="success-message">\n                        <div class="welcome-icon">üèÜ</div>\n                        <h3>Join Competition</h3>\n                        <p><strong>${o.name}</strong></p>\n                        <p>You need to sign up or log in to join this competition.</p>\n                    </div>\n                    \n                    <div class="success-navigation">\n                        <div class="success-buttons">\n                            <button class="success-nav-btn primary" onclick="signupToJoinCompetition('${e}')">\n                                <span class="btn-icon">üë§</span>\n                                Sign Up to Join\n                            </button>\n                            <button class="success-nav-btn secondary" onclick="loginToJoinCompetition('${e}')">\n                                <span class="btn-icon">üîë</span>\n                                Log In to Join\n                            </button>\n                            <button class="success-nav-btn tertiary" onclick="closeJoinCompetitionModal()">\n                                <span class="btn-icon">‚úï</span>\n                                Cancel\n                            </button>\n                        </div>\n                    </div>\n                `}else n.innerHTML='\n                <div class="success-message">\n                    <div class="welcome-icon">‚ùå</div>\n                    <h3>Competition Not Found</h3>\n                    <p>The competition you\'re trying to join doesn\'t exist or has been removed.</p>\n                </div>\n                \n                <div class="success-navigation">\n                    <div class="success-buttons">\n                        <button class="success-nav-btn tertiary" onclick="closeJoinCompetitionModal()">\n                            <span class="btn-icon">‚úï</span>\n                            Close\n                        </button>\n                    </div>\n                </div>\n            '}catch(e){console.error("Error loading competition details:",e),n.innerHTML='\n            <div class="success-message">\n                <div class="welcome-icon">‚ùå</div>\n                <h3>Error</h3>\n                <p>Unable to load competition details. Please try again.</p>\n            </div>\n            \n            <div class="success-navigation">\n                <div class="success-buttons">\n                    <button class="success-nav-btn tertiary" onclick="closeJoinCompetitionModal()">\n                        <span class="btn-icon">‚úï</span>\n                        Close\n                    </button>\n                </div>\n            </div>\n        '}}function closeJoinCompetitionModal(){const e=document.getElementById("joinCompetitionModal");e&&(e.style.display="none",window.CompetitionManager&&window.CompetitionManager.clearJoinLink(),sessionStorage.removeItem("pendingJoinCompetitionId"),console.log("üóëÔ∏è Cleared pending competition join"))}async function joinCompetitionFromModal(e){try{const t=window.AuthService?.currentUser?.id||window.AuthManager?.getCurrentUser()?.id;if(!t)return void alert("Please log in to join the competition");const n=await window.CompetitionManager.joinCompetition(e,t);if(n.success){closeJoinCompetitionModal();const e=document.getElementById("joinCompetitionModal"),t=document.getElementById("joinCompetitionContent");e&&t&&(t.innerHTML=`\n                    <div style="text-align: center; padding: 30px;">\n                        <div style="font-size: 48px; margin-bottom: 20px;">‚úÖ</div>\n                        <h3 style="margin-bottom: 10px;">Successfully joined!</h3>\n                        <p style="color: #666; margin-bottom: 20px;">\n                            ${"Already participating"===n.message?"You were already part of this competition":"Welcome to the competition!"}\n                        </p>\n                        <button class="success-nav-btn primary" onclick="closeJoinCompetitionModal(); openCompetitionModal();">\n                            Continue\n                        </button>\n                    </div>\n                `,setTimeout(()=>{closeJoinCompetitionModal(),openCompetitionModal()},500))}else{const e=document.getElementById("joinCompetitionContent");e&&(e.innerHTML=`\n                    <div style="text-align: center; padding: 30px;">\n                        <div style="font-size: 48px; margin-bottom: 20px;">‚ùå</div>\n                        <h3 style="margin-bottom: 10px;">Unable to join</h3>\n                        <p style="color: #666; margin-bottom: 20px;">${n.error||"Unknown error"}</p>\n                        <button class="success-nav-btn secondary" onclick="location.reload()">\n                            Try Again\n                        </button>\n                    </div>\n                `)}}catch(e){console.error("Error joining competition:",e);const t=document.getElementById("joinCompetitionContent");t&&(t.innerHTML='\n                <div style="text-align: center; padding: 30px;">\n                    <div style="font-size: 48px; margin-bottom: 20px;">‚ùå</div>\n                    <h3 style="margin-bottom: 10px;">Connection Error</h3>\n                    <p style="color: #666; margin-bottom: 20px;">Unable to connect to the competition system</p>\n                    <button class="success-nav-btn secondary" onclick="location.reload()">\n                        Try Again\n                    </button>\n                </div>\n            ')}}function signupToJoinCompetition(e){sessionStorage.setItem("pendingJoinCompetitionId",e),closeJoinCompetitionModal(),window.openAuthModal&&window.openAuthModal("signup","Create an account to join this competition")}function loginToJoinCompetition(e){sessionStorage.setItem("pendingJoinCompetitionId",e),closeJoinCompetitionModal(),window.openAuthModal&&window.openAuthModal("login","Log in to join this competition")}async function processJoinLink(){const e=new URLSearchParams(window.location.search).get("join");if(e){console.log("üîó Processing join link with competition ID:",e);const t=e;if(window.AuthService?.isLoggedIn()){console.log("üîó User is logged in, checking participation status");await checkUserParticipation(t)?(console.log("üîó User already participating, showing already playing modal"),showAlreadyPlayingModal(t)):(console.log("üîó User not participating, showing join competition modal"),showJoinCompetitionModal(t))}else console.log("üîó User not logged in, storing pending join and showing auth"),sessionStorage.setItem("pendingJoinCompetitionId",t),showCompetitionAuthPopup();const n=window.location.protocol+"//"+window.location.host+window.location.pathname;window.history.replaceState({},document.title,n)}}function showCompetitionAuthPopup(){let e=document.getElementById("competitionAuthPopup");e||(e=document.createElement("div"),e.id="competitionAuthPopup",e.className="auth-popup-overlay",e.innerHTML='\n            <div class="auth-popup-content">\n                <button class="auth-popup-close" id="compAuthClose" aria-label="Close">√ó</button>\n                <h3>Join Competition</h3>\n                <p>To join this Daily Shapes competition, you\'ll need a free account.</p>\n                <div class="auth-popup-buttons">\n                    <button id="compAuthCreateAccount" class="auth-popup-btn primary">Create Account</button>\n                    <button id="compAuthSignIn" class="auth-popup-btn secondary">Sign In</button>\n                </div>\n            </div>\n        ',document.body.appendChild(e),document.getElementById("compAuthCreateAccount").addEventListener("click",()=>{closeCompetitionAuthPopup(),window.openAuthModal&&window.openAuthModal("signup","Create an account to join this competition")}),document.getElementById("compAuthSignIn").addEventListener("click",()=>{closeCompetitionAuthPopup(),window.openAuthModal&&window.openAuthModal("login","Sign in to join this competition")}),document.getElementById("compAuthClose").addEventListener("click",()=>{closeCompetitionAuthPopup(),sessionStorage.removeItem("pendingJoinCompetitionId")}),e.addEventListener("click",t=>{t.target===e&&(closeCompetitionAuthPopup(),sessionStorage.removeItem("pendingJoinCompetitionId"))})),e.style.display="flex"}function closeCompetitionAuthPopup(){const e=document.getElementById("competitionAuthPopup");e&&(e.style.display="none")}async function checkUserParticipation(e){try{console.log("üîó Checking participation for competition:",e);const t=window.AuthService?.currentUser?.id;if(!t)return console.log("‚ùå No user ID available for participation check"),!1;if(console.log("üîó Checking database directly for user:",t),window.SupabaseConfig?.client){const{data:n,error:o}=await window.SupabaseConfig.client.from("competition_participants").select("id, competition_id, status").eq("competition_id",e).eq("user_id",t).maybeSingle();if(o)return console.error("‚ùå Database error checking participation:",o),await checkUserParticipationCached(e);const a=!!n;return console.log("üîó Database participation check result:",a),n&&console.log("üîó Found participation record:",n),a}return console.log("‚ö†Ô∏è Supabase not available, falling back to cached check"),await checkUserParticipationCached(e)}catch(e){return console.error("‚ùå Error checking user participation:",e),!1}}async function checkUserParticipationCached(e){try{console.log("üîó Using cached participation check for:",e);let t=0;const n=3;for(;t<n;)try{window.CompetitionManager&&window.CompetitionManager.loadUserCompetitions&&(console.log(`üîó Loading user competitions (attempt ${t+1}/${n})`),await window.CompetitionManager.loadUserCompetitions());break}catch(e){if(t++,console.log(`‚ö†Ô∏è Failed to load user competitions (attempt ${t}):`,e),t>=n)throw e;await new Promise(e=>setTimeout(e,500))}const o=window.CompetitionManager?.userCompetitions||[];console.log("üîó Cached user competitions:",o.map(e=>({id:e.id||e.competition_id,name:e.name})));const a=o.some(t=>{const n=t.competition_id===e,o=t.id===e;return n||o});return console.log("üîó Cached participation check result:",a),a}catch(e){return console.error("‚ùå Error in cached participation check:",e),!1}}function showAlreadyPlayingModal(e){console.log("üéØ SHOWING ALREADY PLAYING MODAL for competition:",e),showAlreadyPlayingNotification()}function showAlreadyPlayingNotification(){console.log("üéØ CREATING ALREADY PLAYING NOTIFICATION POPUP");const e=document.createElement("div");e.style.cssText="\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        background: white;\n        color: black;\n        border: 2px solid black;\n        padding: 12px 24px;\n        border-radius: 8px;\n        font-size: 14px;\n        font-weight: bold;\n        box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n        z-index: 10000;\n        pointer-events: none;\n        text-align: center;\n    ",e.textContent="You're already playing in this competition",document.body.appendChild(e),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},1e3)}function viewCompetitionLeaderboard(e){if(closeJoinCompetitionModal(),window.CustomCompetitionManager&&window.CustomCompetitionManager.viewCompetitionLeaderboard)console.log("üìä Opening leaderboard for competition:",e),window.CustomCompetitionManager.viewCompetitionLeaderboard(e);else{console.log("üìä CustomCompetitionManager not available, triggering event");const t=new CustomEvent("showCompetitionLeaderboard",{detail:{competitionId:e}});document.dispatchEvent(t)}}function generateShortCode(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let t="";for(let n=0;n<6;n++)t+=e.charAt(Math.floor(36*Math.random()));return t}function formatCompetitionDate(e){return e===(new Date).toISOString().split("T")[0]?"Today":formatDateForUser(e)}function copyJoinLink(){const e=document.getElementById("joinLinkInput");if(e){const o=e.value,a=o.split("?join=")[1],i=localStorage.getItem(`compDetails_${a}`);if(i){const e=JSON.parse(i),a=formatCompetitionDate(e.startDate),r=formatCompetitionDate(e.endDate),s=`Join my Daily Shapes competition!\nRuns from ${a} to ${r}\nDon't be a square - join the fun!\n\n${o}`,c=`Join my Daily Shapes competition!<br>\nRuns from ${a} to ${r}<br>\nDon't be a square - join the fun!<br><br>\n<a href="${o}">${o}</a>`,l=document.querySelector(".success-nav-btn.secondary");try{const e=new ClipboardItem({"text/plain":new Blob([s],{type:"text/plain"}),"text/html":new Blob([c],{type:"text/html"})});navigator.clipboard.write([e]).then(()=>{t(l)}).catch(()=>{navigator.clipboard.writeText(s).then(()=>{t(l)}).catch(()=>{n(s,l)})})}catch(e){try{navigator.clipboard.writeText(s).then(()=>{t(l)}).catch(()=>{n(s,l)})}catch(e){n(s,l)}}}else{e.select(),e.setSelectionRange(0,99999);try{document.execCommand("copy");t(document.querySelector(".success-nav-btn.secondary"))}catch(e){console.error("Failed to copy: ",e),alert("Failed to copy link. Please select and copy manually.")}}}function t(e){if(e){const t=e.innerHTML;e.innerHTML='<span class="btn-icon">‚úÖ</span>Copied!',setTimeout(()=>{e.innerHTML=t},2e3)}showCopyNotification()}function n(e,n){const o=document.createElement("textarea");o.value=e,o.style.top="0",o.style.left="0",o.style.position="fixed",document.body.appendChild(o),o.focus(),o.select();try{document.execCommand("copy")?t(n):alert("Failed to copy. Please copy manually.")}catch(e){console.error("Fallback: Failed to copy: ",e),alert("Failed to copy. Please copy manually.")}document.body.removeChild(o)}}window.isUserSignedIn=isUserSignedIn,window.showUserProfileMenu=showUserProfileMenu,window.refreshAuthState=async function(){console.log("üîÑ Manual auth refresh requested"),window.AuthService&&(await window.AuthService.initialize(),console.log("‚úÖ AuthService refreshed"),updateButtonStates(),document.dispatchEvent(new CustomEvent("authStateChanged")),console.log("‚úÖ UI updated"))},window.openCompetitionModal=openCompetitionModal,window.closeCompetitionModal=closeCompetitionModal,window.showCompetitionMain=showCompetitionMain,window.showActiveCompetitions=showActiveCompetitions,window.showCreateCompetition=showCreateCompetition,window.showExpiredCompetitions=showExpiredCompetitions,window.createNewCompetition=createNewCompetition,window.viewCompetitionDetails=viewCompetitionDetails,window.showCompetitionLeaderboard=showCompetitionLeaderboard,window.copyCompetitionLink=copyCompetitionLink,window.showCopyNotification=showCopyNotification,window.isAmericanUser=isAmericanUser,window.formatDateForUser=formatDateForUser,window.testCompetitionLeaderboard=testCompetitionLeaderboard,window.openFullCompetitionInterface=openFullCompetitionInterface,window.showJoinCompetitionModal=showJoinCompetitionModal,window.closeJoinCompetitionModal=closeJoinCompetitionModal,window.processJoinLink=processJoinLink,window.joinCompetitionFromModal=joinCompetitionFromModal,window.signupToJoinCompetition=signupToJoinCompetition,window.loginToJoinCompetition=loginToJoinCompetition,window.copyJoinLink=copyJoinLink,window.handleAuthSuccess=function(){console.log("üîê handleAuthSuccess called - processing authentication success");const e=sessionStorage.getItem("pendingJoinCompetitionId");return setTimeout(async()=>{try{console.log("üîê Re-initializing AuthService to detect new session after login"),window.AuthService&&(await window.AuthService.initialize(),console.log("‚úÖ AuthService re-initialized, new state:",{isGuest:window.AuthService.isGuest,currentUser:!!window.AuthService.currentUser,userId:window.AuthService.currentUser?.id})),window.updateLoginStatus&&window.updateLoginStatus(!0),window.updateMenuState&&window.updateMenuState(),updateMenuVisibility(),updateButtonStates(),document.dispatchEvent(new CustomEvent("authStateChanged")),console.log("‚úÖ Login completed - competition handling delegated to authStateChanged event")}catch(t){console.error("‚ùå Error in handleAuthSuccess:",t),e&&showJoinCompetitionModal(e)}},300),!0};let hasProcessedInitialJoinLink=!1;function updateButtonStates(){updateActiveButtonState()}function updateActiveButtonState(){console.log("üîµ Active state updated for dropdown menu")}function showAuthenticationPopup(){let e=document.getElementById("authRequiredPopup");e||(e=document.createElement("div"),e.id="authRequiredPopup",e.className="auth-popup-overlay",e.innerHTML='\n            <div class="auth-popup-content">\n                <button class="auth-popup-close" id="authClose" aria-label="Close">√ó</button>\n                <h3>Account Required</h3>\n                <p>You need to sign in to access this feature.</p>\n                <div class="auth-popup-buttons">\n                    <button id="authCreateAccount" class="auth-popup-btn primary">Create Account</button>\n                    <button id="authSignIn" class="auth-popup-btn secondary">Sign In</button>\n                </div>\n            </div>\n        ',document.body.appendChild(e),document.getElementById("authCreateAccount").addEventListener("click",()=>{closeAuthPopup(),openAuthModal(),switchAuthMode("signup")}),document.getElementById("authSignIn").addEventListener("click",()=>{closeAuthPopup(),openAuthModal(),switchAuthMode("login")}),document.getElementById("authClose").addEventListener("click",closeAuthPopup),e.addEventListener("click",t=>{t.target===e&&closeAuthPopup()})),e.style.display="flex"}function closeAuthPopup(){const e=document.getElementById("authRequiredPopup");e&&(e.style.display="none")}async function showUserProfileMenu(){try{console.log("üìã showUserProfileMenu called - entering function");let e=document.getElementById("userProfilePopup");e?console.log("üìã Profile popup already exists"):(e=document.createElement("div"),e.id="userProfilePopup",e.className="profile-popup-overlay",document.body.appendChild(e),console.log("üìã Profile popup created"));let t="User",n="User";if(window.supabase&&window.supabase.auth)try{const{data:{session:e}}=await window.supabase.auth.getSession();e&&e.user&&(t=e.user.email||"User",n=t.split("@")[0],console.log("üìã Got user from Supabase:",t))}catch(e){console.log("‚ö†Ô∏è Could not get Supabase session in profile menu:",e)}if("User"===t){const e=JSON.parse(localStorage.getItem("sb-zxrfhumifazjxgikltkz-auth-token")||"{}");e?.currentSession?.user&&(t=e.currentSession.user.email||"User",n=t.split("@")[0],console.log("üìã Got user from localStorage:",t))}"User"===t&&window.AuthService&&window.AuthService.currentUser&&(t=window.AuthService.currentUser.email||"User",n=t.split("@")[0],console.log("üìã Got user from AuthService:",t)),console.log("üìã Final user data:",{userName:n,userEmail:t});let o={gamesPlayed:parseInt(localStorage.getItem("totalGamesPlayed")||"0"),perfectCuts:parseInt(localStorage.getItem("totalPerfectCuts")||"0"),averageScore:parseFloat(localStorage.getItem("averageScore")||"0").toFixed(1),currentStreak:parseInt(localStorage.getItem("currentStreak")||"0"),bestStreak:parseInt(localStorage.getItem("bestStreak")||"0"),competitionsWon:0};if(window.UserAccountManager&&window.UserAccountManager.getUserStats){const e=window.UserAccountManager.getUserStats();e&&(o={gamesPlayed:o.gamesPlayed,perfectCuts:e.perfectCuts||0,averageScore:(e.averageScore||0).toFixed(1),currentStreak:e.currentStreak||0,bestStreak:e.bestStreak||0,competitionsWon:void 0!==e.competitionsWon&&null!==e.competitionsWon?e.competitionsWon:0})}void 0!==o.competitionsWon&&null!==o.competitionsWon||(o.competitionsWon=0),e.innerHTML=`\n        <div class="profile-popup-content">\n            <button class="profile-popup-close" id="profileClose" aria-label="Close">√ó</button>\n            <h3>${n}</h3>\n\n            <div class="profile-stats">\n                <h4>Statistics</h4>\n                <div class="stats-grid">\n                    <div class="stat-item">\n                        <span class="stat-label">Perfect Cuts</span>\n                        <span class="stat-value">${o.perfectCuts}</span>\n                    </div>\n                    <div class="stat-item">\n                        <span class="stat-label">Average Score</span>\n                        <span class="stat-value">${o.averageScore}%</span>\n                    </div>\n                    <div class="stat-item">\n                        <span class="stat-label">Daily Streak</span>\n                        <span class="stat-value">${o.currentStreak} üî•</span>\n                    </div>\n                    <div class="stat-item">\n                        <span class="stat-label">Comps Won</span>\n                        <span class="stat-value">${o.competitionsWon}</span>\n                    </div>\n                </div>\n            </div>\n            \n            <div class="profile-buttons">\n                <button id="changePasswordBtn" class="profile-popup-btn secondary">Change Password</button>\n                <button id="logoutBtn" class="profile-popup-btn primary">Log Out</button>\n            </div>\n        </div>\n    `,document.getElementById("profileClose").addEventListener("click",closeProfilePopup),document.getElementById("changePasswordBtn").addEventListener("click",()=>{closeProfilePopup(),showChangePasswordModal()}),document.getElementById("logoutBtn").addEventListener("click",async()=>{closeProfilePopup(),await handleLogout()}),e.addEventListener("click",t=>{t.target===e&&closeProfilePopup()}),e.style.display="flex",console.log("üìã Profile popup displayed with display:flex")}catch(e){console.error("‚ùå Error in showUserProfileMenu:",e),console.error("Stack trace:",e.stack),alert("Error showing profile menu. Please try again.")}}function closeProfilePopup(){const e=document.getElementById("userProfilePopup");e&&(e.style.display="none")}async function showChangePasswordModal(){console.log("üîê Opening change password modal");const e=document.getElementById("changePasswordModal");e&&e.remove();const t=document.createElement("div");t.id="changePasswordModal",t.style.cssText="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 3000;",t.innerHTML='\n        <div style="background: white; padding: 30px; border-radius: 12px; border: 2px solid black; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); max-width: 400px; width: 90%; position: relative;">\n            <button class="auth-modal-close" onclick="document.getElementById(\'changePasswordModal\').remove()" style="position: absolute; top: 10px; right: 10px;">√ó</button>\n            <h3 style="margin: 0 0 10px 0; font-size: 24px; font-weight: 700; text-align: center;">Change Password</h3>\n            <p style="color: #666; margin-bottom: 20px; text-align: center;">Enter your new password below</p>\n            \n            <div style="margin-bottom: 15px;">\n                <input type="password" id="newPassword" placeholder="New Password" \n                    style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;">\n            </div>\n            \n            <div style="margin-bottom: 20px;">\n                <input type="password" id="confirmPassword" placeholder="Confirm Password" \n                    style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;">\n            </div>\n            \n            <div id="passwordError" style="color: #ff4444; margin-bottom: 15px; display: none; text-align: center;"></div>\n            <div id="passwordSuccess" style="color: #44aa44; margin-bottom: 15px; display: none; text-align: center;"></div>\n            \n            <button id="submitPasswordChange" \n                style="width: 100%; padding: 12px 24px; border: 2px solid black; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; background: #6496FF; color: white;">\n                Update Password\n            </button>\n            \n            <button onclick="document.getElementById(\'changePasswordModal\').remove()" \n                style="width: 100%; margin-top: 10px; padding: 12px 24px; border: 2px solid #666; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; background: white; color: #333;">\n                Cancel\n            </button>\n        </div>\n    ',document.body.appendChild(t),document.getElementById("submitPasswordChange").addEventListener("click",async()=>{const e=document.getElementById("newPassword").value,n=document.getElementById("confirmPassword").value,o=document.getElementById("passwordError"),a=document.getElementById("passwordSuccess"),i=document.getElementById("submitPasswordChange");if(o.style.display="none",a.style.display="none",!e||!n)return o.textContent="Please enter and confirm your new password",void(o.style.display="block");if(e.length<6)return o.textContent="Password must be at least 6 characters long",void(o.style.display="block");if(e!==n)return o.textContent="Passwords do not match",void(o.style.display="block");i.textContent="Updating...",i.disabled=!0,i.style.opacity="0.7";try{let n=null;if(window.SupabaseConfig&&window.SupabaseConfig.client?(n=window.SupabaseConfig.client,console.log("üîê Got Supabase client from SupabaseConfig")):window.supabaseClient?(n=window.supabaseClient,console.log("üîê Got Supabase client from window")):window.supabase&&(n=window.supabase,console.log("üîê Got Supabase client from window.supabase")),console.log("üîê Supabase client check:",{hasClient:!!n,hasAuth:!(!n||!n.auth),hasUpdateUser:!!(n&&n.auth&&n.auth.updateUser)}),!n||!n.auth)throw new Error("Authentication service not available. Please refresh the page and try again.");console.log("üîê Updating password via Supabase...");const{data:r,error:s}=await n.auth.updateUser({password:e});s?(console.error("Password update error:",s),o.textContent=s.message||"Failed to update password",o.style.display="block",i.textContent="Update Password",i.disabled=!1,i.style.opacity="1"):(console.log("‚úÖ Password updated successfully"),a.textContent="Password updated successfully!",a.style.display="block",i.textContent="Success!",i.style.background="#44aa44",setTimeout(()=>{t.remove();const e=document.getElementById("userProfilePopup");e&&e.remove()},2e3))}catch(e){console.error("Password update error:",e),o.textContent=e.message||"An error occurred while updating password",o.style.display="block",i.textContent="Update Password",i.disabled=!1,i.style.opacity="1"}}),t.addEventListener("click",e=>{e.target===t&&t.remove()}),setTimeout(()=>{document.getElementById("newPassword").focus()},100)}async function handleLogout(){try{console.log("üîê Logging out...");let e=null;if(window.SupabaseConfig&&window.SupabaseConfig.client?(e=window.SupabaseConfig.client,console.log("üîê Got Supabase client from SupabaseConfig for logout")):window.supabaseClient&&(e=window.supabaseClient,console.log("üîê Got Supabase client from window for logout")),e&&e.auth){const{error:t}=await e.auth.signOut();t?console.error("Supabase signOut error:",t):console.log("‚úÖ Successfully signed out from Supabase")}localStorage.removeItem("sb-zxrfhumifazjxgikltkz-auth-token"),localStorage.removeItem("userAuthToken"),console.log("‚úÖ Cleared local storage tokens"),window.location.reload()}catch(e){console.error("Logout error:",e),alert("Error logging out. Please try again.")}}async function switchToSection(e){const t=currentSection;currentSection=e,"daily"===t&&"daily"!==e&&window.SimpleRefresh&&window.SimpleRefresh.save&&(window.SimpleRefresh.save(),console.log("üíæ Game state saved when navigating to",e));[".canvas-container",".goal-display",".results-container",".buttons-below-canvas"].forEach(e=>{const t=document.querySelector(e);t&&(t.style.display="none")}),await showSectionContent(e,t),updateActiveButtonState(),updateSectionTitle(e)}function updateSectionTitle(e){const t=document.getElementById("dateTitle");if(t)switch(e){case"archive":t.innerHTML="<strong>Practice</strong>",document.title="Practice - Daily Shapes";break;case"competition":t.innerHTML="<strong>Competitions</strong>",document.title="Competitions - Daily Shapes";break;case"profile":t.innerHTML="<strong>Profile</strong>",document.title="Profile - Daily Shapes";break;default:window.updateDateTitle&&"function"==typeof window.updateDateTitle?(window.updateDateTitle(),document.title=`Daily Shapes #${currentDayNumber||1}`):updateTitle()}}async function showSectionContent(e,t){const n=document.getElementById("sectionContent");if(n&&n.remove(),"daily"===e){return void[".canvas-container",".goal-display",".results-container",".buttons-below-canvas"].forEach(e=>{const t=document.querySelector(e);t&&(t.style.display="")})}const o=document.createElement("div");o.id="sectionContent",o.className="section-content";const a=document.querySelector(".canvas-container");a?a.parentNode.insertBefore(o,a.nextSibling):document.querySelector("main").appendChild(o),o.innerHTML='<div class="loading-content">Loading...</div>';let i="";switch(e){case"archive":i=createPracticeContent();break;case"competition":i=createCompetitionContent();break;case"profile":i=await createProfileContent()}o.innerHTML=i}function createPracticeContent(){return`\n        <div class="section-placeholder">\n            <div class="section-header">\n                <h2>Your Puzzle History</h2>\n                <button class="back-to-daily-btn" onclick="handleBackToDaily()">‚Üê Back to Daily Shapes</button>\n            </div>\n            <div class="placeholder-content">\n                <div class="placeholder-calendar">\n                    <div class="calendar-grid">\n                        ${generateCalendarPlaceholder()}\n                    </div>\n                </div>\n                <div class="placeholder-stats">\n                    <h3>Your Statistics</h3>\n                    <div class="stats-grid">\n                        <div class="stat-item">\n                            <div class="stat-number">--</div>\n                            <div class="stat-label">Puzzles Solved</div>\n                        </div>\n                        <div class="stat-item">\n                            <div class="stat-number">--</div>\n                            <div class="stat-label">Current Streak</div>\n                        </div>\n                        <div class="stat-item">\n                            <div class="stat-number">--</div>\n                            <div class="stat-label">Best Time</div>\n                        </div>\n                    </div>\n                </div>\n                <div class="coming-soon">\n                    <p>üöß Coming Soon - View your puzzle history and statistics</p>\n                </div>\n            </div>\n        </div>\n    `}function createCompetitionContent(){return setTimeout(()=>{window.CompetitionUI&&window.CompetitionUI.showCompetitionInterface()},100),'\n        <div class="section-placeholder">\n            <div class="section-header">\n                <h2>Loading Competitions...</h2>\n                <button class="back-to-daily-btn" onclick="handleBackToDaily()">‚Üê Back to Daily Shapes</button>\n            </div>\n            <div class="placeholder-content">\n                <div style="text-align: center; padding: 40px;">\n                    <div class="loading-spinner" style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #2a5298; border-radius: 50%; animation: spin 1s linear infinite;"></div>\n                    <p>Opening competition interface...</p>\n                </div>\n            </div>\n        </div>'}async function createProfileContent(){let e="Guest",t=null,n=null,o=[];if(isUserSignedIn()&&window.UserAccountManager)try{await window.UserAccountManager.initialize();const a=window.UserAccountManager.getCurrentUser();t=window.UserAccountManager.getUserProfile(),n=window.UserAccountManager.getUserStats(),o=window.UserAccountManager.getUserCompetitions(),a&&!a.isGuest&&(e=t?.username||a.username||"Player")}catch(e){console.error("Error loading user data for profile:",e)}const a=isUserSignedIn();return`\n        <div class="section-placeholder">\n            <div class="section-header">\n                <h2>Profile</h2>\n                <button class="back-to-daily-btn" onclick="handleBackToDaily()">‚Üê Back to Daily Shapes</button>\n            </div>\n            <div class="placeholder-content">\n                <div class="profile-info">\n                    <div class="profile-avatar">\n                        <svg width="64" height="64" viewBox="0 0 24 24" fill="#333">\n                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>\n                        </svg>\n                    </div>\n                    <h3>${e}</h3>\n                    <p class="profile-status">${a?"Signed In":"Guest User"}</p>\n                </div>\n                \n                ${a&&n?`\n                    <div class="profile-stats">\n                        <h4>Game Statistics</h4>\n                        <div class="stats-grid">\n                            <div class="stat-item">\n                                <div class="stat-number">${n.totalDaysPlayed}</div>\n                                <div class="stat-label">Days Played</div>\n                            </div>\n                            <div class="stat-item">\n                                <div class="stat-number">${n.currentStreak}</div>\n                                <div class="stat-label">Current Streak</div>\n                            </div>\n                            <div class="stat-item">\n                                <div class="stat-number">${n.bestStreak}</div>\n                                <div class="stat-label">Best Streak</div>\n                            </div>\n                            <div class="stat-item">\n                                <div class="stat-number">${n.averageScore?.toFixed(1)||"0.0"}</div>\n                                <div class="stat-label">Average Score</div>\n                            </div>\n                        </div>\n                    </div>\n                `:""}\n                \n                ${a&&o.length>0?`\n                    <div class="profile-competitions">\n                        <h4>My Competitions (${o.length})</h4>\n                        <div class="competitions-list">\n                            ${o.slice(0,3).map(e=>`\n                                <div class="competition-item">\n                                    <div class="comp-name">${e.name.toUpperCase()}</div>\n                                    <div class="comp-status status-${e.status}">${e.status}</div>\n                                </div>\n                            `).join("")}\n                            ${o.length>3?`<div class="competition-item more">+${o.length-3} more competitions</div>`:""}\n                        </div>\n                    </div>\n                `:""}\n                \n                <div class="profile-sections">\n                    <div class="profile-section">\n                        <h4>Account Settings</h4>\n                        <div class="settings-list">\n                            ${a?'\n                                <div class="setting-item" onclick="changeUsername()">Change Username</div>\n                                <div class="setting-item" onclick="changePassword()">Change Password</div>\n                                <div class="setting-item" onclick="togglePrivacy()">Privacy Settings</div>\n                                <div class="setting-item" onclick="manageNotifications()">Notifications</div>\n                            ':'\n                                <div class="setting-item disabled">Sign in to access settings</div>\n                            '}\n                        </div>\n                    </div>\n                    \n                    <div class="profile-section">\n                        <h4>Competition Stats</h4>\n                        ${a&&n?`\n                            <div class="competition-stats">\n                                <p>Competitions Created: <strong>${n.competitionsCreated}</strong></p>\n                                <p>Competitions Joined: <strong>${n.competitionsJoined}</strong></p>\n                                <p>Competitions Won: <strong>${n.competitionsWon}</strong></p>\n                                ${n.globalRanking?`<p>Global Ranking: <strong>#${n.globalRanking}</strong></p>`:""}\n                            </div>\n                        `:'\n                            <p class="no-data">Sign in to view competition statistics</p>\n                        '}\n                    </div>\n                </div>\n                \n                ${a?'\n                    <div class="profile-actions">\n                        <button onclick="refreshProfile()" class="secondary-btn">Refresh Data</button>\n                        <button onclick="handleLogout()" class="danger-btn">Sign Out</button>\n                    </div>\n                ':'\n                    <div class="profile-actions">\n                        <button onclick="openAuthModal(); switchAuthMode(\'signup\')" class="primary-btn">Create Account</button>\n                        <button onclick="openAuthModal(); switchAuthMode(\'login\')" class="secondary-btn">Sign In</button>\n                    </div>\n                '}\n                \n                ${a?"":'\n                    <div class="coming-soon">\n                        <p>üìä Sign in to view your detailed statistics and manage competitions</p>\n                    </div>\n                '}\n            </div>\n        </div>\n    `}function generateCalendarPlaceholder(){return Array.from({length:30},(e,t)=>t+1).map(e=>`\n        <div class="calendar-day ${Math.random()>.7?"solved":""}">\n            <span class="day-number">${e}</span>\n            ${Math.random()>.7?'<span class="solved-indicator">‚úì</span>':""}\n        </div>\n    `).join("")}async function handleBackToDaily(){await switchToSection("daily");const e=document.getElementById("menuOptions");e&&e.classList.contains("expanded")&&collapseMenu()}async function handleOption1Click(){console.log("Account selected"),collapseMenu();let e=!1;if(window.supabase&&window.supabase.auth)try{const{data:{session:t}}=await window.supabase.auth.getSession();t&&t.user&&(e=!0,console.log("‚úÖ User logged in (Supabase session):",t.user.email))}catch(e){console.log("‚ö†Ô∏è Could not check Supabase session:",e)}if(!e){const t=localStorage.getItem("sb-zxrfhumifazjxgikltkz-auth-token");if(t)try{const n=JSON.parse(t);n?.currentSession?.user&&(e=!0,console.log("‚úÖ User logged in (localStorage):",n.currentSession.user.email))}catch(e){console.log("‚ö†Ô∏è Could not parse localStorage token")}}if(e||!window.AuthService||window.AuthService.isGuest||(e=!0,console.log("‚úÖ User logged in (AuthService)")),console.log("üîç Final login status:",e),e){console.log("üìã Creating profile popup inline...");try{const e=document.getElementById("userProfilePopup");e&&e.remove();const t=document.createElement("div");t.id="userProfilePopup",t.className="profile-popup-overlay",t.style.cssText="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 2000;";let n="User",o="User";if(window.AuthService&&window.AuthService.currentUser)n=window.AuthService.currentUser.email||"User",o=window.AuthService.currentUser.username||n.split("@")[0],console.log("üìã Got user from AuthService:",n,"username:",o);else{const e=JSON.parse(localStorage.getItem("sb-zxrfhumifazjxgikltkz-auth-token")||"{}");e?.currentSession?.user&&(n=e.currentSession.user.email||"User",o=e.currentSession.user.user_metadata?.username||n.split("@")[0])}let a={gamesPlayed:0,perfectCuts:0,averageScore:"0.0",currentStreak:0};try{if(window.UserAccountManager){await window.UserAccountManager.initialize();const e=window.UserAccountManager.getUserStats(),t=window.UserAccountManager.getUserProfile();if(t&&t.username&&(o=t.username,console.log("üìã Updated username from UserAccountManager profile:",o)),e){console.log("üìä User Profile Debug - Raw stats from UserAccountManager:",e);let t=0;t=window.AuthService&&"function"==typeof window.AuthService.getPerfectCutsCount?await window.AuthService.getPerfectCutsCount():e.competitionsWon||0,a={perfectCuts:e.perfectCuts??0,competitionsWon:void 0!==e.competitionsWon&&null!==e.competitionsWon?e.competitionsWon:0,averageScore:(e.averageScore||0).toFixed(1),currentStreak:e.currentStreak??0}}}}catch(e){console.error("Error loading user statistics:",e)}t.innerHTML=`\n                <div class="profile-popup-content" style="background: white; padding: 30px; border-radius: 12px; border: 2px solid black; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); text-align: center; max-width: 450px; width: 90%; position: relative;">\n                    <button onclick="document.getElementById('userProfilePopup').remove()" style="position: absolute !important; top: 10px !important; right: 10px !important; width: 28px !important; height: 28px !important; min-width: 28px !important; min-height: 28px !important; max-width: 28px !important; max-height: 28px !important; border-radius: 50% !important; background: white !important; border: 2px solid #000 !important; font-size: 14px !important; cursor: pointer !important; color: #333 !important; display: flex !important; align-items: center !important; justify-content: center !important; padding: 0 !important; margin: 0 !important; line-height: 1 !important; font-weight: bold !important; box-sizing: border-box !important;">√ó</button>\n                    <h3 style="margin: 0 0 25px 0; font-size: 28px; font-weight: 700;">${o}</h3>\n\n                    <div style="background: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 25px; border: 1px solid #e0e0e0;">\n                        <h4 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600;">Statistics</h4>\n                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">\n                            <div>\n                                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">PERFECT CUTS</div>\n                                <div style="font-size: 20px; font-weight: 700;">${a.perfectCuts}</div>\n                            </div>\n                            <div>\n                                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">COMPS WON</div>\n                                <div style="font-size: 20px; font-weight: 700;">${a.competitionsWon}</div>\n                            </div>\n                            <div>\n                                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">AVERAGE SCORE</div>\n                                <div style="font-size: 20px; font-weight: 700;">${a.averageScore}/100</div>\n                            </div>\n                            <div>\n                                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">DAILY STREAK</div>\n                                <div style="font-size: 20px; font-weight: 700;">${a.currentStreak} üî•</div>\n                                <div style="font-size: 10px; color: #888; margin-top: 2px;">consecutive days</div>\n                            </div>\n                        </div>\n                    </div>\n                    \n                    <div style="display: flex; flex-direction: column; gap: 12px;">\n                        <button onclick="window.showChangePasswordModal()" style="padding: 12px 24px; border: 2px solid #666; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; background: white; color: #333;">Change Password</button>\n                        <button onclick="window.handleLogoutClick()" style="padding: 12px 24px; border: 2px solid black; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; background: #FF6B6B; color: white;">Log Out</button>\n                    </div>\n                </div>\n            `,document.body.appendChild(t),t.addEventListener("click",e=>{e.target===t&&t.remove()}),console.log("‚úÖ Profile popup displayed successfully")}catch(e){console.error("‚ùå Error creating profile popup:",e),alert("Error showing profile menu. Please try again.")}}else showAuthenticationPopup()}async function handleOption2Click(){if(console.log("handleOption2Click triggered - Today's Shapes button pressed"),collapseMenu(),window.isPracticeMode){console.log("üîÑ Exiting practice mode - performing complete state reset..."),window.isPracticeMode=!1,window.isDailyMode=!0,window.PracticeMode&&(window.PracticeMode.isActive=!1,window.PracticeMode.practiceShapes=[]),window.practiceMode&&(window.practiceMode.isActive=!1,window.practiceMode.availableShapes=[],window.practiceMode.currentShapePath=null);try{Object.keys(localStorage).forEach(e=>{(e.includes("practice")||e.includes("Practice"))&&(localStorage.removeItem(e),console.log(`üóëÔ∏è Cleared practice storage: ${e}`))})}catch(e){console.log("‚ö†Ô∏è Could not clear practice storage:",e)}console.log("üîÑ Reloading page to restore daily mode state after practice exit..."),window.location.reload()}else console.log("üîÑ Refreshing page to restore current daily mode state..."),window.location.reload()}async function handleOption3Click(){console.log("Competitions selected"),collapseMenu();let e=!1;if(window.AuthService&&!window.AuthService.isGuest)e=!0;else{localStorage.getItem("sb-zxrfhumifazjxgikltkz-auth-token")&&(e=!0)}if(!e)return console.log("üîí User not logged in - showing authentication popup"),localStorage.setItem("pendingUserAction","competitions"),void showAuthenticationPopup();openCompetitionModal()}async function handleOption4Click(){console.log("Practice selected"),collapseMenu(),await enterPracticeMode()}async function enterPracticeMode(){console.log("üéÆ Entering practice mode...");if(!localStorage.getItem("sb-zxrfhumifazjxgikltkz-auth-token"))return localStorage.setItem("pendingUserAction","practice"),void showAuthenticationPopup();window.PracticeMode?(await window.PracticeMode.open(),console.log("‚úÖ Practice mode entered")):console.error("‚ùå PracticeMode instance not available")}function showSimplePracticeNavigation(){if(document.getElementById("practiceModeIndicator").style.display="block",document.getElementById("practiceNavigation").style.display="flex",window.innerWidth>=769){const e=document.getElementById("fixedPercentageArea"),t=document.getElementById("buttonsContainer");e&&(e.style.setProperty("margin-top","55px","important"),e.style.setProperty("position","relative","important")),t&&(t.style.setProperty("margin-top","50px","important"),t.style.setProperty("margin-bottom","0","important"),t.style.setProperty("position","relative","important")),console.log("‚úÖ Desktop: Moved practice mode elements down by 50px")}}function showPracticeResults(e,t){const n=window.ScoringSystem.calculateCutScore(e),o=100===n?"100":n.toFixed(1),a=430===window.innerWidth&&805===window.innerHeight||390===window.innerWidth&&715===window.innerHeight||412===window.innerWidth&&785===window.innerHeight||360===window.innerWidth&&630===window.innerHeight,i=a?"3px":"-17px";console.log("üìä showPracticeResults called - Device:",window.innerWidth,"x",window.innerHeight,"isSpecificMobile:",a,"scoreMarginTop:",i);document.getElementById("fixedPercentageArea").innerHTML=`\n        <div style="text-align: center; margin: 16px 0; line-height: 1.5;">\n            <div class="split-display-large" style="display: inline-block; white-space: nowrap;">\n                <span style="color: #FAB06A; font-weight: bold; font-size: 46px;">${e.toFixed(1)}%</span><span style="color: #999999; font-weight: bold; font-size: 46px; margin: 0 5px;"> / </span><span style="color: #999999; font-weight: bold; font-size: 46px;">${t.toFixed(1)}%</span>\n            </div>\n            <br>\n            <div style="margin-top: ${i};">\n                <span style="font-size: 16px; color: #666;">Score&nbsp;</span><span style="font-size: 18px; font-weight: bold;">${o}/100</span>\n            </div>\n        </div>\n        <div style="text-align: center; margin-top: 20px;">\n            <button onclick="returnToDailyGame()" style="\n                background: #f0f0f0;\n                border: 1px solid #ccc;\n                border-radius: 3px;\n                padding: 4px 8px;\n                font-size: 10px;\n                color: #666;\n                cursor: pointer;\n                transition: background 0.2s;\n                display: inline-block;\n            " onmouseover="this.style.background='#e0e0e0'" onmouseout="this.style.background='#f0f0f0'">\n                Return to Game\n            </button>\n        </div>\n    `,canvas.style.pointerEvents="none",console.log("‚úÖ Practice cut completed - score:",n)}function handlePracticeCutComplete(e,t=null){const n=t||window.currentVector||currentVector;if(console.log("üîç Practice mode check:",{PracticeMode:!!window.PracticeMode,PracticeModeDisplayResults:!(!window.PracticeMode||!window.PracticeMode.displayResults),SimplePracticeMode:!!window.SimplePracticeMode,SimplePracticeModeActive:!(!window.SimplePracticeMode||!window.SimplePracticeMode.isActive),practiceMode:!!window.practiceMode}),window.PracticeMode&&window.PracticeMode.displayResults)console.log("üìç Taking PracticeMode.displayResults path"),window.PracticeMode.displayResults(e);else{const t=window.SimplePracticeMode&&window.SimplePracticeMode.isActive||window.practiceMode;if(currentMechanic&&currentMechanic.renderCutResult&&(window.currentCircle||window.currentCircleData)&&!t){console.log("üé® Taking shape-based mechanic rendering path");const t=window.currentCircleData||window.currentCircle;currentMechanic.renderCutResult(e,t)}else n&&(console.log("üìç Taking vector-based rendering path"),currentVector=n,t&&console.log("üéØ Practice mode: Forcing vector-based rendering for shading support"),window.canceledLineDrawing&&(console.log("üîß Practice mode: Clearing canceledLineDrawing flag just before rendering to fix shading"),window.canceledLineDrawing=!1),renderVectorCutResult(e))}showPracticeResults(e.leftPercentage,e.rightPercentage)}function resetPracticeShape(){document.getElementById("fixedPercentageArea").innerHTML="",currentVector=null,window.currentVector=null,globalThis.currentVector=null,currentMechanic&&currentMechanic.reset&&(currentMechanic.reset(),console.log("üîß Practice mode: Reset mechanic for new attempt")),setInteractionEnabled(!0),setGameState("cutting"),canvas.style.pointerEvents="auto",window.isPracticeMode&&(totalCutsMade=0,cutsMadeThisShape=0,attemptCount=0,console.log("üîÑ Practice mode: Reset cut counters for unlimited cutting"));const e=practiceShapes[currentPracticeShapeIndex];loadSimplePracticeShape(e),window.isPracticeMode&&(isShapeAnimationComplete=!0,setInteractionEnabled(!0),setGameState("cutting"),canvas.style.pointerEvents="auto",console.log("‚úÖ Practice mode: Canvas interaction re-enabled after reset")),console.log("‚úÖ Practice shape reset")}function hideInitialWelcomeButtons(){const e=document.getElementById("playBtn"),t=document.getElementById("practiceBtn"),n=document.querySelector(".buttons-below-canvas");e&&(e.style.display="none"),t&&(t.style.display="none"),n&&(n.style.display="none"),console.log("üßπ Initial welcome buttons hidden to prevent UI conflicts")}function returnToDailyGame(){console.log("üîÑ Returning to daily game..."),hideInitialWelcomeButtons(),isPracticeMode=!1,window.isPracticeMode=!1,isDailyMode=!0;const e=document.getElementById("practiceNavigation"),t=document.getElementById("practiceModeIndicator");e&&(e.style.display="none"),t&&(t.style.display="none");const n=document.getElementById("fixedPercentageArea");if(n&&(n.innerHTML=""),window.ctx&&window.canvas&&(window.ctx.clearRect(0,0,canvas.width,canvas.height),console.log("üßπ Cleared canvas before restoring daily game state")),window.SimpleRefresh&&window.SimpleRefresh.restore){console.log("üíæ Restoring daily game state from saved data...");const e=window.SimpleRefresh.restore();if(e){if(console.log("‚úÖ Daily game state restored successfully"),e.canvasData&&(console.log("üé® Restoring canvas with cut shading..."),restoreVisualState(e)),e.isGameStarted&&(showInstructionArea(),console.log("üìù Instruction area restored for active game")),e.currentAttempts&&e.currentAttempts.length>0){const t=e.currentAttempts[e.currentAttempts.length-1];void 0!==t.leftPercentage&&void 0!==t.rightPercentage&&updatePercentageDisplays(t.leftPercentage,t.rightPercentage)}}else console.log("‚ÑπÔ∏è No saved state found - returning to initial game state"),setGameState("initial"),setInteractionEnabled(!1)}else console.log("‚ö†Ô∏è SimpleRefresh not available - resetting to initial state"),setGameState("initial"),setInteractionEnabled(!1);setTimeout(()=>{if(window.dailyGameState&&(window.dailyGameState.dayComplete||window.dailyGameState.isGameComplete))if(console.log("üèÜ Daily game was completed - restoring completion view after practice mode"),window.completeView&&window.showCompletionView)window.showCompletionView();else if(window.completeView){const e=getDayStats(currentDay);if(e&&window.buildCompletionModel){const t=window.buildCompletionModel(e);window.completeView.show(t),console.log("‚úÖ Completion view restored after practice mode exit")}}},200),console.log("‚úÖ Successfully returned to daily game")}async function handleDailyClick(){await switchToSection("daily")}async function handleProfileClick(){isUserSignedIn()?await switchToSection("profile"):showAuthenticationPopup()}async function refreshProfile(){if(window.UserAccountManager)try{await window.UserAccountManager.refresh(),"profile"===currentSection&&await switchToSection("profile"),showAuthSuccess("Profile data refreshed")}catch(e){console.error("Profile refresh error:",e),showAuthError("Failed to refresh profile data")}}async function changeUsername(){const e=prompt("Enter new username (3-20 characters, letters, numbers, and underscores only):");if(e&&window.UserAccountManager)try{const t=await window.UserAccountManager.changeUsername(e);t.success?(showAuthSuccess(t.message),await refreshProfile()):showAuthError(t.error)}catch(e){console.error("Username change error:",e),showAuthError("Failed to change username")}}function changePassword(){showAuthError("Password changes must be done through the account settings. This feature will be available soon.")}function togglePrivacy(){showAuthError("Privacy settings will be available soon.")}function manageNotifications(){showAuthError("Notification settings will be available soon.")}function updateShapeProgress(){if("initial"===gameState){showPlayButton();const e=document.getElementById("playBtn");e&&(e.disabled=!1,e.classList.remove("disabled"))}}function isLoading(){const e=document.getElementById("loadingPopup");return e&&e.classList.contains("visible")}function setupOrientationDetection(){void 0===window.isModalOpenForOrientationCheck&&(window.isModalOpenForOrientationCheck=!1);let e=window.innerHeight,t=null;function n(){console.log(`üîç checkOrientation() called - modalFlag: ${window.isModalOpenForOrientationCheck}`);const t=document.getElementById("orientationMessage"),n=document.querySelector(".app-container");if(!0===window.isModalOpenForOrientationCheck)return void console.log("üö´ Orientation check skipped - modal is open");const o=document.activeElement;if(o&&("INPUT"===o.tagName||"TEXTAREA"===o.tagName||o.isContentEditable||"text"===o.type||"password"===o.type||"email"===o.type))return void console.log("‚å®Ô∏è Orientation check skipped - input field has focus");const a=window.innerHeight,i=e-a,r=i>100;if(i>50&&console.log(`üìê Height change detected: ${i}px (keyboard: ${r})`),r)return void console.log("‚å®Ô∏è Orientation check skipped - keyboard likely open");const s=e=>{if(!e)return!1;const t=window.getComputedStyle(e);return"none"!==t.display&&"hidden"!==t.visibility&&null!==e.offsetParent},c=document.getElementById("authModal"),l=document.getElementById("changePasswordModal"),d=document.getElementById("userStatsModal");if(s(c)||s(l)||s(d))return void console.log("üö´ Orientation check skipped - modal is visible");let p;if(screen.orientation&&screen.orientation.type)p=screen.orientation.type.includes("landscape");else{p=window.screen&&window.screen.width&&window.screen.height?window.screen.width>window.screen.height:window.innerWidth>window.innerHeight&&window.innerWidth>768}const u=window.innerHeight<500,g=/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);p&&u&&g?(t.style.display="flex",n.style.display="none"):(t.style.display="none",n.style.display="flex")}n(),window.addEventListener("resize",()=>{clearTimeout(t),t=setTimeout(()=>{n()},200)}),window.addEventListener("orientationchange",()=>{setTimeout(()=>{e=window.innerHeight,n()},100)})}function setupEventListeners(){try{console.log("üîß Setting up event listeners...");const n=document.getElementById("playBtn");if(!n)throw new Error("Play button not found");n.hasAttribute("data-listener-added")||(n.addEventListener("click",function(e){console.log("üîò Play button clicked!",e),console.log("Button disabled?",n.disabled),console.log("Button classes:",n.className),handlePlayButtonClick(e)}),n.addEventListener("mousedown",function(e){console.log("üü¢ Play button MOUSEDOWN detected!",e)}),n.addEventListener("touchstart",function(e){console.log("üü¢ Play button TOUCHSTART detected!",e)}),n.setAttribute("data-listener-added","true")),console.log("‚úÖ Play button event listener attached"),console.log("Play button element:",n),console.log("Play button initial disabled state:",n.disabled);const o=document.getElementById("practiceBtn");o&&(o.addEventListener("click",function(e){enterPracticeMode()}),console.log("‚úÖ Practice button event listener attached"),console.log("Practice button element:",o)),setupReplayNavigation(),console.log("‚úÖ Demo canvas initialized");const a=document.getElementById("shareBtn");a&&a.addEventListener("click",handleShare);const i=document.getElementById("trophyBtn"),r=document.getElementById("trophyPopup"),s=document.getElementById("trophyPopupClose");if(i&&r){function e(){r.classList.add("show")}function t(){r.classList.remove("show")}window.hideTrophyPopup=t,i.addEventListener("click",function(){e(),setTimeout(()=>{t()},5e3)}),s&&s.addEventListener("click",function(){t()}),r.addEventListener("click",function(e){e.target===r&&t()});localStorage.getItem("hasSeenTrophyPopup")||setTimeout(()=>{e(),localStorage.setItem("hasSeenTrophyPopup","true"),setTimeout(()=>{t()},5e3)},500)}console.log("üîß Setting up navigation button listeners...");const c=document.getElementById("option1Btn"),l=(document.getElementById("option2Btn"),document.getElementById("option3Btn"));document.getElementById("animatedMenuButton");c&&(c.addEventListener("click",handleOption1Click),console.log("‚úÖ Account button listener attached")),l&&(l.addEventListener("click",handleOption3Click),console.log("‚úÖ Competitions button listener attached"));const d=document.getElementById("option4Btn");d&&(d.addEventListener("click",handleOption4Click),console.log("‚úÖ Practice button listener attached")),updateButtonStates(),window.handleOption1Click=handleOption1Click,window.handleOption2Click=handleOption2Click,window.handleOption3Click=handleOption3Click,window.handleOption4Click=handleOption4Click,window.handleDailyClick=handleDailyClick,window.handleProfileClick=handleProfileClick,window.openCompetitionsPopup=openCompetitionModal,console.log("üñ±Ô∏è Setting up vector cutting event listeners..."),setupVectorEventListeners(),console.log("‚úÖ All event listeners set up successfully"),document.addEventListener("click",function(e){console.log("üåç GLOBAL CLICK detected on:",e.target.tagName,e.target.id,e.target.className),"playBtn"!==e.target.id&&"practiceBtn"!==e.target.id||console.log("üéØ BUTTON CLICK detected:",e.target.id)}),document.addEventListener("touchstart",function(e){console.log("üåç GLOBAL TOUCHSTART detected on:",e.target.tagName,e.target.id,e.target.className),e.target&&"geoCanvas"===e.target.id&&window.menuState&&window.menuState.isExpanded&&(console.log("üîµ Global touchstart on canvas - closing menu dropdown"),window.collapseMenu())}),document.addEventListener("click",function(e){const t=document.getElementById("menuDropdown"),n=document.getElementById("animatedMenuButton");t&&n&&!t.contains(e.target)&&!n.contains(e.target)&&menuState.isExpanded&&collapseMenu()})}catch(p){throw console.error("üí• Failed to setup event listeners:",p),window.debugLogger&&debugLogger.error("Event listener setup failed",p),p}}function setupVectorEventListeners(){try{if(!canvas)throw new Error("Canvas not available for event listeners");canvas.addEventListener("mousedown",handleVectorStart),canvas.addEventListener("mousemove",handleVectorDrag),canvas.addEventListener("mouseup",handleVectorEnd),canvas.addEventListener("click",function(e){console.log("üîç DEBUG: Canvas clicked!",{x:e.clientX,y:e.clientY,target:e.target,canvasStyle:canvas.style.pointerEvents,practiceMode:practiceMode.isActive,isInteractionEnabled:isInteractionEnabled}),window.menuState&&window.menuState.isExpanded&&(console.log("üîµ Canvas clicked - closing menu dropdown"),window.collapseMenu())}),canvas.addEventListener("mousedown",function(e){console.log("üîç DEBUG: Canvas mousedown detected before handleVectorStart!",{practiceMode:practiceMode.isActive,isInteractionEnabled:isInteractionEnabled,pointerEvents:canvas.style.pointerEvents})}),console.log("‚úÖ Mouse event listeners attached to canvas"),canvas.addEventListener("touchstart",handleVectorStart),canvas.addEventListener("touchmove",handleVectorDrag),canvas.addEventListener("touchend",handleVectorEnd),console.log("‚úÖ Touch event listeners attached to canvas"),canvas.addEventListener("touchstart",e=>e.preventDefault()),canvas.addEventListener("touchmove",e=>e.preventDefault()),canvas.addEventListener("touchend",e=>e.preventDefault()),console.log("‚úÖ Touch event prevention set up")}catch(e){throw console.error("üí• Failed to setup vector event listeners:",e),window.debugLogger&&debugLogger.error("Vector event listener setup failed",e),e}}function redrawCanvas(){if(console.log("üîÑ redrawCanvas() called, parsedShapes:",parsedShapes?`array with ${parsedShapes.length} items`:"null/undefined"),console.log("üîß Current mechanic:",currentMechanic?currentMechanic.name:"null"),console.log("üîß Current day:",currentDay),7===currentDay&&currentMechanic&&"Rotating Shape Vector Cut"===currentMechanic.name&&currentMechanic.isRotating)return void console.log("üåÄ Sunday rotating mechanic active - skipping redraw, let rotation handle it");let e=parsedShapes;if(parsedShapes&&0!==parsedShapes.length||!window.isPracticeMode||(console.log("üéØ Practice mode: Using stored shapes for redraw"),window.practiceMode&&window.practiceMode.practiceParsedShapes?(e=window.practiceMode.practiceParsedShapes,console.log("üîÑ Found practice mode shapes:",e.length)):window.PracticeMode&&window.PracticeMode.originalShapes&&(e=window.PracticeMode.originalShapes,console.log("üîÑ Found practice mode shapes (fallback):",e.length))),!e||0===e.length)return console.log("‚ö†Ô∏è No shapes to redraw, only drawing grid"),void drawGrid();console.log("üîÑ Redrawing canvas with current shapes"),ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid(),renderShapeForCutting(e)}function drawGrid(e=ctx){e.save();const t=380;if(e.fillStyle="#ffffff",e.fillRect(0,0,t,t),e.strokeStyle="#000000",e.lineWidth=2,e.strokeRect(0,0,t,t),"initial"!==gameState){e.strokeStyle="#d0d0d0",e.lineWidth=.5;const n=14,o=t/n;for(let a=0;a<=n;a++){const n=a*o;e.beginPath(),e.moveTo(n,0),e.lineTo(n,t),e.stroke()}for(let a=0;a<=n;a++){const n=a*o;e.beginPath(),e.moveTo(0,n),e.lineTo(t,n),e.stroke()}}e.restore()}function drawGridLinesOnly(e=ctx){e.save();const t=380;if(e.strokeStyle="#000000",e.lineWidth=2,e.strokeRect(0,0,t,t),"initial"!==gameState){e.strokeStyle="#d0d0d0",e.lineWidth=.5;const n=14,o=t/n;for(let a=0;a<=n;a++){const n=a*o;e.beginPath(),e.moveTo(n,0),e.lineTo(n,t),e.stroke()}for(let a=0;a<=n;a++){const n=a*o;e.beginPath(),e.moveTo(0,n),e.lineTo(t,n),e.stroke()}}e.restore()}function drawReferencePoints(){ctx.save(),ctx.fillStyle="red",ctx.font="12px Arial",ctx.fillRect(0,0,8,8),ctx.fillText("0,0",12,12),ctx.fillRect(372,0,8,8),ctx.fillText("380,0",330,12),ctx.fillRect(0,372,8,8),ctx.fillText("0,380",12,368),ctx.fillRect(372,372,8,8),ctx.fillText("380,380",300,368),ctx.fillRect(186,186,8,8),ctx.fillText("190,190",200,180),ctx.restore()}function handlePlayButtonClickOld(){try{console.log("üéÆ Play button clicked (old handler)"),window.hideTrophyPopup&&window.hideTrophyPopup(),window.Analytics&&window.Analytics.trackGameStart();const e=document.getElementById("playBtn");if(!e)throw new Error("Play button not found");const t=e.textContent,n=e.disabled;if(console.log(`Button state: "${t}", disabled: ${n}`),n)return void console.log("Button click ignored - button is disabled");window.debugLogger&&debugLogger.log("Play button clicked",{buttonText:t,gameState:gameState}),hidePlayButton(),fadeOutWelcomeText(),setTimeout(()=>{"Play"===t?(console.log("üöÄ Starting new game..."),startGame()):"Play Again"===t?(console.log("üîÑ Resetting game..."),resetGame()):"Reset"===t?(console.log("üîÑ Hard reset..."),handleReset()):console.warn("‚ö†Ô∏è Unknown button state:",t),"Play"===t&&setTimeout(()=>{showCutPopup()},500)},100)}catch(e){console.error("üí• Error in handlePlayButtonClick:",e),window.debugLogger&&debugLogger.error("Play button handler failed",e)}}function handlePractiseButtonClick(){try{console.log("üéÆ Practise button clicked"),window.hideTrophyPopup&&window.hideTrophyPopup(),window.Analytics&&window.Analytics.trackPracticeMode(),fadeOutWelcomeText();const e=document.querySelector(".buttons-below-canvas");e?(e.style.transition="opacity 0.5s",e.style.opacity="0",e.style.pointerEvents="none",setTimeout(async()=>{await initializePracticeMode()},500)):initializePracticeMode(),window.debugLogger&&debugLogger.log("Practise mode activated")}catch(e){console.error("üí• Error in handlePractiseButtonClick:",e),window.debugLogger&&debugLogger.error("Practise button handler failed",e)}}async function startGame(){document.getElementById("playBtn");hideInitialWelcomeButtons(),isPracticeMode=!1,window.isPracticeMode=!1,isPractiseMode=!1,isDemoMode&&(isDailyMode=!1,console.log("üîß DEMO MODE: Forcing isDailyMode = false to ensure demo logic is used")),console.log("üéØ GAME START: Mode preserved, isDailyMode =",isDailyMode,"isDemoMode =",isDemoMode),isInteractionEnabled=!1,console.log("üöÄ Canvas interaction disabled at game start"),gameState="playing",currentAttempts=[],attemptCount=0,finalLockedScore=null,shapeScreenshot=null,canvasRestoreData=null,dailyGameState||initializeDailyGameState(),dailyGameState.isGameStarted=!0,dailyGameState.gameStateValue="playing",saveStructuredGameState(),saveDemoGameState(),window.SimpleRefresh&&window.SimpleRefresh.save&&window.SimpleRefresh.save(),pulseInterval&&(clearInterval(pulseInterval),pulseInterval=null);const e=document.querySelector(".results-container");e&&(e.style.display="none"),await new Promise(e=>setTimeout(e,200));try{window.freshGameStart=!0,console.log("üîç DEBUG: Checking Supabase integration status..."),console.log("üîç DEBUG: window.supabaseIntegrationActive =",window.supabaseIntegrationActive),console.log("üîç DEBUG: window.DailyGameCore =",!!window.DailyGameCore),window.supabaseIntegrationActive&&window.DailyGameCore?(console.log("üîó Loading Supabase shapes for daily game..."),console.log("üîç DEBUG: About to call loadSupabaseShape with day:",currentDay,"shape:",currentShapeNumber),await loadSupabaseShape(currentDay,currentShapeNumber)):(console.log("üéÆ Loading demo shapes (Supabase not available)..."),console.log("üîç DEBUG: About to call loadDemoDay with day:",currentDay),await loadDemoDay(currentDay)),await new Promise(e=>setTimeout(async()=>{showGoalBeneathCanvas(),ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid(),renderShapeForCutting(parsedShapes,!1),isShapeAnimationComplete=!0,setInteractionEnabled(!0),console.log("‚úÖ Shape animation marked as complete - interaction now allowed"),window.freshGameStart=!1,gameState="cutting",isShapeAnimationComplete=!0,isInteractionEnabled=!0,canvas&&(canvas.style.pointerEvents="auto"),console.log("‚úÖ Daily shape is ready for cutting - game state:",gameState,"interaction enabled:",isInteractionEnabled),saveDemoGameState(),window.SimpleRefresh&&window.SimpleRefresh.save&&window.SimpleRefresh.save(),console.log("üíæ State saved after shape load - currentDay:",currentDay,"currentShapeNumber:",currentShapeNumber,"gameState:",gameState),e()},200))}catch(e){console.error("Error during game start:",e),await hideLoadingPopup(),window.debugLogger&&debugLogger.error("Game start failed",e),showCommentary("Failed to load shape. Please refresh the page.",!1)}}async function loadCurrentShape(){try{console.log(`üîÑ Loading single shape for date ${currentDate}`),window.debugLogger&&debugLogger.log(`Loading single shape for ${currentDate}`);let e=null,t="unknown";const n=[()=>loadFromSupabase(),()=>loadFallbackShape()];for(const o of n)try{const n=await o();if(n.success){e=n.geoJSON,t=n.source;break}}catch(e){console.warn("Loading strategy failed:",e)}if(!e)throw new Error("All shape loading strategies failed");console.log(`‚úÖ Daily shape ready from ${t}`),currentGeoJSON=e;const o=parseGeometry(e);parsedShapes=o.shapes,window.debugLogger&&debugLogger.success(`Daily shape loaded from ${t}`,{date:currentDate,featuresCount:e.features?.length,parsedShapes:parsedShapes.length}),gameState="cutting"}catch(e){throw console.error("üí• Failed to load shape:",e),window.debugLogger&&debugLogger.error("Shape loading failed completely",e),showCommentary("Failed to load shape. Please refresh the page.",!1),e}}async function loadCurrentShapeData(){await loadCurrentShape()}function renderCurrentShape(){parsedShapes&&0!==parsedShapes.length?(ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid(),renderShapeForCutting(parsedShapes),hidePlayButton()):console.error("No shape data to render")}async function loadFromSupabase(){console.log("üåê Trying to load from Supabase...");try{return{success:!0,geoJSON:await supabaseClient.loadShape(currentDate,1),source:"Supabase"}}catch(e){return console.log("Supabase loading failed:",e.message),{success:!1,error:e}}}async function loadDailyShape(){try{console.log(`üîÑ Loading daily shape for date ${currentDate}`),window.debugLogger&&debugLogger.log(`Loading daily shape for ${currentDate}`);let e=null,t="unknown";const n=[()=>loadFromSupabaseV3(),()=>loadFallbackShape()];for(const o of n)try{const n=await o();if(n.success){e=n.geoJSON,t=n.source;break}}catch(e){console.warn("Loading strategy failed:",e)}if(!e)throw new Error("All shape loading strategies failed");console.log(`‚úÖ Daily shape ready from ${t}`),currentGeoJSON=e;const o=parseGeometry(e);parsedShapes=o.shapes,console.log(`üîç Daily shape parsing complete: ${parsedShapes.length} shapes`),window.debugLogger&&debugLogger.success(`Daily shape loaded from ${t}`,{date:currentDate,featuresCount:e.features?.length,parsedShapes:parsedShapes.length})}catch(e){throw console.error("üí• Failed to load daily shape:",e),window.debugLogger&&debugLogger.error("Daily shape loading failed completely",e),e}}async function loadFromSupabaseV3(){console.log("üåê Loading v3.0 single daily shape from Supabase...");try{const e=await supabaseClient.loadShape(currentDate,1);return console.log("‚úÖ Successfully loaded single daily shape via existing method"),{success:!0,geoJSON:e,source:"Supabase"}}catch(e){return console.log("Supabase v3.0 loading failed:",e.message),{success:!1,error:e}}}async function loadFallbackShape(){return console.log("üîÑ Using fallback shape..."),showCommentary("Using test shape (network shapes unavailable)",!0),{success:!0,geoJSON:fallbackShape,source:"Fallback"}}function renderShapeForCutting(e,t=!1,n=ctx){if(window.isAnimating||console.log(`üé® renderShapeForCutting called with ${e.length} shapes, useDirectCoordinates: ${t}`),0===e.length)return void(window.isAnimating||console.error("‚ùå No shapes to render!"));const o=calculateBounds(e),a=calculateScale(o,t),i=calculateOffset(o,a,t);window.isAnimating||console.log(`üé® Rendering with offset: (${i.x.toFixed(1)}, ${i.y.toFixed(1)}), scale: ${a.toFixed(2)}`),n.save(),n.fillStyle="#dddddd",n.strokeStyle="#000000",n.lineWidth=2,e.forEach((e,t)=>{drawPolygon(e,a,i,n)}),n.restore()}function drawShapeFromGeoJSON(e){if(!e||!e.features||0===e.features.length)return void console.warn("Invalid GeoJSON provided to drawShapeFromGeoJSON");const t=parseGeometry(e);renderShapeForCutting(t.shapes,t.useDirectCoordinates)}function drawShapeOutlineFromGeoJSON(e){if(!e||!e.features||0===e.features.length)return void console.warn("Invalid GeoJSON provided to drawShapeOutlineFromGeoJSON");const t=parseGeometry(e),n=t.shapes,o=calculateBounds(n),a=calculateScale(o,t.useDirectCoordinates),i=calculateOffset(o,a,t.useDirectCoordinates);ctx.save(),ctx.fillStyle="transparent",ctx.strokeStyle="#000000",ctx.lineWidth=2,ctx.setLineDash([]),n.forEach(e=>{drawPolygonOutline(e,a,i)}),ctx.restore()}async function showStats(){console.log("showStats called - finalLockedScore:",finalLockedScore);let e="No result";finalLockedScore&&(e=`${finalLockedScore.leftPercentage.toFixed(1)}% / ${finalLockedScore.rightPercentage.toFixed(1)}%`);let t="Loading...";try{const n=await supabaseClient.getTodaysAverage(currentDate);t=n?`${n.leftPercentage.toFixed(1)}% / ${n.rightPercentage.toFixed(1)}%`:e}catch(n){console.error("Error fetching global average:",n),t=e}document.getElementById("yourAverage").textContent=e,document.getElementById("globalAverage").textContent=t,canvas.style.pointerEvents="none",isReplayMode=!1;const n=document.getElementById("swipeIndicators");n&&(n.style.display="none"),document.getElementById("statsPopup").style.display="flex"}function hideStats(){const e=document.getElementById("statsPopup");e&&(e.style.display="none",document.body.appendChild(e)),hideCommentary();const t=document.getElementById("shareBtn");t&&(t.style.visibility="visible",t.style.opacity="1"),canvas.style.pointerEvents="auto",setupReplayNavigation(),isReplayMode=!0,window.Analytics&&window.Analytics.trackReplayUsage(),hidePlayButton(),showReplayShape(replayShapeIndex),console.log("üîÑ Stats popup closed - replay mode activated")}function handleShare(){if(!finalLockedScore)return void console.error("No locked score available for sharing");window.Analytics&&window.Analytics.trackShare();const e=currentDayNumber||1;let t=" ";if(currentAttempts&&currentAttempts.length>0){const e=[...currentAttempts].map((e,t)=>({...e,originalIndex:t,accuracy:Math.abs(50-e.leftPercentage)})).sort((e,t)=>e.accuracy-t.accuracy),n=["ü•á","ü•à","ü•â"],o={};e.forEach((e,t)=>{t<n.length?o[e.originalIndex]=n[t]:o[e.originalIndex]="ü•â"});for(let e=0;e<3;e++)e<currentAttempts.length?t+=o[e]:t+="‚¨ú"}else t=" ü•áü•àü•â";let n,o,a=1;if(currentAttempts&&currentAttempts.length>0){console.log("üîç Share Debug - Finding best attempt from:",currentAttempts.map((e,t)=>({attempt:t+1,left:e.leftPercentage,right:e.rightPercentage,accuracy:Math.abs(50-e.leftPercentage)})));let e=1/0,t=0;for(let n=0;n<currentAttempts.length;n++){const o=currentAttempts[n],a=Math.abs(50-o.leftPercentage);console.log(`üîç Attempt ${n+1}: ${o.leftPercentage}% / ${o.rightPercentage}%, accuracy: ${a}`),a<e&&(e=a,t=n,console.log(`üèÜ New best: Attempt ${n+1} with accuracy ${a}`))}a=t+1,console.log(`üéØ Final best attempt number: ${a}`)}else console.log("‚ö†Ô∏è No currentAttempts available for share message");if(currentAttempts&&currentAttempts.length>0&&a<=currentAttempts.length){const e=currentAttempts[a-1];n=e.leftPercentage.toFixed(1),o=e.rightPercentage.toFixed(1),console.log(`üîç Using percentages from best attempt ${a}: ${n}% / ${o}%`)}else n=finalLockedScore.leftPercentage.toFixed(1),o=finalLockedScore.rightPercentage.toFixed(1),console.log(`üîç Fallback: Using finalLockedScore percentages: ${n}% / ${o}%`);const i=`Daily Shapes #${e}\n${t}\n ${n}% / ${o}% (best split) on my ${1===a?"1st":2===a?"2nd":"3rd"} cut\n (dailyshapes.com)`;console.log("üîç Final share text:",i),copyToClipboardWithPopup(i)}function copyToClipboardWithPopup(e){if(navigator.clipboard)navigator.clipboard.writeText(e).then(()=>{showCopyConfirmationPopup()}).catch(e=>{console.error("Clipboard write failed:",e),showCopyConfirmationPopup("Copy failed - try again")});else try{const t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),showCopyConfirmationPopup()}catch(e){console.error("Fallback copy failed:",e),showCopyConfirmationPopup("Copy not supported")}}function showCopyConfirmationPopup(e="Copied to clipboard"){const t=document.createElement("div");t.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background-color: rgba(0, 0, 0, 0.5);\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        z-index: 10000;\n        opacity: 0;\n        transition: opacity 0.3s ease;\n    ",t.innerHTML=`\n        <div style="\n            background-color: #ffffff;\n            border: 3px solid #000000;\n            border-radius: 12px;\n            padding: 16px 24px;\n            text-align: center;\n            box-shadow: 6px 6px 0px #000000;\n            margin: 20px;\n        ">\n            <div style="\n                font-size: 18px;\n                font-weight: 600;\n                color: #000000;\n                line-height: 1.4;\n                margin: 0;\n            ">${e}</div>\n        </div>\n    `,document.body.appendChild(t),setTimeout(()=>{t.style.opacity="1"},10),setTimeout(()=>{document.body.contains(t)&&document.body.removeChild(t)},2e3)}function endGame(){console.log("üéØ endGame() function called - all shapes completed"),hidePlayButton(),console.log("üéØ Setting replayShapeIndex to 3 in endGame()"),replayShapeIndex=3,console.log("üéØ replayShapeIndex is now:",replayShapeIndex),gameState="finished",console.log("üéØ gameState set to:",gameState),showStats(),console.log("üîÑ Replay mode fully activated - starting with shape 3")}function resetGame(){isInteractionEnabled=!1,console.log("üîÑ Canvas interaction disabled at game reset"),currentAttempts=[],attemptCount=0,finalLockedScore=null,shapeScreenshot=null,canvasRestoreData=null,pulseInterval&&(clearInterval(pulseInterval),pulseInterval=null),window.gameCountdownInterval&&(clearInterval(window.gameCountdownInterval),window.gameCountdownInterval=null),hideCommentary();const e=document.querySelector(".attempt-result");e&&e.remove();const t=document.querySelector(".post-lockin-container");t&&t.remove();const n=document.getElementById("countdownOverlay");n&&(n.style.display="none");const o=document.querySelector(".attempt-buttons");o&&o.remove(),gameState="initial",ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid();const a=document.getElementById("playBtn");a.textContent="Play Again",a.disabled=!1,a.classList.remove("disabled"),showPlayButton()}function handleReset(){location.reload()}function showLoadingPopup(){loadingPopupElement||(loadingPopupElement=document.getElementById("loadingPopup")),loadingPopupElement&&(console.log("‚è≥ Showing compact loading popup..."),splashStartTime=Date.now(),loadingPopupElement.style.display="block",requestAnimationFrame(()=>{loadingPopupElement.classList.add("visible")}),window.debugLogger&&debugLogger.log("Loading popup displayed"))}async function hideLoadingPopup(){if(!loadingPopupElement)return;const e=splashStartTime?Date.now()-splashStartTime:300,t=Math.max(0,300-e);t>0&&(console.log(`‚è±Ô∏è Waiting ${t}ms more for minimum popup display time...`),await new Promise(e=>setTimeout(e,t))),console.log("‚è≥ Hiding loading popup..."),loadingPopupElement.classList.remove("visible"),setTimeout(()=>{loadingPopupElement&&(loadingPopupElement.style.display="none"),hidePlayButton(),window.debugLogger&&debugLogger.log("Loading popup hidden")},300)}function showLoadingPopupInstant(){console.log("üîç showLoadingPopupInstant called, window.startLoadingAnimation exists:",!!window.startLoadingAnimation),window.startLoadingAnimation?(console.log("‚è≥ Starting canvas loading animation..."),window.startLoadingAnimation()):console.error("‚ùå window.startLoadingAnimation not found!")}function hideLoadingPopupInstant(){window.stopImmediateLoadingAnimation&&(console.log("‚è≥ Stopping canvas loading animation..."),window.stopImmediateLoadingAnimation())}function handleVectorStart(e){try{if(console.log("üîç DEBUG: handleVectorStart called",{isInteractionEnabled:isInteractionEnabled,gameState:gameState,attemptCount:attemptCount,isPracticeMode:window.isPracticeMode,practiceMode:practiceMode.isActive,canvasPointerEvents:canvas?.style.pointerEvents,eventType:e.type,eventTarget:e.target.tagName}),window.menuState&&window.menuState.isExpanded&&(console.log("üîµ Active canvas interaction started - closing menu dropdown"),window.collapseMenu()),resetInstructionsToInitial(),window.isPracticeMode){if(console.log("üî™ Practice mode vector start detected"),isReplayMode)return void console.log("Vector start ignored - in replay mode")}else{if(!isInteractionEnabled)return void console.log("Vector start ignored - interaction not enabled yet");if(isReplayMode)return void console.log("Vector start ignored - in replay mode");if("cutting"!==gameState)return void console.log("Vector start ignored - not in cutting state:",gameState)}if(hideGoalCommentary(),window.isPracticeMode){console.log("üî™ Starting practice vector cut - using current mechanic"),console.log("üîß DEBUG: currentMechanic exists:",!!currentMechanic),console.log("üîß DEBUG: window.currentMechanic exists:",!!window.currentMechanic),console.log("üîß DEBUG: currentMechanic name:",currentMechanic?currentMechanic.name:"null"),console.log("üîß DEBUG: window.currentMechanic name:",window.currentMechanic?window.currentMechanic.name:"null");const t=window.currentMechanic||currentMechanic;console.log("üîß DEBUG: Using mechanic:",t?t.name:"null");const n=canvas.getBoundingClientRect();if(practiceMode.cachedCanvasRect=n,console.log("üìê Cached canvas rect for drag operation:",n),t&&"function"==typeof t.handleStart){console.log("üîß Practice mode: Using current mechanic start handler",{mechanicName:t.name,isInteractionEnabled:window.isInteractionEnabled});const o=t.handleStart(e,n);if(console.log("üîß Practice mode: Mechanic handleStart result:",o,typeof o),o)return console.log("üîß Practice mode: Mechanic handled start - setting practice flags"),practiceMode.practiceIsDrawingVector=!0,practiceMode.practiceVectorStart=getCanvasCoordinates(e),practiceMode.practiceVectorEnd=null,practiceMode.practiceCurrentVector=null,void console.log("üîß Practice mode: Practice flags set, returning early");console.log("üîß Practice mode: Mechanic did not handle start, falling back")}else console.log("üîß Practice mode: No mechanic handleStart available");console.log("üîß Practice mode: Using fallback start handling"),practiceMode.practiceIsDrawingVector=!0,practiceMode.practiceVectorStart=getCanvasCoordinates(e),practiceMode.practiceVectorEnd=null,practiceMode.practiceCurrentVector=null,console.log("üîß Practice vector state:",{isDrawing:practiceMode.practiceIsDrawingVector,start:practiceMode.practiceVectorStart})}else console.log("üî™ Starting vector cut - attempt:",attemptCount+1),hideTryAgainMessage(),isDrawingVector=!0,vectorStart=getCanvasCoordinates(e),vectorEnd=null,currentVector=null,vectorCutActive=!1,dragDistance=0;window.debugLogger&&debugLogger.debug("Vector drawing started",{x:practiceMode.isActive?practiceMode.practiceVectorStart.x:vectorStart.x,y:practiceMode.isActive?practiceMode.practiceVectorStart.y:vectorStart.y,practiceMode:practiceMode.isActive})}catch(e){console.error("üí• Error in handleVectorStart:",e),window.debugLogger&&debugLogger.error("Vector start handler failed",e)}}function handleVectorDrag(e){if(console.log("üîç DEBUG: handleVectorDrag called - event type:",e.type),console.log("üîç DEBUG: Practice mode status:",{practiceMode_isActive:practiceMode.isActive,isPracticeMode:window.isPracticeMode,practiceMode_object:practiceMode}),window.isPracticeMode){if(console.log("üîç DEBUG: handleVectorDrag called for practice mode",{isReplayMode:isReplayMode,practiceIsDrawingVector:practiceMode.practiceIsDrawingVector,practiceVectorStart:practiceMode.practiceVectorStart,eventType:e.type}),isReplayMode||!practiceMode.practiceIsDrawingVector||!practiceMode.practiceVectorStart)return void console.log("üîç Practice drag blocked:",{isReplayMode:isReplayMode,practiceIsDrawingVector:practiceMode.practiceIsDrawingVector,practiceVectorStart:!!practiceMode.practiceVectorStart,condition1_isReplayMode:isReplayMode,condition2_notPracticeIsDrawingVector:!practiceMode.practiceIsDrawingVector,condition3_noPracticeVectorStart:!practiceMode.practiceVectorStart});const t=window.currentMechanic||currentMechanic;if(t&&"function"==typeof t.handleMove){console.log("üîß Practice mode: About to call mechanic.handleMove",{mechanicName:t.name,handleMoveType:typeof t.handleMove});const n=practiceMode.cachedCanvasRect||canvas.getBoundingClientRect();console.log("üîß Canvas rect for mechanic (cached):",n);const o=t.handleMove(e,n);if(console.log("üîß Practice mode: Mechanic handleMove result:",o,typeof o),o)return console.log("üîß Practice mode: Mechanic handled visual feedback - preventing default and returning"),void e.preventDefault();console.log("üîß Practice mode: Mechanic did not handle - falling back to default")}else console.log("üîß Practice mode: No currentMechanic.handleMove available:",{currentMechanic:!!currentMechanic,windowCurrentMechanic:!!window.currentMechanic,practiceMechanic:!!t,currentMechanicName:currentMechanic?.name,windowCurrentMechanicName:window.currentMechanic?.name,handleMove:typeof(t&&t.handleMove)});if(t&&"Three Point Triangle Cut"===t.name)return void console.log("üö´ Three Point Triangle mechanic: No drag fallback permitted - returning early");practiceMode.practiceVectorEnd=getCanvasCoordinates(e);const n=practiceMode.practiceVectorEnd.x-practiceMode.practiceVectorStart.x,o=practiceMode.practiceVectorEnd.y-practiceMode.practiceVectorStart.y,a=Math.sqrt(n*n+o*o);return console.log("üîç Practice drag distance:",a),void(a>5?(console.log("üîç Drawing practice vector preview - fallback mode"),ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid(ctx),renderPracticeShapeForCutting(practiceMode.practiceParsedShapes),drawPracticeCurrentVector()):console.log("üîç Drag distance too small for preview:",a))}if(isReplayMode||!isDrawingVector||!vectorStart||"cutting"!==gameState)return;if(isPracticeMode&&currentVector)return void console.log("üö´ Skipping vector drag redraw - practice mode with completed cut");vectorEnd=getCanvasCoordinates(e);const t=vectorEnd.x-vectorStart.x,n=vectorEnd.y-vectorStart.y;dragDistance=Math.sqrt(t*t+n*n),dragDistance>5&&(ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid(),renderShapeForCutting(parsedShapes),drawCurrentVector(),3===currentShapeIndex&&firstCutVector&&drawPreviousVector(firstCutVector))}async function handleVectorEnd(e){if(window.isPracticeMode){console.log("üîß Practice mode: handleVectorEnd called"),console.log("üîß Practice mode: currentMechanic:",currentMechanic?currentMechanic.name:"null"),console.log("üîß Practice mode: window.currentMechanic:",window.currentMechanic?window.currentMechanic.name:"null");const t=window.currentMechanic||currentMechanic;if(console.log("üîß Practice mode: Using mechanic:",t?t.name:"null"),t&&"function"==typeof t.handleEnd){console.log("üîß Practice mode: Using current mechanic end handler");const n=await t.handleEnd(e);return console.log("üîß Practice mode: Mechanic handleEnd result:",n),console.log("üîß Practice mode: Resetting drawing state (result:",n,")"),practiceMode.practiceIsDrawingVector=!1,practiceMode.practiceVectorStart=null,practiceMode.practiceVectorEnd=null,practiceMode.practiceCurrentVector=null,practiceMode.cachedCanvasRect=null,console.log("üìê Cleared cached canvas rect"),n}console.log("üîß Practice mode: Using fallback daily game cutting mechanics")}if(!isReplayMode&&isDrawingVector&&vectorStart&&("cutting"===gameState||window.isPracticeMode)){if(isDrawingVector=!1,vectorEnd=getCanvasCoordinates(e),dragDistance<10)return window.updateInstructionText&&window.updateInstructionText("Try again",!0),resetVectorState(),ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid(),renderShapeForCutting(parsedShapes),void(3===currentShapeIndex&&firstCutVector&&drawPreviousVector(firstCutVector));if(vectorStart&&vectorEnd){let e=vectorStart,t=vectorEnd;vectorStart.x>vectorEnd.x&&(e=vectorEnd,t=vectorStart),currentMechanic&&"function"==typeof currentMechanic.performVectorCut?(console.log("üîß Using mechanic-specific performVectorCut"),currentMechanic.performVectorCut()):(console.log("üîß Using default performVectorCut - main game sets currentVector"),currentVector=extendVectorToCanvasBounds(e,t),vectorCutActive=!0,performVectorCut())}}}function getCanvasCoordinates(e){const t=canvas.getBoundingClientRect();let n,o;e.type.startsWith("touch")?(n=e.touches[0]?.clientX||e.changedTouches[0]?.clientX,o=e.touches[0]?.clientY||e.changedTouches[0]?.clientY):(n=e.clientX,o=e.clientY);const a=n-t.left,i=o-t.top;return{x:a*(380/t.width),y:i*(380/t.height)}}function extendVectorToCanvasBounds(e,t){const n=t.x-e.x,o=t.y-e.y,a=380;if(Math.abs(n)<.001)return{start:{x:e.x,y:0},end:{x:e.x,y:a}};if(Math.abs(o)<.001)return{start:{x:0,y:e.y},end:{x:a,y:e.y}};const i=o/n,r=e.y-i*e.x,s=[],c=r;c>=0&&c<=a&&s.push({x:0,y:c});const l=i*a+r;l>=0&&l<=a&&s.push({x:a,y:l});const d=(0-r)/i;d>=0&&d<=a&&s.push({x:d,y:0});const p=(a-r)/i;return p>=0&&p<=a&&s.push({x:p,y:a}),s.length>=2?{start:s[0],end:s[1]}:{start:e,end:t}}function drawCurrentVector(){vectorStart&&vectorEnd&&(ctx.save(),ctx.strokeStyle="#000000",ctx.lineWidth=2,ctx.setLineDash([5,5]),ctx.beginPath(),ctx.moveTo(vectorStart.x,vectorStart.y),ctx.lineTo(vectorEnd.x,vectorEnd.y),ctx.stroke(),ctx.restore())}function drawPreviousVector(e){e&&(ctx.save(),ctx.strokeStyle="#000000",ctx.lineWidth=2,ctx.setLineDash([]),ctx.beginPath(),ctx.moveTo(e.start.x,e.start.y),ctx.lineTo(e.end.x,e.end.y),ctx.stroke(),ctx.restore())}function drawVector(e,t,n="cut"){e&&t&&(ctx.save(),ctx.strokeStyle="#000000",ctx.lineWidth=2,ctx.setLineDash([]),ctx.beginPath(),ctx.moveTo(e.x,e.y),ctx.lineTo(t.x,t.y),ctx.stroke(),ctx.restore())}async function performVectorCut(){const e=window.isPracticeMode?window.practiceMode?.practiceParsedShapes||[]:parsedShapes||[];if(console.log("üöÄ performVectorCut called with:",{hasCurrentVector:!!currentVector,currentVector:currentVector,shapesLength:e.length,gameState:gameState,isInteractionEnabled:isInteractionEnabled,isPracticeMode:window.isPracticeMode}),!currentVector||!e.length)return void console.error("‚ùå performVectorCut early exit - missing requirements:",{hasCurrentVector:!!currentVector,shapesLength:e.length,isPracticeMode:window.isPracticeMode});updateStatus("Calculating cut areas...");const t=validateCut();if(console.log("üîç Cut validation result:",t),!t)return console.log("‚ùå Invalid cut detected - not counting attempt"),void handleInvalidCut();console.log("‚úÖ Valid cut detected - proceeding with attempt"),await handleCutAttempt()}function validateCut(){const e=window.isPracticeMode?window.practiceMode?.practiceParsedShapes||[]:parsedShapes||[];if(console.log("üîç validateCut called:",{hasCurrentVector:!!currentVector,shapesLength:e.length,isPracticeMode:window.isPracticeMode}),!currentVector||!e.length)return console.warn("üîç validateCut early return - missing currentVector or shapes"),!1;const t=document.createElement("canvas"),n=getCanvasSize();t.width=n,t.height=n;const o=t.getContext("2d");renderShapesForPixelAnalysis(o,e);const a=o.getImageData(0,0,t.width,t.height).data,i=window.currentVector||currentVector;if(!i)return void console.error("‚ùå No vector available for area calculation");const r=calculatePixelBasedAreas(a,t.width,t.height,i);return!(r.leftPercentage<.1||r.rightPercentage<.1)||(console.log("Invalid cut detected - no actual division:",r.leftPercentage,r.rightPercentage),!1)}function handleInvalidCut(){console.log("üö´ Invalid cut - allowing recut without counting"),resetVectorState(),window.updateInstructionText&&window.updateInstructionText("Try again",!0),ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid();renderShapeForCutting(window.isPracticeMode?window.practiceMode?.practiceParsedShapes||[]:parsedShapes||[]),3===currentShapeIndex&&firstCutVector&&drawPreviousVector(firstCutVector),gameState="cutting"}document.addEventListener("authStateChanged",async()=>{console.log("üîÑ Auth state changed - checking for pending competition joins and refreshing daily game"),window.DailyGameCore&&window.DailyGameCore.refreshForNewUser&&await window.DailyGameCore.refreshForNewUser();if(sessionStorage.getItem("signInFromPlay")&&window.AuthService?.isLoggedIn())return console.log("‚úÖ Sign-in from play button detected - continuing game start"),sessionStorage.removeItem("signInFromPlay"),void setTimeout(()=>{continuePlayButtonClick()},500);const e=sessionStorage.getItem("pendingJoinCompetitionId");if(e&&window.AuthService?.isLoggedIn()){console.log("üîó Found pending competition join after auth state change:",e),sessionStorage.removeItem("pendingJoinCompetitionId");try{console.log("üîó Waiting for CompetitionManager to fully initialize..."),await new Promise(e=>setTimeout(e,500));await checkUserParticipation(e)?(console.log("üîó User already participating after login"),showAlreadyPlayingModal(e)):(console.log("üîó User not participating, showing join modal"),showJoinCompetitionModal(e))}catch(t){console.error("‚ùå Error joining competition in auth state change:",t),showJoinCompetitionModal(e)}}else hasProcessedInitialJoinLink||(hasProcessedInitialJoinLink=!0,processJoinLink())}),window.showChangePasswordModal=showChangePasswordModal,window.handleLogoutClick=handleLogout,window.showCompetitionLeaderboard=showCompetitionLeaderboard,window.shareCompetition=shareCompetition,window.enterPracticeMode=enterPracticeMode;let totalCutsMade=window.totalCutsMade||0,cutsMadeThisShape=window.cutsMadeThisShape||0;async function handleCutAttempt(){if(console.log("üî• MAIN: handleCutAttempt called!"),console.log("üî• MAIN: isDemoMode =",isDemoMode,"isPracticeMode =",isPracticeMode,"window.isPracticeMode =",window.isPracticeMode),console.log("üî• MAIN: isDailyMode =",isDailyMode,"(CRITICAL FOR CUT BLOCKING)"),console.log("üî• MAIN: Current counters - totalCuts:",totalCutsMade,"cutsThisShape:",cutsMadeThisShape),window.isPracticeMode&&console.log("üî™ Practice mode cut attempt - using existing logic"),window.isPracticeMode||isDailyMode||(console.log("üö® SAFETY: Not in practice mode but isDailyMode=false, forcing daily mode"),isDailyMode=!0),isDailyMode&&cutsMadeThisShape>=2)return console.log("üö´ CUT BLOCKED: Daily mode - Shape cuts",cutsMadeThisShape,"exceeds maximum of 2 per shape"),void(window.isPracticeMode||(console.log("üîì Re-enabling canvas after cut limit block (safety)"),canvas.style.pointerEvents="none",isInteractionEnabled=!1,window.isInteractionEnabled=!1));if(isDailyMode&&currentAttemptNumber>2)return console.log("üö´ CUT BLOCKED: Daily mode - Attempt number",currentAttemptNumber,"exceeds maximum of 2 per shape"),void(window.isPracticeMode||(console.log("üîì Re-enabling canvas after attempt limit block (safety)"),canvas.style.pointerEvents="none",isInteractionEnabled=!1,window.isInteractionEnabled=!1));const e=window.isPracticeMode?window.gameState:gameState;if("cutting"!==e)return void console.log("üö´ CUT BLOCKED: Game state is",e,'not "cutting"',window.isPracticeMode?"(practice mode)":"(daily mode)");if(!(window.isPracticeMode?window.isInteractionEnabled:isInteractionEnabled))return void console.log("üö´ CUT BLOCKED: Interaction is disabled",window.isPracticeMode?"(practice mode)":"(daily mode)");window.isPracticeMode?console.log("üéØ Practice mode: NOT incrementing daily game counters"):(totalCutsMade++,cutsMadeThisShape++,window.totalCutsMade=totalCutsMade,window.cutsMadeThisShape=cutsMadeThisShape),console.log("‚úÖ Cut allowed - Attempt:",currentAttemptNumber,"Shape:",currentShapeNumber,"State:",gameState),console.log("‚úÖ Updated counters - totalCuts:",totalCutsMade,"cutsThisShape:",cutsMadeThisShape),isDailyMode&&!isPracticeMode&&(console.log("üîí IMMEDIATE: Deactivating canvas to prevent multiple rapid cuts"),canvas.style.pointerEvents="none",isInteractionEnabled=!1,window.isInteractionEnabled=!1);const t=document.createElement("canvas"),n=getCanvasSize();t.width=n,t.height=n;const o=t.getContext("2d"),a=window.isPracticeMode?window.practiceMode?.practiceParsedShapes||window.parsedShapes||[]:parsedShapes||[];console.log(`üîç CRITICAL: renderShapesForPixelAnalysis using ${a.length} shapes (isPracticeMode: ${window.isPracticeMode})`),window.isPracticeMode&&console.log("üéÆ PRACTICE: Using practice shapes for pixel analysis:",a[0]?.coordinates?.length||"no shape","vertices"),renderShapesForPixelAnalysis(o,a);const i=o.getImageData(0,0,t.width,t.height).data;let r;if(window.currentAreaResults)console.log("üî• MAIN: Using pre-calculated area results from shape-based mechanic"),r=window.currentAreaResults,window.currentVector&&!currentVector&&(currentVector=window.currentVector);else{const e=window.currentVector||currentVector;if(!e)return void console.error("‚ùå No vector available for area calculation");r=calculatePixelBasedAreas(i,t.width,t.height,e),currentVector=e}console.log("Valid cut - Area Results:",r.leftPercentage,r.rightPercentage);const s=ShapeTypeHandler.calculateShape1Score(r.leftPercentage,r.rightPercentage);if(window.isPracticeMode){const e=getInitialInstruction(getPracticeMechanicName());window.updateInstructionText&&e&&setTimeout(()=>{window.updateInstructionText(e,!1);const t=document.getElementById("instructionArea");t&&(t.style.display="flex",t.style.visibility="visible",t.style.opacity="1",console.log("üîß FORCED instruction area visibility for practice mode")),console.log("üéÆ Practice mode - restored initial instruction:",e)},500)}else{console.log("üéØ Score calculation - Percentages:",r.leftPercentage,"/",r.rightPercentage,"Score:",s);const e=getPlayfulCommentary(s);console.log("üéØ Showing cut commentary:",e),window.updateInstructionText?(window.updateInstructionText(e,!0),console.log("üéØ Commentary sent to updateInstructionText")):console.error("üéØ updateInstructionText not available")}if(s>=100&&(console.log("üéâ Perfect cut detected! Triggering confetti animation"),triggerConfettiAnimation()),window.currentAreaResults&&(window.currentAreaResults=null,console.log("üî• MAIN: Cleared shape-based area results")),!window.isPracticeMode){const e={attemptNumber:attemptCount,leftPercentage:r.leftPercentage,rightPercentage:r.rightPercentage,cutVector:{...currentVector},splitAreas:{left:r.leftArea,right:r.rightArea},timestamp:(new Date).toISOString()};window.triangleCutResult&&window.triangleCutResult.triangle&&(e.trianglePoints=window.triangleCutResult.triangle.points,console.log("üíæ Saved triangle points to attempt:",e.trianglePoints)),currentAttempts.push(e),window.currentAttempts=[...currentAttempts],window.debugCurrentAttempts("cut-processing","PUSHED new attempt result"),window.SimpleRefresh&&window.SimpleRefresh.save&&(window.SimpleRefresh.save(),console.log("üíæ SimpleRefresh: Saved state immediately after cut processing"))}if(isDemoMode&&!window.isPracticeMode&&currentDay&&currentShapeNumber&&recordAttemptScore(currentDay,currentShapeNumber,r.leftPercentage,r.rightPercentage),!window.isPracticeMode&&currentAttempts.length>attemptCount&&(attemptCount=currentAttempts.length,console.log("üìä Attempt count updated to match attempts made:",attemptCount),console.log("üìä maxAttempts:",maxAttempts,"isPracticeMode:",isPracticeMode)),!window.isPracticeMode&&window.Analytics&&window.Analytics.trackAttemptMade(attemptCount,r.leftPercentage,r.rightPercentage),window.isPracticeMode)console.log("üéÆ Practice mode - skipping database save and competition updates");else if(window.AuthService&&window.AuthService.isLoggedIn())try{const e=(new Date).toISOString().split("T")[0];console.log("üîç DEBUG: Starting automatic score save for logged-in user"),console.log("   Current shape number:",currentShapeNumber),console.log("   Current attempt:",attemptCount),console.log("   Current date:",e),console.log("   Current mechanic:",getCurrentMechanicName());const t={};console.log("üîç DEBUG: Fetching existing scores from database for accumulation...");try{const n=await window.AuthService.getExistingDailyScore(e);if(n){console.log("üîç DEBUG: Found existing score record:",n);for(let e=1;e<=3;e++){const o=`shape${e}`,a=`${o}_attempt1`,i=`${o}_attempt2`;null===n[a]&&null===n[i]||(t[o]={attempt1:n[a],attempt2:n[i]})}}else console.log("üîç DEBUG: No existing score record found - starting fresh")}catch(e){console.error("‚ùå ERROR: Failed to fetch existing scores:",e)}const n=`shape${currentShapeNumber}`;t[n]||(t[n]={attempt1:null,attempt2:null}),currentAttempts[0]&&(t[n].attempt1=calculateScore(currentAttempts[0].leftPercentage,currentAttempts[0].rightPercentage)),currentAttempts[1]&&(t[n].attempt2=calculateScore(currentAttempts[1].leftPercentage,currentAttempts[1].rightPercentage));const o=calculateScore(r.leftPercentage,r.rightPercentage);1===attemptCount?t[n].attempt1=o:2===attemptCount&&(t[n].attempt2=o),console.log("üìä DEBUG: Shape scores prepared for saving:",JSON.stringify(t,null,2)),console.log("‚ÑπÔ∏è Daily score will be saved during final completion, not after each attempt")}catch(e){console.error("‚ùå Failed to prepare score data:",e)}else console.log("‚ÑπÔ∏è DEBUG: Score preparation skipped - user not logged in");if(window.isPracticeMode){console.log("üî™ Practice mode cut detected - intercepting results");const e=window.currentVector||currentVector;return console.log("üîß Practice mode vector for rendering:",{hasWindowVector:!!window.currentVector,hasCurrentVector:!!currentVector,vectorStart:e?.start,vectorEnd:e?.end}),void handlePracticeCutComplete(r,e)}if(window.canceledLineDrawing&&(console.log("üîß Clearing canceledLineDrawing flag just before rendering to fix shading"),window.canceledLineDrawing=!1),window.triangleCutActive&&window.triangleCutResult?console.log("‚úÖ Triangle mechanic already rendered result - skipping main.js rendering to preserve grid and outline"):(renderVectorCutResult(r),console.log("üé® handleCutAttempt - rendered colored cut result, isPracticeMode:",isPracticeMode)),canvas.style.pointerEvents="none",window.isPracticeMode?(console.log("üéÆ PRACTICE MODE: Keeping gameState as cutting for unlimited cuts"),setTimeout(()=>{window.isPracticeMode&&(canvas.style.pointerEvents="auto",window.gameState="cutting",window.isInteractionEnabled=!0,console.log("üéÆ PRACTICE MODE: Canvas re-enabled for next cut"))},2e3)):gameState="animating",isDailyMode&&(isInteractionEnabled=!1,window.isInteractionEnabled=!1,console.log("üö´ DAILY MODE: Canvas interaction force disabled after cut")),showAttemptResult(r.leftPercentage,r.rightPercentage),!window.isPracticeMode){const e=document.getElementById("progressCircles");e&&(e.style.display="flex",e.style.opacity="1"),updateProgressCircles(attemptCount)}if(isDailyMode&&attemptCount<maxAttempts&&(gameState="awaiting_choice",isInteractionEnabled=!1,console.log("üéØ Daily mode: Canvas deactivated after cut - awaiting user decision"),console.log("üîò DAILY MODE: Creating progression button after cut"),createProgressionButton(),console.log("üíæ Saving awaiting_choice state before animation:",{attemptCount:attemptCount,currentAttemptsLength:currentAttempts.length,gameState:gameState}),saveGameState(),saveStructuredGameState()),isDailyMode&&!isDemoMode&&attemptCount>=maxAttempts){console.log("üéØ 3rd attempt reached - showing cut fade, then finding best attempt"),gameState="finished";const e=currentAttempts.reduce((e,t)=>Math.abs(50-t.leftPercentage)<Math.abs(50-e.leftPercentage)?t:e);finalLockedScore={leftPercentage:e.leftPercentage,rightPercentage:e.rightPercentage};const t=getCurrentDateString();localStorage.setItem(STORAGE_KEYS.lastPlayDate,t),localStorage.setItem(STORAGE_KEYS.gamePhase,"post-play"),localStorage.setItem(STORAGE_KEYS.isFinished,"true"),localStorage.setItem(STORAGE_KEYS.hasTriedToday,"true"),saveGameState(),saveStructuredGameState();try{console.log("üéÆ Starting 3rd attempt fade animation...");const e=new Promise((e,t)=>setTimeout(()=>t(new Error("Fade animation timeout")),5e3));await Promise.race([performFadeAnimation(),e]),console.log("‚úÖ 3rd attempt fade animation complete"),console.log("üìä All attempts for comparison:",currentAttempts.map(e=>({attempt:e.attemptNumber,leftPercent:e.leftPercentage.toFixed(1),rightPercent:e.rightPercentage.toFixed(1),deviation:(Math.abs(e.leftPercentage-50)+Math.abs(e.rightPercentage-50)).toFixed(1)})));const t=findBestAttempt(currentAttempts);finalLockedScore=t,localStorage.setItem(STORAGE_KEYS.finalScoreData,JSON.stringify({leftPercentage:t.leftPercentage,rightPercentage:t.rightPercentage,attemptCount:attemptCount,cutVector:t.cutVector,splitAreas:t.splitAreas})),currentVector=t.cutVector,ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid(),renderCurrentShape();const n={leftPercentage:t.leftPercentage,rightPercentage:t.rightPercentage,leftArea:t.splitAreas.left,rightArea:t.splitAreas.right};console.log("üéÆ Rendering best cut result..."),ctx.clearRect(0,0,canvas.width,canvas.height),currentVector=t.cutVector,window.canceledLineDrawing&&(console.log("üîß Best attempt: Clearing canceledLineDrawing flag just before rendering to fix shading"),window.canceledLineDrawing=!1),renderVectorCutResult(n),console.log("‚úÖ Best cut rendered"),console.log("‚úÖ Direct rendering complete");const o=document.querySelector(".attempt-buttons");o&&o.remove(),showPostLockInElements();try{await supabaseClient.submitAttemptV3(currentDate,t.leftPercentage,t.rightPercentage,attemptCount),console.log("‚úÖ Final score submitted successfully")}catch(e){console.error("Failed to submit final score:",e)}gameState="locked",window.Analytics&&finalLockedScore&&window.Analytics.trackGameComplete(attemptCount,finalLockedScore),saveGameState(),saveStructuredGameState(),await showFinalState()}catch(e){console.error("üí• Error in end-of-game sequence:",e),gameState="locked",saveGameState(),saveStructuredGameState(),await showFinalState()}}else isDemoMode?(console.log("üéÆ Demo mode cut completed"),console.log("üéÆ Current state - Attempt:",currentAttemptNumber,"Shape:",currentShapeNumber),console.log("üéÆ Cuts made this shape:",cutsMadeThisShape,"Total cuts:",totalCutsMade),console.log("üéÆ isDemoMode:",isDemoMode,"isPracticeMode:",isPracticeMode),1===cutsMadeThisShape?(console.log("üîÑ 1st cut completed - need 2nd cut on shape",currentShapeNumber),console.log("üîÑ Setting currentAttemptNumber to 1 for button logic"),currentAttemptNumber=1,window.currentAttemptNumber=currentAttemptNumber,updateProgressUI(),createProgressionButton(),gameState="awaiting_choice",isInteractionEnabled=!1):2===cutsMadeThisShape?(console.log("‚úÖ 2nd cut completed on shape",currentShapeNumber),console.log("‚úÖ Setting currentAttemptNumber to 2 for button logic"),currentAttemptNumber=2,window.currentAttemptNumber=currentAttemptNumber,updateProgressUI(),createProgressionButton(),gameState="awaiting_choice",isInteractionEnabled=!1):(console.error("‚ö†Ô∏è Unexpected cuts made this shape:",cutsMadeThisShape),gameState="awaiting_choice",isInteractionEnabled=!1)):isPracticeMode?(console.log("üéÆ Practice mode cut - showing staged instructions"),await handlePracticeModeCut(r)):(await performFadeAnimation(),setTimeout(()=>{handleTryAgain()},1e3));window.triangleCutActive&&(console.log("üßπ handleCutAttempt complete - clearing triangle protection flags"),window.triangleCutActive=!1,window.triangleCutResult=null),saveDemoGameState()}function findBestAttempt(e){if(!e||0===e.length)return null;let t=e[0],n=Math.abs(t.leftPercentage-50)+Math.abs(t.rightPercentage-50);for(let o=1;o<e.length;o++){const a=e[o],i=Math.abs(a.leftPercentage-50)+Math.abs(a.rightPercentage-50);i<n&&(n=i,t=a)}return console.log("üéØ Best attempt selected:",{attemptNumber:t.attemptNumber,leftPercentage:t.leftPercentage.toFixed(1),rightPercentage:t.rightPercentage.toFixed(1),deviationFromPerfect:n.toFixed(1),totalAttempts:e.length}),t}async function prepareCanvasForFade(){try{const e=document.createElement("canvas");e.width=380,e.height=380;const t=e.getContext("2d");t.clearRect(0,0,e.width,e.height),drawGrid(t),renderShapeForCutting(parsedShapes,!1,t),canvasRestoreData=e.toDataURL("image/png"),console.log("üì∏ Prepared canvas states for fade animation")}catch(e){console.error("Failed to prepare canvas:",e)}}async function performFadeAnimation(){return new Promise(e=>{const t=1e3,n=Date.now(),o=new Image;o.src=canvas.toDataURL("image/png"),prepareCanvasForFade(),o.onload=()=>{const a=()=>{const i=Date.now()-n,r=Math.min(i/4e3,1);let s;if(i<t)s=1;else{const e=i-t;s=1-Math.min(e/3e3,1)}ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid(ctx),renderShapeForCutting(parsedShapes,!1,ctx),s>0&&(ctx.save(),ctx.globalAlpha=s,ctx.drawImage(o,0,0),ctx.restore()),r<1?requestAnimationFrame(a):setTimeout(()=>{e()},300)};a()}})}async function handlePracticeModeCut(e){console.log("üéÆ Practice mode cut - simplified flow"),setTimeout(async()=>{const e=getInitialInstruction(getPracticeMechanicName());window.updateInstructionText&&(window.updateInstructionText(e,!1),console.log("üéÆ Practice mode - reset to initial instruction:",e)),await showPlayButtonForPractice(),resetPracticeForNextCut()},1e3)}async function performPracticeRenderFade(){return new Promise(e=>{const t=Date.now();console.log("üé® Practice fade - starting with existing colored cut on canvas");const n=new Image;n.src=canvas.toDataURL("image/png"),console.log("üé® Practice fade - currentVector exists:",!!currentVector),console.log("üé® Practice fade - canvas data URL length:",n.src.length),console.log("üé® Practice fade - parsedShapes length:",parsedShapes.length);const o=ctx.getImageData(0,0,380,380).data;let a=0,i=0;for(let e=0;e<o.length;e+=4)100===o[e]&&150===o[e+1]&&255===o[e+2]?a++:221===o[e]&&221===o[e+1]&&221===o[e+2]&&i++;console.log("üé® Canvas pixels before capture:",{bluePixelsInCanvas:a,greyPixelsInCanvas:i}),prepareCanvasForFade(),n.onerror=()=>{console.error("üé® Failed to load colored cut image"),e()},n.onload=()=>{console.log("üé® Colored cut image loaded successfully for practice fade"),console.log("üé® Image dimensions:",n.width,"x",n.height);const o=()=>{const a=Date.now()-t,i=Math.min(a/2e3,1);let r;if(a<500)r=1;else{const e=a-500;r=1-Math.min(e/1500,1)}ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid(ctx),r>0&&n.complete&&(ctx.save(),ctx.globalAlpha=r,ctx.drawImage(n,0,0),ctx.restore(),a%500<50&&console.log("üé® Drawing colored cut image with alpha:",r)),r<1?(ctx.save(),ctx.globalAlpha=1-r,renderShapeForCutting(parsedShapes,!1,ctx),ctx.restore(),a%500<50&&console.log("üé® Drawing base grey shape with alpha:",1-r)):a%500<50&&console.log("üé® Skipping base grey shape - colored cut at full alpha"),i<1?requestAnimationFrame(o):e()};o()}})}async function performLockInFadeAnimation(e){return new Promise(t=>{const n=performance.now();requestAnimationFrame(function o(a){const i=a-n,r=Math.min(i/1e3,1);ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid(ctx),renderShapeForCutting(parsedShapes,!1,ctx),renderVectorCutResultWithOpacity(e,.3+.7*r),r<1?requestAnimationFrame(o):t()})})}function showCommittedResultInstant(e,t){const n=document.querySelector(".results-container"),o=n.querySelector(".attempt-result");o&&o.remove(),createCommittedResultDisplay(e,t,n,!1);animateStatsTable(currentAttempts&&currentAttempts.length>0?currentAttempts:[e],t)}function showCommittedResultWithFadeIn(e,t){const n=document.querySelector(".results-container"),o=n.querySelector(".attempt-result");o&&o.remove(),createCommittedResultDisplay(e,t,n,!0)}function createMedalStatsTable(e,t,n){console.log("üèÖ Creating medal stats table with:",{attemptsCount:e?.length,attempts:e,todaysAverage:t,resultsContainer:!!n});const o=document.createElement("div");if(o.className="attempt-result",o.id="medalStatsTable",o.innerHTML='\n        <div class="attempt-info">\n            <div class="medal-stats-table">\n                <div class="stats-row" id="attempt1Row" style="opacity: 0;">\n                    <div class="medal">ü•á</div>\n                    <div class="attempt-split" id="attempt1Split">--.- % / --.- %</div>\n                </div>\n                <div class="stats-row" id="attempt2Row" style="opacity: 0;">\n                    <div class="medal">ü•à</div>\n                    <div class="attempt-split" id="attempt2Split">--.- % / --.- %</div>\n                </div>\n                <div class="stats-row" id="attempt3Row" style="opacity: 0;">\n                    <div class="medal">ü•â</div>\n                    <div class="attempt-split" id="attempt3Split">--.- % / --.- %</div>\n                </div>\n            </div>\n        </div>\n    ',n){n.querySelector(".results-table"),n.querySelector("#progressCircles");const e=document.getElementById("dynamicResultsContainer");e?(e.appendChild(o),console.log("üèÖ Medal stats positioned in dedicated container")):(n.appendChild(o),console.log("‚ö†Ô∏è Fallback: Medal stats appended to results container"))}else console.error("üèÖ No results container found!");return o}async function animateStatsTable(e,t){const n=[...e].map((e,t)=>({...e,originalIndex:t,accuracy:Math.abs(50-e.leftPercentage)})).sort((e,t)=>e.accuracy-t.accuracy),o=["ü•á","ü•à","ü•â"];for(let e=0;e<Math.min(n.length,3);e++){const t=n[e],a=`attempt${e+1}Row`,i=`attempt${e+1}Split`,r=o[e];setTimeout(()=>{const e=document.getElementById(a),n=document.getElementById(i),o=e?.querySelector(".medal");e&&n&&(o&&(o.textContent=r),n.innerHTML=`<span style="color: #000000;">${t.leftPercentage.toFixed(1)}%</span> / <span style="color: #000000;">${t.rightPercentage.toFixed(1)}%</span>`,e.style.transition="opacity 400ms ease-out",e.style.opacity="1")},300*e)}}function createCommittedResultDisplay(e,t,n,o){console.log("üèÖ Creating committed result display with:",{currentAttempts:currentAttempts?.length,attemptResult:e,todaysAverage:t,withFadeIn:o});const a=currentAttempts&&currentAttempts.length>0?currentAttempts:[e];createMedalStatsTable(a,t,n),o&&setTimeout(()=>{animateStatsTable(a,t)},200)}function showAttemptResult(e,t){if(console.log("üß™ Cut results:",e.toFixed(1),t.toFixed(1)),isPracticeMode||50!==e||50!==t||(console.log("üéØ Perfect 50/50 cut achieved in daily mode!"),window.AuthService&&!window.AuthService.isGuest&&window.AuthService.trackPerfectCut()),window.isPracticeMode){const n=document.getElementById("resultsTableBody");n&&(n.innerHTML="");if(!document.querySelector(".results-container"))return;return document.querySelectorAll(".attempt-result").forEach(e=>{e.remove()}),void createNewAttemptResult(e,t)}if(isDailyMode||isDemoMode){if(!document.querySelector(".results-container"))return;return document.querySelectorAll(".attempt-result").forEach(e=>{e.remove()}),void createNewAttemptResult(e,t)}}function showDoubleCircleResult(e,t,n){if(console.log("üß™ Double Circle results:",e.toFixed(1),t.toFixed(1),n.toFixed(1)),window.isPracticeMode){const o=document.getElementById("resultsTableBody");o&&(o.innerHTML="");const a=document.querySelector(".results-container");if(!a)return;return document.querySelectorAll(".attempt-result").forEach(e=>{e.remove()}),void createDoubleCircleResult(e,t,n,a)}}function createDoubleCircleResult(e,t,n,o){const a=document.createElement("div");a.className="attempt-result",a.innerHTML=`\n        <div class="attempt-info">\n            <div class="split-display-large">\n                <span style="color: rgb(100, 150, 255); font-weight: bold;">${e.toFixed(1)}%</span><span style="color: #999999; font-weight: bold; font-size: 46px; margin: 0 5px;"> / </span><span style="color: rgb(255, 165, 0); font-weight: bold;">${t.toFixed(1)}%</span><span style="color: #999999; font-weight: bold; font-size: 46px; margin: 0 5px;"> / </span><span style="color: #999999; font-weight: bold;">${n.toFixed(1)}%</span>\n            </div>\n        </div>\n    `;const i=document.getElementById("fixedPercentageArea");i?(i.innerHTML="",i.appendChild(a),console.log("‚úÖ Double Circle percentages displayed in FIXED area:",e.toFixed(1),t.toFixed(1),n.toFixed(1))):console.error("‚ùå Fixed percentage area not found")}function createNewAttemptResult(e,t){if(window.completeView&&"function"==typeof window.completeView.isActive&&window.completeView.isActive())return void console.log("üéÆ Completion view is active - skipping split display creation to prevent interference");let n,o;if(window.isPracticeMode){n="rgb(250, 176, 106)",o="#999999",console.log("üéØ Practice mode colors: leftPercentage="+e.toFixed(1)+"% (yellow), rightPercentage="+t.toFixed(1)+"% (grey)"),console.log("üéØ Vector details:",window.currentVector?{start:window.currentVector.start,end:window.currentVector.end,direction:"start‚Üíend",slope:window.currentVector.start&&window.currentVector.end?((window.currentVector.end.y-window.currentVector.start.y)/(window.currentVector.end.x-window.currentVector.start.x)).toFixed(2):"N/A"}:"No vector"),console.log("üéØ Split display assignment: LEFT side always gets COLORED text, RIGHT side always gets GREY text")}else n="rgb(100, 150, 255)",o="#999999";const a=document.getElementById("fixedPercentageArea");if(!a)return void console.error("‚ùå Fixed percentage area not found");a.innerHTML="";const i=document.createElement("div");i.className="attempt-result",i.style.cssText="display: block !important; visibility: visible !important; opacity: 1 !important;";const r=window.isPracticeMode?ShapeTypeHandler.calculateShape1Score(e,t):null;i.innerHTML=`\n        <div class="attempt-info" style="display: flex !important; flex-direction: column !important; align-items: center !important;">\n            <div class="split-display-large" style="display: flex !important; justify-content: center !important; align-items: center !important; font-size: 46px !important; font-weight: 700 !important; min-height: 60px !important;">\n                <span style="color: ${n} !important; font-weight: bold !important; font-size: 46px !important; display: inline-block !important; visibility: visible !important;">${e.toFixed(1)}%</span><span style="color: #999999 !important; font-weight: bold !important; font-size: 46px !important; display: inline-block !important; visibility: visible !important; margin: 0 5px !important;"> / </span><span style="color: ${o} !important; font-weight: bold !important; font-size: 46px !important; display: inline-block !important; visibility: visible !important;">${t.toFixed(1)}%</span>\n            </div>\n            ${null!==r?`\n                <div style="margin-top: 8px !important; display: flex !important; justify-content: center !important; align-items: center !important;">\n                    <span style="font-size: 16px !important; color: #666 !important; display: inline-block !important;">Score&nbsp;</span>\n                    <span style="font-size: 18px !important; font-weight: bold !important; display: inline-block !important; margin-left: 4px !important;">${r.toFixed(1)}/100</span>\n                </div>\n            `:""}\n        </div>\n    `,a.style.setProperty("visibility","visible","important"),a.style.setProperty("display","flex","important"),a.style.setProperty("opacity","1","important"),a.appendChild(i);const s=window.getComputedStyle(a);console.log("üîç FixedPercentageArea computed styles:",{display:s.display,visibility:s.visibility,opacity:s.opacity,position:s.position,top:s.top,left:s.left,width:s.width,height:s.height,zIndex:s.zIndex,backgroundColor:s.backgroundColor,overflow:s.overflow});const c=a.getBoundingClientRect();console.log("üîç FixedPercentageArea bounding box:",{x:c.x,y:c.y,width:c.width,height:c.height,top:c.top,left:c.left,bottom:c.bottom,right:c.right}),console.log("‚úÖ Percentage splits positioned in FIXED area:",e.toFixed(1),t.toFixed(1)),console.log("üìä DEBUG - Fixed area HTML:",a.innerHTML),console.log("üìä DEBUG - Result div HTML:",i.innerHTML),console.log("üìä DEBUG - Split display element:",i.querySelector(".split-display-large"));const l=i.querySelector(".split-display-large");l&&(l.style.setProperty("display","flex","important"),l.style.setProperty("visibility","visible","important"),l.style.setProperty("opacity","1","important"),console.log("üìä DEBUG - Forced split display styles applied"))}function animatePercentageReplacement(e,t,n,o){const a="rgb(100, 150, 255)",i=e.querySelector(".attempt-info");if(!i)return;const r=i.querySelector(".split-display-large");if(!r)return;const s=r.querySelector("span");if(!s)return;const c=window.matchMedia("(prefers-reduced-motion: reduce)").matches,l=r.offsetWidth||200,d=r.offsetHeight||80;if(c)return s.textContent=`${percentage.toFixed(1)}%`,void(s.style.color=color);const p=document.createElement("div");p.style.position="relative",p.style.width=2*l+"px",p.style.height=d+"px",p.style.left="0px",p.style.transition="left 0.35s cubic-bezier(0.4, 0.0, 0.2, 1)",r.style.overflow="hidden",r.style.position="relative",r.style.width="100%",r.style.maxWidth=l+"px",r.style.height=d+"px",r.style.minHeight="1.2em";const u=document.createElement("span");u.innerHTML=s.innerHTML,u.style.position="absolute",u.style.left="0px",u.style.top="0px",u.style.width=l+"px",u.style.textAlign="center",u.style.whiteSpace="nowrap";const g=document.createElement("span");g.innerHTML=`<span style="color: ${a}; font-weight: bold; font-size: 46px;">${t.toFixed(1)}%</span><span style="color: #999999; font-weight: bold; font-size: 46px; margin: 0 5px;"> / </span><span style="color: #999999; font-weight: bold; font-size: 46px;">${n.toFixed(1)}%</span>`,g.style.position="absolute",g.style.left=l+"px",g.style.top="0px",g.style.width=l+"px",g.style.textAlign="center",g.style.whiteSpace="nowrap",p.appendChild(u),p.appendChild(g),s.remove(),r.appendChild(p),requestAnimationFrame(()=>{p.style.left=-l+"px",setTimeout(()=>{p.remove();const e=document.createElement("span");e.innerHTML=`<span style="color: ${a}; font-weight: bold; font-size: 46px;">${t.toFixed(1)}%</span><span style="color: #999999; font-weight: bold; font-size: 46px; margin: 0 5px;"> / </span><span style="color: #999999; font-weight: bold; font-size: 46px;">${n.toFixed(1)}%</span>`,r.appendChild(e),r.style.overflow="",r.style.position="",r.style.width="",r.style.maxWidth="",r.style.height="",r.style.minHeight=""},350)})}function triggerConfettiAnimation(){const e=["#ff0000","#00ff00","#0000ff","#ffff00","#ff00ff","#00ffff","#ffa500","#800080"],t=document.body,n=[];for(let o=0;o<100;o++){const o=document.createElement("div");o.style.position="fixed",o.style.width=10*Math.random()+5+"px",o.style.height=10*Math.random()+5+"px",o.style.backgroundColor=e[Math.floor(Math.random()*e.length)],o.style.left=Math.random()*window.innerWidth+"px",o.style.top="-20px",o.style.opacity="1",o.style.pointerEvents="none",o.style.zIndex="9999",o.style.borderRadius="50%";const a=360*Math.random(),i=3*Math.random()+2,r=4*(Math.random()-.5);o.style.transform=`rotate(${a}deg)`,t.appendChild(o),n.push({element:o,x:parseFloat(o.style.left),y:-20,fallSpeed:i,horizontalDrift:r,rotation:a,rotationSpeed:10*(Math.random()-.5)})}requestAnimationFrame(function e(){let t=0;n.forEach(e=>{if(e.y<window.innerHeight+20){e.y+=e.fallSpeed,e.x+=e.horizontalDrift,e.rotation+=e.rotationSpeed,e.element.style.top=e.y+"px",e.element.style.left=e.x+"px",e.element.style.transform=`rotate(${e.rotation}deg)`;const n=Math.max(0,1-e.y/window.innerHeight);e.element.style.opacity=n,t++}}),t>0?requestAnimationFrame(e):n.forEach(e=>{e.element.parentNode&&e.element.parentNode.removeChild(e.element)})}),setTimeout(()=>{n.forEach(e=>{e.element.parentNode&&e.element.parentNode.removeChild(e.element)})},4e3)}function showAttemptButtons(){console.log("üîò showAttemptButtons called - but buttons are disabled for automatic flow")}function handleTryAgain(){console.log("üîÑ Try Again clicked - current attempt count:",attemptCount,"of",maxAttempts),window.Analytics&&window.Analytics.trackRetryAction();const e=document.querySelector(".attempt-buttons");if(e&&e.remove(),showCutPopup(),resetVectorState(),ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid(),renderShapeForCutting(parsedShapes),isDailyMode&&!window.isPracticeMode)return console.log("üö´ DAILY MODE: Canvas remains inactive - waiting for user progression button"),canvas.style.pointerEvents="none",isInteractionEnabled=!1,void(gameState="awaiting_choice");if(canvas.style.pointerEvents="auto",isInteractionEnabled=!0,gameState="cutting",console.log("üíæ Saving during-play state after Retry decision"),currentAttempts.length>0){const e=currentAttempts[currentAttempts.length-1],t={leftPercentage:e.leftPercentage,rightPercentage:e.rightPercentage,tryNumber:currentAttempts.length+1};localStorage.setItem(STORAGE_KEYS.displayedPercentages,JSON.stringify(t)),console.log("üíæ Saved displayedPercentages for restoration:",t)}saveGameState(),saveStructuredGameState()}async function handleLockIn(){console.log("üîí Lock In clicked - finalizing score"),console.log("üìä All attempts for comparison:",currentAttempts.map(e=>({attempt:e.attemptNumber,leftPercent:e.leftPercentage.toFixed(1),rightPercent:e.rightPercentage.toFixed(1),deviation:(Math.abs(e.leftPercentage-50)+Math.abs(e.rightPercentage-50)).toFixed(1)})));const e=findBestAttempt(currentAttempts);if(!e)return void console.error("No attempt to lock in");finalLockedScore=e,currentVector=e.cutVector;const t={leftPercentage:e.leftPercentage,rightPercentage:e.rightPercentage,leftArea:e.splitAreas.left,rightArea:e.splitAreas.right};window.canceledLineDrawing&&(console.log("üîß Final result: Clearing canceledLineDrawing flag just before rendering to fix shading"),window.canceledLineDrawing=!1),renderVectorCutResult(t);const n=document.querySelector(".attempt-buttons");n&&n.remove(),await performLockInFadeAnimation(e.areaResults),showPostLockInElements();try{await supabaseClient.submitAttemptV3(currentDate,e.leftPercentage,e.rightPercentage,attemptCount),console.log("‚úÖ Score submitted successfully")}catch(e){console.error("Failed to submit score:",e)}gameState="locked",saveGameState(),saveStructuredGameState(),await showFinalState()}async function showFinalState(){}function showPostLockInElements(){const e=document.querySelector(".results-container");if(!e)return void console.error("Results container not found");const t=document.createElement("div");t.className="post-lockin-container";const n=document.createElement("button");n.className="post-lockin-share-btn",n.textContent="Share",n.onclick=handleShare,t.appendChild(n),e.appendChild(t);const o=document.getElementById("countdownOverlay");o&&(o.style.display="block"),startNextGameCountdown(),setTimeout(()=>{t.classList.add("visible")},100)}function startNextGameCountdown(){const e=document.getElementById("countdownDisplay");if(!e)return;function t(){const t=new Date,n=new Date(t);n.setDate(n.getDate()+1),n.setHours(0,0,0,0);const o=n-t;if(o<=0)return void(e.textContent="New game available now!");const a=Math.floor(o/36e5),i=Math.floor(o%36e5/6e4),r=Math.floor(o%6e4/1e3),s=`${a.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`;e.textContent=`New shapes in ${s}`}t();const n=setInterval(t,1e3);window.gameCountdownInterval||(window.gameCountdownInterval=n)}async function handleSingleCut(){console.warn("handleSingleCut called but should not be used in v3.0")}async function handleShape3TwoCuts(){hideGoalCommentary();const e=calculateFourQuadrants(firstCutVector,currentVector),t=ShapeTypeHandler.calculateShape3ScoreWithQuadrants(e.percentages),n=getPlayfulCommentary(t),o={shape:currentShapeIndex,quadrants:e.quadrants,quadrantPercentages:e.percentages,score:t,cuts:2,cutVector:{...currentVector},firstCutVector:{...firstCutVector},originalShape:currentGeoJSON,splitAreas:{quadrants:e.quadrants},timestamp:(new Date).toISOString()};gameResults.push(o);try{await supabaseClient.submitScore(currentDate,currentShapeIndex,t,e.percentages.q1,e.percentages.q2)}catch(e){console.error("Failed to submit score:",e)}renderShape3QuadrantResult(e,firstCutVector,currentVector),captureShapeScreenshot(currentShapeIndex),updateResultsTable(),console.log("üéØ Showing cut commentary:",n),window.updateInstructionText?(window.updateInstructionText(n,!0),console.log("üéØ Commentary sent to updateInstructionText")):console.error("üéØ updateInstructionText not available"),replayShapeIndex=currentShapeIndex,console.log("üéØ Set replayShapeIndex to",replayShapeIndex,"when entering results state for shape",currentShapeIndex),gameState="results",3===gameResults.length&&(console.log("üîÑ All shapes completed - triggering endGame"),setTimeout(()=>{endGame()},500))}function handleMiss(){console.log("handleMiss() called - showing miss commentary"),isDrawingVector=!1,vectorStart=null,vectorEnd=null,currentVector=null,vectorCutActive=!1,dragDistance=0,window.updateInstructionText&&window.updateInstructionText("Try again",!0),ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid(),renderShapeForCutting(parsedShapes),3===currentShapeIndex&&firstCutVector&&drawPreviousVector(firstCutVector),gameState="cutting"}function resetVectorState(){isDrawingVector=!1,vectorStart=null,vectorEnd=null,currentVector=null,vectorCutActive=!1,dragDistance=0,hideCommentary()}function showCommentary(e,t=!1){console.log("showCommentary() called with text:",e);const n=document.getElementById("commentaryOverlay"),o=document.getElementById("commentaryText");n&&o&&(o.textContent=e,n.style.display="block",n.style.visibility="visible",n.style.opacity="1",n.style.zIndex="1000",t&&setTimeout(()=>{n.style.display="none"},3e3))}function hideCommentary(){const e=document.getElementById("commentaryOverlay");e&&(e.style.display="none")}function getPlayfulCommentary(e){return e>=100?"PERFECT CUT!!! üíØ":e>=95?"Almost perfect! üéâ":e>=85?"Clean cut! ‚úÇÔ∏è":e>=70?"Close shave! üî™":e>=50?"Not bad! üëç":"Shapes can be hard... üòÖ"}function showPlayButton(){const e=document.querySelector(".buttons-below-canvas");e&&(e.style.opacity="1",e.style.visibility="visible",e.style.pointerEvents="auto")}function showGoalDisplay(){const e=document.getElementById("goalDisplay");e&&(e.style.display="none")}function showGoalDisplayWithPreviousResult(e){console.log("üé® showGoalDisplayWithPreviousResult called with:",e);const t=document.getElementById("goalDisplay"),n=document.getElementById("goalText");if(console.log("üé® Goal display elements:",{goalDisplay:!!t,goalTextEl:!!n}),t&&n)if(e&&null!=e.leftPercentage){const o=e.leftPercentage.toFixed(1),a=e.rightPercentage.toFixed(1);console.log("üé® Setting goal display with percentages:",{bluePercent:o,greyPercent:a,goalTextElBefore:n.innerHTML});const i=`<span style="color: rgb(100, 150, 255); font-weight: bold;">${o}%</span> <span style="color: #777777; font-weight: bold;">/ ${a}%</span>`;n.innerHTML=i,t.style.display="block",t.style.opacity="1",n.style.opacity="1",n.style.transition="none",console.log("üé® Goal display updated:",{newHTML:i,goalTextElAfter:n.innerHTML,goalDisplayStyle:{display:t.style.display,opacity:t.style.opacity}})}else if(currentAttempts.length>0){const e=currentAttempts[currentAttempts.length-1],o=e.leftPercentage.toFixed(1),a=e.rightPercentage.toFixed(1);n.innerHTML=`<span style="color: rgb(100, 150, 255); font-weight: bold;">${o}%</span> <span style="color: #777777; font-weight: bold;">/ ${a}%</span>`,t.style.display="block",t.style.opacity="1",n.style.opacity="1",n.style.transition="none"}else showGoalDisplay()}function showAttemptDisplay(){const e=document.getElementById("attemptDisplay"),t=document.getElementById("attemptText");if(e&&t){const n=attemptCount+1,o=1===n?"1st Try":2===n?"2nd Try":"3rd Try";t.textContent=o,e.style.display="block",e.style.opacity="1"}}function hidePlayButton(){console.log("üö´ Hiding play button immediately...");const e=document.querySelector(".buttons-below-canvas");e&&(e.style.opacity="0",e.style.visibility="hidden",e.style.pointerEvents="none",console.log("‚úÖ Old play button location hidden"));const t=document.getElementById("initialPlayButton");t?(t.style.visibility="hidden",console.log("‚úÖ Initial play button hidden - display: none applied")):console.error("‚ùå initialPlayButton not found!")}function showPlayButtonBelowGoal(){console.log("üîß Showing play button below canvas for practise mode...");let e=document.getElementById("playBtnBelowCanvas");if(!e){e=document.createElement("button"),e.id="playBtnBelowCanvas",e.className="canvas-play-button",e.textContent="Play",e.addEventListener("click",function(){console.log("üéÆ Play button below canvas clicked - starting regular game"),isPracticeMode=!1,window.isPracticeMode=!1,isPractiseMode=!1,isDailyMode=!0,localStorage.removeItem("dailyShapes_practiceMode"),console.log("üéØ TRANSITION: Practice->Daily mode, isDailyMode set to",isDailyMode),handlePlayButtonClickOld()});const t=document.querySelector(".canvas-container"),n=document.querySelector(".results-container");t.parentNode.insertBefore(e,n)}e.style.display="block",e.style.opacity="1",e.style.backgroundColor="rgb(100, 150, 255)",e.style.color="white",e.style.position="static",console.log("‚úÖ Play button shown below canvas with blue color")}function showPhase1Instructions(){const e=document.getElementById("goalDisplay");e&&(e.style.display="none");const t=document.getElementById("playBtnBelowCanvas");t&&t.remove();let n=document.getElementById("phase1Instructions");if(!n){n=document.createElement("div"),n.id="phase1Instructions",n.className="practice-instructions practice-phase-1",n.innerHTML="\n            <strong>Tap and drag</strong> across the grey shapes to make a cut. <strong>Release</strong> to complete your cut.\n        ";const e=document.querySelector(".results-container");e&&e.parentNode.insertBefore(n,e)}n.style.display="block",n.style.opacity="0",n.style.transition="opacity 0.5s ease",setTimeout(()=>{n.style.opacity="1"},100),console.log("üìã Phase 1 instructions displayed")}async function fadeOutPhase1Instructions(){return new Promise(e=>{const t=document.getElementById("phase1Instructions");t?(t.style.transition="opacity 0.5s ease",t.style.opacity="0",setTimeout(()=>{t.style.display="none",e()},500)):e()})}async function showPhase2Instructions(e){showPracticePercentageSplit(e),isFirstPracticeCut?(setTimeout(()=>{let e=document.getElementById("phase2Instructions");if(!e){e=document.createElement("div"),e.id="phase2Instructions",e.className="practice-instructions practice-phase-2",e.innerHTML="\n                    Percentages show how close you are to <strong>50% / 50%</strong>.\n                ";const t=document.getElementById("practicePercentageDisplay");if(t)t.parentNode.insertBefore(e,t.nextSibling);else{const t=document.querySelector(".results-container");t&&t.parentNode.insertBefore(e,t)}}e.style.display="block",e.style.opacity="0",e.style.transition="opacity 0.5s ease",setTimeout(()=>{e.style.opacity="1"},100),console.log("üìã Phase 2 instructions displayed (first cut)")},1e3),isFirstPracticeCut=!1):console.log("üìã Skipping phase 2 instructions - not first cut")}async function fadeRenderAndPercentages(){return console.log("üé® Fading render and percentages"),await performPracticeRenderFade(),new Promise(e=>{const t=document.getElementById("practicePercentageDisplay"),n=document.getElementById("phase2Instructions");let o=[];t&&o.push(new Promise(e=>{t.style.transition="opacity 0.5s ease",t.style.opacity="0",setTimeout(()=>{t.style.display="none",e()},500)})),n&&o.push(new Promise(e=>{n.style.transition="opacity 0.5s ease",n.style.opacity="0",setTimeout(()=>{n.style.display="none",e()},500)})),o.length>0?Promise.all(o).then(e):setTimeout(e,500)})}async function showFinalPracticeInstructions(){console.log("üìã Showing final practice instructions");let e=document.getElementById("finalPracticeInstructions");if(!e){e=document.createElement("div"),e.id="finalPracticeInstructions",e.className="practice-instructions practice-phase-final",e.innerHTML='\n            Make unlimited cuts to practice and tap <strong style="color: rgb(100, 150, 255);">Play</strong> when you\'re ready.\n        ';const t=document.querySelector(".canvas-container");if(t)t.parentNode.insertBefore(e,t.nextSibling);else{const t=document.querySelector(".results-container");t&&t.parentNode.insertBefore(e,t)}}return e.style.display="block",e.style.opacity="0",e.style.transition="opacity 0.5s ease",setTimeout(()=>{e.style.opacity="1"},100),console.log("üìã Final practice instructions displayed"),Promise.resolve()}async function showPlayButtonForPractice(){console.log("üîß Showing play button for practice mode completion");let e=document.getElementById("practicePlayBtn");e||(e=document.createElement("button"),e.id="practicePlayBtn",e.className="canvas-play-button",e.textContent="Play",e.style.backgroundColor="rgb(100, 150, 255)",e.style.color="white",e.style.display="block",e.style.position="fixed",e.style.top="540px",e.style.left="50%",e.style.transform="translateX(-50%)",e.style.zIndex="1000",e.onclick=async function(){console.log("üéÆ Practice play button clicked"),e.style.display="none";["phase1Instructions","phase2Instructions","finalPracticeInstructions","practicePercentageDisplay","playBtnBelowCanvas","practicePlayBtn"].forEach(e=>{const t=document.getElementById(e);t&&t.remove()}),await fadeOutDemoShape(),await new Promise(e=>setTimeout(e,200)),isPracticeMode=!1,window.isPracticeMode=!1,isPractiseMode=!1,isDailyMode=!0,localStorage.removeItem("dailyShapes_practiceMode"),console.log("üéØ TRANSITION: Practice->Daily mode, isDailyMode set to",isDailyMode),handlePlayButtonClickOld()},document.body.appendChild(e)),e.style.display="block",e.style.opacity="1";const t=document.querySelector(".buttons-below-canvas");t&&(t.style.opacity="0",t.style.visibility="hidden",t.style.pointerEvents="none"),console.log("‚úÖ Practice play button positioned below results container")}async function fadeOutDemoShape(){return new Promise(e=>{console.log("üéÆ Fading out demo shape..."),ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid(),setTimeout(()=>{e()},300)})}function fadeOutWelcomeText(){const e=document.getElementById("goalDisplay"),t=document.getElementById("welcomeOverlay");e&&"none"!==e.style.display&&(console.log("üéÆ Fading out goal display..."),e.style.transition="opacity 0.5s ease-out",e.style.opacity="0",setTimeout(()=>{e.style.display="none"},500)),t&&"hidden"!==t.style.visibility&&(console.log("üéÆ Fading out welcome overlay..."),t.style.transition="opacity 0.5s ease-out",t.style.opacity="0",setTimeout(()=>{t.style.visibility="hidden"},500))}function resetPracticeForNextCut(){console.log("üîÑ Resetting practice mode for next cut"),currentVector=null,vectorCutActive=!1,gameState="cutting",isInteractionEnabled=!0,canvas&&(canvas.style.pointerEvents="auto"),console.log("‚úÖ Practice mode reset - ready for next cut")}async function fadeOutFinalInstructionsOnly(){return new Promise(e=>{const t=document.getElementById("finalPracticeInstructions");t?(t.style.transition="opacity 0.3s ease",t.style.opacity="0",setTimeout(()=>{t.style.display="none",e()},300)):e()})}async function fadeOutFinalInstructionsAndButton(){return new Promise(e=>{const t=document.getElementById("finalPracticeInstructions"),n=document.getElementById("practicePlayBtn");let o=[];t&&o.push(new Promise(e=>{t.style.transition="opacity 0.3s ease",t.style.opacity="0",setTimeout(()=>{t.style.display="none",e()},300)})),n&&o.push(new Promise(e=>{n.style.transition="opacity 0.3s ease",n.style.opacity="0",setTimeout(()=>{n.style.display="none",e()},300)})),o.length>0?Promise.all(o).then(e):e()})}function showPracticePercentageSplit(e){console.log("üìä Showing practice percentage split");let t=document.getElementById("practicePercentageDisplay");if(!t){t=document.createElement("div"),t.id="practicePercentageDisplay",t.className="attempt-result";const e=document.querySelector(".canvas-container");e&&e.parentNode.insertBefore(t,e.nextSibling)}t.innerHTML=`\n        <div class="attempt-info">\n            <div class="split-display-large">\n                <span style="color: #FAB06A; font-weight: bold; font-size: 46px;">${e.leftPercentage.toFixed(1)}%</span><span style="color: #999999; font-weight: bold; font-size: 46px; margin: 0 5px;"> / </span><span style="color: #999999; font-weight: bold; font-size: 46px;">${e.rightPercentage.toFixed(1)}%</span>\n            </div>\n        </div>\n    `,t.style.display="block",t.style.opacity="0",t.style.transition="opacity 0.5s ease",t.style.textAlign="center",setTimeout(()=>{t.style.opacity="1"},100),console.log("‚úÖ Practice percentage split displayed with original styling")}async function initializePracticeMode(){try{console.log("üéÆ Initializing practice mode..."),isPractiseMode=!0,isFirstPracticeCut=!0,hasShownFinalInstructions=!1,localStorage.setItem("dailyShapes_practiceMode","true");const e=document.querySelector(".buttons-below-canvas");e&&(e.style.visibility="hidden",e.style.opacity="0",e.style.pointerEvents="none"),await showPlayButtonForPractice();const t=document.getElementById("goalDisplay");t&&(t.style.display="none");["phase1Instructions","phase2Instructions","finalPracticeInstructions","practicePercentageDisplay","playBtnBelowCanvas","practicePlayBtn"].forEach(e=>{const t=document.getElementById(e);t&&t.remove()}),await loadPractiseShape()}catch(e){console.error("üí• Error initializing practice mode:",e),showCommentary("Failed to initialize practice mode. Please refresh the page.",!1)}}async function loadPractiseShape(){try{console.log("üéÆ Loading demo-shape.geojson for practise mode..."),gameState="cutting",isInteractionEnabled=!0,currentAttempts=[],attemptCount=0;const e=await fetch("./demo-shape.geojson");if(!e.ok)throw new Error(`Failed to load demo-shape.geojson: ${e.status}`);const t=await e.text();currentGeoJSON=JSON.parse(t);const n=parseGeometry(currentGeoJSON);parsedShapes=n.shapes,ctx.clearRect(0,0,canvas.width,canvas.height),renderShapeForCutting(parsedShapes,!1),isShapeAnimationComplete=!0,isShapeAnimationComplete=!0,canvas&&(canvas.style.pointerEvents="auto",console.log("üîß Canvas interaction enabled for practise mode")),showPhase1Instructions(),console.log("‚úÖ Practice shape loaded and ready for cutting"),window.debugLogger&&debugLogger.log("Practice mode shape loaded successfully")}catch(e){console.error("üí• Error loading practice shape:",e),window.debugLogger&&debugLogger.error("Practice shape loading failed",e),showCommentary("Failed to load practice shape. Please refresh the page.",!1)}}async function fadeInGridAndShape(){return new Promise(e=>{const t=Date.now();let n=0;console.log("üé¨ Starting fadeInGridAndShape animation..."),window.isAnimating=!0;const o=()=>{n++;const a=Date.now()-t,i=Math.min(a/800,1),r=i;if(ctx.clearRect(0,0,canvas.width,canvas.height),ctx.save(),ctx.globalAlpha=r,drawGrid(),renderShapeForCutting(parsedShapes,!1),ctx.restore(),i<1)requestAnimationFrame(o);else{window.isAnimating=!1,isShapeAnimationComplete=!0,console.log(`‚úÖ fadeInGridAndShape animation completed! Frames: ${n}, Duration: ${a}ms`),setInteractionEnabled(!0);const t=document.getElementById("geoCanvas");t&&(t.style.pointerEvents="auto"),console.log("üéØ Canvas interaction enabled after fade-in animation completed"),e()}};o()})}function updateSwipeArrows(){const e=document.getElementById("leftArrow"),t=document.getElementById("rightArrow");e&&t?(console.log("üîÑ Updating arrows for replayShapeIndex:",replayShapeIndex),replayShapeIndex>1?(e.style.display="block",console.log("üëà Left arrow shown - can swipe to shape",replayShapeIndex-1)):(e.style.display="none",console.log("üëà Left arrow hidden - at first shape")),replayShapeIndex<3?(t.style.display="block",console.log("üëâ Right arrow shown - can swipe to shape",replayShapeIndex+1)):(t.style.display="none",console.log("üëâ Right arrow hidden - at last shape")),console.log("üîÑ Arrow state for shape "+replayShapeIndex+": left="+(replayShapeIndex>1?"visible":"hidden")+" (can go to "+(replayShapeIndex-1)+"), right="+(replayShapeIndex<3?"visible":"hidden")+" (can go to "+(replayShapeIndex+1)+")")):console.error("üö´ Arrow elements not found")}window.totalCutsMade=totalCutsMade,window.cutsMadeThisShape=cutsMadeThisShape,window.showAttemptResult=showAttemptResult,window.showDoubleCircleResult=showDoubleCircleResult;let swipeStartX=0,swipeStartY=0,swipeMinDistance=30;function setupReplayNavigation(){setupSwipeGestures()}function setupSwipeGestures(){if(!canvas)return void console.log("No canvas found for swipe setup");console.log("Setting up swipe gestures for replay mode");const e="finished"===gameState&&3===gameResults.length;console.log("üîß Swipe capability status:"),console.log("  - isReplayMode:",isReplayMode),console.log("  - gameState:",gameState),console.log("  - gameResults.length:",gameResults.length),console.log("  - gameCompleted:",e),console.log("  - replayShapeIndex:",replayShapeIndex),console.log("  - Swipes will work when: all 3 shapes completed (gameState: results or finished)");const t=document.querySelector(".canvas-container"),n=[];t?(n.push(t),console.log("Primary target: canvas container for swipes")):(n.push(canvas),console.log("Fallback target: canvas for swipes (container not found)")),n.forEach(e=>{console.log("üîß Setting up swipe listeners on:",e.tagName||e.id||"element"),e.removeEventListener("touchstart",handleSwipeTouchStart),e.removeEventListener("touchend",handleSwipeTouchEnd),e.removeEventListener("mousedown",handleSwipeMouseStart),e.removeEventListener("mouseup",handleSwipeMouseEnd),console.log("  - Removed existing listeners"),e.addEventListener("touchstart",handleSwipeTouchStart,{passive:!1,capture:!0}),e.addEventListener("touchend",handleSwipeTouchEnd,{passive:!1,capture:!0}),console.log("  - Added touch listeners (touchstart, touchend)"),e.addEventListener("mousedown",handleSwipeMouseStart),e.addEventListener("mouseup",handleSwipeMouseEnd),console.log("  - Added mouse listeners (mousedown, mouseup)"),e.addEventListener("click",function(t){console.log("üß™ CLICK TEST - Event detected on:",e.tagName||e.id)}),console.log("  - Added test click listener"),console.log("‚úÖ All swipe listeners attached to:",e.tagName||e.id||"element")})}function handleSwipeTouchStart(e){console.log("üü¢ TOUCH START EVENT DETECTED - isReplayMode:",isReplayMode);const t=3===gameResults.length&&("results"===gameState||"finished"===gameState);if(!t)return void console.log("Swipes disabled. Current state:",{gameState:gameState,gameResultsLength:gameResults.length,isReplayMode:isReplayMode,gameCompleted:t});console.log("‚úÖ Swipes enabled! Game completed, processing touch..."),e.stopPropagation();const n=e.touches[0];n?(swipeStartX=n.clientX,swipeStartY=n.clientY,console.log("Swipe start recorded:",swipeStartX,swipeStartY)):console.log("No touch found in event")}function handleSwipeTouchEnd(e){console.log("üü¢ TOUCH END EVENT DETECTED - isReplayMode:",isReplayMode);const t=3===gameResults.length&&("results"===gameState||"finished"===gameState);if(!t)return void console.log("Swipes disabled. Current state:",{gameState:gameState,gameResultsLength:gameResults.length,isReplayMode:isReplayMode,gameCompleted:t});e.stopPropagation(),e.preventDefault();const n=e.changedTouches[0];if(!n)return void console.log("No touch found in changedTouches");const o=n.clientX,a=n.clientY;console.log("Swipe end coordinates:",o,a),console.log("Swipe start was:",swipeStartX,swipeStartY);const i=o-swipeStartX,r=a-swipeStartY;console.log("Swipe deltas - X:",i,"Y:",r),console.log("Absolute deltas - X:",Math.abs(i),"Y:",Math.abs(r)),console.log("Min distance required:",swipeMinDistance),console.log("Current shape index:",replayShapeIndex);const s=Math.abs(i)>Math.abs(r),c=Math.abs(i)>swipeMinDistance;console.log("Is horizontal swipe:",s),console.log("Is long enough:",c),s&&c?(console.log("‚úÖ Valid swipe detected!"),i>0?(console.log("‚û°Ô∏è Swiping right to see previous shape"),replayShapeIndex>1?(replayShapeIndex--,console.log("üìç Moving to shape:",replayShapeIndex),showReplayShape(replayShapeIndex),updateSwipeArrows()):console.log("üö´ Already at first shape (1)")):(console.log("‚¨ÖÔ∏è Swiping left to see next shape"),replayShapeIndex<3?(replayShapeIndex++,console.log("üìç Moving to shape:",replayShapeIndex),showReplayShape(replayShapeIndex),updateSwipeArrows()):console.log("üö´ Already at last shape (3)"))):console.log("‚ùå Invalid swipe - horizontal:",s,"long enough:",c)}function handleSwipeMouseStart(e){console.log("üü¢ MOUSE DOWN EVENT DETECTED - isReplayMode:",isReplayMode),console.log("üîç Current replayShapeIndex at mouse start:",replayShapeIndex);const t=3===gameResults.length&&("results"===gameState||"finished"===gameState);t?(console.log("‚úÖ Mouse swipes enabled! Game completed, processing mouse down..."),swipeStartX=e.clientX,swipeStartY=e.clientY,console.log("Mouse swipe start recorded:",swipeStartX,swipeStartY)):console.log("Swipes disabled. Current state:",{gameState:gameState,gameResultsLength:gameResults.length,isReplayMode:isReplayMode,gameCompleted:t})}function handleSwipeMouseEnd(e){console.log("üü¢ MOUSE UP EVENT DETECTED - isReplayMode:",isReplayMode),console.log("üîç Current replayShapeIndex at mouse end:",replayShapeIndex);const t=3===gameResults.length&&("results"===gameState||"finished"===gameState);if(!t)return void console.log("Swipes disabled. Current state:",{gameState:gameState,gameResultsLength:gameResults.length,isReplayMode:isReplayMode,gameCompleted:t});const n=e.clientX,o=e.clientY;console.log("Mouse swipe end coordinates:",n,o),console.log("Mouse swipe start was:",swipeStartX,swipeStartY);const a=n-swipeStartX,i=o-swipeStartY;console.log("Mouse swipe deltas - X:",a,"Y:",i);const r=Math.abs(a)>Math.abs(i),s=Math.abs(a)>swipeMinDistance;console.log("Mouse - Is horizontal swipe:",r),console.log("Mouse - Is long enough:",s),r&&s?(console.log("‚úÖ Valid mouse swipe detected!"),a>0?(console.log("‚û°Ô∏è Mouse swiping right to see previous shape"),replayShapeIndex>1?(replayShapeIndex--,console.log("üìç Moving to shape:",replayShapeIndex),showReplayShape(replayShapeIndex),updateSwipeArrows()):console.log("üö´ Already at first shape (1)")):(console.log("‚¨ÖÔ∏è Mouse swiping left to see next shape"),replayShapeIndex<3?(replayShapeIndex++,console.log("üìç Moving to shape:",replayShapeIndex),showReplayShape(replayShapeIndex),updateSwipeArrows()):console.log("üö´ Already at last shape (3)"))):console.log("‚ùå Invalid mouse swipe - horizontal:",r,"long enough:",s)}function showReplayShape(e){if(gameResults[e-1]){const t=gameResults[e-1];console.log("üîç showReplayShape for shape",e,"with result:",t),console.log("üîç splitAreas data:",t.splitAreas),ctx.clearRect(0,0,canvas.width,canvas.height),shapeScreenshots[e]?(console.log("üì∏ Using captured screenshot for shape",e),displayShapeScreenshot(e)):(console.log("üì∏ No screenshot available for shape",e,", falling back to render"),t.splitAreas?renderSplitResult(t.splitAreas,e):(drawGrid(),t.originalShape&&drawShapeOutlineFromGeoJSON(t.originalShape),t.cutVector&&(drawVector(t.cutVector.start,t.cutVector.end),console.log("üé® Drew cut vector for shape",e,"without split areas")),3===e&&t.firstCutVector&&(drawVector(t.firstCutVector.start,t.firstCutVector.end),console.log("üé® Drew first cut vector for shape 3 without split areas")))),canvas.style.pointerEvents="none";const n=document.getElementById("playBtn");n&&(n.style.display="none",n.textContent="",n.disabled=!0,n.classList.remove("again")),hidePlayButton(),updateSwipeArrows(),highlightCurrentShapeInTable(e),console.log("üîÑ Replay mode activated for shape:",e),console.log("üîÑ isReplayMode is now:",isReplayMode),console.log("üîÑ gameState is:",gameState)}}function renderSplitResult(e,t){console.log("üé® renderSplitResult called for shape",t,"with splitAreas:",e);const n=gameResults[t-1];n?(ctx.clearRect(0,0,canvas.width,canvas.height),console.log("üîç Checking rendering conditions for shape",t),console.log("üîç result.firstCutVector:",!!n.firstCutVector),console.log("üîç result.cutVector:",!!n.cutVector),console.log("üîç splitAreas structure:",e),3===t&&n.firstCutVector&&n.cutVector?(console.log("üé® Rendering pixel-based quadrant colors for shape 3"),renderReplayQuadrantColors(n.firstCutVector,n.cutVector,n.originalShape)):!n.cutVector||1!==t&&2!==t?(console.log("üé® No color rendering - conditions not met"),console.log("üîç Shape:",t,"Has cutVector:",!!n.cutVector,"Has firstCutVector:",!!n.firstCutVector),drawGrid(),n.originalShape&&drawShapeOutlineFromGeoJSON(n.originalShape),n.cutVector&&drawVector(n.cutVector.start,n.cutVector.end),3===t&&n.firstCutVector&&drawVector(n.firstCutVector.start,n.firstCutVector.end)):(console.log("üé® Rendering pixel-based binary colors for shape",t),renderReplayBinaryColors(n.cutVector,t,n.originalShape))):console.log("üé® No result data available for shape",t)}function drawPolygonFill(e){if(e&&0!==e.length){ctx.beginPath(),ctx.moveTo(e[0][0],e[0][1]);for(let t=1;t<e.length;t++)ctx.lineTo(e[t][0],e[t][1]);ctx.closePath(),ctx.fill()}}function renderReplayBinaryColors(e,t,n){console.log("üé® Starting pixel-based binary color rendering for shape",t);const o=getShapeMaskData(n);if(!o)return void console.error("üé® Could not get shape mask data");const a=ctx.createImageData(380,380),i=a.data;for(let t=0;t<380;t++)for(let n=0;n<380;n++){const a=4*(380*t+n);if(o[a]>128){const o=getPixelSideOfVector(n,t,e.start,e.end,e.end.x-e.start.x,e.end.y-e.start.y);"left"===o?(i[a]=100,i[a+1]=150,i[a+2]=255,i[a+3]=255):"right"===o?(i[a]=221,i[a+1]=221,i[a+2]=221,i[a+3]=255):(i[a]=0,i[a+1]=0,i[a+2]=0,i[a+3]=255)}else i[a]=0,i[a+1]=0,i[a+2]=0,i[a+3]=0}assignFloatingPiecesToNearestSide(i,o,canvas.width,canvas.height,"binary"),ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid();const r=document.createElement("canvas"),s=getCanvasSize();r.width=s,r.height=s;r.getContext("2d").putImageData(a,0,0),ctx.drawImage(r,0,0),drawShapeOutlinesFromGeoJSON(n),drawVector(e.start,e.end),console.log("üé® Binary color rendering complete")}function renderReplayQuadrantColors(e,t,n){console.log("üé® Starting pixel-based quadrant color rendering for shape 3");const o=getShapeMaskData(n);if(!o)return void console.error("üé® Could not get shape mask data");const a=ctx.createImageData(380,380),i=a.data,r={1:{r:255,g:100,b:100},2:{r:100,g:150,b:255},3:{r:100,g:200,b:100},4:{r:255,g:200,b:100}};for(let n=0;n<380;n++)for(let a=0;a<380;a++){const s=4*(380*n+a);if(o[s]>128){const o=e.end.x-e.start.x,c=e.end.y-e.start.y,l=getPixelSideOfVector(a,n,e.start,e.end,o,c),d=t.end.x-t.start.x,p=t.end.y-t.start.y,u=getPixelSideOfVector(a,n,t.start,t.end,d,p);let g;if("right"===l&&"right"===u)g=1;else if("left"===l&&"right"===u)g=2;else if("left"===l&&"left"===u)g=3;else{if("right"!==l||"left"!==u){i[s]=0,i[s+1]=0,i[s+2]=0,i[s+3]=255;continue}g=4}const m=r[g];i[s]=m.r,i[s+1]=m.g,i[s+2]=m.b,i[s+3]=255}else i[s]=0,i[s+1]=0,i[s+2]=0,i[s+3]=0}assignFloatingPiecesToNearestSide(i,o,canvas.width,canvas.height,"quadrant",r),ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid();const s=document.createElement("canvas"),c=getCanvasSize();s.width=c,s.height=c;s.getContext("2d").putImageData(a,0,0),ctx.drawImage(s,0,0),drawShapeOutlinesFromGeoJSON(n),drawVector(e.start,e.end),drawVector(t.start,t.end),console.log("üé® Quadrant color rendering complete")}function assignFloatingPiecesToNearestSide(e,t,n,o,a,i=null){console.log("üß© Starting floating piece assignment for mode:",a);const r=new Array(n*o).fill(!1);function s(t){const n=e[t],o=e[t+1],a=e[t+2];return e[t+3]>0&&!(0===n&&0===o&&0===a)}function c(e){return t[e]>128&&!s(e)}function l(e,t){const a=[],i=[{x:e,y:t}];for(;i.length>0;){const{x:e,y:t}=i.pop(),s=4*(t*n+e);e<0||e>=n||t<0||t>=o||r[t*n+e]||c(s)&&(r[t*n+e]=!0,a.push({x:e,y:t,pixelIndex:s}),i.push({x:e+1,y:t}),i.push({x:e-1,y:t}),i.push({x:e,y:t+1}),i.push({x:e,y:t-1}))}return a}function d(e){let t=1/0,a=null;for(const i of e)for(let e=0;e<o;e++)for(let o=0;o<n;o++){const r=4*(e*n+o);if(s(r)){const n=Math.sqrt(Math.pow(o-i.x,2)+Math.pow(e-i.y,2));n<t&&(t=n,a={x:o,y:e,pixelIndex:r})}}return a}for(let t=0;t<o;t++)for(let o=0;o<n;o++){const a=4*(t*n+o);if(!r[t*n+o]&&c(a)){console.log("üß© Found uncolored region at:",o,t);const n=l(o,t);if(n.length>0){console.log("üß© Region size:",n.length,"pixels");const t=d(n);if(t){const o=e[t.pixelIndex],a=e[t.pixelIndex+1],i=e[t.pixelIndex+2];console.log("üß© Assigning region to color:",o,a,i);for(const t of n)e[t.pixelIndex]=o,e[t.pixelIndex+1]=a,e[t.pixelIndex+2]=i,e[t.pixelIndex+3]=255}}}}console.log("üß© Floating piece assignment complete")}let shapeScreenshots={};function captureShapeScreenshot(e){try{const t=canvas.toDataURL("image/png");shapeScreenshots[e]=t,console.log("üì∏ Captured screenshot for shape",e)}catch(t){console.error("üì∏ Failed to capture screenshot for shape",e,":",t)}}function displayShapeScreenshot(e){const t=shapeScreenshots[e];if(!t)return void console.error("üì∏ No screenshot available for shape",e);const n=new Image;n.onload=function(){ctx.clearRect(0,0,canvas.width,canvas.height),ctx.drawImage(n,0,0,canvas.width,canvas.height),console.log("üì∏ Successfully displayed screenshot for shape",e)},n.onerror=function(){console.error("üì∏ Failed to load screenshot for shape",e)},n.src=t}function getShapeMaskData(e=null){const t=document.createElement("canvas"),n=getCanvasSize();t.width=n,t.height=n;const o=t.getContext("2d");let a,i=!1;if(e){console.log("üîç GeoJSON provided for mask generation:",e),console.log("üîç GeoJSON features count:",e.features?.length),e.features?.forEach((e,t)=>{console.log(`üîç Feature ${t}: type=${e.geometry?.type}, coordinates=${e.geometry?.coordinates?.length} parts`)});const t=parseGeometry(e);a=t.shapes,i=t.useDirectCoordinates,console.log("üé® Parsed",a.length,"shapes from provided GeoJSON for mask generation")}else a=parsedShapes,console.log("üé® Using global parsedShapes for mask generation with",a.length,"shapes");if(!a.length)return console.error("üé® No shapes available for mask generation"),null;a.forEach((e,t)=>{console.log(`üîç Shape ${t+1}: outerRing=${e.outerRing?.length} points, holes=${e.holes?.length||0}`),e.holes?.length>0&&e.holes.forEach((e,t)=>{console.log(`  üîç Hole ${t+1}: ${e.length} points`)})});const r=calculateBounds(a),s=calculateScale(r,i),c=calculateOffset(r,s,i);console.log("üîç Mask rendering - bounds:",r,"scale:",s,"offset:",c),o.fillStyle="black",o.fillRect(0,0,t.width,t.height),o.fillStyle="white",a.forEach((e,t)=>{console.log("üé® Drawing shape",t+1,"for mask with",e.outerRing?.length,"outer ring points"),o.beginPath(),drawRingForPixelAnalysis(o,e.outerRing,s,c),o.fill(),e.holes&&e.holes.length>0&&(console.log("üé® Drawing",e.holes.length,"holes for shape",t+1),o.fillStyle="black",e.holes.forEach((e,t)=>{console.log("üé® Drawing hole",t+1,"with",e.length,"points"),o.beginPath(),drawRingForPixelAnalysis(o,e,s,c),o.fill()}),o.fillStyle="white")});const l=o.getImageData(0,0,t.width,t.height);let d=0;for(let e=0;e<l.data.length;e+=4)l.data[e]>128&&d++;console.log("üé® Mask generated with",d,"shape pixels out of",t.width*t.height,"total pixels");let p=0;for(let e=0;e<l.data.length;e+=4)l.data[e]<128&&p++;return console.log("üé® Mask composition: white (shape)=",d,", black (background/holes)=",p),l.data}function showTestingModeFeedback(e){console.log("üß™ Testing mode feedback:",e);const t=document.getElementById("commentaryOverlay"),n=document.getElementById("commentaryText");t&&n&&(n.textContent=e,t.style.display="block",setTimeout(()=>{t.style.display="none"},2e3)),window.debugLogger&&window.debugLogger.log("Swipe testing feedback: "+e,null,"info")}function showGoalBeneathCanvas(){const e=document.querySelector(".results-container");if(e){e.style.display="block";const t=e.querySelector(".results-table");t&&(t.style.display="none");const n=document.getElementById("goalDisplay");n&&(n.style.display="none"),showProgressCircles(),console.log("üìã Canvas interaction will be enabled after fade-in animation")}}function showProgressCircles(){const e=document.getElementById("progressCircles");e&&(e.style.display="flex",e.style.opacity="0",setTimeout(()=>{e.style.transition="opacity 0.5s ease",e.style.opacity="1"},100))}function showCutPopup(){console.log("üî™ Showing CUT popup");const e=document.getElementById("cutPopup");e?(e.classList.add("show"),setTimeout(()=>{e.classList.remove("show"),console.log("üî™ CUT popup hidden")},2e3)):console.error("‚ùå CUT popup element not found")}function ensureProgressCirclesVisible(){const e=document.getElementById("progressCircles");e&&(attemptCount>=1&&"locked"!==gameState&&"finished"!==gameState&&"completed"!==gameState)?(e.style.display="flex",e.style.opacity="1",updateProgressCircles(attemptCount),console.log("‚úÖ Progress circles ensured visible and updated for game state:",gameState)):e&&(e.style.display="none",console.log("üîµ Progress circles hidden for game state:",gameState))}function showFirstTryDisplay(){console.log("‚ö†Ô∏è 1st Try display is disabled (showFirstTryDisplay)")}function showTry1Display(){console.log("‚ö†Ô∏è Try 1 display is disabled");const e=document.getElementById("progressCircles");e&&(e.style.display="flex",e.style.opacity="0",setTimeout(()=>{e.style.transition="opacity 0.5s ease",e.style.opacity="1"},150))}function fadeFirstTryDisplay(){const e=document.getElementById("attemptDisplay1st");e&&(e.style.transition="opacity 0.3s ease",e.style.opacity="0",setTimeout(()=>{e.style.display="none"},300))}function showGoalAsCommentary(){const e=document.getElementById("goalDisplay"),t=document.getElementById("goalText"),n=document.getElementById("attemptDisplay"),o=document.getElementById("attemptText");if(e&&t){const n='<strong>GOAL</strong><br><span class="goal-description">'+(ShapeTypeHandler.getGoalText(currentShapeIndex).replace(/^Goal:\s*/,"")+" (50% / 50%)")+"</span>";t.innerHTML=n,e.style.display="block",e.style.opacity="1",e.classList.add("animate-in"),setTimeout(()=>{t.classList.add("fade-in")},50)}if(n&&o){const e=v3GameState.currentAttempt,t=["1st Try","2nd Try","3rd Try"];o.textContent=t[e-1]||"1st Try",n.style.display="block",n.style.opacity="1"}}function showTryAgainMessage(){const e=document.getElementById("attemptDisplay"),t=document.getElementById("attemptText");console.log("üö´ showTryAgainMessage called:",{attemptDisplayExists:!!e,attemptTextExists:!!t,attemptDisplayVisible:e?.style.display,attemptTextContent:t?.textContent});document.querySelectorAll(".split-display-large, .attempt-result").forEach(e=>{"attemptDisplay"!==e.id&&(e.style.display="none",console.log("üö´ Hiding split display element:",e.id||e.className))});const n=document.getElementById("practicePercentageDisplay");n&&(n.style.display="none",console.log("üö´ Hiding practice percentage display"));const o=document.getElementById("fixedPercentageArea");o&&(o.innerHTML="",console.log("üö´ Clearing fixed percentage area")),e&&t?(t.textContent="Try again",e.style.display="block",e.style.opacity="1",e.style.transition="",console.log("üö´ Try again message set successfully")):console.error("üö´ Cannot show try again message - elements missing:",{attemptDisplay:!!e,attemptTextEl:!!t})}function hideTryAgainMessage(){const e=document.getElementById("attemptDisplay");e&&"none"!==e.style.display&&(e.style.transition="opacity 0.3s ease-out",e.style.opacity="0",setTimeout(()=>{"0"===e.style.opacity&&(e.style.display="none",e.style.opacity="1",e.style.transition="")},300))}function hideGoalCommentary(){const e=document.getElementById("goalDisplay"),t=document.getElementById("goalText"),n=document.getElementById("attemptDisplay"),o=3===currentShapeNumber&&2===currentAttemptNumber,a="opacity 0.3s ease-out";e&&"none"!==e.style.display&&(e.style.transition=a),t&&e&&"none"!==e.style.display&&(t.style.transition=a),n&&"none"!==n.style.display&&(n.style.transition=a);const i=document.getElementById("progressCircles");o&&i&&(console.log("üîµ Starting progress tracker fade out (matching percentage fade timing)"),i.style.transition=a),requestAnimationFrame(()=>{e&&"none"!==e.style.display&&(e.style.opacity="0"),t&&e&&"none"!==e.style.display&&(t.style.opacity="0"),n&&"none"!==n.style.display&&(n.style.opacity="0"),o&&i&&(i.style.opacity="0")}),setTimeout(()=>{e&&"0"===e.style.opacity&&(e.style.display="none",e.style.opacity="1",e.style.transition="",e.classList.remove("animate-in")),t&&"0"===t.style.opacity&&(t.style.opacity="1",t.style.transition="",t.classList.remove("fade-in")),n&&"0"===n.style.opacity&&(n.style.display="none",n.style.opacity="1",n.style.transition=""),o&&i&&"0"===i.style.opacity&&(i.style.display="none",console.log("üîµ Progress tracker fade completed (matching percentage fade timing)"))},300)}function fadeOutCommentary(){const e=document.getElementById("commentaryOverlay");e&&"none"!==e.style.display&&(e.style.transition="opacity 0.3s ease-out",e.style.opacity="0",setTimeout(()=>{e.style.display="none",e.style.opacity="1",e.style.transition=""},300))}function updateResultsTable(){hideGoalCommentary();const e=document.getElementById("resultsTableBody"),t=gameResults[gameResults.length-1],n=document.createElement("tr"),o=document.createElement("td");o.textContent=currentShapeIndex,n.appendChild(o);const a=document.createElement("td");if(3===currentShapeIndex&&t.quadrantPercentages){const e=t.quadrantPercentages.q1.toFixed(1),n=t.quadrantPercentages.q2.toFixed(1),o=t.quadrantPercentages.q3.toFixed(1),i=t.quadrantPercentages.q4.toFixed(1);a.className="split-multi-line",a.innerHTML=`<span class="split-q1">${e}%</span> / <span class="split-q2">${n}%</span><br><span class="split-q3">${o}%</span> / <span class="split-q4">${i}%</span>`}else a.innerHTML=`<span class="split-left">${t.leftPercentage.toFixed(1)}%</span> / <span class="split-right">${t.rightPercentage.toFixed(1)}%</span>`;n.appendChild(a);const i=document.createElement("td");i.textContent=`${t.score.toFixed(1)}/100`,n.appendChild(i),e.appendChild(n),setTimeout(()=>{if(currentShapeIndex<3){const e=document.getElementById("playBtn");e&&(e.textContent="Next",e.disabled=!1,e.classList.remove("again","disabled"),showPlayButton())}else if(3===currentShapeIndex&&cutsPerformed<maxCutsForShape3){const e=document.getElementById("playBtn");e&&(e.textContent="Cut 2",e.disabled=!1,e.classList.remove("again","disabled"),showPlayButton())}},1500)}function clearTableRows(){document.getElementById("resultsTableBody").innerHTML=""}function highlightCurrentShapeInTable(e){const t=document.getElementById("resultsTableBody");if(!t)return void console.warn("üö´ Results table body not found");const n=t.querySelectorAll("tr");n.forEach(e=>{e.classList.remove("current-shape")});const o=n[e-1];o&&!o.classList.contains("goal-row")?(o.classList.add("current-shape"),console.log("‚ú® Highlighted table row for shape",e)):console.warn("üö´ Could not find table row for shape",e)}function removeTableHighlights(){const e=document.getElementById("resultsTableBody");if(!e)return;e.querySelectorAll("tr").forEach(e=>{e.classList.remove("current-shape")}),console.log("üßπ Removed all table highlights")}function getScoreEmoji(e){return 100===e?"üéØ":e>=99?"‚úÇÔ∏è":e>=97?"üî™":e>=94?"üëå":e>=90?"üôÇ":e>=85?"ü§î":e>=75?"üòû":"ü™ì"}function parseGeometry(e){const t=[];function n(e){return[e[0],e[1]]}return e.features.forEach((e,o)=>{console.log(`üîç Processing feature ${o}: ${e.geometry?.type}`);const a=e.geometry;if("Polygon"===a.type){let e=a.coordinates;for(;Array.isArray(e[0])&&Array.isArray(e[0][0])&&Array.isArray(e[0][0][0]);)console.warn("‚ö†Ô∏è Detected deeply nested coordinates, flattening..."),e=e[0];let o=e[0],i=e.slice(1);o=o.map(n),i=i.map(e=>e.map(n));const r={type:"polygon",coordinates:[o,...i],outerRing:o,holes:i};t.push(r),console.log(`‚úÖ Added Polygon shape with ${o.length} vertices`),console.log(`   First transformed coord: [${o[0][0].toFixed(1)}, ${o[0][1].toFixed(1)}]`)}else"MultiPolygon"===a.type?a.coordinates.forEach((e,o)=>{let a=e;for(;Array.isArray(a[0])&&Array.isArray(a[0][0])&&Array.isArray(a[0][0][0]);)console.warn("‚ö†Ô∏è Detected deeply nested MultiPolygon coordinates, flattening..."),a=a[0];let i=a[0],r=a.slice(1);if(!i||i.length<3)return void console.warn(`‚ö†Ô∏è Skipping invalid polygon ${o+1}: insufficient coordinates (${i?.length||0})`);i=i.map(n),r=r.map(e=>e.map(n));const s=i.filter(e=>e&&2===e.length&&!isNaN(e[0])&&!isNaN(e[1]));if(s.length!==i.length&&(console.warn(`‚ö†Ô∏è Polygon ${o+1} has ${i.length-s.length} invalid coordinates`),i=s),i.length<3)return void console.warn(`‚ö†Ô∏è Skipping polygon ${o+1}: too few valid coordinates after transformation (${i.length})`);const c={type:"polygon",coordinates:[i,...r],outerRing:i,holes:r};t.push(c),console.log(`‚úÖ Added MultiPolygon shape ${o+1} with ${i.length} vertices`),console.log(`   First transformed coord: [${i[0][0].toFixed(1)}, ${i[0][1].toFixed(1)}]`)}):(console.warn(`‚ö†Ô∏è Unsupported geometry type: ${a.type} in feature ${o}. Only Polygon and MultiPolygon are supported for shape rendering.`),"Point"===a.type&&console.log(`üìç Point coordinates: [${a.coordinates[0].toFixed(1)}, ${a.coordinates[1].toFixed(1)}] - Points are typically used for metadata, not shapes.`))}),console.log(`üé® parseGeometry SUMMARY: extracted ${t.length} total shapes from ${e.features.length} features`),t.forEach((e,t)=>{const n={minX:Math.min(...e.outerRing.map(e=>e[0])),maxX:Math.max(...e.outerRing.map(e=>e[0])),minY:Math.min(...e.outerRing.map(e=>e[1])),maxY:Math.max(...e.outerRing.map(e=>e[1]))};console.log(`üîç Shape ${t+1}: ${e.outerRing.length} points, ${e.holes?.length||0} holes, bounds: [${n.minX.toFixed(1)},${n.minY.toFixed(1)}] to [${n.maxX.toFixed(1)},${n.maxY.toFixed(1)}]`)}),{shapes:t,useDirectCoordinates:!1}}function calculateBounds(e){let t=1/0,n=1/0,o=-1/0,a=-1/0;return console.log("üîç calculateBounds called with",e.length,"shapes"),e.forEach((e,i)=>{console.log(`üîç Shape ${i}:`,{hasOuterRing:!!e.outerRing,outerRingLength:e.outerRing?.length,firstPoint:e.outerRing?.[0],outerRingType:Array.isArray(e.outerRing)?"array":typeof e.outerRing}),e.outerRing&&Array.isArray(e.outerRing)?(e.outerRing.forEach(([e,r],s)=>{s<3&&console.log(`üîç Shape ${i} point ${s}:`,[e,r],typeof e,typeof r),"number"!=typeof e||"number"!=typeof r||isNaN(e)||isNaN(r)?s<3&&console.log("‚ùå Invalid coordinate at point",s,":",[e,r]):(t=Math.min(t,e),n=Math.min(n,r),o=Math.max(o,e),a=Math.max(a,r))}),e.holes&&e.holes.forEach(e=>{e.forEach(([e,i])=>{"number"!=typeof e||"number"!=typeof i||isNaN(e)||isNaN(i)||(t=Math.min(t,e),n=Math.min(n,i),o=Math.max(o,e),a=Math.max(a,i))})})):console.log("‚ùå Shape",i,"has invalid outerRing")}),console.log("üîç calculateBounds result:",{minX:t,minY:n,maxX:o,maxY:a}),{minX:t,minY:n,maxX:o,maxY:a}}function calculateScale(e,t=!1){const n=e.maxX-e.minX,o=e.maxY-e.minY;return window.isAnimating||(console.log(`üìê Shape bounds: ${n.toFixed(1)}x${o.toFixed(1)} (minX: ${e.minX.toFixed(1)}, minY: ${e.minY.toFixed(1)})`),console.log("üìê Using 1:1 scaling (coordinate scaling handled during parsing)")),1}function calculateOffset(e,t,n=!1){window.isAnimating||(console.log("üìê Canvas size: 380x380 (logical)"),console.log(`üìê Shape bounds: minX=${e.minX.toFixed(1)}, minY=${e.minY.toFixed(1)}, maxX=${e.maxX.toFixed(1)}, maxY=${e.maxY.toFixed(1)}`));return window.isAnimating||console.log(`üìê Using original shape positioning: offset (${(0).toFixed(1)}, ${(0).toFixed(1)})`),{x:0,y:0}}function createMockCutVector(e,t,n){console.log(`üéØ Creating mock cut vector for ${t.toFixed(1)}%/${n.toFixed(1)}%`);const o=e.maxX-e.minX,a=e.maxY-e.minY,i=(e.minX+e.maxX)/2,r=(e.minY+e.maxY)/2;let s;if(Math.abs(t-50)<15){const n=(t-50)*o/100;s={x1:i+n,y1:e.minY-50,x2:i+n,y2:e.maxY+50}}else if(Math.abs(t-50)<25){const n=(t-50)*o/200;s={x1:e.minX-50,y1:r-.3*a,x2:e.maxX+50,y2:r+.3*a+n}}else{const n=t<50?r+.2*a:r-.2*a;s={x1:e.minX-50,y1:n,x2:e.maxX+50,y2:n}}return console.log(`üéØ Mock cut vector created: (${s.x1.toFixed(1)}, ${s.y1.toFixed(1)}) to (${s.x2.toFixed(1)}, ${s.y2.toFixed(1)})`),s}function drawPolygon(e,t,n,o=ctx){o.beginPath(),drawRing(e.outerRing,t,n,o),e.holes&&e.holes.length>0&&e.holes.forEach(e=>{drawRing(e,t,n,o)}),o.fill("evenodd"),o.stroke()}function drawRing(e,t,n,o=ctx){if(e.length<2)return;const[a,i]=e[0];o.moveTo(a*t+n.x,380-(i*t+n.y));for(let a=1;a<e.length;a++){const[i,r]=e[a];o.lineTo(i*t+n.x,380-(r*t+n.y))}o.closePath()}function renderShapesForPixelAnalysis(e,t,n=!1){if(0===t.length)return;const o=calculateBounds(t),a=calculateScale(o,n),i=calculateOffset(o,a,n);e.fillStyle="#dddddd",e.strokeStyle="#000000",e.lineWidth=2,t.forEach(t=>{drawPolygonForPixelAnalysis(e,t,a,i)})}function drawPolygonForPixelAnalysis(e,t,n,o){e.beginPath(),drawRingForPixelAnalysis(e,t.outerRing,n,o),t.holes&&t.holes.length>0&&t.holes.forEach(t=>{drawRingForPixelAnalysis(e,t,n,o)}),e.fill("evenodd"),e.stroke()}function drawRingForPixelAnalysis(e,t,n,o){if(t.length<2)return;const[a,i]=t[0];e.moveTo(a*n+o.x,380-(i*n+o.y));for(let a=1;a<t.length;a++){const[i,r]=t[a];e.lineTo(i*n+o.x,380-(r*n+o.y))}e.closePath()}function calculatePixelBasedAreas(e,t,n,o){let a=0,i=0,r=0;const s=o.start,c=o.end,l=c.x-s.x,d=c.y-s.y;for(let o=0;o<n;o++)for(let n=0;n<t;n++){const p=4*(o*t+n),u=e[p],g=e[p+1],m=e[p+2];if(221===u&&221===g&&221===m){r++;const e=getPixelSideOfVector(n,o,s,c,l,d);"left"===e?a++:"right"===e&&i++}}return{leftArea:a,rightArea:i,totalShapePixels:r,leftPercentage:r>0?a/r*100:0,rightPercentage:r>0?i/r*100:0}}function calculateFourQuadrants(e,t){const n=document.createElement("canvas"),o=getCanvasSize();n.width=o,n.height=o;const a=n.getContext("2d"),i=window.isPracticeMode?window.practiceMode?.practiceParsedShapes||[]:parsedShapes||[];console.log(`üîç CALCULATE FOUR QUADRANTS: Using ${i.length} shapes for pixel analysis (isPracticeMode: ${window.isPracticeMode})`),renderShapesForPixelAnalysis(a,i);const r=a.getImageData(0,0,n.width,n.height).data;let s=0,c=0,l=0,d=0,p=0;const u=e.start,g=e.end,m=g.x-u.x,h=g.y-u.y,y=t.start,w=t.end,f=w.x-y.x,S=w.y-y.y;for(let e=0;e<n.height;e++)for(let t=0;t<n.width;t++){const o=4*(e*n.width+t),a=r[o],i=r[o+1],v=r[o+2];if(221===a&&221===i&&221===v){p++;const n=getPixelSideOfVector(t,e,u,g,m,h),o=getPixelSideOfVector(t,e,y,w,f,S);"right"===n&&"right"===o?s++:"left"===n&&"right"===o?c++:"left"===n&&"left"===o?l++:"right"===n&&"left"===o&&d++}}return{quadrants:{quadrant1:s,quadrant2:c,quadrant3:l,quadrant4:d},percentages:p>0?{q1:s/p*100,q2:c/p*100,q3:l/p*100,q4:d/p*100}:{q1:0,q2:0,q3:0,q4:0},totalShapePixels:p}}function getPixelSideOfVector(e,t,n,o,a,i){const r=(e-n.x)*i-(t-n.y)*a,s=Math.sqrt(a*a+i*i);return Math.abs(r)/s<=1?"on_line":r>0?"left":"right"}function renderPixelBasedCutResult(e){console.log("üé® renderPixelBasedCutResult called"),console.log("   leftArea type:",typeof e.leftArea),console.log("   leftArea value:",e.leftArea),console.log("   leftPercentage:",e.leftPercentage),console.log("   rightPercentage:",e.rightPercentage);if(!(Array.isArray(e.leftArea)&&Array.isArray(e.rightArea)))return console.log("‚ö†Ô∏è Triangle mechanic provided counts, not pixel arrays - cannot restore pixel shading"),console.log("üìä Displaying percentages only"),void showAttemptResult(e.leftPercentage,e.rightPercentage);console.log("‚úÖ Has pixel arrays - leftArea pixels:",e.leftArea.length),console.log("‚úÖ Has pixel arrays - rightArea pixels:",e.rightArea.length);const t=window.isPracticeMode?window.practiceMode?.practiceParsedShapes||[]:parsedShapes||[];if(!t||0===t.length)return void console.log("üö´ No shapes available for pixel-based rendering");ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid(),renderShapesForPixelAnalysis(ctx,t);const n=ctx.getImageData(0,0,380,380).data,o=ctx.createImageData(380,380),a=o.data,i=new Set(e.leftArea.map(e=>e/4)),r=new Set(e.rightArea.map(e=>e/4));console.log("üé® Applying pixel-based shading...");for(let e=0;e<380;e++)for(let t=0;t<380;t++){const o=4*(380*e+t),s=380*e+t,c=n[o],l=n[o+1],d=n[o+2],p=n[o+3];if(221===c&&221===l&&221===d){const e=i.has(s);r.has(s);e?(window.isPracticeMode?(a[o]=250,a[o+1]=176,a[o+2]=106):(a[o]=50,a[o+1]=130,a[o+2]=246),a[o+3]=255):(a[o]=221,a[o+1]=221,a[o+2]=221,a[o+3]=255)}else a[o]=c,a[o+1]=l,a[o+2]=d,a[o+3]=p}ctx.putImageData(o,0,0),console.log("‚úÖ Pixel-based shading applied successfully"),showAttemptResult(e.leftPercentage,e.rightPercentage)}function renderVectorCutResult(e){if(window.canceledLineDrawing)return void console.log("üö´ renderVectorCutResult blocked - cut was canceled via right-click");if(e&&e.leftArea&&e.rightArea)return console.log("üé® Using pixel-based rendering (Triangle mechanic) - leftArea and rightArea provided"),void renderPixelBasedCutResult(e);const t=window.currentVector||currentVector;console.log("üé®üé®üé® RENDER FUNCTION CALLED üé®üé®üé®"),console.log("üìç CHOOSING VECTOR FOR PIXEL ANALYSIS:"),console.log("   üîß window.currentVector exists:",!!window.currentVector),console.log("   üîß Using vector:",window.currentVector?"window.currentVector (from mechanic)":"currentVector (main game)"),console.log("üìç EXACT COORDINATES BEING USED FOR PIXEL ANALYSIS:"),console.log("   üî¥ renderingVector.start.x:",t?.start?.x),console.log("   üî¥ renderingVector.start.y:",t?.start?.y),console.log("   üü¢ renderingVector.end.x:",t?.end?.x),console.log("   üü¢ renderingVector.end.y:",t?.end?.y),console.log("   üìè Vector length:",t?.start&&t?.end?Math.sqrt(Math.pow(t.end.x-t.start.x,2)+Math.pow(t.end.y-t.start.y,2)).toFixed(2):"N/A"),console.log("üé®üé®üé® END RENDER DEBUG üé®üé®üé®"),currentVector=t;const n=window.isPracticeMode?window.practiceMode?.practiceParsedShapes||[]:parsedShapes||[];if(!t||!n.length)return void console.log("üö´ renderVectorCutResult early return - renderingVector:",!!t,"shapes length:",n?.length);ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid();const o=document.createElement("canvas"),a=getCanvasSize();o.width=a,o.height=a;const i=o.getContext("2d");renderShapesForPixelAnalysis(i,n);const r=i.getImageData(0,0,o.width,o.height).data,s=ctx.createImageData(380,380),c=s.data;let l=t.start,d=t.end;t.isCircle||Math.abs((d.y-l.y)/(d.x-l.x)+1)<.1&&l.x>d.x&&([l,d]=[d,l],console.log("üîÑ Pre-normalized diagonal vector for consistent left-side coloring"));for(let e=0;e<380;e++)for(let n=0;n<380;n++){const o=4*(380*e+n),a=r[o],i=r[o+1],s=r[o+2];if(221===a&&221===i&&221===s){let a;if(t.isCircle&&t.circle){const o=t.circle;a=Math.sqrt(Math.pow(n-o.center.x,2)+Math.pow(e-o.center.y,2))<=o.radius?"left":"right"}else a=getPixelSideOfVector(n,e,l,d,d.x-l.x,d.y-l.y);"left"===a?window.isPracticeMode?(c[o]=250,c[o+1]=176,c[o+2]=106,c[o+3]=255):(c[o]=100,c[o+1]=150,c[o+2]=255,c[o+3]=255):"on_line"===a?(c[o]=0,c[o+1]=0,c[o+2]=0,c[o+3]=255):(c[o]=221,c[o+1]=221,c[o+2]=221,c[o+3]=255)}else c[o]=255,c[o+1]=255,c[o+2]=255,c[o+3]=255}ctx.putImageData(s,0,0),drawGridLinesOnly(),drawShapeOutlines(),drawFinalVector()}function renderVectorCutResultWithOpacity(e,t){console.log("üé® renderVectorCutResultWithOpacity called, isPracticeMode:",isPracticeMode,"opacity:",t);const n=window.isPracticeMode?window.practiceMode?.practiceParsedShapes||[]:parsedShapes||[];if(!currentVector||!n.length)return;ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid();const o=document.createElement("canvas"),a=getCanvasSize();o.width=a,o.height=a;const i=o.getContext("2d");renderShapesForPixelAnalysis(i,n);const r=i.getImageData(0,0,o.width,o.height).data,s=ctx.createImageData(380,380),c=s.data,l=Math.round(255*t);for(let e=0;e<380;e++)for(let t=0;t<380;t++){const n=4*(380*e+t),o=r[n],a=r[n+1],i=r[n+2];if(221===o&&221===a&&221===i){let o;if(renderingVector.isCircle&&renderingVector.circle){const n=renderingVector.circle;o=Math.sqrt(Math.pow(t-n.center.x,2)+Math.pow(e-n.center.y,2))<=n.radius?"left":"right"}else o=getPixelSideOfVector(t,e,renderingVector.start,renderingVector.end,renderingVector.end.x-renderingVector.start.x,renderingVector.end.y-renderingVector.start.y);"left"===o?window.isPracticeMode?(c[n]=250,c[n+1]=176,c[n+2]=106,c[n+3]=l):(c[n]=100,c[n+1]=150,c[n+2]=255,c[n+3]=l):"on_line"===o?(c[n]=0,c[n+1]=0,c[n+2]=0,c[n+3]=255):(c[n]=221,c[n+1]=221,c[n+2]=221,c[n+3]=255)}else c[n]=255,c[n+1]=255,c[n+2]=255,c[n+3]=255}ctx.putImageData(s,0,0),drawGridLinesOnly(),drawShapeOutlines(),drawFinalVector()}function renderShape3QuadrantResult(e,t,n){const o=window.isPracticeMode?window.practiceMode?.practiceParsedShapes||[]:parsedShapes||[];if(!t||!n||!o.length)return;ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid();const a=document.createElement("canvas"),i=getCanvasSize();a.width=i,a.height=i;const r=a.getContext("2d");console.log(`üîç RENDER SHAPE 3 QUADRANT: Using ${o.length} shapes for pixel analysis (isPracticeMode: ${window.isPracticeMode})`),renderShapesForPixelAnalysis(r,o);const s=r.getImageData(0,0,a.width,a.height).data,c=ctx.createImageData(380,380),l=c.data,d={1:{r:255,g:100,b:100},2:{r:100,g:150,b:255},3:{r:100,g:200,b:100},4:{r:255,g:200,b:100}},p=t.end.x-t.start.x,u=t.end.y-t.start.y,g=n.end.x-n.start.x,m=n.end.y-n.start.y;for(let e=0;e<380;e++)for(let o=0;o<380;o++){const a=4*(380*e+o),i=s[a],r=s[a+1],c=s[a+2];if(221===i&&221===r&&221===c){const i=getPixelSideOfVector(o,e,t.start,t.end,p,u),r=getPixelSideOfVector(o,e,n.start,n.end,g,m);let s;if("right"===i&&"right"===r)s=1;else if("left"===i&&"right"===r)s=2;else if("left"===i&&"left"===r)s=3;else{if("right"!==i||"left"!==r){l[a]=0,l[a+1]=0,l[a+2]=0,l[a+3]=255;continue}s=4}const c=d[s];l[a]=c.r,l[a+1]=c.g,l[a+2]=c.b,l[a+3]=255}else l[a]=255,l[a+1]=255,l[a+2]=255,l[a+3]=255}ctx.putImageData(c,0,0),drawGridLinesOnly(),drawShapeOutlines(),drawFinalizedVector(t),drawFinalizedVector(n)}function drawShapeOutlines(){let e;if(e=window.isPracticeMode?window.practiceMode&&window.practiceMode.practiceParsedShapes||window.PracticeMode&&window.PracticeMode.originalShapes||[]:parsedShapes||[],console.log("üé® drawShapeOutlines called - isPracticeMode:",window.isPracticeMode,"shapes.length:",e.length),console.log("üé® Shape sources checked:",{"practiceMode.practiceParsedShapes":window.practiceMode?.practiceParsedShapes?.length||0,"PracticeMode.originalShapes":window.PracticeMode?.originalShapes?.length||0,parsedShapes:parsedShapes?.length||0}),!e.length)return void console.warn("‚ö†Ô∏è drawShapeOutlines: No shapes to draw!");const t=calculateBounds(e),n=calculateScale(t),o=calculateOffset(t,n);ctx.save(),ctx.strokeStyle="#000000",ctx.lineWidth=1.5,ctx.fillStyle="transparent",ctx.setLineDash([]),e.forEach(e=>{drawPolygonOutline(e,n,o)}),console.log("‚úÖ drawShapeOutlines: Drew",e.length,"shape outlines"),ctx.restore()}function drawShapeOutlinesFromGeoJSON(e){if(!e)return void console.warn("üé® No GeoJSON provided to drawShapeOutlinesFromGeoJSON");const t=parseGeometry(e),n=t.shapes;if(!n.length)return void console.warn("üé® No shapes parsed from GeoJSON");const o=calculateBounds(n),a=calculateScale(o,t.useDirectCoordinates),i=calculateOffset(o,a,t.useDirectCoordinates);ctx.save(),ctx.strokeStyle="#000000",ctx.lineWidth=1.5,ctx.fillStyle="transparent",ctx.setLineDash([]),n.forEach(e=>{drawPolygonOutline(e,a,i)}),ctx.restore(),console.log("üé® Drew shape outlines from provided GeoJSON")}function drawPolygonOutline(e,t,n){ctx.beginPath(),drawRingForPixelAnalysis(ctx,e.outerRing,t,n),ctx.stroke(),e.holes&&e.holes.length>0&&e.holes.forEach(e=>{ctx.beginPath(),drawRingForPixelAnalysis(ctx,e,t,n),ctx.stroke()})}function drawFinalVector(){if(currentVector){if(currentMechanic&&currentMechanic.name){if(currentMechanic.name.includes("Circle Cut")||currentMechanic.name.includes("Triangle")||currentMechanic.name.includes("Square"))return void console.log("üö´ Skipping vector line drawing for shape-based mechanic:",currentMechanic.name)}ctx.save(),ctx.strokeStyle="#000000",ctx.lineWidth=2,ctx.setLineDash([]),ctx.beginPath(),ctx.moveTo(currentVector.start.x,currentVector.start.y),ctx.lineTo(currentVector.end.x,currentVector.end.y),ctx.stroke(),ctx.restore()}}function drawFinalizedVector(e){e&&(ctx.save(),ctx.strokeStyle="#000000",ctx.lineWidth=2,ctx.setLineDash([]),ctx.beginPath(),ctx.moveTo(e.start.x,e.start.y),ctx.lineTo(e.end.x,e.end.y),ctx.stroke(),ctx.restore())}function updateStatus(e){console.log("üìã Status:",e);const t=document.getElementById("statusMessage");t&&(t.textContent=e)}let menuState={isExpanded:!1,selectedOption:null,isLoggedIn:!1,isInitialized:!1};function initializeAnimatedMenu(){if(menuState.isInitialized)return void console.log("üîµ Menu already initialized, skipping...");console.log("üîµ Initializing animated menu..."),console.trace("üîµ MENU INIT CALL STACK:");const e=document.getElementById("animatedMenuButton"),t=document.getElementById("menuDropdown");if(console.log("üîµ Menu elements:",{animatedMenuButton:e,menuDropdown:t}),!e)return void console.error("üîµ ERROR: animatedMenuButton not found!");if(!t)return void console.error("üîµ ERROR: menuDropdown not found!");if(e){e.addEventListener("click",handleMenuButtonClick),console.log("üîµ Click listener added to main button"),e.addEventListener("click",function(){console.log("üîµ DEBUG: Menu button clicked!")});let t=!1,n=!1;e.ontouchstart=o=>{o.preventDefault(),n=!0,t=!0,e.style.transform="scale(0.95)"},e.ontouchend=n=>{n.preventDefault(),e.style.transform="scale(1)",t=!1,setTimeout(()=>e.click(),10)},e.onmouseenter=()=>{n||t||(e.style.transform="scale(1.05)")},e.onmouseleave=()=>{n||(e.style.transform="scale(1)",t=!1)},e.onmousedown=()=>{n||(t=!0,e.style.transform="scale(0.95)")},e.onmouseup=()=>{n||(e.style.transform="scale(1)",t=!1)}}else console.error("üî¥ animatedMenuButton not found!");document.querySelectorAll(".menu-item").forEach(e=>{e.addEventListener("click",e=>{e.stopPropagation();const t=e.currentTarget.dataset.action;console.log("üîµ Menu item clicked:",t),"account"===t?handleOption1Click():"daily"===t?handleOption2Click():"competition"===t?handleOption3Click():"practice"===t&&handleOption4Click(),collapseMenu()})}),document.addEventListener("click",function(e){const t=document.getElementById("animatedMenuButton"),n=document.getElementById("menuDropdown");menuState.isExpanded&&t&&n&&!t.contains(e.target)&&!n.contains(e.target)&&(console.log("üîµ Clicked outside menu - closing dropdown"),collapseMenu())}),updateMenuVisibility()}function handleMenuButtonClick(e){e&&e.stopPropagation(),console.log("üîµ Menu button clicked, isExpanded:",menuState.isExpanded),console.log("üîµ Menu state:",menuState),menuState.isExpanded?collapseMenu():expandMenu()}function expandMenu(){console.log("üîµ Expanding dropdown menu...");const e=document.getElementById("animatedMenuButton"),t=document.getElementById("menuDropdown");console.log("üîµ animatedMenuButton:",e),console.log("üîµ menuDropdown:",t),e.classList.add("expanded"),t.style.display="block",setTimeout(()=>{t.classList.add("show")},10),console.log("üîµ Dropdown menu expanded"),menuState.isExpanded=!0}function collapseMenu(){const e=document.getElementById("animatedMenuButton"),t=document.getElementById("menuDropdown");e.classList.remove("expanded"),t.classList.remove("show"),setTimeout(()=>{t.style.display="none"},300),menuState.isExpanded=!1}function updateMenuVisibility(){console.log("üîµ Updating menu visibility, isLoggedIn:",menuState.isLoggedIn);const e=document.getElementById("menuDropdown");console.log("üîµ Menu dropdown:",e),e&&console.log("üîµ Menu dropdown ready")}function updateLoginStatus(e){menuState.isLoggedIn=e,updateMenuVisibility()}function showAuthRequiredPopup(e){const t={archive:"To practice with previous shapes, you'll need a free account",competition:"To play in or create a competition with mates, you'll need a free account"}[e]||`To access ${e}, you'll need a free account`;"function"==typeof openAuthModal?openAuthModal("signup",t):alert(t)}function resetMenu(){const e=document.getElementById("animatedMenuButton"),t=document.getElementById("menuOptions"),n=document.getElementById("selectedOption");e.querySelector(".hamburger-icon");e.style.display="flex",e.classList.remove("hidden"),e.classList.remove("expanded"),t.classList.remove("expanded"),n.style.display="none",menuState.isExpanded=!1,menuState.selectedOption=null}function restoreCompleteVisualState(e){if(console.log("üé® Restoring complete visual state for scenario:",e.scenarioNumber),window.pendingCanvasRestoration||e.canvasData){if(console.log("üé® Using saved canvas image for accurate restoration (preferred for Triangle mechanic)"),restoreVisualState(e),e.currentAttempts&&e.currentAttempts.length>0){const t=e.currentAttempts[e.currentAttempts.length-1];t&&t.trianglePoints&&3===t.trianglePoints.length&&setTimeout(()=>{console.log("‚úèÔ∏è Drawing triangle cut line on top of restored canvas");const e=window.ctx;e.save(),e.strokeStyle="#000000",e.lineWidth=3,e.setLineDash([]),e.beginPath(),e.moveTo(t.trianglePoints[0].x,t.trianglePoints[0].y),e.lineTo(t.trianglePoints[1].x,t.trianglePoints[1].y),e.lineTo(t.trianglePoints[2].x,t.trianglePoints[2].y),e.closePath(),e.stroke(),e.restore(),console.log("‚úÖ Triangle cut line drawn on restored canvas")},150)}return}if(e.currentAttempts&&e.currentAttempts.length>0){const t=e.currentAttempts[e.currentAttempts.length-1];if(t&&t.cutVector&&void 0!==t.leftPercentage)return console.log("üé® No canvas image - recreating cut visualization from attempt data (fallback)"),restoreCutVisualization(e),void(window.pendingCanvasRestoration&&(window.pendingCanvasRestoration=null,window.isRestoringGameState=!1,console.log("üîÑ Cleared pendingCanvasRestoration after cut visualization")))}const t=e.canvasData||window.pendingCanvasRestoration;if(t&&window.canvas&&window.ctx){console.log("üé® Using canvas image restoration (fallback method)");const e=new Image;e.onload=function(){window.ctx.clearRect(0,0,canvas.width,canvas.height),window.ctx.drawImage(e,0,0),console.log("‚úÖ Canvas shaded state restored from saved image"),window.pendingCanvasRestoration&&(window.pendingCanvasRestoration=null,window.isRestoringGameState=!1,console.log("üîÑ Cleared pendingCanvasRestoration after use"))},e.src=t}else console.log("‚ö†Ô∏è No restoration data available - showing unshaded shape only");let n=null;const o=e.currentShape||window.currentShapeNumber||1,a=e.currentAttempt||window.currentAttemptNumber||1,i=e.totalCutsMade||window.totalCutsMade||0,r=2*(o-1)+(a-1);console.log(`üéØ Finding correct attempt for Shape ${o}, Cut ${a}`),console.log(`   Total cuts made: ${i}, target index: ${r}`);let s=null;if(e.currentAttempts&&e.currentAttempts.length>0?s=e.currentAttempts:window.currentAttempts&&window.currentAttempts.length>0?s=window.currentAttempts:void 0!==currentAttempts&&currentAttempts.length>0&&(s=currentAttempts),s&&r>=0&&r<s.length)n=s[r],console.log(`‚úÖ Found correct attempt at index ${r}:`,n);else if(console.warn(`‚ö†Ô∏è Could not find attempt at index ${r}, attempts array length: ${s?.length||0}`),s&&s.length>0){const e=Math.min(s.length-1,r);n=s[e],console.log(`üîÑ FALLBACK: Using attempt at index ${e} for Shape ${o}, Cut ${a}`)}if(n&&n.leftPercentage&&n.rightPercentage)console.log("üìä Restoring percentage display:",n.leftPercentage+"%",n.rightPercentage+"%"),showPercentageResults(n.leftPercentage,n.rightPercentage);else if(console.log("‚ö†Ô∏è No attempt data found for percentage restoration"),console.log("üìä Debug - Available sources:",{restoredStateAttempts:e.currentAttempts?.length||0,windowCurrentAttempts:window.currentAttempts?.length||0,localCurrentAttempts:void 0!==currentAttempts?currentAttempts.length:"undefined"}),1===e.scenarioNumber||3===e.scenarioNumber||5===e.scenarioNumber||7===e.scenarioNumber||9===e.scenarioNumber){console.log("üìä Restoring cut state for completed scenario",e.scenarioNumber);let t=50,n=50;if(window.dailyGameState&&window.dailyGameState.cuts&&window.dailyGameState.cuts.length>0){const e=window.dailyGameState.cuts[window.dailyGameState.cuts.length-1];e&&void 0!==e.leftPercentage&&void 0!==e.rightPercentage&&(t=e.leftPercentage,n=e.rightPercentage,console.log("üìä Using saved cut results:",t,n))}showPercentageResults(t,n)}const c=document.getElementById("geoCanvas");c&&(c.style.pointerEvents="none",console.log("üö´ Canvas interaction disabled - awaiting button choice"))}function restoreCutVisualization(e){if(e.currentAttempts&&e.currentAttempts.length>0){const t=e.currentAttempts[e.currentAttempts.length-1];if(t&&void 0!==t.leftPercentage){if(console.log("üé® Recreating cut visualization from attempt data"),console.log("   - leftPercentage:",t.leftPercentage),console.log("   - rightPercentage:",t.rightPercentage),console.log("   - splitAreas exists:",!!t.splitAreas),t.splitAreas&&t.splitAreas.left&&t.splitAreas.right&&(console.log("üé® Using pixel-based rendering for Triangle/shape-based mechanic"),"function"==typeof renderVectorCutResult&&window.canvas&&window.ctx)){const e={leftPercentage:t.leftPercentage,rightPercentage:t.rightPercentage,leftArea:t.splitAreas.left,rightArea:t.splitAreas.right};if(t.cutVector&&(window.currentVector=t.cutVector),window.canceledLineDrawing&&(console.log("üîß Restoration: Clearing canceledLineDrawing flag"),window.canceledLineDrawing=!1),renderVectorCutResult(e),t.trianglePoints&&3===t.trianglePoints.length){console.log("‚úèÔ∏è Drawing triangle cut line from saved points");const e=window.ctx;e.save(),e.strokeStyle="#000000",e.lineWidth=3,e.setLineDash([]),e.beginPath(),e.moveTo(t.trianglePoints[0].x,t.trianglePoints[0].y),e.lineTo(t.trianglePoints[1].x,t.trianglePoints[1].y),e.lineTo(t.trianglePoints[2].x,t.trianglePoints[2].y),e.closePath(),e.stroke(),e.restore(),console.log("‚úÖ Triangle cut line drawn")}return}if(t.cutVector&&t.cutVector.start&&t.cutVector.end&&(console.log("üé® Using renderVectorCutResult for vector-based mechanic"),window.currentVector=t.cutVector,window.canceledLineDrawing&&(console.log("üîß Restoration: Clearing canceledLineDrawing flag"),window.canceledLineDrawing=!1),"function"==typeof renderVectorCutResult&&window.canvas&&window.ctx)){return void renderVectorCutResult({leftPercentage:t.leftPercentage,rightPercentage:t.rightPercentage,leftArea:t.splitAreas?.left||null,rightArea:t.splitAreas?.right||null})}console.log("‚ö†Ô∏è No compatible visualization method - showing unshaded shape"),"function"==typeof redrawCanvas&&redrawCanvas()}else console.log("‚ö†Ô∏è Missing cut data - redrawing clean shape"),"function"==typeof redrawCanvas&&redrawCanvas()}}function drawCutLine(e){window.ctx&&e&&(console.log("üî∏ Drawing fallback cut line"),window.ctx.save(),window.ctx.strokeStyle="#ff6b6b",window.ctx.lineWidth=3,window.ctx.setLineDash([5,5]),window.ctx.beginPath(),window.ctx.moveTo(e.start.x,e.start.y),window.ctx.lineTo(e.end.x,e.end.y),window.ctx.stroke(),window.ctx.restore())}function restoreAttemptCommentary(e){if(console.log("üí¨ Restoring attempt commentary for scenario:",e.scenarioNumber),e.currentAttempts&&e.currentAttempts.length>0){const t=e.currentAttempts[e.currentAttempts.length-1];if(t&&t.commentary)console.log("üìù Displaying commentary:",t.commentary),showCommentaryText(t.commentary);else if(t&&t.leftPercentage&&t.rightPercentage){const e=generateCommentary(t.leftPercentage,t.rightPercentage);console.log("üìù Generated commentary:",e),showCommentaryText(e)}}}function showCommentaryText(e){"function"==typeof updateInstructionText?(updateInstructionText(e,!0),console.log("üí¨ Commentary displayed in instruction area:",e)):console.log("‚ö†Ô∏è updateInstructionText not available, commentary not displayed:",e)}function generateCommentary(e,t){const n=Math.abs(e-t);return n<=2?"Perfect! Nearly equal split.":n<=5?"Excellent! Very close to 50/50.":n<=10?"Good attempt! Getting closer to the center.":n<=20?"Not quite centered, but you're learning!":"Keep practicing!"}function showPercentageResults(e,t){if("function"==typeof displayPercentages)return void displayPercentages(e,t);const n=document.getElementById("fixedPercentageArea");if(!n)return void console.log("‚ö†Ô∏è Fixed percentage area not found - creating fallback");n.style.setProperty("visibility","visible","important");const o=document.createElement("div");o.className="attempt-result";o.innerHTML=`\n        <div class="attempt-info">\n            <div class="split-display-large">\n                <span style="color: #6496FF; font-weight: bold; font-size: 46px;">${e.toFixed(1)}%</span><span style="color: #999999; font-weight: bold; font-size: 46px; margin: 0 5px;"> / </span><span style="color: #999999; font-weight: bold; font-size: 46px;">${t.toFixed(1)}%</span>\n            </div>\n        </div>\n    `,n.innerHTML="",n.appendChild(o),console.log("‚úÖ Percentage splits restored with normal appearance:",e.toFixed(1),t.toFixed(1))}function drawPracticeGrid(e=ctx){if(e.save(),e.fillStyle="#ffffff",e.fillRect(0,0,canvas.width,canvas.height),e.strokeStyle="#000000",e.lineWidth=2,e.strokeRect(0,0,canvas.width,canvas.height),"initial"!==gameState){e.strokeStyle="#d0d0d0",e.lineWidth=.5;const t=14,n=canvas.width/t;for(let o=0;o<=t;o++){const t=o*n;e.beginPath(),e.moveTo(t,0),e.lineTo(t,canvas.height),e.stroke()}for(let o=0;o<=t;o++){const t=o*n;e.beginPath(),e.moveTo(0,t),e.lineTo(canvas.width,t),e.stroke()}}e.restore()}function renderPracticeShapeForCutting(e,t=!1,n=ctx){if(window.PracticeMode&&window.PracticeMode.isActive)return void console.log("üéØ New PracticeMode system is active - skipping old rendering system");if(window.isAnimating||console.log(`üé® renderPracticeShapeForCutting called with ${e.length} shapes, useDirectCoordinates: ${t}`),0===e.length)return void(window.isAnimating||console.error("‚ùå No shapes to render!"));const o=calculateBounds(e),a=calculateScale(o,t),i=calculateOffset(o,a,t);window.isAnimating||console.log(`üé® Rendering with offset: (${i.x.toFixed(1)}, ${i.y.toFixed(1)}), scale: ${a.toFixed(2)}`),n.save(),n.fillStyle="#dddddd",n.strokeStyle="#000000",n.lineWidth=2,e.forEach((e,t)=>{drawPolygon(e,a,i,n)}),n.restore()}function calculatePracticePixelBasedAreas(e,t,n,o){let a=0,i=0,r=0;const s=o.start,c=o.end,l=c.x-s.x,d=c.y-s.y;for(let o=0;o<n;o++)for(let n=0;n<t;n++){const p=4*(o*t+n),u=e[p],g=e[p+1],m=e[p+2];if(221===u&&221===g&&221===m){r++;const e=getPixelSideOfVector(n,o,s,c,l,d);"left"===e?a++:"right"===e&&i++}}return{leftArea:a,rightArea:i,totalShapePixels:r,leftPercentage:r>0?a/r*100:0,rightPercentage:r>0?i/r*100:0}}function renderPracticeVectorCutResult(e){if(!practiceMode.practiceCurrentVector||!practiceMode.practiceParsedShapes.length)return;ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid();const t=document.createElement("canvas"),n=getCanvasSize();t.width=n,t.height=n;const o=t.getContext("2d");renderShapesForPixelAnalysis(o,practiceMode.practiceParsedShapes);const a=o.getImageData(0,0,t.width,t.height).data,i=ctx.createImageData(380,380),r=i.data;for(let e=0;e<380;e++)for(let t=0;t<380;t++){const n=4*(380*e+t),o=a[n],i=a[n+1],s=a[n+2];if(221===o&&221===i&&221===s){const o=getPixelSideOfVector(t,e,practiceMode.practiceCurrentVector.start,practiceMode.practiceCurrentVector.end,practiceMode.practiceCurrentVector.end.x-practiceMode.practiceCurrentVector.start.x,practiceMode.practiceCurrentVector.end.y-practiceMode.practiceCurrentVector.start.y);"left"===o?window.isPracticeMode?(r[n]=250,r[n+1]=176,r[n+2]=106,r[n+3]=255):(r[n]=100,r[n+1]=150,r[n+2]=255,r[n+3]=255):"on_line"===o?(r[n]=0,r[n+1]=0,r[n+2]=0,r[n+3]=255):(r[n]=221,r[n+1]=221,r[n+2]=221,r[n+3]=255)}else r[n]=255,r[n+1]=255,r[n+2]=255,r[n+3]=255}ctx.putImageData(i,0,0),ctx.save(),ctx.strokeStyle="#000000",ctx.lineWidth=2,ctx.lineCap="round",ctx.beginPath(),ctx.moveTo(practiceMode.practiceCurrentVector.start.x,practiceMode.practiceCurrentVector.start.y),ctx.lineTo(practiceMode.practiceCurrentVector.end.x,practiceMode.practiceCurrentVector.end.y),ctx.stroke(),ctx.restore()}function loadOldestPracticeShape(){console.warn("‚ö†Ô∏è loadOldestPracticeShape is deprecated - use practice-mode.js class system");const e=getPracticeMechanicName();console.log("üéÆ Practice mode using mechanic:",e);const t=document.getElementById("instructionArea");if(t){t.style.display="flex",t.style.visibility="visible",console.log("üéÆ Practice mode: Set instruction area display and visibility");const n=getInitialInstruction(e);window.updateInstructionText&&(window.updateInstructionText(n,!1),console.log("üéÆ Practice mode initial instruction:",n))}}async function loadPracticeShape(e){try{const t=await fetch(`./Practice Shapes/${e}`),n=parseGeometry(await t.json());practiceMode.practiceParsedShapes=n.shapes,practiceMode.practiceCurrentVector=null,practiceMode.practiceVectorStart=null,practiceMode.practiceVectorEnd=null;const o=document.getElementById("fixedPercentageArea");o&&(o.innerHTML=""),ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid(ctx),renderPracticeShapeForCutting(practiceMode.practiceParsedShapes),canvas&&(canvas.style.pointerEvents="auto",console.log("üîß Canvas interaction maintained after practice shape load")),updatePracticeNavigationButtons(),console.log("Practice shape loaded:",e)}catch(t){console.error("Failed to load practice shape:",e,t)}}function setupPracticeEventListeners(){if(!canvas)return void console.error("‚ùå Cannot setup practice event listeners - canvas not found");console.log("üîß Setting up practice-specific event listeners"),canvas.addEventListener("click",function(e){practiceMode.isActive&&console.log("üîç DEBUG: Practice mode canvas CLICK detected!",{clientX:e.clientX,clientY:e.clientY,offsetX:e.offsetX,offsetY:e.offsetY,target:e.target.tagName,practiceActive:practiceMode.isActive,pointerEvents:canvas.style.pointerEvents}),window.menuState&&window.menuState.isExpanded&&(console.log("üîµ Practice mode canvas clicked - closing menu dropdown"),window.collapseMenu())}),canvas.addEventListener("mousemove",function(e){practiceMode.isActive&&practiceMode.practiceIsDrawingVector&&(console.log("üîç DEBUG: Practice mode canvas MOUSEMOVE detected during drag!",{clientX:e.clientX,clientY:e.clientY,isDrawing:practiceMode.practiceIsDrawingVector}),e.stopPropagation())}),canvas.addEventListener("mousedown",function(e){window.isPracticeMode&&console.log("üîç DEBUG: Practice mode canvas MOUSEDOWN detected!",{clientX:e.clientX,clientY:e.clientY,offsetX:e.offsetX,offsetY:e.offsetY,button:e.button,practiceActive:practiceMode.isActive,isInteractionEnabled:isInteractionEnabled})}),canvas.removeEventListener("mousedown",handleVectorStart),canvas.removeEventListener("mousemove",handleVectorDrag),canvas.removeEventListener("mouseup",handleVectorEnd),canvas.addEventListener("mousedown",handleVectorStart),canvas.addEventListener("mousemove",handleVectorDrag),canvas.addEventListener("mouseup",handleVectorEnd);let e=null;canvas.addEventListener("mousedown",function(t){window.isPracticeMode&&(e={x:t.clientX,y:t.clientY},console.log("üîç TEMP: Mouse down for drag test",e))}),canvas.addEventListener("mousemove",function(t){if(isPracticeMode&&e){const n=t.clientX-e.x,o=t.clientY-e.y,a=Math.sqrt(n*n+o*o);console.log("üîç TEMP: Mouse move during drag",{distance:a,current:{x:t.clientX,y:t.clientY}})}}),canvas.addEventListener("mouseup",function(t){if(practiceMode.isActive&&e){const n=t.clientX-e.x,o=t.clientY-e.y,a=Math.sqrt(n*n+o*o);console.log("üîç TEMP: Mouse up - total drag distance",a),e=null}}),console.log("‚úÖ Practice-specific event listeners attached"),console.log("üîß Vector event handlers re-attached for practice mode")}function exitPracticeMode(){if(window.SimplePracticeMode&&window.SimplePracticeMode.isActive&&(console.log("üéØ Deactivating SimplePracticeMode instance..."),window.SimplePracticeMode.isActive=!1,window.SimplePracticeMode.close&&window.SimplePracticeMode.close(),console.log("‚úÖ SimplePracticeMode instance deactivated")),document.getElementById("practiceModeIndicator").style.display="none",document.getElementById("practiceNavigation").style.display="none",window.innerWidth>=769){const e=document.getElementById("fixedPercentageArea"),t=document.getElementById("buttonsContainer");e&&(e.style.removeProperty("margin-top"),e.style.removeProperty("position")),t&&(t.style.removeProperty("margin-top"),t.style.removeProperty("margin-bottom"),t.style.removeProperty("position")),console.log("‚úÖ Desktop: Reset practice mode element positioning")}const e=document.getElementById("floatingPracticeNav");e&&(e.remove(),console.log("üöÄ AGGRESSIVE: Cleaned up floating practice navigation on exit"));const t=document.getElementById("fixedPercentageArea");t&&(t.innerHTML="");const n=document.getElementById("demoProgressDisplay");n&&(n.style.display="block");const o=document.querySelector(".welcome-overlay");o&&(o.style.visibility="visible");const a=document.getElementById("initialPlayButton");a&&(a.style.visibility="visible");const i=document.getElementById("welcomeOverlay");if(i&&(i.style.visibility="visible"),practiceMode.savedDailyGameCounters&&(window.totalCutsMade=practiceMode.savedDailyGameCounters.totalCutsMade,window.cutsMadeThisShape=practiceMode.savedDailyGameCounters.cutsMadeThisShape,window.currentShapeNumber=practiceMode.savedDailyGameCounters.currentShapeNumber,window.currentAttemptNumber=practiceMode.savedDailyGameCounters.currentAttemptNumber,totalCutsMade=practiceMode.savedDailyGameCounters.totalCutsMade,cutsMadeThisShape=practiceMode.savedDailyGameCounters.cutsMadeThisShape,currentShapeNumber=practiceMode.savedDailyGameCounters.currentShapeNumber,currentAttemptNumber=practiceMode.savedDailyGameCounters.currentAttemptNumber,console.log("üîÑ Restored daily game counters via exitPracticeMode:",practiceMode.savedDailyGameCounters),practiceMode.savedDailyGameCounters.cutsMadeThisShape>0&&setTimeout(()=>{"awaiting_choice"!==gameState&&"finished"!==gameState||(createProgressionButton(),console.log("üîÑ Restored daily mode button after exiting practice mode"))},100)),practiceMode.savedDailyGameState){if(setGameState(practiceMode.savedDailyGameState.gameState),currentAttempts=practiceMode.savedDailyGameState.currentAttempts,currentShapeNumber=practiceMode.savedDailyGameState.currentShapeNumber,currentAttemptNumber=practiceMode.savedDailyGameState.currentAttemptNumber,practiceMode.savedDailyGameState.canvasContent){const e=new Image;e.onload=function(){window.canceledLineDrawing?console.log("üö´ Skipping practice mode canvas restoration due to recent cancel - preventing visual corruption"):(ctx.clearRect(0,0,canvas.width,canvas.height),ctx.drawImage(e,0,0))},e.src=practiceMode.savedDailyGameState.canvasContent}else ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid();const e="cutting"===practiceMode.savedDailyGameState.gameState&&(!isDailyMode||window.cutsMadeThisShape<2);isDailyMode&&window.cutsMadeThisShape>=2?(console.log("üö´ EXIT PRACTICE: Daily mode shape has reached cut limit, keeping canvas disabled"),setInteractionEnabled(!1),canvas.style.pointerEvents="none"):setInteractionEnabled(e)}if(practiceMode.isActive=!1,practiceMode.savedDailyGameState=null,practiceMode.savedDailyGameCounters=null,"cutting"===window.gameState||"playing"===window.gameState){const e=getInitialInstruction(getCurrentMechanicName());window.updateInstructionText&&(window.updateInstructionText(e),console.log("üìù Restored daily mode instruction after exiting practice:",e))}else if(("awaiting_choice"===window.gameState||"finished"===window.gameState)&&currentAttempts&&currentAttempts.length>0){const e=currentAttempts[currentAttempts.length-1];e&&e.commentary&&window.updateInstructionText&&(window.updateInstructionText(e.commentary,!0),console.log("üìù Restored daily mode commentary after exiting practice:",e.commentary))}}function returnToDailyShapes(){console.log("üéØ Exiting practice mode and returning to Daily Shapes"),isPracticeMode=!1,window.isPracticeMode=!1,isDailyMode=!0;const e=document.getElementById("accountDropdown");if(e&&(e.style.display="none"),document.getElementById("practiceModeIndicator").style.display="none",document.getElementById("practiceNavigation").style.display="none",window.innerWidth>=769){const e=document.getElementById("fixedPercentageArea"),t=document.getElementById("buttonsContainer");e&&(e.style.removeProperty("margin-top"),e.style.removeProperty("position")),t&&(t.style.removeProperty("margin-top"),t.style.removeProperty("margin-bottom"),t.style.removeProperty("position")),console.log("‚úÖ Desktop: Reset practice mode element positioning")}const t=document.getElementById("floatingPracticeNav");t&&(t.remove(),console.log("üöÄ AGGRESSIVE: Cleaned up floating practice navigation on return to daily"));const n=document.getElementById("fixedPercentageArea");if(n&&(n.innerHTML=""),practiceMode.savedDailyGameCounters&&(window.totalCutsMade=practiceMode.savedDailyGameCounters.totalCutsMade,window.cutsMadeThisShape=practiceMode.savedDailyGameCounters.cutsMadeThisShape,window.currentShapeNumber=practiceMode.savedDailyGameCounters.currentShapeNumber,window.currentAttemptNumber=practiceMode.savedDailyGameCounters.currentAttemptNumber,totalCutsMade=practiceMode.savedDailyGameCounters.totalCutsMade,cutsMadeThisShape=practiceMode.savedDailyGameCounters.cutsMadeThisShape,currentShapeNumber=practiceMode.savedDailyGameCounters.currentShapeNumber,currentAttemptNumber=practiceMode.savedDailyGameCounters.currentAttemptNumber,console.log("üîÑ Restored daily game counters:",practiceMode.savedDailyGameCounters),practiceMode.savedDailyGameCounters.cutsMadeThisShape>0&&setTimeout(()=>{"awaiting_choice"!==gameState&&"finished"!==gameState||(createProgressionButton(),console.log("üîÑ Restored daily mode button via returnToDailyShapes"))},100)),practiceMode.isActive=!1,practiceMode.savedDailyGameState=null,practiceMode.savedDailyGameCounters=null,window.ctx&&window.canvas&&(window.ctx.clearRect(0,0,canvas.width,canvas.height),console.log("üßπ Cleared canvas before restoring daily game state")),window.SimpleRefresh&&window.SimpleRefresh.restore){console.log("üîÑ Using SimpleRefresh to restore daily game state");const e=window.SimpleRefresh.restore();if(e&&e.canvasData&&(console.log("üé® Restoring canvas with cut shading..."),restoreVisualState(e)),e&&e.currentAttempts&&e.currentAttempts.length>0){const t=e.currentAttempts[e.currentAttempts.length-1];void 0!==t.leftPercentage&&void 0!==t.rightPercentage&&updatePercentageDisplays(t.leftPercentage,t.rightPercentage)}}else console.log("‚ö†Ô∏è SimpleRefresh not available, falling back to fresh state"),window.location.reload();setTimeout(()=>{if(window.dailyGameState&&(window.dailyGameState.dayComplete||window.dailyGameState.isGameComplete))if(console.log("üèÜ Daily game was completed - restoring completion view after practice mode"),window.completeView&&window.showCompletionView)window.showCompletionView();else if(window.completeView){const e=getDayStats(currentDay);if(e&&window.buildCompletionModel){const t=window.buildCompletionModel(e);window.completeView.show(t),console.log("‚úÖ Completion view restored after practice mode exit")}}},200)}function showPracticeResults(e,t){const n=window.ScoringSystem.calculateCutScore(e),o=100===n?"100":n.toFixed(1),a=430===window.innerWidth&&805===window.innerHeight||390===window.innerWidth&&715===window.innerHeight||412===window.innerWidth&&785===window.innerHeight||360===window.innerWidth&&630===window.innerHeight,i=a?"3px":"-17px";console.log("üìä showPracticeResults (line 20355) - Device:",window.innerWidth,"x",window.innerHeight,"isSpecificMobile:",a,"scoreMarginTop:",i);document.getElementById("fixedPercentageArea").innerHTML=`\n        <div style="text-align: center; margin: 16px 0; line-height: 1.5;">\n            <div class="split-display-large" style="display: inline-block; white-space: nowrap;">\n                <span style="color: #FAB06A; font-weight: bold; font-size: 46px;">${e.toFixed(1)}%</span><span style="color: #999999; font-weight: bold; font-size: 46px; margin: 0 5px;"> / </span><span style="color: #999999; font-weight: bold; font-size: 46px;">${t.toFixed(1)}%</span>\n            </div>\n            <br>\n            <div style="margin-top: ${i};">\n                <span style="font-size: 16px; color: #666;">Score&nbsp;</span><span style="font-size: 18px; font-weight: bold;">${o}/100</span>\n            </div>\n        </div>\n    `}function setupPracticeNavigation(){const e=document.getElementById("practiceLeftBtn"),t=document.getElementById("practiceRightBtn"),n=document.getElementById("practiceRandomBtn"),o=document.getElementById("practiceResetBtn");e&&e.replaceWith(e.cloneNode(!0)),t&&t.replaceWith(t.cloneNode(!0)),n&&n.replaceWith(n.cloneNode(!0)),o&&o.replaceWith(o.cloneNode(!0));const a=document.getElementById("practiceLeftBtn"),i=document.getElementById("practiceRightBtn"),r=document.getElementById("practiceRandomBtn"),s=document.getElementById("practiceResetBtn");a&&a.addEventListener("click",async()=>{window.practiceMode&&window.practiceMode.navigateShape&&await window.practiceMode.navigateShape("left")}),i&&i.addEventListener("click",async()=>{window.practiceMode&&window.practiceMode.navigateShape&&await window.practiceMode.navigateShape("right")}),r&&r.addEventListener("click",async()=>{window.practiceMode&&window.practiceMode.navigateShape&&await window.practiceMode.navigateShape("random")}),s&&s.addEventListener("click",async()=>{window.practiceMode&&window.practiceMode.loadCurrentShape&&await window.practiceMode.loadCurrentShape()})}function updatePracticeNavigationButtons(){const e=document.getElementById("practiceLeftBtn"),t=document.getElementById("practiceRightBtn"),n=document.getElementById("floatingPracticeLeft"),o=document.getElementById("floatingPracticeRight");e&&(e.disabled=!1),t&&(t.disabled=!1),n&&(n.disabled=!1),o&&(o.disabled=!1)}function setupSimplePracticeButtons(){if(window.OLD_PRACTICE_NAVIGATION_DISABLED)return void console.log("‚ö†Ô∏è setupSimplePracticeButtons disabled - using practice-mode.js system");console.log("üöÄ AGGRESSIVE: Creating completely new practice navigation directly in body...");const e=document.getElementById("floatingPracticeNav");e&&e.remove();const t=document.querySelector(".buttons-below-canvas")||document.getElementById("buttonsContainer");if(t){const e=document.createElement("div");e.id="floatingPracticeNav",e.className="practice-navigation",e.innerHTML='\n            <button id="floatingPracticeLeft" class="practice-nav-btn" title="Previous Shape">\n                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">\n                    <path d="M16 20L8 12L16 4" stroke="black" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>\n                </svg>\n            </button>\n            <button id="floatingPracticeRandom" class="practice-nav-btn" title="Random Shape">\n                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">\n                    <text x="12" y="17" text-anchor="middle" font-family="Arial, sans-serif" font-size="18" font-weight="bold" fill="black">?</text>\n                </svg>\n            </button>\n            <button id="floatingPracticeRight" class="practice-nav-btn" title="Next Shape">\n                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">\n                    <path d="M8 4L16 12L8 20" stroke="black" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>\n                </svg>\n            </button>\n        ',e.style.cssText="\n            display: flex !important;\n            gap: 12px !important;\n            justify-content: center !important;\n            margin: 10px 0 !important;\n            visibility: visible !important;\n            opacity: 1 !important;\n            z-index: 100 !important;\n            pointer-events: auto !important;\n        ",setTimeout(()=>{e.querySelectorAll(".practice-nav-btn").forEach(e=>{e.style.cssText="\n                    width: 44px !important;\n                    height: 44px !important;\n                    border-radius: 50% !important;\n                    border: 3px solid #000000 !important;\n                    background-color: #ffffff !important;\n                    display: flex !important;\n                    align-items: center !important;\n                    justify-content: center !important;\n                    padding: 0 !important;\n                    margin: 0 !important;\n                    cursor: pointer !important;\n                    transition: all 0.2s ease !important;\n                    box-shadow: 3px 3px 0px #000000 !important;\n                    position: relative !important;\n                ";const t=document.createElement("style");t.textContent=`\n                    #${e.id}::before,\n                    #${e.id}::after {\n                        display: none !important;\n                        content: none !important;\n                    }\n                `,document.head.appendChild(t);const n=e.querySelector("svg"),o=e.querySelectorAll("path");n&&(n.style.cssText="\n                        width: 24px !important;\n                        height: 24px !important;\n                        display: block !important;\n                        pointer-events: none !important;\n                    "),o.forEach(e=>{e.style.cssText="\n                        fill: none !important;\n                        stroke: black !important;\n                        stroke-width: 2.5px !important;\n                        stroke-linecap: round !important;\n                        stroke-linejoin: round !important;\n                        pointer-events: none !important;\n                    "}),e.addEventListener("mouseenter",()=>{e.disabled||(e.style.transform="translate(-2px, -2px)",e.style.boxShadow="5px 5px 0px #000000")}),e.addEventListener("mouseleave",()=>{e.disabled||(e.style.transform="translate(0, 0)",e.style.boxShadow="3px 3px 0px #000000")}),e.addEventListener("mousedown",()=>{e.disabled||(e.style.transform="translate(1px, 1px)",e.style.boxShadow="2px 2px 0px #000000")}),e.addEventListener("mouseup",()=>{e.disabled||(e.style.transform="translate(-2px, -2px)",e.style.boxShadow="5px 5px 0px #000000")})})},0),t.appendChild(e),t.style.setProperty("opacity","1","important"),t.style.setProperty("visibility","visible","important"),t.style.setProperty("display","flex","important"),console.log("üöÄ AGGRESSIVE: Practice navigation inserted into buttons container with original styling")}else{const e=document.createElement("div");e.id="floatingPracticeNav",e.className="practice-navigation",e.innerHTML='\n            <button id="floatingPracticeLeft" class="practice-nav-btn" title="Previous Shape">\n                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">\n                    <path d="M16 20L8 12L16 4" stroke="black" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>\n                </svg>\n            </button>\n            <button id="floatingPracticeRandom" class="practice-nav-btn" title="Random Shape">\n                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">\n                    <text x="12" y="17" text-anchor="middle" font-family="Arial, sans-serif" font-size="18" font-weight="bold" fill="black">?</text>\n                </svg>\n            </button>\n            <button id="floatingPracticeRight" class="practice-nav-btn" title="Next Shape">\n                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">\n                    <path d="M8 4L16 12L8 20" stroke="black" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>\n                </svg>\n            </button>\n        ',e.style.cssText="\n            position: fixed !important;\n            bottom: 100px !important;\n            left: 50% !important;\n            transform: translateX(-50%) !important;\n            z-index: 100 !important;\n            display: flex !important;\n            gap: 12px !important;\n            justify-content: center !important;\n            margin: 10px 0 !important;\n            visibility: visible !important;\n            opacity: 1 !important;\n            pointer-events: auto !important;\n        ",setTimeout(()=>{e.querySelectorAll(".practice-nav-btn").forEach(e=>{e.style.cssText="\n                    width: 44px !important;\n                    height: 44px !important;\n                    border-radius: 50% !important;\n                    border: 3px solid #000000 !important;\n                    background-color: #ffffff !important;\n                    display: flex !important;\n                    align-items: center !important;\n                    justify-content: center !important;\n                    padding: 0 !important;\n                    margin: 0 !important;\n                    cursor: pointer !important;\n                    transition: all 0.2s ease !important;\n                    box-shadow: 3px 3px 0px #000000 !important;\n                    position: relative !important;\n                ";const t=document.createElement("style");t.textContent=`\n                    #${e.id}::before,\n                    #${e.id}::after {\n                        display: none !important;\n                        content: none !important;\n                    }\n                `,document.head.appendChild(t);const n=e.querySelector("svg"),o=e.querySelectorAll("path");n&&(n.style.cssText="\n                        width: 24px !important;\n                        height: 24px !important;\n                        display: block !important;\n                        pointer-events: none !important;\n                    "),o.forEach(e=>{e.style.cssText="\n                        fill: none !important;\n                        stroke: black !important;\n                        stroke-width: 2.5px !important;\n                        stroke-linecap: round !important;\n                        stroke-linejoin: round !important;\n                        pointer-events: none !important;\n                    "}),e.addEventListener("mouseenter",()=>{e.disabled||(e.style.transform="translate(-2px, -2px)",e.style.boxShadow="5px 5px 0px #000000")}),e.addEventListener("mouseleave",()=>{e.disabled||(e.style.transform="translate(0, 0)",e.style.boxShadow="3px 3px 0px #000000")}),e.addEventListener("mousedown",()=>{e.disabled||(e.style.transform="translate(1px, 1px)",e.style.boxShadow="2px 2px 0px #000000")}),e.addEventListener("mouseup",()=>{e.disabled||(e.style.transform="translate(-2px, -2px)",e.style.boxShadow="5px 5px 0px #000000")})})},0),document.body.appendChild(e),console.log("üöÄ AGGRESSIVE: Fallback floating navigation created")}setTimeout(()=>{const e=document.getElementById("floatingPracticeNav");if(e){const t=e.getBoundingClientRect();console.log("üîç AGGRESSIVE: Practice nav rect:",t),console.log("üîç AGGRESSIVE: Practice nav visible?",t.width>0&&t.height>0),console.log("üîç AGGRESSIVE: Practice nav computed style:",{display:window.getComputedStyle(e).display,visibility:window.getComputedStyle(e).visibility,opacity:window.getComputedStyle(e).opacity,zIndex:window.getComputedStyle(e).zIndex})}},100);const n=document.getElementById("practiceNavigation");n&&(n.style.display="none",console.log("üöÄ AGGRESSIVE: Hidden original navigation container to prevent conflicts"));const o=document.getElementById("floatingPracticeLeft"),a=document.getElementById("floatingPracticeRight"),i=document.getElementById("floatingPracticeRandom");console.log("üöÄ AGGRESSIVE: Setting up floating button event handlers..."),o&&o.addEventListener("click",()=>{console.log("üöÄ AGGRESSIVE: Floating left button clicked, isPracticeMode:",isPracticeMode,"currentIndex:",currentPracticeShapeIndex),window.isPracticeMode&&(0===currentPracticeShapeIndex?currentPracticeShapeIndex=practiceShapes.length-1:currentPracticeShapeIndex--,totalCutsMade=0,cutsMadeThisShape=0,attemptCount=0,document.getElementById("fixedPercentageArea").innerHTML="",loadSimplePracticeShape(practiceShapes[currentPracticeShapeIndex]),isShapeAnimationComplete=!0,setInteractionEnabled(!0),canvas.style.pointerEvents="auto")}),a&&a.addEventListener("click",()=>{console.log("üöÄ AGGRESSIVE: Floating right button clicked, isPracticeMode:",isPracticeMode,"currentIndex:",currentPracticeShapeIndex),window.isPracticeMode&&(currentPracticeShapeIndex===practiceShapes.length-1?currentPracticeShapeIndex=0:currentPracticeShapeIndex++,totalCutsMade=0,cutsMadeThisShape=0,attemptCount=0,document.getElementById("fixedPercentageArea").innerHTML="",loadSimplePracticeShape(practiceShapes[currentPracticeShapeIndex]),isShapeAnimationComplete=!0,setInteractionEnabled(!0),canvas.style.pointerEvents="auto")}),i&&i.addEventListener("click",()=>{console.log("üöÄ AGGRESSIVE: Floating random button clicked, isPracticeMode:",isPracticeMode),window.isPracticeMode&&(currentPracticeShapeIndex=Math.floor(Math.random()*practiceShapes.length),totalCutsMade=0,cutsMadeThisShape=0,attemptCount=0,document.getElementById("fixedPercentageArea").innerHTML="",loadSimplePracticeShape(practiceShapes[currentPracticeShapeIndex]),isShapeAnimationComplete=!0,setInteractionEnabled(!0),canvas.style.pointerEvents="auto")}),console.log("‚úÖ Practice navigation buttons set up successfully with original styling and positioning"),updatePracticeNavigationButtons()}function drawPracticeCurrentVector(){practiceMode.practiceVectorStart&&practiceMode.practiceVectorEnd&&(ctx.save(),ctx.strokeStyle="#000000",ctx.lineWidth=2,ctx.lineCap="round",ctx.beginPath(),ctx.moveTo(practiceMode.practiceVectorStart.x,practiceMode.practiceVectorStart.y),ctx.lineTo(practiceMode.practiceVectorEnd.x,practiceMode.practiceVectorEnd.y),ctx.stroke(),ctx.restore())}function executePracticeCut(){if(!practiceMode.practiceVectorStart||!practiceMode.practiceVectorEnd||!practiceMode.practiceParsedShapes.length)return void console.warn("Cannot execute practice cut - missing required data");practiceMode.practiceCurrentVector={start:practiceMode.practiceVectorStart,end:practiceMode.practiceVectorEnd};const e=document.createElement("canvas"),t=getCanvasSize();e.width=t,e.height=t;const n=e.getContext("2d");renderShapesForPixelAnalysis(n,practiceMode.practiceParsedShapes);const o=calculatePracticePixelBasedAreas(n.getImageData(0,0,e.width,e.height).data,e.width,e.height,practiceMode.practiceCurrentVector);renderPracticeVectorCutResult(o),showPracticeResults(o.leftPercentage,o.rightPercentage),console.log("üî™ Practice cut executed:",{left:o.leftPercentage.toFixed(1)+"%",right:o.rightPercentage.toFixed(1)+"%",score:window.ScoringSystem.calculateCutScore(o.leftPercentage).toFixed(1)})}window.testSignup=async function(e="test@example.com",t="testuser",n="password123"){if(console.log("Testing signup with:",{email:e,username:t}),!window.AuthService)return void console.error("AuthService not available");const o=await window.AuthService.createUser(e,t,n);return o.error?(console.error("Signup failed:",o.error),o.suggestion&&console.log("Suggestion:",o.suggestion)):console.log("‚úÖ Signup successful!",o),o},window.checkAuth=function(){return console.log("=== Authentication Status ==="),console.log("AuthService exists:",!!window.AuthService),window.AuthService&&(console.log("AuthService initialized:",window.AuthService.initialized),console.log("Is logged in:",window.AuthService.isLoggedIn()),console.log("Is guest:",window.AuthService.isGuest),console.log("Current user:",window.AuthService.currentUser)),console.log("\nLocalStorage auth tokens:"),console.log("userAuthToken:",localStorage.getItem("userAuthToken")),console.log("sb-auth-token:",localStorage.getItem("sb-zxrfhumifazjxgikltkz-auth-token")),window.SupabaseConfig&&window.SupabaseConfig.client&&window.SupabaseConfig.client.auth.getSession().then(({data:e})=>{console.log("\nSupabase session:",e.session)}),"Check console for auth details"},window.forceLogin=function(e="TestUser"){return console.log("Creating demo session for testing..."),localStorage.setItem("userAuthToken","demo_token_"+Date.now()),window.AuthService&&(window.AuthService.isGuest=!1,window.AuthService.currentUser={id:"demo_user_"+Date.now(),email:e.toLowerCase()+"@demo.com",username:e,isGuest:!1},window.AuthService.initialized=!0),window.AuthManager&&(window.AuthManager.authService=window.AuthService),document.dispatchEvent(new CustomEvent("authStateChange",{detail:{isLoggedIn:!0}})),window.updateLoginStatus&&window.updateLoginStatus(!0),window.updateButtonStates&&window.updateButtonStates(),window.closeAuthModal&&window.closeAuthModal(),window.CompetitionManager&&window.CompetitionManager.initialize(),console.log('‚úÖ Demo session created. You are now "logged in" as:',e),console.log("Note: This is only for testing UI behavior. No actual authentication occurred."),console.log("Auth check result:",window.isUserSignedIn()),"Demo login successful"},window.forceLogout=function(){return console.log("Clearing authentication..."),localStorage.removeItem("userAuthToken"),localStorage.removeItem("sb-zxrfhumifazjxgikltkz-auth-token"),window.AuthService&&(window.AuthService.isGuest=!0,window.AuthService.currentUser=null,window.AuthService.initializeGuestMode()),document.dispatchEvent(new CustomEvent("authStateChange",{detail:{isLoggedIn:!1}})),window.updateLoginStatus&&window.updateLoginStatus(!1),console.log("‚úÖ Logged out. You are now in guest mode."),"Logout successful"},document.addEventListener("DOMContentLoaded",()=>{});