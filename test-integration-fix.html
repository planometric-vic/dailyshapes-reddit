<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Integration Fix</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #f0f0f0;
        }
        .log {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #007bff;
            border-radius: 3px;
        }
        .success { border-color: #28a745; }
        .error { border-color: #dc3545; }
        .warning { border-color: #ffc107; }
        button {
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Test Integration Fix</h1>

    <button onclick="testIntegration()">Test Integration</button>
    <button onclick="clearLogs()">Clear Logs</button>

    <div id="logs"></div>

    <!-- Load all required modules -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="shape-storage.js"></script>
    <script src="daily-mode-manager.js"></script>
    <script src="practice-mode-manager.js"></script>
    <script src="game-mode-integration.js"></script>
    <script src="daily-game-core.js"></script>

    <script>
        function log(message, type = 'log') {
            const logsDiv = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            logsDiv.appendChild(logDiv);
            console.log(message);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        async function testIntegration() {
            clearLogs();
            log('ðŸ” Testing integration fix...');

            try {
                // 1. Test Supabase config
                log('1. Testing Supabase config...');
                if (window.SupabaseConfig && window.SupabaseConfig.client) {
                    log('âœ… Supabase client available', 'success');
                } else {
                    log('âŒ Supabase client NOT available', 'error');
                    return;
                }

                // 2. Test GameModeIntegration
                log('2. Testing GameModeIntegration...');
                if (window.GameModeIntegration) {
                    const gameModeIntegration = new GameModeIntegration();
                    const initResult = await gameModeIntegration.initialize();

                    if (initResult) {
                        log('âœ… GameModeIntegration initialized successfully', 'success');
                        log(`   Demo mode: ${window.isDemoMode || false}`);

                        if (window.DailyGameCore) {
                            log(`   DailyGameCore disabled: ${window.DailyGameCore.disabled || false}`);
                        }
                    } else {
                        log('âŒ GameModeIntegration failed to initialize', 'error');
                    }
                } else {
                    log('âŒ GameModeIntegration class not available', 'error');
                    return;
                }

                // 3. Test DailyGameCore
                log('3. Testing DailyGameCore...');
                if (window.DailyGameCore) {
                    try {
                        await window.DailyGameCore.initialize();
                        log('âœ… DailyGameCore initialized', 'success');

                        // Check shapes
                        const shape1 = window.DailyGameCore.getShapeData(1);
                        const shape2 = window.DailyGameCore.getShapeData(2);
                        const shape3 = window.DailyGameCore.getShapeData(3);

                        log(`   Shape 1: ${shape1 ? 'loaded' : 'not loaded'}`);
                        log(`   Shape 2: ${shape2 ? 'loaded' : 'not loaded'}`);
                        log(`   Shape 3: ${shape3 ? 'loaded' : 'not loaded'}`);

                        if (shape1) {
                            // Check if it's a Supabase shape or demo shape
                            const isDemo = JSON.stringify(shape1).includes('demo') ||
                                          JSON.stringify(shape1).includes('v4-tests');
                            log(`   Source: ${isDemo ? 'Demo/Local' : 'Supabase'}`, isDemo ? 'warning' : 'success');
                        }

                    } catch (error) {
                        log(`âŒ DailyGameCore error: ${error.message}`, 'error');
                    }
                } else {
                    log('âŒ DailyGameCore not available', 'error');
                }

                // 4. Test DailyModeManager directly
                log('4. Testing DailyModeManager directly...');
                if (window.DailyModeManager) {
                    try {
                        const dailyManager = new window.DailyModeManager();
                        const result = await dailyManager.initialize();

                        if (result.success) {
                            log('âœ… DailyModeManager initialized successfully', 'success');
                            log(`   Shapes preloaded: ${dailyManager.shapes.length}/3`);

                            if (dailyManager.shapes.length > 0) {
                                const firstShape = dailyManager.shapes[0];
                                const isDemo = JSON.stringify(firstShape).includes('demo') ||
                                              JSON.stringify(firstShape).includes('v4-tests');
                                log(`   First shape source: ${isDemo ? 'Demo/Local' : 'Supabase'}`, isDemo ? 'warning' : 'success');
                            }
                        } else {
                            log('âŒ DailyModeManager failed to initialize', 'error');
                            log(`   Error: ${result.error}`, 'error');
                        }
                    } catch (error) {
                        log(`âŒ DailyModeManager error: ${error.message}`, 'error');
                    }
                } else {
                    log('âŒ DailyModeManager not available', 'error');
                }

                log('ðŸŽ¯ Integration test complete!');

            } catch (error) {
                log(`âŒ Test error: ${error.message}`, 'error');
            }
        }

        // Auto-run test on load
        window.addEventListener('load', () => {
            setTimeout(testIntegration, 1000);
        });
    </script>
</body>
</html>