class DailyGameCore{constructor(){this.currentDate=null,this.currentMechanic=null,this.userTimezone=null,this.midnightTimer=null,this.gameState={currentShape:1,currentAttempt:1,shapeResults:{},hasStartedToday:!1,completedShapes:[],isCompleted:!1},this.shapes={shape1:null,shape2:null,shape3:null}}async initialize(){if(!this.disabled)return console.log("ğŸ® Initializing Daily Game Core..."),this.userTimezone=Intl.DateTimeFormat().resolvedOptions().timeZone,this.currentDate=(new Date).toLocaleDateString("en-CA"),console.log(`ğŸ“… Current date: ${this.currentDate}`),console.log(`ğŸŒ User timezone: ${this.userTimezone}`),await this.restoreGameState(),await this.loadTodaysContent(),this.setupMidnightReset(),this.setupOrientationBlocking(),console.log("âœ… Daily Game Core initialized"),this.gameState;console.log("ğŸš« Daily Game Core initialization BLOCKED - demo mode active")}getMechanicForDay(e){return{1:"DefaultWithUndoMechanic",2:"HorizontalOnlyMechanic",3:"DiagonalAscendingMechanic",4:"CircleCutMechanic",5:"ThreePointTriangleMechanic",6:"RotatingSquareMechanic",0:"RotatingShapeVectorMechanic"}[new Date(e).getDay()]}async loadTodaysContent(){try{const e=this.getMechanicForDay(this.currentDate);this.currentMechanic=e,console.log(`ğŸ¯ Today's mechanic: ${e}`),await this.loadTodaysShapes(),window.initializeGameEngine&&window.initializeGameEngine(e)}catch(e){console.error("Error loading today's content:",e),await this.loadFallbackShapes()}}async loadTodaysShapes(){try{if(!window.DailyModeManager||this.disabled||window.isDemoMode)console.log("âš ï¸ DailyModeManager not available, using demo shapes"),await this.loadDemoShapes();else{if(console.log("ğŸ”— Loading shapes via DailyModeManager..."),window.dailyModeManager||(window.dailyModeManager=new window.DailyModeManager,await window.dailyModeManager.initialize()),!(window.dailyModeManager.shapes&&window.dailyModeManager.shapes.length>=3))throw new Error("DailyModeManager shapes not available");{const e=window.dailyModeManager.shapes[0],t=window.dailyModeManager.shapes[1],a=window.dailyModeManager.shapes[2],o=[e,t,a].filter(e=>null!=e);if(!(o.length>=2))throw new Error(`DailyModeManager has insufficient valid shapes (${o.length}/3)`);this.shapes.shape1=e||o[0],this.shapes.shape2=t||o[0],this.shapes.shape3=a||o[0],console.log(`âœ… Shapes loaded from Supabase via DailyModeManager (${o.length}/3 valid)`)}}console.log("ğŸ¨ Today's shapes loaded successfully")}catch(e){console.log("ğŸ“ Loading fallback shapes due to error:",e.message),await this.loadDemoShapes()}}async loadShapesFromSupabase(e){throw console.log("âš ï¸ loadShapesFromSupabase is deprecated, use DailyModeManager instead"),new Error("Use DailyModeManager for Supabase shape loading")}async loadDemoShapes(){console.log("ğŸ“ Loading demo shapes from local files");const e=new Date(this.currentDate).getDay(),t=0===e?7:e,a=[`v4-tests/day${t}/shape1.geojson`,`v4-tests/day${t}/shape2.geojson`,`v4-tests/day${t}/shape3.geojson`];for(let e=0;e<3;e++){const t=`shape${e+1}`;try{const o=await fetch(a[e]);if(!o.ok)throw new Error(`Shape ${e+1} not found`);this.shapes[t]=await o.json()}catch(e){console.warn(`Error loading ${t}:`,e)}}}async loadFallbackShapes(){console.log("ğŸ”„ Loading fallback shapes");try{const e=await fetch("geojson library/shape1.geojson");if(e.ok){const t=await e.json();this.shapes.shape1=t,this.shapes.shape2=t,this.shapes.shape3=t}}catch(e){console.error("Failed to load fallback shapes:",e)}}getShapeData(e){const t=`shape${e}`;return this.shapes[t]}saveGameState(){const e={...this.gameState,date:this.currentDate,mechanic:this.currentMechanic,timestamp:Date.now()};try{localStorage.setItem("dailyGameState",JSON.stringify(e)),console.log("ğŸ’¾ Game state saved")}catch(e){console.error("Error saving game state:",e)}}async restoreGameState(){if(window.AuthService&&!window.AuthService.isGuest&&window.SupabaseConfig?.isReady()){console.log("ğŸ” User logged in, checking server for daily progress...");try{const e=localStorage.getItem("dailyGameState");if(e){JSON.parse(e).date!==this.currentDate&&(localStorage.removeItem("dailyGameState"),console.log("ğŸ—‘ï¸ Cleared old localStorage state for new day"))}}catch(e){console.error("Error checking localStorage date:",e)}if(await this.loadDailyProgressFromServer())return console.log("âœ… Restored game state from server"),!0}try{const e=localStorage.getItem("dailyGameState");if(!e)return console.log("ğŸ“ No saved game state found"),!1;const t=JSON.parse(e);return t.date!==this.currentDate?(console.log("ğŸ—‘ï¸ Clearing old game state for new day"),this.clearGameState(),!1):(this.gameState={currentShape:t.currentShape||1,currentAttempt:t.currentAttempt||1,shapeResults:t.shapeResults||{},hasStartedToday:t.hasStartedToday||!1,completedShapes:t.completedShapes||[],isCompleted:t.isCompleted||!1},console.log("ğŸ”„ Game state restored:",this.gameState),!0)}catch(e){return console.error("Error restoring game state:",e),!1}}clearGameState(){this.gameState={currentShape:1,currentAttempt:1,shapeResults:{},hasStartedToday:!1,completedShapes:[],isCompleted:!1};try{localStorage.removeItem("dailyGameState"),console.log("ğŸ§¹ Game state cleared")}catch(e){console.error("Error clearing game state:",e)}}updateGameState(e,t,a){const o=`shape${e}`;this.gameState.shapeResults[o]||(this.gameState.shapeResults[o]={}),this.gameState.shapeResults[o][`attempt${t}`]=a,this.gameState.hasStartedToday=!0;const i=this.gameState.shapeResults[o];void 0!==i.attempt1&&void 0!==i.attempt2&&(this.gameState.completedShapes.includes(e)||this.gameState.completedShapes.push(e)),3===this.gameState.completedShapes.length&&(this.gameState.isCompleted=!0),1===t?this.gameState.currentAttempt=2:e<3&&(this.gameState.currentShape=e+1,this.gameState.currentAttempt=1),this.saveGameState(),window.AuthService&&window.AuthService.isLoggedIn()&&this.saveToDatabaseDebounced()}saveToDatabaseDebounced(){clearTimeout(this.dbSaveTimer),this.dbSaveTimer=setTimeout(async()=>{await this.saveDailyProgressToServer()},1e3)}async loadDailyProgressFromServer(){if(!window.SupabaseConfig?.isReady()||!window.AuthService?.currentUser?.id)return null;try{const{data:e,error:t}=await window.SupabaseConfig.client.from("user_daily_progress").select("*").eq("user_id",window.AuthService.currentUser.id).eq("date",this.currentDate).single();return t&&"PGRST116"!==t.code?(console.error("Error loading daily progress:",t),null):e?(this.gameState={currentShape:e.completed?4:(e.attempts,Math.floor((e.attempts?.length||0)/2)+1),currentAttempt:e.completed?1:(e.attempts?.length||0)%2+1,shapeResults:e.scores?this.convertScoresToShapeResults(e.scores):{},hasStartedToday:e.attempts?.length>0,completedShapes:e.scores?Object.keys(this.convertScoresToShapeResults(e.scores)):[],isCompleted:e.completed},console.log("ğŸ“Š Loaded daily progress from server:",e),!0):null}catch(e){return console.error("Error loading daily progress:",e),null}}async saveDailyProgressToServer(){if(window.SupabaseConfig?.isReady()&&window.AuthService?.currentUser?.id)try{const{data:e,error:t}=await window.SupabaseConfig.client.from("user_daily_progress").select("completed, total_score").eq("user_id",window.AuthService.currentUser.id).eq("date",this.currentDate).single();if(e&&e.completed)return console.log("ğŸš« Game already completed on server - not overwriting existing score:",e.total_score),void console.log("âš ï¸ This prevents score manipulation by replaying after clearing cache");const a=this.getAllAttempts(),o=this.getAllScores(),i=o.reduce((e,t)=>e+(t||0),0),s={user_id:window.AuthService.currentUser.id,date:this.currentDate,completed:this.gameState.isCompleted,scores:o.length>0?o:null,attempts:a.length>0?a:null,total_score:i,updated_at:(new Date).toISOString()},{data:n,error:r}=await window.SupabaseConfig.client.from("user_daily_progress").upsert(s,{onConflict:"user_id,date",ignoreDuplicates:!1}).select();if(r)return void console.error("Error saving daily progress:",r);console.log("ğŸ’¾ Daily progress saved to server:",n),this.saveGameState()}catch(e){console.error("Error saving daily progress:",e)}else console.log("âš ï¸ Cannot save to server - not authenticated")}convertScoresToShapeResults(e){const t={};return e.forEach((e,a)=>{null!==e&&(t[`shape${a+1}`]=e)}),t}getAllAttempts(){const e=[];for(let t=1;t<=3;t++){this.getShapeAttempts(t).forEach(a=>{e.push({...a,shape:t,timestamp:a.timestamp||Date.now()})})}return e.sort((e,t)=>e.timestamp-t.timestamp)}getAllScores(){const e=[];for(let t=1;t<=3;t++)e.push(this.gameState.shapeResults[`shape${t}`]||null);return e}async refreshForNewUser(){console.log("ğŸ”„ Refreshing game state for new user..."),this.gameState={currentShape:1,currentAttempt:1,shapeResults:{},hasStartedToday:!1,completedShapes:[],isCompleted:!1},await this.restoreGameState(),window.updateGameUI&&window.updateGameUI(),console.log("âœ… Game state refreshed for new user")}async saveToDatabase(){if(window.AuthService&&window.AuthService.isLoggedIn())try{if(!this.gameState.isCompleted)return;const e={};for(let t=1;t<=3;t++){const a=`shape${t}`,o=this.gameState.shapeResults[a];o&&(e[a]={attempt1:o.attempt1?.score,attempt2:o.attempt2?.score})}await window.AuthService.saveDailyScore(this.currentDate,e,this.currentMechanic),console.log("ğŸ’¾ Progress saved to database")}catch(e){console.error("Error saving to database:",e)}}setupMidnightReset(){const e=this.getTimeUntilMidnight();console.log(`â° Setting midnight reset timer: ${Math.round(e/1e3/60)} minutes`),this.midnightTimer=setTimeout(()=>{this.handleMidnightReset()},e)}getTimeUntilMidnight(){const e=new Date,t=new Date(e);return t.setDate(t.getDate()+1),t.setHours(0,0,0,0),t-e}async handleMidnightReset(){console.log("ğŸŒ™ Midnight reset triggered"),this.clearGameState(),this.currentDate=(new Date).toLocaleDateString("en-CA"),window.updateDateTitle&&window.updateDateTitle(),await this.loadTodaysContent(),window.resetGameForNewDay&&window.resetGameForNewDay(),this.setupMidnightReset(),console.log("ğŸ‰ New day initialized!")}setupOrientationBlocking(){if(void 0===window.isModalOpenForOrientationCheck&&(window.isModalOpenForOrientationCheck=!1),!document.getElementById("orientationMessage")){const e=document.createElement("div");e.id="orientationMessage",e.className="orientation-message",e.innerHTML='\n                <div class="orientation-content">\n                    <div class="rotate-icon">ğŸ“±</div>\n                    <h2>Please rotate your device</h2>\n                    <p>Daily Shapes works best in portrait mode</p>\n                </div>\n            ',e.style.display="none",document.body.appendChild(e)}this.initialViewportHeight=window.innerHeight,this.orientationCheckDebounce=null,this.checkOrientation(),window.addEventListener("resize",()=>{clearTimeout(this.orientationCheckDebounce),this.orientationCheckDebounce=setTimeout(()=>{this.checkOrientation()},200)}),window.addEventListener("orientationchange",()=>{setTimeout(()=>{this.initialViewportHeight=window.innerHeight,this.checkOrientation()},500)})}checkOrientation(){console.log(`ğŸ” checkOrientation() called - modalFlag: ${window.isModalOpenForOrientationCheck}`);const e=document.getElementById("orientationMessage"),t=document.querySelector(".app-container");if(!0===window.isModalOpenForOrientationCheck)return void console.log("ğŸš« Orientation check skipped - modal is open");const a=document.activeElement;if(a&&("INPUT"===a.tagName||"TEXTAREA"===a.tagName||a.isContentEditable||"text"===a.type||"password"===a.type||"email"===a.type))return void console.log("âŒ¨ï¸ Orientation check skipped - input field has focus");const o=window.innerHeight,i=this.initialViewportHeight-o,s=i>100;if(i>50&&console.log(`ğŸ“ Height change detected: ${i}px (keyboard: ${s})`),s)return void console.log("âŒ¨ï¸ Orientation check skipped - keyboard likely open");const n=e=>{if(!e)return!1;const t=window.getComputedStyle(e);return"none"!==t.display&&"hidden"!==t.visibility&&null!==e.offsetParent},r=document.getElementById("authModal"),l=document.getElementById("changePasswordModal"),c=document.getElementById("userStatsModal");if(n(r)||n(l)||n(c))return void console.log("ğŸš« Orientation check skipped - modal is visible");let d;if(screen.orientation&&screen.orientation.type)d=screen.orientation.type.includes("landscape");else{d=window.screen&&window.screen.width&&window.screen.height?window.screen.width>window.screen.height:window.innerWidth>window.innerHeight&&window.innerWidth>768}const h=window.innerHeight<500,g=/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);d&&h&&g?(e.style.display="flex",t.style.display="none",document.body.style.overflow="hidden"):(e.style.display="none",t.style.display="flex",document.body.style.overflow="")}getGameProgress(){return{...this.gameState,currentDate:this.currentDate,currentMechanic:this.currentMechanic,userTimezone:this.userTimezone}}canMakeCut(e,t){return this.gameState.currentShape===e&&this.gameState.currentAttempt===t}getNextAction(){if(this.gameState.isCompleted)return{type:"completed",message:"All shapes completed!"};const e=this.gameState.currentShape,t=this.gameState.currentAttempt;return{type:"cut",shape:e,attempt:t,message:`Shape ${e}, Attempt ${t}`}}destroy(){this.midnightTimer&&clearTimeout(this.midnightTimer),this.dbSaveTimer&&clearTimeout(this.dbSaveTimer)}}const dailyGameCore=new DailyGameCore;"undefined"!=typeof window&&(window.DailyGameCore=dailyGameCore,window.refreshDailyGameForNewUser=async function(){window.DailyGameCore&&window.DailyGameCore.refreshForNewUser&&await window.DailyGameCore.refreshForNewUser()}),window.initializeGameEngine=function(e){console.log(`ğŸ”§ Initializing game engine with ${e}`),window[e]?(window.currentMechanic=window[e],console.log(`âœ… ${e} mechanic activated`)):(console.warn(`âŒ Mechanic ${e} not found, using default`),window.currentMechanic=window.DefaultWithUndoMechanic)},window.resetGameForNewDay=function(){console.log("ğŸ”„ Resetting game for new day"),window.resetGameState&&window.resetGameState(),window.ctx&&window.ctx.clearRect(0,0,window.canvas.width,window.canvas.height);const e=document.getElementById("resultsContainer");e&&(e.style.display="none"),window.loadShapeForDay&&window.loadShapeForDay(1)};