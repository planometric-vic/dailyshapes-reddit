<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Practice Navigation Fix</title>
    <style>
        body { font-family: monospace; padding: 20px; max-width: 1000px; }
        .log { margin: 5px 0; padding: 5px; border-radius: 3px; font-size: 12px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        button { margin: 5px; padding: 8px 16px; }
        #geoCanvas { border: 2px solid #333; margin: 10px 0; }
        .canvas-info { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 5px; font-size: 11px; }
    </style>
</head>
<body>
    <h1>Practice Mode Navigation Fix Test</h1>
    <div>
        <button onclick="initPracticeTest()">Initialize Practice Mode</button>
        <button onclick="testNavigation()">Test Navigation</button>
        <button onclick="checkCanvasState()">Check Canvas State</button>
    </div>

    <div id="logs"></div>

    <div class="canvas-info">
        <strong>Canvas State:</strong>
        <div id="canvasState">Canvas not checked</div>
    </div>

    <!-- Main canvas with correct ID -->
    <canvas id="geoCanvas" width="380" height="380"></canvas>

    <!-- Include required scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="shape-storage.js"></script>
    <script src="practice-mode-manager.js"></script>
    <script src="daily-mode-manager.js"></script>
    <script src="game-mode-integration.js"></script>
    <script src="practice-mode.js"></script>

    <script>
        const logs = document.getElementById('logs');
        const canvasState = document.getElementById('canvasState');

        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = new Date().toLocaleTimeString() + ' - ' + msg;
            logs.appendChild(div);
            console.log(msg);
        }

        function updateCanvasState() {
            const canvas = document.getElementById('geoCanvas');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const pixels = imageData.data;

                let nonTransparentPixels = 0;
                for (let i = 3; i < pixels.length; i += 4) {
                    if (pixels[i] > 0) nonTransparentPixels++;
                }

                canvasState.innerHTML = `
                    Canvas found: ‚úÖ<br>
                    Dimensions: ${canvas.width}x${canvas.height}<br>
                    Non-transparent pixels: ${nonTransparentPixels}<br>
                    Context available: ${ctx ? '‚úÖ' : '‚ùå'}<br>
                    parsedShapes: ${window.parsedShapes ? window.parsedShapes.length : 'none'} shapes<br>
                    isPracticeMode: ${window.isPracticeMode ? '‚úÖ' : '‚ùå'}
                `;
            } else {
                canvasState.innerHTML = 'Canvas not found ‚ùå';
            }
        }

        async function initPracticeTest() {
            logs.innerHTML = '';
            log('üß™ Starting practice mode initialization test...', 'info');

            try {
                // Set practice mode flags
                window.isPracticeMode = true;
                window.isDailyMode = false;
                window.gameState = 'cutting';
                window.isInteractionEnabled = true;

                // Initialize practice mode if available
                if (window.PracticeMode) {
                    log('‚úÖ PracticeMode class found', 'success');

                    // Check if already active
                    if (!window.PracticeMode.isActive) {
                        log('üîÑ Opening practice mode...', 'info');
                        await window.PracticeMode.open();
                        log('‚úÖ Practice mode opened', 'success');
                    } else {
                        log('‚ÑπÔ∏è Practice mode already active', 'info');
                    }

                    // Check current shape
                    const navInfo = window.PracticeMode.practiceShapes && window.PracticeMode.practiceShapes[0]
                                   && window.PracticeMode.practiceShapes[0].supabaseManager
                                   ? window.PracticeMode.practiceShapes[0].supabaseManager.getNavigationInfo()
                                   : null;

                    if (navInfo) {
                        log(`üìÖ Current shape: ${navInfo.currentShapeName}`, 'success');
                    }

                    updateCanvasState();

                } else {
                    log('‚ùå PracticeMode class not found', 'error');
                }

            } catch (error) {
                log(`‚ùå Practice mode init failed: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function testNavigation() {
            if (!window.PracticeMode || !window.PracticeMode.isActive) {
                log('‚ùå Initialize practice mode first', 'error');
                return;
            }

            log('üîÑ Testing navigation...', 'info');

            try {
                // Test right navigation
                log('‚û°Ô∏è Testing right navigation...', 'info');
                updateCanvasState();

                await window.PracticeMode.navigateShape('right');

                // Wait for rendering
                await new Promise(resolve => setTimeout(resolve, 500));

                updateCanvasState();
                log('‚úÖ Right navigation completed', 'success');

                // Test left navigation
                await new Promise(resolve => setTimeout(resolve, 1000));
                log('‚¨ÖÔ∏è Testing left navigation...', 'info');

                await window.PracticeMode.navigateShape('left');

                // Wait for rendering
                await new Promise(resolve => setTimeout(resolve, 500));

                updateCanvasState();
                log('‚úÖ Left navigation completed', 'success');

            } catch (error) {
                log(`‚ùå Navigation test failed: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function checkCanvasState() {
            log('üîç Checking canvas state...', 'info');

            const canvas = document.getElementById('geoCanvas');
            if (canvas) {
                log(`üìê Canvas dimensions: ${canvas.width}x${canvas.height}`, 'success');
                log(`üé® Canvas style: ${canvas.style.cssText || 'none'}`, 'info');

                const ctx = canvas.getContext('2d');
                if (ctx) {
                    log('‚úÖ Canvas context available', 'success');

                    // Draw test shape to verify canvas works
                    ctx.fillStyle = 'blue';
                    ctx.fillRect(5, 5, 30, 30);
                    log('üü¶ Drew test blue square', 'success');

                } else {
                    log('‚ùå Canvas context not available', 'error');
                }
            } else {
                log('‚ùå Canvas element not found', 'error');
            }

            updateCanvasState();
        }

        // Auto-update canvas state every 2 seconds
        setInterval(updateCanvasState, 2000);

        // Initial canvas state check
        setTimeout(updateCanvasState, 1000);
    </script>
</body>
</html>