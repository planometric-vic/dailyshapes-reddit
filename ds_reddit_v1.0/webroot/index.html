<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Daily Shapes</title>

    <!-- CSS -->
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="responsive.css">
    <link rel="stylesheet" href="circular-button-styles.css">
    <link rel="stylesheet" href="custom-competition-styles.css">
    <link rel="stylesheet" href="neobrutalist-styles.css">
    <link rel="stylesheet" href="collapsible-menu-styles.css">

    <!-- Devvit WebView: no external CDNs allowed -->
    <style>
        /* Prevent any scrolling in the Reddit WebView iframe */
        html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100%;
            width: 100%;
        }
        body {
            margin: 0;
            padding: 0 !important;
            overflow: hidden;
            height: 100%;
            width: 100%;
            -webkit-overflow-scrolling: touch;
        }
        /* Hide elements not needed in Reddit context */
        #accountDropdown,
        #authModal,
        #forgotPasswordModal,
        #changePasswordModal,
        #recoveryCodeModal,
        #successConfirmationModal,
        #joinCompetitionModal,
        #competitionPromptModal,
        #competitionModal,
        #userStatsModal,
        #signInReminderModal,
        #welcomeBackPopup {
            display: none !important;
        }
        /* Reddit WebView specific adjustments - fill viewport, center content within */
        .app-container {
            padding-top: 0;
            min-height: 100% !important;
            height: 100% !important;
            max-height: 100% !important;
            padding-bottom: 0 !important;
            box-sizing: border-box !important;
            justify-content: center !important; /* vertical center for mobile flex column */
        }
        /* Hide elements not needed in Reddit context */
        .main-header,
        .mechanic-info {
            display: none !important;
        }
        /* Hide countdown timer - new game posts daily, no 24h time limit */
        #countdownOverlay,
        #completion-countdown,
        .countdown-overlay {
            display: none !important;
        }
        /* Hide competition buttons - replaced by weekly leaderboard */
        #option3Btn,
        .competition-close-btn {
            display: none !important;
        }
        /* Hide practice button for now (no practice mode shapes in Reddit).
           Must use high specificity to override style.css rules like
           .initial-play-container #practiceBtn { display: inline-block !important } */
        .initial-play-container #practiceBtn,
        .initial-play-container button#practiceBtn,
        #initialPlayButton #practiceBtn,
        #practiceBtn {
            display: none !important;
        }
        /* Hide post-canvas action buttons (Share Score, Competitions) */
        #post-canvas-actions {
            display: none !important;
        }
        /* ============================================
           DESKTOP: Side-by-side layout (canvas left, UI right)
           ============================================ */
        @media (min-width: 600px) {
            .app-container {
                display: grid !important;
                grid-template-columns: auto 1fr;
                grid-template-rows: auto auto auto auto auto;
                gap: 0 16px !important;
                max-width: 100% !important;
                padding: 4px 16px 4px 24px !important;
                align-items: start !important;
                align-content: center !important; /* vertical center grid tracks in viewport */
            }
            /* Instruction text sits above the canvas */
            .instruction-area {
                grid-column: 1 !important;
                grid-row: 1 / 6 !important;
                align-self: start !important;
                transform: translateY(calc(-100% - 10px)) !important;
                z-index: 20 !important;
                height: auto !important;
                min-height: auto !important;
                max-height: none !important;
                margin: 0 !important;
                padding: 2px 0 !important;
                background: transparent !important;
                border: none !important;
                border-radius: 0 !important;
                pointer-events: none !important;
                width: 100% !important;
                justify-self: center !important;
            }
            .instruction-text {
                font-size: 14px !important;
                text-align: center !important;
                white-space: nowrap !important;
            }
            /* Canvas in left column, spanning all rows */
            .canvas-container, .canvas-container-fixed {
                grid-column: 1 !important;
                grid-row: 1 / 6 !important;
                margin: 0 !important;
                align-self: start !important;
                position: relative !important;
            }
            /* Play button to the right of the canvas, vertically centered with it */
            #initialPlayButton, #initialPlayButton.initial-play-container {
                grid-column: 2 !important;
                grid-row: 1 / 6 !important; /* span same rows as canvas */
                align-self: center !important;
                justify-self: center !important;
                margin: 0 !important;
                position: relative !important;
                z-index: 25 !important;
                transform: none !important;
                text-align: center !important;
                width: auto !important; /* content-sized, not canvas-width */
            }
            /* Progress display: under the canvas, centered horizontally.
               Overlaps the canvas grid area so it doesn't add a new row
               or cause any grid recalculation when it appears. */
            #demoProgressDisplay, .demo-progress-display {
                grid-column: 1 !important;
                grid-row: 1 / 6 !important;
                align-self: end !important;
                justify-self: center !important;
                transform: translateY(calc(100% + 12px)) !important; /* sit below canvas with breathing room */
                margin: 0 !important;
                padding: 0 !important;
                font-size: 11px !important;
                text-align: center !important;
                white-space: nowrap !important;
            }
            .fixed-percentage-area, #fixedPercentageArea {
                grid-column: 2 !important;
                grid-row: 2 !important;
                align-self: start !important;
                min-height: auto !important;
                margin: 0 !important;
            }
            .split-display-large {
                font-size: 32px !important;
                min-height: auto !important;
            }
            /* Lock split display child spans so JS inline font-size can't cause resize flicker */
            .split-display-large span {
                font-size: 32px !important;
            }
            .fixed-button-area, #fixedButtonArea {
                grid-column: 2 !important;
                grid-row: 3 !important;
                align-self: start !important;
                min-height: auto !important;
                margin: 16px 0 0 0 !important;
            }
            .fixed-button-area .progression-button,
            #fixedButtonArea .progression-button {
                margin-top: 0 !important;
                transform: none !important;
            }
            /* Leaderboard: hidden during gameplay, shown after completion.
               Height set via JS to match canvas exactly. */
            .weekly-leaderboard {
                grid-column: 2 !important;
                grid-row: 1 / 6 !important;
                align-self: start !important;
                display: none;
                max-width: none !important;
                border: 2px solid #000;
                box-sizing: border-box;
            }
            /* Hide practice nav / results in grid */
            .buttons-below-canvas, .results-container {
                grid-column: 2 !important;
                grid-row: 5 !important;
                overflow: hidden !important;
                max-height: 0 !important;
            }
        }
        /* Commentary overlay: above the canvas, centered horizontally */
        .commentary-overlay {
            position: absolute !important;
            bottom: calc(100% + 10px) !important;
            top: auto !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            z-index: 20 !important;
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }
        .commentary-text {
            font-size: 15px !important;
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding: 2px 8px !important;
        }
        /* Center the single Play button (Practice is hidden) */
        #initialPlayButton #playBtn,
        #initialPlayButton .canvas-play-button#playBtn {
            display: inline-block !important;
            margin-left: auto !important;
            margin-right: auto !important;
        }

        /* ============================================
           MOBILE: Stacked layout (compact vertical)
           ============================================ */
        @media (max-width: 599px) {
            #initialPlayButton,
            #initialPlayButton.initial-play-container {
                margin-top: -10px !important;
                position: relative !important;
                z-index: 25 !important;
                transform: none !important;
                text-align: center !important;
            }
            .instruction-area {
                height: 24px !important;
                min-height: 24px !important;
                max-height: 24px !important;
                margin-bottom: 0 !important;
                padding: 0 8px !important;
            }
            .canvas-container, .canvas-container-fixed {
                margin-bottom: 2px !important;
                position: relative !important;
            }
            .demo-progress-display, #demoProgressDisplay {
                margin: 0 !important;
                padding: 2px 0 !important;
                font-size: 13px !important;
            }
            .fixed-percentage-area {
                min-height: 40px !important;
                margin: 0 !important;
            }
            .split-display-large {
                font-size: 34px !important;
                min-height: 40px !important;
            }
            .split-display-large span {
                font-size: 34px !important;
            }
            .fixed-button-area {
                min-height: 40px !important;
                margin: 2px 0 0 0 !important;
            }
            .fixed-button-area .progression-button,
            #fixedButtonArea .progression-button {
                margin-top: 0 !important;
                transform: none !important;
            }
        }
        /* ============================================
           LEADERBOARD: Neobrutalist style
           ============================================ */
        .weekly-leaderboard {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            width: 100%;
            max-width: none;
            display: none;
            flex-direction: column;
        }
        .lb-header {
            font-size: 13px;
            font-weight: 800;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            padding: 6px 8px;
            border-bottom: 3px solid #000;
            margin-bottom: 0;
            position: relative;
        }
        .lb-table {
            flex: 1;
            overflow-y: auto;
        }
        .lb-row {
            display: flex;
            align-items: center;
            padding: 2px 8px;
            font-size: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        .lb-row-empty {
            color: transparent;
            user-select: none;
        }
        .lb-row-first {
            font-weight: 700;
        }
        .lb-row-user {
            background: #FFF3CD;
            font-weight: 700;
            border-bottom: 2px solid #000;
        }
        .lb-rank {
            width: 26px;
            font-weight: 700;
            font-size: 11px;
            color: #666;
            flex-shrink: 0;
        }
        .lb-row-first .lb-rank {
            color: #000;
        }
        .lb-row-user .lb-rank {
            color: #000;
        }
        .lb-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 12px;
        }
        .lb-score {
            font-weight: 700;
            font-size: 12px;
            min-width: 36px;
            text-align: right;
            font-variant-numeric: tabular-nums;
        }
        .lb-separator {
            height: 2px;
            background: #000;
            margin: 2px 0;
        }
        .lb-subtitle {
            font-size: 9px;
            font-weight: 600;
            letter-spacing: 1px;
            color: #666;
            margin-top: 1px;
        }
        .lb-tabs {
            display: flex;
            gap: 3px;
            padding: 4px 6px 3px;
            border-top: 2px solid #000;
            flex-shrink: 0;
        }
        .lb-tab {
            flex: 1;
            padding: 3px 2px !important;
            font-size: 9px !important;
            font-weight: 700 !important;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border: 1.5px solid #000 !important;
            border-radius: 3px !important;
            background: #fff !important;
            color: #333 !important;
            cursor: pointer;
            text-align: center;
            box-shadow: 1px 1px 0px #000 !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
        }
        .lb-tab:hover {
            transform: none !important;
            box-shadow: 2px 2px 0px #000 !important;
        }
        .lb-tab:active {
            transform: none !important;
            box-shadow: 0px 0px 0px #000 !important;
        }
        .lb-tab-active {
            background: #000 !important;
            color: #fff !important;
        }
        .lb-table::-webkit-scrollbar {
            width: 4px;
        }
        .lb-table::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 2px;
        }
        /* Close button: only visible in mobile modal mode */
        .lb-close-btn {
            display: none;
            position: absolute;
            top: 4px;
            right: 6px;
            background: none;
            border: none;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            padding: 0 4px;
            line-height: 1;
            color: #000;
        }
        .lb-modal-mode .lb-close-btn {
            display: block;
        }
        /* Mobile modal backdrop */
        .lb-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        /* Mobile modal positioning */
        .lb-modal-mode {
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            width: 85% !important;
            max-width: 320px !important;
            max-height: 75vh !important;
            z-index: 1000 !important;
            background: #fff !important;
            border: 2px solid #000 !important;
            box-shadow: 4px 4px 0px #000 !important;
        }
    </style>
</head>
<body>

    <!-- Welcome Back Popup (hidden in Reddit, but kept for DOM reference) -->
    <div id="welcomeBackPopup" class="welcome-popup" style="display: none;">
        <div class="welcome-content" id="welcomeBackContent">
            <div class="welcome-body" id="welcomeBackBody">
                <div class="welcome-message" id="welcomeBackMessage">
                    <p id="welcomeBackText"></p>
                    <button id="continueBtn" class="continue-button">Continue</button>
                </div>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Header hidden on Reddit (post title replaces it), but keep IDs for JS references -->
        <div class="main-header" style="display: none;">
            <h1 id="dateTitle" class="app-title" role="button" tabindex="0"><strong>Daily Shapes</strong> <span class="date-light"></span></h1>
            <div class="animated-menu-container">
                <button id="animatedMenuButton" class="animated-menu-button">
                    <svg id="hamburgerIcon" class="menu-icon hamburger-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2.5" stroke-linecap="round">
                        <path d="M3 6h18M3 12h18M3 18h18"/>
                    </svg>
                </button>
                <div id="menuDropdown" class="menu-dropdown" style="display: none;">
                    <div id="option1Btn" class="menu-item" data-action="account">Account</div>
                    <div id="option2Btn" class="menu-item" data-action="daily">Today's Shapes</div>
                    <div id="option3Btn" class="menu-item" data-action="competition">Leaderboard</div>
                    <div id="option4Btn" class="menu-item" data-action="practice">Practice</div>
                </div>
            </div>
        </div>

        <!-- Account Dropdown (hidden in Reddit but kept for DOM reference) -->
        <div id="accountDropdown" class="account-dropdown" style="display: none;"></div>

        <!-- Challenge Info -->
        <div class="mechanic-info" id="mechanicInfo"></div>

        <!-- Instruction Area -->
        <div id="instructionArea" class="instruction-area" style="display: flex; visibility: hidden;">
            <div id="instructionText" class="instruction-text"></div>
        </div>

        <!-- Canvas Container -->
        <div class="canvas-container">
            <canvas id="geoCanvas" width="380" height="380"></canvas>

            <!-- Loading animation (simplified - no KaTeX dependency) -->
            <script src="loading-animation.js"></script>

            <!-- Practice Mode indicator -->
            <div id="practiceModeIndicator" style="display: none; position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(255, 255, 255, 0.9); border: 1px solid black; padding: 3px 8px; font-size: 12px; font-weight: bold; border-radius: 3px; z-index: 10;">Practice Mode</div>

            <!-- Commentary Overlay -->
            <div class="commentary-overlay" id="commentaryOverlay" style="display: none;">
                <div class="commentary-text" id="commentaryText">Perfect cut!</div>
            </div>

            <!-- Canvas Button Overlay -->
            <div class="canvas-button-overlay" id="canvasButtonOverlay" style="display: none;">
                <div class="canvas-buttons-group"></div>
            </div>

            <!-- Countdown Timer Overlay -->
            <div class="countdown-overlay" id="countdownOverlay" style="display: none;">
                <div class="countdown-box">
                    <div class="countdown-message" id="countdownDisplay"></div>
                </div>
            </div>

            <!-- Swipe Indicators -->
            <div class="swipe-indicators" id="swipeIndicators" style="display: none;">
                <div class="swipe-arrow swipe-arrow-left" id="leftArrow" style="display: none;">
                    <svg width="24" height="24" viewBox="0 0 24 24"><polygon points="18,4 6,12 18,20" /></svg>
                </div>
                <div class="swipe-arrow swipe-arrow-right" id="rightArrow" style="display: none;">
                    <svg width="24" height="24" viewBox="0 0 24 24"><polygon points="6,4 18,12 6,20" /></svg>
                </div>
            </div>

            <!-- Welcome Overlay -->
            <div class="welcome-overlay" id="welcomeOverlay" style="visibility: hidden;">
                <div class="welcome-content">
                    <h2>WELCOME TO DAILY SHAPES!</h2>
                    <p><strong>Your goal is to cut three unique shapes as close to 50/50 as possible each day.</strong> You get two attempts per shape.</p>
                    <p>Your score is the sum of your smaller percentages from each cut, plus a 50-point bonus for any perfect 50/50 cut.</p>
                    <p>Today's cutter: <strong id="todaysMechanic" style="color: #3b82f6;">Loading...</strong></p>
                </div>
            </div>
        </div>

        <!-- Play Button -->
        <div id="initialPlayButton" class="initial-play-container" style="visibility: hidden;">
            <button id="playBtn" class="canvas-play-button">Play</button>
            <button id="practiceBtn" class="canvas-play-button practice-button">Practice</button>
        </div>

        <!-- Progress Tracker -->
        <div id="demoProgressDisplay" class="demo-progress-display" style="display: block; visibility: hidden;">
            Shape 1 of 10
        </div>

        <!-- Split/Percentage Display Area -->
        <div id="fixedPercentageArea" class="fixed-percentage-area">
            <div id="attemptDisplay" class="attempt-display" style="display: none; text-align: center;">
                <div id="attemptText" class="attempt-text"></div>
            </div>
        </div>

        <!-- Button Area -->
        <div id="fixedButtonArea" class="fixed-button-area" style="visibility: hidden;"></div>

        <!-- Weekly Leaderboard (Reddit only) -->
        <div id="weeklyLeaderboard" class="weekly-leaderboard"></div>

        <!-- Practice Navigation -->
        <div class="buttons-below-canvas" id="buttonsContainer">
            <div id="practiceNavigation" class="practice-navigation" style="display: none;">
                <button id="practiceLeftBtn" class="practice-nav-btn" title="Previous Shape"></button>
                <button id="practiceRandomBtn" class="practice-nav-btn" title="Random Shape"></button>
                <button id="practiceResetBtn" class="practice-nav-btn" title="Reset Shape"></button>
                <button id="practiceRightBtn" class="practice-nav-btn" title="Next Shape"></button>
            </div>
        </div>

        <!-- Results Container -->
        <div class="results-container" id="resultsContainer" style="overflow: hidden; position: relative;"></div>
    </div>

    <!-- Stats Overlay (kept for DOM reference) -->
    <div id="statsOverlay" class="stats-overlay" style="display: none;">
        <div class="stats-window">
            <div class="stats-header">
                Daily Stats
                <button class="stats-close" id="statsCloseBtn">&times;</button>
            </div>
            <div class="stats-content" id="statsContent"></div>
        </div>
    </div>

    <!-- Minimal modal stubs (hidden, but keep IDs so game code doesn't crash) -->
    <div id="authModal" class="auth-modal" style="display: none;"></div>
    <div id="competitionModal" class="success-modal" style="display: none;">
        <div class="success-modal-content">
            <div id="competitionMainView">
                <div class="success-modal-header">
                    <h2>Leaderboard</h2>
                    <button class="success-modal-close competition-close-btn">&times;</button>
                </div>
                <div class="success-modal-body"></div>
            </div>
            <div id="competitionActiveView" style="display: none;"></div>
            <div id="competitionExpiredView" style="display: none;"></div>
            <div id="competitionCreateView" style="display: none;"></div>
            <div id="competitionLeaderboardView" style="display: none;">
                <div class="success-modal-header">
                    <h2 id="leaderboardCompetitionTitle">Leaderboard</h2>
                    <button class="success-modal-close competition-close-btn">&times;</button>
                </div>
                <div class="success-modal-body">
                    <div id="competitionLeaderboardContainer"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="joinCompetitionModal" class="success-modal" style="display: none;">
        <div class="success-modal-content">
            <div class="success-modal-body">
                <div id="joinCompetitionContent"></div>
            </div>
        </div>
    </div>
    <div id="userStatsModal" class="auth-modal" style="display: none;">
        <div class="auth-modal-content">
            <div class="stats-display" id="statsDisplay" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-value" id="perfectCuts">0</div></div>
                    <div class="stat-card"><div class="stat-value" id="currentStreak">0</div></div>
                    <div class="stat-card"><div class="stat-value" id="bestStreak">0</div></div>
                    <div class="stat-card"><div class="stat-value" id="averageScore">0</div></div>
                    <div class="stat-card"><div class="stat-value" id="totalScore">0</div></div>
                    <div class="stat-card"><div class="stat-value" id="competitionsWon">0</div></div>
                </div>
            </div>
        </div>
    </div>
    <div id="changePasswordModal" class="auth-modal" style="display: none;"></div>
    <div id="forgotPasswordModal" class="auth-modal" style="display: none;"></div>
    <div id="recoveryCodeModal" class="auth-modal" style="display: none;"></div>
    <div id="competitionPromptModal" class="success-modal" style="display: none;"></div>
    <div id="successConfirmationModal" class="success-modal" style="display: none;"></div>
    <div id="signInReminderModal" style="display: none;"></div>

    <!-- ============================================================ -->
    <!-- Script Loading Order (critical!) -->
    <!-- ============================================================ -->

    <!-- 1. Devvit bridge (sets up postMessage listener first) -->
    <script src="devvit-bridge.js"></script>

    <!-- 2. Devvit shims (must load BEFORE main.js - provides fake Supabase/Auth/etc.) -->
    <script src="devvit-supabase-shim.js"></script>

    <!-- 3. Stubs for missing competition/auth globals -->
    <script src="devvit-stubs.js"></script>

    <!-- 4. Refresh protection -->
    <script src="simple-refresh.js"></script>

    <!-- 5. Shape types -->
    <script src="shape-types.js"></script>

    <!-- 6. Mechanic Modules -->
    <script src="mechanics/default-with-undo.js"></script>
    <script src="mechanics/horizontal-only.js"></script>
    <script src="mechanics/diagonal-ascending.js"></script>
    <script src="mechanics/circle-cut.js"></script>
    <script src="mechanics/rotating-square.js"></script>
    <script src="mechanics/three-point-triangle.js"></script>
    <script src="mechanics/rotating-shape-vector.js"></script>

    <!-- 7. Error notification system -->
    <script src="global-error-notifications.js"></script>

    <!-- 8. Competition UI (references may exist in main.js) -->
    <script src="competition-ui.js"></script>
    <script src="local-competition-demo.js"></script>

    <!-- 9. Practice mode -->
    <script src="practice-mode.js"></script>

    <!-- 10. Main game engine (core - depends on all above) -->
    <script src="main.js"></script>

    <!-- 11. Post-main systems -->
    <script src="collapsible-menu.js"></script>
    <script src="scoring-system.js"></script>
    <script src="daily-game-core.js"></script>

    <!-- 12. Completion view and countdown -->
    <script src="countdown.js"></script>
    <script src="complete-view.js"></script>

    <!-- 13. Test interstitial (development) -->
    <script src="test-interstitial.js"></script>

    <!-- 14. Devvit game initializer (MUST be LAST - bootstraps game with Devvit data) -->
    <script src="devvit-leaderboard.js"></script>
    <script src="devvit-game-init.js"></script>

</body>
</html>
